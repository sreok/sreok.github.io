<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Elijah</title>
  
  
  <link href="https://sreok.cn/rss.xml" rel="self"/>
  
  <link href="https://sreok.cn/"/>
  <updated>2025-09-13T12:28:40.419Z</updated>
  <id>https://sreok.cn/</id>
  
  <author>
    <name>Elijah</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>【云原生】日志收集方案（二）：基于ECK部署生产级ElasticSearch + Kibana + Logstash</title>
    <link href="https://sreok.cn/2025/09/13/%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E6%96%B9%E6%A1%88%EF%BC%88%E4%BA%8C%EF%BC%89%EF%BC%9A%E5%9F%BA%E4%BA%8EECK%E9%83%A8%E7%BD%B2%E7%94%9F%E4%BA%A7%E7%BA%A7ElasticSearch%20+%20Kibana%20+%20Logstash/"/>
    <id>https://sreok.cn/2025/09/13/%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E6%96%B9%E6%A1%88%EF%BC%88%E4%BA%8C%EF%BC%89%EF%BC%9A%E5%9F%BA%E4%BA%8EECK%E9%83%A8%E7%BD%B2%E7%94%9F%E4%BA%A7%E7%BA%A7ElasticSearch%20+%20Kibana%20+%20Logstash/</id>
    <published>2025-09-13T12:28:40.419Z</published>
    <updated>2025-09-13T12:28:40.419Z</updated>
    
    <content type="html"><![CDATA[<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>之前文章写过<a href="./%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E6%96%B9%E6%A1%88%EF%BC%88%E4%B8%80%EF%BC%89%EF%BC%9A%E5%9F%BA%E4%BA%8EECK%E9%83%A8%E7%BD%B2%E7%94%9F%E4%BA%A7%E7%BA%A7ElasticSearch%20+%20Kibana%20+%20FileBeat.md">基于ECK部署生产级ElasticSearch + Kibana + FileBeat</a>，采用filebeat轻量级采集器，本文使用Logstash采集器。</p><h3 id="ELK组件关系"><a href="#ELK组件关系" class="headerlink" title="ELK组件关系"></a>ELK组件关系</h3><p>官方在 2018 年后把“ELK”改名 Elastic Stack，成员扩充为：<br>Elastic Stack &#x3D; Elasticsearch + Kibana + Logstash + Beats + 其他（如 Elastic Agent、Fleet、APM、Security 等）</p><p>早期的 ELK 只有 Elasticsearch、Logstash、Kibana，后来官方推出 Beats 家族作为轻量采集器，Filebeat 的前身叫 logstash-forwarder，由 Logstash 作者 Jordan Sissel 用 Go 写成，之后被 Elastic 团队重构并纳入 Beats；Logstash 与 Beats 是同级兄弟，而非 Beats 成员。</p><p>虽然 Logstash 因 JVM 吃资源被吐槽笨重，但它拥有 200+ 插件、强大 ETL 能力、持久化缓冲以及与 Kafka&#x2F;Redis 的高可靠链路。</p><p>二者在现代架构中互补共存：边缘用 Beats 采集，必要时经 Logstash 深加工后再进 Elasticsearch。</p><h2 id="产品支持列表"><a href="#产品支持列表" class="headerlink" title="产品支持列表"></a>产品支持列表</h2><p><a href="https://www.elastic.co/cn/support/matrix/#matrix_kubernetes">https://www.elastic.co/cn/support/matrix/#matrix_kubernetes</a></p><h2 id="部署ECK-crd"><a href="#部署ECK-crd" class="headerlink" title="部署ECK crd"></a>部署ECK crd</h2><p>官方地址：<a href="https://www.elastic.co/docs/deploy-manage/deploy/cloud-on-k8s/install-using-yaml-manifest-quickstart">https://www.elastic.co/docs/deploy-manage/deploy/cloud-on-k8s/install-using-yaml-manifest-quickstart</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f https://download.elastic.co/downloads/eck/3.0.0/crds.yaml</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://download.elastic.co/downloads/eck/3.0.0/operator.yaml</span><br></pre></td></tr></table></figure><h3 id="部署elasticsearch"><a href="#部署elasticsearch" class="headerlink" title="部署elasticsearch"></a>部署elasticsearch</h3><p>部署前应设置虚拟内存：<a href="https://www.elastic.co/docs/deploy-manage/deploy/cloud-on-k8s/virtual-memory">https://www.elastic.co/docs/deploy-manage/deploy/cloud-on-k8s/virtual-memory</a></p><p><code>elasticsearch.yaml</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: elasticsearch.k8s.elastic.co/v1</span><br><span class="line">kind: Elasticsearch</span><br><span class="line">metadata:</span><br><span class="line">  name: elasticsearch</span><br><span class="line">  namespace: elk</span><br><span class="line">spec:</span><br><span class="line">  version: 9.0.3</span><br><span class="line">  nodeSets:</span><br><span class="line">  - name: elk</span><br><span class="line">    count: 3</span><br><span class="line">    #config:</span><br><span class="line">    #  node.store.allow_mmap: false</span><br><span class="line">    volumeClaimTemplates:</span><br><span class="line">    - metadata:</span><br><span class="line">        name: elasticsearch-data</span><br><span class="line">      spec:</span><br><span class="line">        accessModes:</span><br><span class="line">        - ReadWriteOnce</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            storage: 5Gi</span><br><span class="line">        storageClassName: nfs-storage</span><br><span class="line">    podTemplate:</span><br><span class="line">      spec:</span><br><span class="line">        initContainers:</span><br><span class="line">        - name: sysctl</span><br><span class="line">          securityContext:</span><br><span class="line">            privileged: true</span><br><span class="line">            runAsUser: 0</span><br><span class="line">          command: [&#x27;sh&#x27;, &#x27;-c&#x27;, &#x27;sysctl -w vm.max_map_count=262144&#x27;]</span><br></pre></td></tr></table></figure><h3 id="部署kibana"><a href="#部署kibana" class="headerlink" title="部署kibana"></a>部署kibana</h3><p><code>kibana.yaml</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: kibana.k8s.elastic.co/v1</span><br><span class="line">kind: Kibana</span><br><span class="line">metadata:</span><br><span class="line">  name: kibana</span><br><span class="line">  namespace: elk</span><br><span class="line">spec:</span><br><span class="line">  version: 9.0.3</span><br><span class="line">  count: 3</span><br><span class="line">  elasticsearchRef:</span><br><span class="line">    name: elasticsearch</span><br><span class="line">  config:</span><br><span class="line">    # 更多kibana设置：https://www.elastic.co/docs/reference/kibana/configuration-reference/general-settings</span><br><span class="line">    elasticsearch.requestHeadersWhitelist:</span><br><span class="line">    - authorization</span><br><span class="line">  podTemplate:</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: kibana</span><br><span class="line">        env:</span><br><span class="line">        - name: I18N_LOCALE</span><br><span class="line">          value: &quot;zh-CN&quot;</span><br><span class="line">  http:</span><br><span class="line">    service:</span><br><span class="line">      spec:</span><br><span class="line">        type: NodePort</span><br></pre></td></tr></table></figure><h3 id="部署Logstash"><a href="#部署Logstash" class="headerlink" title="部署Logstash"></a>部署Logstash</h3><p><code>logstash.yaml</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: logstash.k8s.elastic.co/v1alpha1</span><br><span class="line">kind: Logstash</span><br><span class="line">metadata:</span><br><span class="line">  name: logstash</span><br><span class="line">  namespace: elk</span><br><span class="line">spec:</span><br><span class="line">  count: 3</span><br><span class="line">  elasticsearchRefs:</span><br><span class="line">    - name: elasticsearch</span><br><span class="line">      clusterName: elasticsearch</span><br><span class="line">  version: 9.0.3</span><br><span class="line">  pipelines:</span><br><span class="line">    - pipeline.id: main</span><br><span class="line">      config.string: |</span><br><span class="line">        input &#123;</span><br><span class="line">          beats &#123;</span><br><span class="line">            port =&gt; 5044</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        output &#123;</span><br><span class="line">          elasticsearch &#123;</span><br><span class="line">            hosts =&gt; [ &quot;$&#123;ELASTICSEARCH_ES_HOSTS&#125;&quot; ]</span><br><span class="line">            user =&gt; &quot;$&#123;ELASTICSEARCH_ES_USER&#125;&quot;</span><br><span class="line">            password =&gt; &quot;$&#123;ELASTICSEARCH_ES_PASSWORD&#125;&quot;</span><br><span class="line">            ssl_certificate_authorities =&gt; &quot;$&#123;ELASTICSEARCH_ES_SSL_CERTIFICATE_AUTHORITY&#125;&quot;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">  services:</span><br><span class="line">    - name: beats</span><br><span class="line">      service:</span><br><span class="line">        spec:</span><br><span class="line">          type: NodePort</span><br><span class="line">          ports:</span><br><span class="line">            - port: 5044</span><br><span class="line">              name: &quot;filebeat&quot;</span><br><span class="line">              protocol: TCP</span><br><span class="line">              targetPort: 5044</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;介绍&quot;&gt;&lt;a href=&quot;#介绍&quot; class=&quot;headerlink&quot; title=&quot;介绍&quot;&gt;&lt;/a&gt;介绍&lt;/h2&gt;&lt;p&gt;之前文章写过&lt;a href=&quot;./%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91%E6%97%A</summary>
      
    
    
    
    <category term="云原生" scheme="https://sreok.cn/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/"/>
    
    
    <category term="ELK" scheme="https://sreok.cn/tags/ELK/"/>
    
  </entry>
  
  <entry>
    <title>【云原生】日志收集方案（一）：基于ECK部署生产级ElasticSearch + Kibana + FileBeat</title>
    <link href="https://sreok.cn/2025/09/13/%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E6%96%B9%E6%A1%88%EF%BC%88%E4%B8%80%EF%BC%89%EF%BC%9A%E5%9F%BA%E4%BA%8EECK%E9%83%A8%E7%BD%B2%E7%94%9F%E4%BA%A7%E7%BA%A7ElasticSearch%20+%20Kibana%20+%20FileBeat/"/>
    <id>https://sreok.cn/2025/09/13/%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E6%96%B9%E6%A1%88%EF%BC%88%E4%B8%80%EF%BC%89%EF%BC%9A%E5%9F%BA%E4%BA%8EECK%E9%83%A8%E7%BD%B2%E7%94%9F%E4%BA%A7%E7%BA%A7ElasticSearch%20+%20Kibana%20+%20FileBeat/</id>
    <published>2025-09-13T12:28:40.345Z</published>
    <updated>2025-09-13T12:28:40.345Z</updated>
    
    <content type="html"><![CDATA[<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>官方文档：<a href="https://www.elastic.co/guide/en/cloud-on-k8s/current/k8s-deploy-eck.html"><em>Deploy ECK in your Kubernetes cluster</em></a></p><h3 id="Beats成员"><a href="#Beats成员" class="headerlink" title="Beats成员"></a>Beats成员</h3><table><thead><tr><th>官方 Beat</th><th>采集对象</th><th>核心优势</th></tr></thead><tbody><tr><td><strong>Filebeat</strong></td><td>日志文件</td><td>极低的 CPU&#x2F;内存占用；内建“背压感知”与“断点续传”；支持多行合并、容器日志、模块一键解析（Nginx、MySQL 等）。</td></tr><tr><td><strong>Metricbeat</strong></td><td>系统与服务指标</td><td>100+ 现成模块（CPU、内存、Redis、Kafka…）；支持指标自动发现与维度标签；可按周期分片抓取，避免雪崩。</td></tr><tr><td><strong>Packetbeat</strong></td><td>网络流量&#x2F;协议</td><td>零侵入地捕获 L7 协议（HTTP、DNS、MySQL、PG…），实时生成事务级日志；适合 APM 与故障定位。</td></tr><tr><td><strong>Winlogbeat</strong></td><td>Windows 事件日志</td><td>原生解析 EVTX；支持事件 ID 过滤、通道多路复用、域控级批量部署；资源消耗远低于 WMI。</td></tr><tr><td><strong>Auditbeat</strong></td><td>审计&#x2F;安全事件</td><td>监控文件完整性、用户登录、进程启动、SELinux&#x2F;AppArmor 事件；可与 SIEM 规则直接对接。</td></tr><tr><td><strong>Heartbeat</strong></td><td>运行状态&#x2F;可用性</td><td>轻量级“黑盒探针”，支持 HTTP、TCP、ICMP、SSL 证书到期检测；可输出 Uptime SLA 与告警。</td></tr></tbody></table><h3 id="部署ECK-crd"><a href="#部署ECK-crd" class="headerlink" title="部署ECK crd"></a><strong>部署ECK crd</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f https://download.elastic.co/downloads/eck/2.13.0/crds.yaml</span><br></pre></td></tr></table></figure><h3 id="部署Operator"><a href="#部署Operator" class="headerlink" title="部署Operator"></a><strong>部署Operator</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://download.elastic.co/downloads/eck/2.13.0/operator.yaml</span><br></pre></td></tr></table></figure><h3 id="部署ElasticSearch集群"><a href="#部署ElasticSearch集群" class="headerlink" title="部署ElasticSearch集群"></a><strong>部署ElasticSearch集群</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; elasticsearch.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: elasticsearch.k8s.elastic.co/v1</span><br><span class="line">kind: Elasticsearch</span><br><span class="line">metadata:</span><br><span class="line">  name: elasticsearch</span><br><span class="line">spec:</span><br><span class="line">  version: 8.14.1</span><br><span class="line">  nodeSets:</span><br><span class="line">  - name: master</span><br><span class="line">    count: 3</span><br><span class="line">    config:</span><br><span class="line">      node.store.allow_mmap: false</span><br><span class="line">    podTemplate:</span><br><span class="line">      spec:</span><br><span class="line">        initContainers:</span><br><span class="line">        - name: sysctl</span><br><span class="line">          securityContext:</span><br><span class="line">            privileged: true</span><br><span class="line">          command: [&#x27;sh&#x27;, &#x27;-c&#x27;, &#x27;sysctl -w vm.max_map_count=262144&#x27;]</span><br><span class="line">    volumeClaimTemplates:</span><br><span class="line">    - metadata:</span><br><span class="line">        name: elasticsearch-data</span><br><span class="line">      spec:</span><br><span class="line">        accessModes:</span><br><span class="line">        - ReadWriteOnce</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            storage: 200Gi</span><br><span class="line">        storageClassName: nfs-storage</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f elasticsearch.yaml</span><br></pre></td></tr></table></figure><h4 id="获取密码"><a href="#获取密码" class="headerlink" title="获取密码"></a>获取密码</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get secret elasticsearch-es-elastic-user -o=jsonpath=&#x27;&#123;.data.elastic&#125;&#x27; | base64 --decode; echo</span><br></pre></td></tr></table></figure><h3 id="部署kibana"><a href="#部署kibana" class="headerlink" title="部署kibana"></a><strong>部署kibana</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kibana.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: kibana.k8s.elastic.co/v1</span><br><span class="line">kind: Kibana</span><br><span class="line">metadata:</span><br><span class="line">  name: kibana</span><br><span class="line">spec:</span><br><span class="line">  version: 8.14.1</span><br><span class="line">  count: 1</span><br><span class="line">  elasticsearchRef:</span><br><span class="line">    name: elasticsearch</span><br><span class="line">  podTemplate:</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: kibana</span><br><span class="line">        env:</span><br><span class="line">        - name: I18N_LOCALE</span><br><span class="line">          value: &quot;zh-CN&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f kibana.yaml</span><br></pre></td></tr></table></figure><h4 id="访问"><a href="#访问" class="headerlink" title="访问"></a>访问</h4><p>修改svc为NodePort或LoadBalancer</p><p>账号：elastic</p><p>密码：<code>kubectl get secret elasticsearch-es-elastic-user -o=jsonpath=&#39;&#123;.data.elastic&#125;&#39; | base64 --decode; echo</code></p><h3 id="部署Beats（DaemonSet模式）"><a href="#部署Beats（DaemonSet模式）" class="headerlink" title="部署Beats（DaemonSet模式）"></a><strong>部署Beats（DaemonSet模式）</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; beats.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: beat.k8s.elastic.co/v1beta1</span><br><span class="line">kind: Beat</span><br><span class="line">metadata:</span><br><span class="line">  name: filebeat</span><br><span class="line">spec:</span><br><span class="line">  type: filebeat</span><br><span class="line">  version: 8.14.1</span><br><span class="line">  elasticsearchRef:</span><br><span class="line">    name: elasticsearch</span><br><span class="line">  config:</span><br><span class="line">    filebeat.inputs:</span><br><span class="line">    - type: container</span><br><span class="line">      paths:</span><br><span class="line">      - /var/log/containers/*.log</span><br><span class="line">  daemonSet:</span><br><span class="line">    podTemplate:</span><br><span class="line">      spec:</span><br><span class="line">        dnsPolicy: ClusterFirstWithHostNet</span><br><span class="line">        hostNetwork: true</span><br><span class="line">        securityContext:</span><br><span class="line">          runAsUser: 0</span><br><span class="line">        containers:</span><br><span class="line">        - name: filebeat</span><br><span class="line">          volumeMounts:</span><br><span class="line">          - name: varlogcontainers</span><br><span class="line">            mountPath: /var/log/containers</span><br><span class="line">          - name: varlogpods</span><br><span class="line">            mountPath: /var/log/pods</span><br><span class="line">          - name: varlibdockercontainers</span><br><span class="line">            mountPath: /var/lib/docker/containers</span><br><span class="line">        volumes:</span><br><span class="line">        - name: varlogcontainers</span><br><span class="line">          hostPath:</span><br><span class="line">            path: /var/log/containers</span><br><span class="line">        - name: varlogpods</span><br><span class="line">          hostPath:</span><br><span class="line">            path: /var/log/pods</span><br><span class="line">        - name: varlibdockercontainers</span><br><span class="line">          hostPath:</span><br><span class="line">            path: /var/lib/docker/containers</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f beats.yaml</span><br></pre></td></tr></table></figure><h4 id="配置索引"><a href="#配置索引" class="headerlink" title="配置索引"></a>配置索引</h4><p><img src="/images/image-xgfq.png"></p><p><img src="/images/image-hsrd.png"></p><h3 id=""><a href="#" class="headerlink" title=""></a><img src="/images/image-fjjo.png"></h3>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;介绍&quot;&gt;&lt;a href=&quot;#介绍&quot; class=&quot;headerlink&quot; title=&quot;介绍&quot;&gt;&lt;/a&gt;介绍&lt;/h2&gt;&lt;p&gt;官方文档：&lt;a href=&quot;https://www.elastic.co/guide/en/cloud-on-k8s/current/k8s</summary>
      
    
    
    
    <category term="云原生" scheme="https://sreok.cn/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/"/>
    
    
    <category term="Kubernetes" scheme="https://sreok.cn/tags/Kubernetes/"/>
    
    <category term="ECK" scheme="https://sreok.cn/tags/ECK/"/>
    
    <category term="Elasticsearch" scheme="https://sreok.cn/tags/Elasticsearch/"/>
    
  </entry>
  
  <entry>
    <title>【云原生】云原生监控方案（四）：使用podMonitor监控微服务</title>
    <link href="https://sreok.cn/2025/09/13/%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91%E4%BA%91%E5%8E%9F%E7%94%9F%E7%9B%91%E6%8E%A7%E6%96%B9%E6%A1%88%EF%BC%88%E5%9B%9B%EF%BC%89%EF%BC%9A%E4%BD%BF%E7%94%A8podMonitor%E7%9B%91%E6%8E%A7%E5%BE%AE%E6%9C%8D%E5%8A%A1/"/>
    <id>https://sreok.cn/2025/09/13/%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91%E4%BA%91%E5%8E%9F%E7%94%9F%E7%9B%91%E6%8E%A7%E6%96%B9%E6%A1%88%EF%BC%88%E5%9B%9B%EF%BC%89%EF%BC%9A%E4%BD%BF%E7%94%A8podMonitor%E7%9B%91%E6%8E%A7%E5%BE%AE%E6%9C%8D%E5%8A%A1/</id>
    <published>2025-09-13T12:28:39.720Z</published>
    <updated>2025-09-13T12:28:39.720Z</updated>
    
    <content type="html"><![CDATA[<h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>上一篇使用了ServiceMonitor创建监控指标：<a href="./%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91%E4%BA%91%E5%8E%9F%E7%94%9F%E7%9B%91%E6%8E%A7%E6%96%B9%E6%A1%88%EF%BC%88%E4%B8%89%EF%BC%89%EF%BC%9A%E4%BD%BF%E7%94%A8serviceMonitor%E7%9B%91%E6%8E%A7%E5%BE%AE%E6%9C%8D%E5%8A%A1.md">原文地址</a></p><p>对于没有service的pod监控，可以使用PodMonitor告诉Prometheus指标的配置</p><h3 id="部署微服务"><a href="#部署微服务" class="headerlink" title="部署微服务"></a>部署微服务</h3><p>采用Prometheus官方提供的基于golang编写的微服务示例</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: example-app</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: example-app</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        jobname: testpodmonitor</span><br><span class="line">        app: example-app</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: example-app</span><br><span class="line">        image: quay.io/brancz/prometheus-example-app:v0.5.0</span><br><span class="line">        ports:</span><br><span class="line">        - name: web</span><br><span class="line">          containerPort: 8080</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="部署PodMonitor"><a href="#部署PodMonitor" class="headerlink" title="部署PodMonitor"></a>部署PodMonitor</h3><p>告诉Prometheus基于pod获取</p><p>官方api参考：<a href="https://prometheus-operator.dev/docs/api-reference/api/#monitoring.coreos.com/v1.PodMonitor">https://prometheus-operator.dev/docs/api-reference/api/#monitoring.coreos.com/v1.PodMonitor</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: monitoring.coreos.com/v1</span><br><span class="line">kind: PodMonitor</span><br><span class="line">metadata:</span><br><span class="line">  name: example-app   # PodMonitor 的名称</span><br><span class="line">spec:</span><br><span class="line">  podMetricsEndpoints:</span><br><span class="line">  - port: web       # 抓取指标的端口名称（对应pod中的端口名称）</span><br><span class="line">    interval: 15s   # 抓取指标的间隔时间</span><br><span class="line">    path: /metrics  # 指定自定义路径</span><br><span class="line">    scheme: http    # 使用 HTTP 协议抓取指标</span><br><span class="line">    tlsConfig:</span><br><span class="line">      insecureSkipVerify: true # 跳过 TLS 证书验证（用于自签名证书场景）</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: example-app</span><br><span class="line">  jobLabel: jobname  # 用于 Prometheus 中 job 标签的值，取自Pod的该标签，不指定时，默认为PodMonitor 对象的命名空间和名称（例如 &lt;namespace&gt;/&lt;name&gt;）</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: example-app  # 选择带有 app=example-app 标签的 Pod</span><br></pre></td></tr></table></figure><p>访问：<a href="http://nodeip:30900/targets">http://nodeip:30900/targets</a></p><p>查看podmonitor已经将指标获取到,并且job名称为pod标签中设置的名称</p><p><img src="/../images/Prometheus-targer-podmonitor-example-app.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;介绍&quot;&gt;&lt;a href=&quot;#介绍&quot; class=&quot;headerlink&quot; title=&quot;介绍&quot;&gt;&lt;/a&gt;介绍&lt;/h3&gt;&lt;p&gt;上一篇使用了ServiceMonitor创建监控指标：&lt;a href=&quot;./%E3%80%90%E4%BA%91%E5%8E%9F%E7%9</summary>
      
    
    
    
    <category term="云原生" scheme="https://sreok.cn/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/"/>
    
    
    <category term="Kubernetes" scheme="https://sreok.cn/tags/Kubernetes/"/>
    
    <category term="Prometheus" scheme="https://sreok.cn/tags/Prometheus/"/>
    
  </entry>
  
  <entry>
    <title>【云原生】云原生监控方案（六）：集成k8s监控组件kube-state-metrics的使用</title>
    <link href="https://sreok.cn/2025/09/13/%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91%E4%BA%91%E5%8E%9F%E7%94%9F%E7%9B%91%E6%8E%A7%E6%96%B9%E6%A1%88%EF%BC%88%E5%85%AD%EF%BC%89%EF%BC%9A%E9%9B%86%E6%88%90k8s%E7%9B%91%E6%8E%A7%E7%BB%84%E4%BB%B6kube-state-metrics%E7%9A%84%E4%BD%BF%E7%94%A8/"/>
    <id>https://sreok.cn/2025/09/13/%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91%E4%BA%91%E5%8E%9F%E7%94%9F%E7%9B%91%E6%8E%A7%E6%96%B9%E6%A1%88%EF%BC%88%E5%85%AD%EF%BC%89%EF%BC%9A%E9%9B%86%E6%88%90k8s%E7%9B%91%E6%8E%A7%E7%BB%84%E4%BB%B6kube-state-metrics%E7%9A%84%E4%BD%BF%E7%94%A8/</id>
    <published>2025-09-13T12:28:39.625Z</published>
    <updated>2025-09-13T12:28:39.625Z</updated>
    
    <content type="html"><![CDATA[<p>官方仓库地址：<a href="https://github.com/kubernetes/kube-state-metrics">https://github.com/kubernetes/kube-state-metrics</a></p><p><a href="https://github.com/kubernetes/kube-state-metrics/releases">下载地址</a></p><h3 id="兼容性"><a href="#兼容性" class="headerlink" title="兼容性"></a>兼容性</h3><p><a href="https://github.com/kubernetes/kube-state-metrics#versioning">https://github.com/kubernetes/kube-state-metrics#versioning</a></p><table><thead><tr><th>kube-state-metrics</th><th align="center">Kubernetes client-go Version</th></tr></thead><tbody><tr><td><strong>v2.12.0</strong></td><td align="center">v1.29</td></tr><tr><td><strong>v2.13.0</strong></td><td align="center">v1.30</td></tr><tr><td><strong>v2.14.0</strong></td><td align="center">v1.31</td></tr><tr><td><strong>v2.15.0</strong></td><td align="center">v1.32</td></tr><tr><td><strong>v2.16.0</strong></td><td align="center">v1.32</td></tr><tr><td><strong>main</strong></td><td align="center">v1.32</td></tr></tbody></table><h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><p><code>rbac.yaml</code></p><p>组件使用的集群权限</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">automountServiceAccountToken: false</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">  namespace: monitoring</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - &quot;&quot;</span><br><span class="line">  resources:</span><br><span class="line">  - configmaps</span><br><span class="line">  - secrets</span><br><span class="line">  - nodes</span><br><span class="line">  - pods</span><br><span class="line">  - services</span><br><span class="line">  - serviceaccounts</span><br><span class="line">  - resourcequotas</span><br><span class="line">  - replicationcontrollers</span><br><span class="line">  - limitranges</span><br><span class="line">  - persistentvolumeclaims</span><br><span class="line">  - persistentvolumes</span><br><span class="line">  - namespaces</span><br><span class="line">  - endpoints</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - apps</span><br><span class="line">  resources:</span><br><span class="line">  - statefulsets</span><br><span class="line">  - daemonsets</span><br><span class="line">  - deployments</span><br><span class="line">  - replicasets</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - batch</span><br><span class="line">  resources:</span><br><span class="line">  - cronjobs</span><br><span class="line">  - jobs</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - autoscaling</span><br><span class="line">  resources:</span><br><span class="line">  - horizontalpodautoscalers</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - authentication.k8s.io</span><br><span class="line">  resources:</span><br><span class="line">  - tokenreviews</span><br><span class="line">  verbs:</span><br><span class="line">  - create</span><br><span class="line">- apiGroups:</span><br><span class="line">  - authorization.k8s.io</span><br><span class="line">  resources:</span><br><span class="line">  - subjectaccessreviews</span><br><span class="line">  verbs:</span><br><span class="line">  - create</span><br><span class="line">- apiGroups:</span><br><span class="line">  - policy</span><br><span class="line">  resources:</span><br><span class="line">  - poddisruptionbudgets</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - certificates.k8s.io</span><br><span class="line">  resources:</span><br><span class="line">  - certificatesigningrequests</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - discovery.k8s.io</span><br><span class="line">  resources:</span><br><span class="line">  - endpointslices</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - storage.k8s.io</span><br><span class="line">  resources:</span><br><span class="line">  - storageclasses</span><br><span class="line">  - volumeattachments</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - admissionregistration.k8s.io</span><br><span class="line">  resources:</span><br><span class="line">  - mutatingwebhookconfigurations</span><br><span class="line">  - validatingwebhookconfigurations</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - networking.k8s.io</span><br><span class="line">  resources:</span><br><span class="line">  - networkpolicies</span><br><span class="line">  - ingressclasses</span><br><span class="line">  - ingresses</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - coordination.k8s.io</span><br><span class="line">  resources:</span><br><span class="line">  - leases</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">- apiGroups:</span><br><span class="line">  - rbac.authorization.k8s.io</span><br><span class="line">  resources:</span><br><span class="line">  - clusterrolebindings</span><br><span class="line">  - clusterroles</span><br><span class="line">  - rolebindings</span><br><span class="line">  - roles</span><br><span class="line">  verbs:</span><br><span class="line">  - list</span><br><span class="line">  - watch</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">  namespace: monitoring</span><br><span class="line"></span><br></pre></td></tr></table></figure><p><code>kube-state-metrics.yaml</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: kube-state-metrics</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: kube-state-metrics</span><br><span class="line">    spec:</span><br><span class="line">      automountServiceAccountToken: true</span><br><span class="line">      containers:</span><br><span class="line">        #- image: registry.k8s.io/kube-state-metrics/kube-state-metrics:v2.16.0</span><br><span class="line">      - image: swr.cn-north-4.myhuaweicloud.com/ddn-k8s/registry.k8s.io/kube-state-metrics/kube-state-metrics:v2.15.0</span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /livez</span><br><span class="line">            port: http-metrics</span><br><span class="line">          initialDelaySeconds: 5</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">        name: kube-state-metrics</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">          name: http-metrics</span><br><span class="line">        - containerPort: 8081</span><br><span class="line">          name: telemetry</span><br><span class="line">        readinessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /readyz</span><br><span class="line">            port: telemetry</span><br><span class="line">          initialDelaySeconds: 5</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">        securityContext:</span><br><span class="line">          allowPrivilegeEscalation: false</span><br><span class="line">          capabilities:</span><br><span class="line">            drop:</span><br><span class="line">            - ALL</span><br><span class="line">          readOnlyRootFilesystem: true</span><br><span class="line">          runAsNonRoot: true</span><br><span class="line">          runAsUser: 65534</span><br><span class="line">          seccompProfile:</span><br><span class="line">            type: RuntimeDefault</span><br><span class="line">      nodeSelector:</span><br><span class="line">        kubernetes.io/os: linux</span><br><span class="line">      serviceAccountName: kube-state-metrics</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: kube-state-metrics</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  clusterIP: None</span><br><span class="line">  ports:</span><br><span class="line">  - name: http-metrics</span><br><span class="line">    port: 8080</span><br><span class="line">    targetPort: http-metrics</span><br><span class="line">  - name: telemetry</span><br><span class="line">    port: 8081</span><br><span class="line">    targetPort: telemetry</span><br><span class="line">  selector:</span><br><span class="line">    app: kube-state-metrics</span><br><span class="line">---</span><br><span class="line">apiVersion: monitoring.coreos.com/v1</span><br><span class="line">kind: ServiceMonitor</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  endpoints:</span><br><span class="line">  - bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line">    honorLabels: true</span><br><span class="line">    interval: 30s</span><br><span class="line">    metricRelabelings:</span><br><span class="line">    - action: drop</span><br><span class="line">      regex: kube_endpoint_address_not_ready|kube_endpoint_address_available</span><br><span class="line">      sourceLabels:</span><br><span class="line">      - __name__</span><br><span class="line">    port: http-metrics</span><br><span class="line">    relabelings:</span><br><span class="line">    - action: labeldrop</span><br><span class="line">      regex: (pod|service|endpoint|namespace)</span><br><span class="line">    scheme: http</span><br><span class="line">    scrapeTimeout: 30s</span><br><span class="line">  - bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line">    interval: 30s</span><br><span class="line">    port: telemetry</span><br><span class="line">    scheme: http</span><br><span class="line">  jobLabel: app.kubernetes.io/name</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: kube-state-metrics</span><br></pre></td></tr></table></figure><p><code>kubeStateMetrics-prometheusRule.yaml</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: monitoring.coreos.com/v1</span><br><span class="line">kind: PrometheusRule</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    prometheus: prometheus</span><br><span class="line">    role: alert-rules</span><br><span class="line">  name: kube-state-metrics-rules</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  groups:</span><br><span class="line">  - name: kube-state-metrics</span><br><span class="line">    rules:</span><br><span class="line">    - alert: 列表操作错误</span><br><span class="line">      annotations:</span><br><span class="line">        description: kube-state-metrics 在列表操作中出现错误的频率过高，这可能会导致它无法正确或根本无法暴露 Kubernetes 对象的指标。</span><br><span class="line">        runbook_url: https://runbooks.prometheus-operator.dev/runbooks/kube-state-metrics/kubestatemetricslisterrors</span><br><span class="line">        summary: kube-state-metrics 在列表操作中出现错误。</span><br><span class="line">      expr: |</span><br><span class="line">        (sum(rate(kube_state_metrics_list_total&#123;job=&quot;kube-state-metrics&quot;,result=&quot;error&quot;&#125;[5m])) by (cluster)</span><br><span class="line">          /</span><br><span class="line">        sum(rate(kube_state_metrics_list_total&#123;job=&quot;kube-state-metrics&quot;&#125;[5m])) by (cluster))</span><br><span class="line">        &gt; 0.01</span><br><span class="line">      for: 15m</span><br><span class="line">      labels:</span><br><span class="line">        severity: critical</span><br><span class="line">    - alert: 监控操作错误</span><br><span class="line">      annotations:</span><br><span class="line">        description: kube-state-metrics 在监控操作中出现错误的频率过高，这可能会导致它无法正确或根本无法暴露 Kubernetes 对象的指标。</span><br><span class="line">        runbook_url: https://runbooks.prometheus-operator.dev/runbooks/kube-state-metrics/kubestatemetricswatcherrors</span><br><span class="line">        summary: kube-state-metrics 在监控操作中出现错误。</span><br><span class="line">      expr: |</span><br><span class="line">        (sum(rate(kube_state_metrics_watch_total&#123;job=&quot;kube-state-metrics&quot;,result=&quot;error&quot;&#125;[5m])) by (cluster)</span><br><span class="line">          /</span><br><span class="line">        sum(rate(kube_state_metrics_watch_total&#123;job=&quot;kube-state-metrics&quot;&#125;[5m])) by (cluster))</span><br><span class="line">        &gt; 0.01</span><br><span class="line">      for: 15m</span><br><span class="line">      labels:</span><br><span class="line">        severity: critical</span><br><span class="line">    - alert: 分片配置不一致</span><br><span class="line">      annotations:</span><br><span class="line">        description: kube-state-metrics 的分片配置不一致，可能会导致某些 Kubernetes 对象被重复暴露或完全不暴露。</span><br><span class="line">        runbook_url: https://runbooks.prometheus-operator.dev/runbooks/kube-state-metrics/kubestatemetricsshardingmismatch</span><br><span class="line">        summary: kube-state-metrics 的分片配置不一致。</span><br><span class="line">      expr: |</span><br><span class="line">        stdvar (kube_state_metrics_total_shards&#123;job=&quot;kube-state-metrics&quot;&#125;) by (cluster) != 0</span><br><span class="line">      for: 15m</span><br><span class="line">      labels:</span><br><span class="line">        severity: critical</span><br><span class="line">    - alert: 分片缺失</span><br><span class="line">      annotations:</span><br><span class="line">        description: kube-state-metrics 的分片缺失，某些 Kubernetes 对象未被暴露。</span><br><span class="line">        runbook_url: https://runbooks.prometheus-operator.dev/runbooks/kube-state-metrics/kubestatemetricsshardsmissing</span><br><span class="line">        summary: kube-state-metrics 的分片缺失。</span><br><span class="line">      expr: |</span><br><span class="line">        2^max(kube_state_metrics_total_shards&#123;job=&quot;kube-state-metrics&quot;&#125;) by (cluster) - 1</span><br><span class="line">          -</span><br><span class="line">        sum( 2 ^ max by (cluster, shard_ordinal) (kube_state_metrics_shard_ordinal&#123;job=&quot;kube-state-metrics&quot;&#125;) ) by (cluster)</span><br><span class="line">        != 0</span><br><span class="line">      for: 15m</span><br><span class="line">      labels:</span><br><span class="line">        severity: critical</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;官方仓库地址：&lt;a href=&quot;https://github.com/kubernetes/kube-state-metrics&quot;&gt;https://github.com/kubernetes/kube-state-metrics&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;ht</summary>
      
    
    
    
    <category term="云原生" scheme="https://sreok.cn/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/"/>
    
    
    <category term="Kubernetes" scheme="https://sreok.cn/tags/Kubernetes/"/>
    
    <category term="Prometheus" scheme="https://sreok.cn/tags/Prometheus/"/>
    
  </entry>
  
  <entry>
    <title>【云原生】云原生监控方案（八）：Kubernetes部署Grafana接入Prometheus</title>
    <link href="https://sreok.cn/2025/09/13/%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91%E4%BA%91%E5%8E%9F%E7%94%9F%E7%9B%91%E6%8E%A7%E6%96%B9%E6%A1%88%EF%BC%88%E5%85%AB%EF%BC%89%EF%BC%9AKubernetes%E9%83%A8%E7%BD%B2Grafana%E6%8E%A5%E5%85%A5Prometheus/"/>
    <id>https://sreok.cn/2025/09/13/%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91%E4%BA%91%E5%8E%9F%E7%94%9F%E7%9B%91%E6%8E%A7%E6%96%B9%E6%A1%88%EF%BC%88%E5%85%AB%EF%BC%89%EF%BC%9AKubernetes%E9%83%A8%E7%BD%B2Grafana%E6%8E%A5%E5%85%A5Prometheus/</id>
    <published>2025-09-13T12:28:39.552Z</published>
    <updated>2025-09-13T12:28:39.552Z</updated>
    
    <content type="html"><![CDATA[<p><code>grafana-deployment.yaml</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: grafana</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: grafana</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: grafana</span><br><span class="line">    spec:</span><br><span class="line">      automountServiceAccountToken: false</span><br><span class="line">      containers:</span><br><span class="line">      - env: []</span><br><span class="line">        image: grafana/grafana:12.0.2</span><br><span class="line">        name: grafana</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 3000</span><br><span class="line">          name: http</span><br><span class="line">        readinessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /api/health</span><br><span class="line">            port: http</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 200m</span><br><span class="line">            memory: 200Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">            memory: 100Mi</span><br><span class="line">        securityContext:</span><br><span class="line">          allowPrivilegeEscalation: false</span><br><span class="line">          capabilities:</span><br><span class="line">            drop:</span><br><span class="line">            - ALL</span><br><span class="line">          readOnlyRootFilesystem: true</span><br><span class="line">          seccompProfile:</span><br><span class="line">            type: RuntimeDefault</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /var/lib/grafana</span><br><span class="line">          name: grafana-storage</span><br><span class="line">          readOnly: false</span><br><span class="line">        - mountPath: /etc/grafana/provisioning/datasources</span><br><span class="line">          name: grafana-datasources</span><br><span class="line">          readOnly: false</span><br><span class="line">        - mountPath: /etc/grafana/provisioning/dashboards</span><br><span class="line">          name: grafana-dashboards</span><br><span class="line">          readOnly: false</span><br><span class="line">        - mountPath: /tmp</span><br><span class="line">          name: tmp-plugins</span><br><span class="line">          readOnly: false</span><br><span class="line">        - mountPath: /etc/grafana</span><br><span class="line">          name: grafana-config</span><br><span class="line">          readOnly: false</span><br><span class="line">      nodeSelector:</span><br><span class="line">        kubernetes.io/os: linux</span><br><span class="line">      securityContext:</span><br><span class="line">        fsGroup: 65534</span><br><span class="line">        runAsGroup: 65534</span><br><span class="line">        runAsNonRoot: true</span><br><span class="line">        runAsUser: 65534</span><br><span class="line">      volumes:</span><br><span class="line">      - emptyDir: &#123;&#125;</span><br><span class="line">        name: grafana-storage</span><br><span class="line">      - name: grafana-datasources</span><br><span class="line">        secret:</span><br><span class="line">          secretName: grafana-datasources</span><br><span class="line">      - configMap:</span><br><span class="line">          name: grafana-dashboards</span><br><span class="line">        name: grafana-dashboards</span><br><span class="line">      - emptyDir:</span><br><span class="line">          medium: Memory</span><br><span class="line">        name: tmp-plugins</span><br><span class="line">      - name: grafana-config</span><br><span class="line">        secret:</span><br><span class="line">          secretName: grafana-config</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: grafana-config</span><br><span class="line">  namespace: monitoring</span><br><span class="line">stringData:</span><br><span class="line">  grafana.ini: |</span><br><span class="line">    [date_formats]</span><br><span class="line">    default_timezone = Asia/Shanghai</span><br><span class="line">type: Opaque</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: grafana-datasources</span><br><span class="line">  namespace: monitoring</span><br><span class="line">type: Opaque</span><br><span class="line">stringData:</span><br><span class="line">  datasources.yaml: |-</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;apiVersion&quot;: 1,</span><br><span class="line">        &quot;datasources&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;access&quot;: &quot;proxy&quot;,</span><br><span class="line">                &quot;editable&quot;: false,</span><br><span class="line">                &quot;name&quot;: &quot;prometheus&quot;,</span><br><span class="line">                &quot;orgId&quot;: 1,</span><br><span class="line">                &quot;type&quot;: &quot;prometheus&quot;,</span><br><span class="line">                &quot;url&quot;: &quot;http://prometheus.monitoring.svc:9090&quot;,</span><br><span class="line">                &quot;version&quot;: 1</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>grafana-svc.yaml</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: grafana</span><br><span class="line">  name: grafana</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 3000</span><br><span class="line">    targetPort: http</span><br><span class="line">    nodePort: 30000</span><br><span class="line">  selector:</span><br><span class="line">    app: grafana</span><br><span class="line">  type: NodePort</span><br></pre></td></tr></table></figure><p><code>grafana-cm.yaml</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: grafana-dashboards</span><br><span class="line">  namespace: monitoring</span><br><span class="line">data:</span><br><span class="line">  dashboards.yaml: |-</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;apiVersion&quot;: 1,</span><br><span class="line">        &quot;providers&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;folder&quot;: &quot;Default&quot;,</span><br><span class="line">                &quot;folderUid&quot;: &quot;&quot;,</span><br><span class="line">                &quot;name&quot;: &quot;0&quot;,</span><br><span class="line">                &quot;options&quot;: &#123;</span><br><span class="line">                    &quot;path&quot;: &quot;/grafana-dashboard-definitions/0&quot;</span><br><span class="line">                &#125;,</span><br><span class="line">                &quot;orgId&quot;: 1,</span><br><span class="line">                &quot;type&quot;: &quot;file&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p><code>grafana-sm.yaml</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: monitoring.coreos.com/v1</span><br><span class="line">kind: ServiceMonitor</span><br><span class="line">metadata:</span><br><span class="line">  name: grafana</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  endpoints:</span><br><span class="line">  - interval: 15s</span><br><span class="line">    port: http</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: grafana</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;code&gt;grafana-deployment.yaml&lt;/code&gt;&lt;/p&gt;
&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/spa</summary>
      
    
    
    
    <category term="云原生" scheme="https://sreok.cn/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/"/>
    
    
    <category term="Kubernetes" scheme="https://sreok.cn/tags/Kubernetes/"/>
    
    <category term="Grafana" scheme="https://sreok.cn/tags/Grafana/"/>
    
  </entry>
  
  <entry>
    <title>【云原生】云原生监控方案（五）：监控主机组件node-exporter的使用</title>
    <link href="https://sreok.cn/2025/09/13/%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91%E4%BA%91%E5%8E%9F%E7%94%9F%E7%9B%91%E6%8E%A7%E6%96%B9%E6%A1%88%EF%BC%88%E4%BA%94%EF%BC%89%EF%BC%9A%E7%9B%91%E6%8E%A7%E4%B8%BB%E6%9C%BA%E7%BB%84%E4%BB%B6node-exporter%E7%9A%84%E4%BD%BF%E7%94%A8/"/>
    <id>https://sreok.cn/2025/09/13/%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91%E4%BA%91%E5%8E%9F%E7%94%9F%E7%9B%91%E6%8E%A7%E6%96%B9%E6%A1%88%EF%BC%88%E4%BA%94%EF%BC%89%EF%BC%9A%E7%9B%91%E6%8E%A7%E4%B8%BB%E6%9C%BA%E7%BB%84%E4%BB%B6node-exporter%E7%9A%84%E4%BD%BF%E7%94%A8/</id>
    <published>2025-09-13T12:28:39.467Z</published>
    <updated>2025-09-13T12:28:39.467Z</updated>
    
    <content type="html"><![CDATA[<p><code>rbac.yaml</code></p><p>组件使用的集群权限</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">automountServiceAccountToken: false</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: node-exporter</span><br><span class="line">  namespace: monitoring</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: node-exporter</span><br><span class="line">rules:</span><br><span class="line">- apiGroups:</span><br><span class="line">  - authentication.k8s.io</span><br><span class="line">  resources:</span><br><span class="line">  - tokenreviews</span><br><span class="line">  verbs:</span><br><span class="line">  - create</span><br><span class="line">- apiGroups:</span><br><span class="line">  - authorization.k8s.io</span><br><span class="line">  resources:</span><br><span class="line">  - subjectaccessreviews</span><br><span class="line">  verbs:</span><br><span class="line">  - create</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: node-exporter</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: node-exporter</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: node-exporter</span><br><span class="line">  namespace: monitoring</span><br></pre></td></tr></table></figure><p><code>node-exporter.yaml</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: DaemonSet</span><br><span class="line">metadata:</span><br><span class="line">  name: node-exporter</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: node-exporter</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      annotations:</span><br><span class="line">        kubectl.kubernetes.io/default-container: node-exporter</span><br><span class="line">      labels:</span><br><span class="line">        app: node-exporter</span><br><span class="line">    spec:</span><br><span class="line">      automountServiceAccountToken: true</span><br><span class="line">      containers:</span><br><span class="line">      - args:</span><br><span class="line">        - --web.listen-address=127.0.0.1:9100</span><br><span class="line">        - --path.sysfs=/host/sys</span><br><span class="line">        - --path.rootfs=/host/root</span><br><span class="line">        - --path.udev.data=/host/root/run/udev/data</span><br><span class="line">        - --no-collector.wifi</span><br><span class="line">        - --no-collector.hwmon</span><br><span class="line">        - --no-collector.btrfs</span><br><span class="line">        - --collector.filesystem.mount-points-exclude=^/(dev|proc|sys|run/k3s/containerd/.+|var/lib/docker/.+|var/lib/kubelet/pods/.+)($|/)</span><br><span class="line">        - --collector.netclass.ignored-devices=^(veth.*|[a-f0-9]&#123;15&#125;)$</span><br><span class="line">        - --collector.netdev.device-exclude=^(veth.*|[a-f0-9]&#123;15&#125;)$</span><br><span class="line">        image: quay.io/prometheus/node-exporter:v1.9.1</span><br><span class="line">        name: node-exporter</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 250m</span><br><span class="line">            memory: 180Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 102m</span><br><span class="line">            memory: 180Mi</span><br><span class="line">        securityContext:</span><br><span class="line">          allowPrivilegeEscalation: false</span><br><span class="line">          capabilities:</span><br><span class="line">            add:</span><br><span class="line">            - SYS_TIME</span><br><span class="line">            drop:</span><br><span class="line">            - ALL</span><br><span class="line">          readOnlyRootFilesystem: true</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /host/sys</span><br><span class="line">          mountPropagation: HostToContainer</span><br><span class="line">          name: sys</span><br><span class="line">          readOnly: true</span><br><span class="line">        - mountPath: /host/root</span><br><span class="line">          mountPropagation: HostToContainer</span><br><span class="line">          name: root</span><br><span class="line">          readOnly: true</span><br><span class="line">      - args:</span><br><span class="line">        - --secure-listen-address=[$(IP)]:9100</span><br><span class="line">        - --tls-cipher-suites=TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256,TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384,TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305,TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305</span><br><span class="line">        - --upstream=http://127.0.0.1:9100/</span><br><span class="line">        env:</span><br><span class="line">        - name: IP</span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: status.podIP</span><br><span class="line">        image: quay.io/brancz/kube-rbac-proxy:v0.18.1</span><br><span class="line">        name: kube-rbac-proxy</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9100</span><br><span class="line">          hostPort: 9100</span><br><span class="line">          name: https</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 20m</span><br><span class="line">            memory: 40Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 10m</span><br><span class="line">            memory: 20Mi</span><br><span class="line">        securityContext:</span><br><span class="line">          allowPrivilegeEscalation: false</span><br><span class="line">          capabilities:</span><br><span class="line">            drop:</span><br><span class="line">            - ALL</span><br><span class="line">          readOnlyRootFilesystem: true</span><br><span class="line">          runAsGroup: 65532</span><br><span class="line">          runAsNonRoot: true</span><br><span class="line">          runAsUser: 65532</span><br><span class="line">          seccompProfile:</span><br><span class="line">            type: RuntimeDefault</span><br><span class="line">      hostNetwork: true</span><br><span class="line">      hostPID: true</span><br><span class="line">      nodeSelector:</span><br><span class="line">        kubernetes.io/os: linux</span><br><span class="line">      priorityClassName: system-cluster-critical</span><br><span class="line">      securityContext:</span><br><span class="line">        runAsGroup: 65534</span><br><span class="line">        runAsNonRoot: true</span><br><span class="line">        runAsUser: 65534</span><br><span class="line">      serviceAccountName: node-exporter</span><br><span class="line">      tolerations:</span><br><span class="line">      - operator: Exists</span><br><span class="line">      volumes:</span><br><span class="line">      - hostPath:</span><br><span class="line">          path: /sys</span><br><span class="line">        name: sys</span><br><span class="line">      - hostPath:</span><br><span class="line">          path: /</span><br><span class="line">        name: root</span><br><span class="line">  updateStrategy:</span><br><span class="line">    rollingUpdate:</span><br><span class="line">      maxUnavailable: 10%</span><br><span class="line">    type: RollingUpdate</span><br></pre></td></tr></table></figure><p><code>service.yaml</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: node-exporter</span><br><span class="line">  name: node-exporter</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  clusterIP: None</span><br><span class="line">  ports:</span><br><span class="line">  - name: https</span><br><span class="line">    port: 9100</span><br><span class="line">    targetPort: https</span><br><span class="line">  selector:</span><br><span class="line">    app: node-exporter</span><br></pre></td></tr></table></figure><p><code>servicemonitor.yaml</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: monitoring.coreos.com/v1</span><br><span class="line">kind: ServiceMonitor</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: node-exporter</span><br><span class="line">  name: node-exporter</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  endpoints:</span><br><span class="line">  - bearerTokenFile: /var/run/secrets/kubernetes.io/serviceaccount/token</span><br><span class="line">    interval: 15s</span><br><span class="line">    port: https</span><br><span class="line">    relabelings:</span><br><span class="line">    - action: replace</span><br><span class="line">      regex: (.*)</span><br><span class="line">      replacement: $1</span><br><span class="line">      sourceLabels:</span><br><span class="line">      - __meta_kubernetes_pod_node_name</span><br><span class="line">      targetLabel: instance</span><br><span class="line">    scheme: https</span><br><span class="line">    tlsConfig:</span><br><span class="line">      insecureSkipVerify: true</span><br><span class="line">  jobLabel: app</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: node-exporter</span><br></pre></td></tr></table></figure><p>示例规则</p><p><code>nodeExporter-prometheusRule.yaml</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: monitoring.coreos.com/v1</span><br><span class="line">kind: PrometheusRule</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    prometheus: prometheus</span><br><span class="line">    role: alert-rules</span><br><span class="line">  name: node-exporter-rules</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  groups:</span><br><span class="line">  - name: node-exporter</span><br><span class="line">    rules:</span><br><span class="line">    - alert: 文件系统空间即将耗尽</span><br><span class="line">      annotations:</span><br><span class="line">        description: $labels.device 设备上的文件系统，挂载在 $labels.mountpoint，位于 $labels.instance，仅剩下 $value% 的可用空间，并且正在迅速填满。</span><br><span class="line">        runbook_url: https://runbooks.prometheus-operator.dev/runbooks/node/nodefilesystemspacefillingup</span><br><span class="line">        summary: 文件系统预计在未来 24 小时内耗尽空间。</span><br><span class="line">      expr: |</span><br><span class="line">        (</span><br><span class="line">          node_filesystem_avail_bytes&#123;job=&quot;node-exporter&quot;,fstype!=&quot;&quot;,mountpoint!=&quot;&quot;&#125; / node_filesystem_size_bytes&#123;job=&quot;node-exporter&quot;,fstype!=&quot;&quot;,mountpoint!=&quot;&quot;&#125; * 100 &lt; 15</span><br><span class="line">        and</span><br><span class="line">          predict_linear(node_filesystem_avail_bytes&#123;job=&quot;node-exporter&quot;,fstype!=&quot;&quot;,mountpoint!=&quot;&quot;&#125;[6h], 24*60*60) &lt; 0</span><br><span class="line">        and</span><br><span class="line">          node_filesystem_readonly&#123;job=&quot;node-exporter&quot;,fstype!=&quot;&quot;,mountpoint!=&quot;&quot;&#125; == 0</span><br><span class="line">        )</span><br><span class="line">      for: 1h</span><br><span class="line">      labels:</span><br><span class="line">        severity: warning</span><br><span class="line">    - alert: 文件系统空间即将耗尽</span><br><span class="line">      annotations:</span><br><span class="line">        description: $labels.device 设备上的文件系统，挂载在 $labels.mountpoint，位于 $labels.instance，仅剩下 $value% 的可用空间，并且正在迅速填满。</span><br><span class="line">        runbook_url: https://runbooks.prometheus-operator.dev/runbooks/node/nodefilesystemspacefillingup</span><br><span class="line">        summary: 文件系统预计在未来 4 小时内耗尽空间。</span><br><span class="line">      expr: |</span><br><span class="line">        (</span><br><span class="line">          node_filesystem_avail_bytes&#123;job=&quot;node-exporter&quot;,fstype!=&quot;&quot;,mountpoint!=&quot;&quot;&#125; / node_filesystem_size_bytes&#123;job=&quot;node-exporter&quot;,fstype!=&quot;&quot;,mountpoint!=&quot;&quot;&#125; * 100 &lt; 10</span><br><span class="line">        and</span><br><span class="line">          predict_linear(node_filesystem_avail_bytes&#123;job=&quot;node-exporter&quot;,fstype!=&quot;&quot;,mountpoint!=&quot;&quot;&#125;[6h], 4*60*60) &lt; 0</span><br><span class="line">        and</span><br><span class="line">          node_filesystem_readonly&#123;job=&quot;node-exporter&quot;,fstype!=&quot;&quot;,mountpoint!=&quot;&quot;&#125; == 0</span><br><span class="line">        )</span><br><span class="line">      for: 1h</span><br><span class="line">      labels:</span><br><span class="line">        severity: critical</span><br><span class="line">    - alert: 文件系统空间不足</span><br><span class="line">      annotations:</span><br><span class="line">        description: $labels.device 设备上的文件系统，挂载在 $labels.mountpoint，位于 $labels.instance，仅剩下 $value% 的可用空间。</span><br><span class="line">        runbook_url: https://runbooks.prometheus-operator.dev/runbooks/node/nodefilesystemalmostoutofspace</span><br><span class="line">        summary: 文件系统可用空间不足 5%。</span><br><span class="line">      expr: |</span><br><span class="line">        (</span><br><span class="line">          node_filesystem_avail_bytes&#123;job=&quot;node-exporter&quot;,fstype!=&quot;&quot;,mountpoint!=&quot;&quot;&#125; / node_filesystem_size_bytes&#123;job=&quot;node-exporter&quot;,fstype!=&quot;&quot;,mountpoint!=&quot;&quot;&#125; * 100 &lt; 5</span><br><span class="line">        and</span><br><span class="line">          node_filesystem_readonly&#123;job=&quot;node-exporter&quot;,fstype!=&quot;&quot;,mountpoint!=&quot;&quot;&#125; == 0</span><br><span class="line">        )</span><br><span class="line">      for: 30m</span><br><span class="line">      labels:</span><br><span class="line">        severity: warning</span><br><span class="line">    - alert: 文件系统空间不足</span><br><span class="line">      annotations:</span><br><span class="line">        description: $labels.device 设备上的文件系统，挂载在 $labels.mountpoint，位于 $labels.instance，仅剩下 $value% 的可用空间。</span><br><span class="line">        runbook_url: https://runbooks.prometheus-operator.dev/runbooks/node/nodefilesystemalmostoutofspace</span><br><span class="line">        summary: 文件系统可用空间不足 3%。</span><br><span class="line">      expr: |</span><br><span class="line">        (</span><br><span class="line">          node_filesystem_avail_bytes&#123;job=&quot;node-exporter&quot;,fstype!=&quot;&quot;,mountpoint!=&quot;&quot;&#125; / node_filesystem_size_bytes&#123;job=&quot;node-exporter&quot;,fstype!=&quot;&quot;,mountpoint!=&quot;&quot;&#125; * 100 &lt; 3</span><br><span class="line">        and</span><br><span class="line">          node_filesystem_readonly&#123;job=&quot;node-exporter&quot;,fstype!=&quot;&quot;,mountpoint!=&quot;&quot;&#125; == 0</span><br><span class="line">        )</span><br><span class="line">      for: 30m</span><br><span class="line">      labels:</span><br><span class="line">        severity: critical</span><br><span class="line">    - alert: 文件系统 inode 即将耗尽</span><br><span class="line">      annotations:</span><br><span class="line">        description: $labels.device 设备上的文件系统，挂载在 $labels.mountpoint，位于 $labels.instance，仅剩下 $value% 的可用 inode，并且正在迅速填满。</span><br><span class="line">        runbook_url: https://runbooks.prometheus-operator.dev/runbooks/node/nodefilesystemfilesfillingup</span><br><span class="line">        summary: 文件系统预计在未来 24 小时内耗尽 inode。</span><br><span class="line">      expr: |</span><br><span class="line">        (</span><br><span class="line">          node_filesystem_files_free&#123;job=&quot;node-exporter&quot;,fstype!=&quot;&quot;,mountpoint!=&quot;&quot;&#125; / node_filesystem_files&#123;job=&quot;node-exporter&quot;,fstype!=&quot;&quot;,mountpoint!=&quot;&quot;&#125; * 100 &lt; 40</span><br><span class="line">        and</span><br><span class="line">          predict_linear(node_filesystem_files_free&#123;job=&quot;node-exporter&quot;,fstype!=&quot;&quot;,mountpoint!=&quot;&quot;&#125;[6h], 24*60*60) &lt; 0</span><br><span class="line">        and</span><br><span class="line">          node_filesystem_readonly&#123;job=&quot;node-exporter&quot;,fstype!=&quot;&quot;,mountpoint!=&quot;&quot;&#125; == 0</span><br><span class="line">        )</span><br><span class="line">      for: 1h</span><br><span class="line">      labels:</span><br><span class="line">        severity: warning</span><br><span class="line">    - alert: 文件系统 inode 即将耗尽</span><br><span class="line">      annotations:</span><br><span class="line">        description: $labels.device 设备上的文件系统，挂载在 $labels.mountpoint，位于 $labels.instance，仅剩下 $value% 的可用 inode，并且正在迅速填满。</span><br><span class="line">        runbook_url: https://runbooks.prometheus-operator.dev/runbooks/node/nodefilesystemfilesfillingup</span><br><span class="line">        summary: 文件系统预计在未来 4 小时内耗尽 inode。</span><br><span class="line">      expr: |</span><br><span class="line">        (</span><br><span class="line">          node_filesystem_files_free&#123;job=&quot;node-exporter&quot;,fstype!=&quot;&quot;,mountpoint!=&quot;&quot;&#125; / node_filesystem_files&#123;job=&quot;node-exporter&quot;,fstype!=&quot;&quot;,mountpoint!=&quot;&quot;&#125; * 100 &lt; 20</span><br><span class="line">        and</span><br><span class="line">          predict_linear(node_filesystem_files_free&#123;job=&quot;node-exporter&quot;,fstype!=&quot;&quot;,mountpoint!=&quot;&quot;&#125;[6h], 4*60*60) &lt; 0</span><br><span class="line">        and</span><br><span class="line">          node_filesystem_readonly&#123;job=&quot;node-exporter&quot;,fstype!=&quot;&quot;,mountpoint!=&quot;&quot;&#125; == 0</span><br><span class="line">        )</span><br><span class="line">      for: 1h</span><br><span class="line">      labels:</span><br><span class="line">        severity: critical</span><br><span class="line">    - alert: 文件系统 inode 不足</span><br><span class="line">      annotations:</span><br><span class="line">        description: $labels.device 设备上的文件系统，挂载在 $labels.mountpoint，位于 $labels.instance，仅剩下 $value% 的可用 inode。</span><br><span class="line">        runbook_url: https://runbooks.prometheus-operator.dev/runbooks/node/nodefilesystemalmostoutoffiles</span><br><span class="line">        summary: 文件系统可用 inode 不足 5%。</span><br><span class="line">      expr: |</span><br><span class="line">        (</span><br><span class="line">          node_filesystem_files_free&#123;job=&quot;node-exporter&quot;,fstype!=&quot;&quot;,mountpoint!=&quot;&quot;&#125; / node_filesystem_files&#123;job=&quot;node-exporter&quot;,fstype!=&quot;&quot;,mountpoint!=&quot;&quot;&#125; * 100 &lt; 5</span><br><span class="line">        and</span><br><span class="line">          node_filesystem_readonly&#123;job=&quot;node-exporter&quot;,fstype!=&quot;&quot;,mountpoint!=&quot;&quot;&#125; == 0</span><br><span class="line">        )</span><br><span class="line">      for: 1h</span><br><span class="line">      labels:</span><br><span class="line">        severity: warning</span><br><span class="line">    - alert: 文件系统 inode 不足</span><br><span class="line">      annotations:</span><br><span class="line">        description: $labels.device 设备上的文件系统，挂载在 $labels.mountpoint，位于 $labels.instance，仅剩下 $value% 的可用 inode。</span><br><span class="line">        runbook_url: https://runbooks.prometheus-operator.dev/runbooks/node/nodefilesystemalmostoutoffiles</span><br><span class="line">        summary: 文件系统可用 inode 不足 3%。</span><br><span class="line">      expr: |</span><br><span class="line">        (</span><br><span class="line">          node_filesystem_files_free&#123;job=&quot;node-exporter&quot;,fstype!=&quot;&quot;,mountpoint!=&quot;&quot;&#125; / node_filesystem_files&#123;job=&quot;node-exporter&quot;,fstype!=&quot;&quot;,mountpoint!=&quot;&quot;&#125; * 100 &lt; 3</span><br><span class="line">        and</span><br><span class="line">          node_filesystem_readonly&#123;job=&quot;node-exporter&quot;,fstype!=&quot;&quot;,mountpoint!=&quot;&quot;&#125; == 0</span><br><span class="line">        )</span><br><span class="line">      for: 1h</span><br><span class="line">      labels:</span><br><span class="line">        severity: critical</span><br><span class="line">    - alert: 节点网络接收错误</span><br><span class="line">      annotations:</span><br><span class="line">        description: $labels.instance 接口 $labels.device 在过去两分钟内发生了 $value 次接收错误。</span><br><span class="line">        runbook_url: https://runbooks.prometheus-operator.dev/runbooks/node/nodenetworkreceiveerrs</span><br><span class="line">        summary: 网络接口报告了大量接收错误。</span><br><span class="line">      expr: |</span><br><span class="line">        rate(node_network_receive_errs_total&#123;job=&quot;node-exporter&quot;&#125;[2m]) / rate(node_network_receive_packets_total&#123;job=&quot;node-exporter&quot;&#125;[2m]) &gt; 0.01</span><br><span class="line">      for: 1h</span><br><span class="line">      labels:</span><br><span class="line">        severity: warning</span><br><span class="line">    - alert: 节点网络发送错误</span><br><span class="line">      annotations:</span><br><span class="line">        description: $labels.instance 接口 $labels.device 在过去两分钟内发生了 $value 次发送错误。</span><br><span class="line">        runbook_url: https://runbooks.prometheus-operator.dev/runbooks/node/nodenetworktransmiterrs</span><br><span class="line">        summary: 网络接口报告了大量发送错误。</span><br><span class="line">      expr: |</span><br><span class="line">        rate(node_network_transmit_errs_total&#123;job=&quot;node-exporter&quot;&#125;[2m]) / rate(node_network_transmit_packets_total&#123;job=&quot;node-exporter&quot;&#125;[2m]) &gt; 0.01</span><br><span class="line">      for: 1h</span><br><span class="line">      labels:</span><br><span class="line">        severity: warning</span><br><span class="line">    - alert: 节点 conntrack 条目使用率过高</span><br><span class="line">      annotations:</span><br><span class="line">        description: 已使用 $value% 的 conntrack 条目。</span><br><span class="line">        runbook_url: https://runbooks.prometheus-operator.dev/runbooks/node/nodehighnumberconntrackentriesused</span><br><span class="line">        summary: conntrack 条目数量接近限制。</span><br><span class="line">      expr: |</span><br><span class="line">        (node_nf_conntrack_entries&#123;job=&quot;node-exporter&quot;&#125; / node_nf_conntrack_entries_limit) &gt; 0.75</span><br><span class="line">      labels:</span><br><span class="line">        severity: warning</span><br><span class="line">    - alert: 节点文本文件采集器采集失败</span><br><span class="line">      annotations:</span><br><span class="line">        description: Node Exporter 文本文件采集器在 $labels.instance 上采集失败。</span><br><span class="line">        runbook_url: https://runbooks.prometheus-operator.dev/runbooks/node/nodetextfilecollectorscrapeerror</span><br><span class="line">        summary: Node Exporter 文本文件采集器采集失败。</span><br><span class="line">      expr: |</span><br><span class="line">        node_textfile_scrape_error&#123;job=&quot;node-exporter&quot;&#125; == 1</span><br><span class="line">      labels:</span><br><span class="line">        severity: warning</span><br><span class="line">    - alert: 节点时钟偏差检测</span><br><span class="line">      annotations:</span><br><span class="line">        description: $labels.instance 的时钟偏差超过 0.05 秒。请确保该主机正确配置了 NTP。</span><br><span class="line">        runbook_url: https://runbooks.prometheus-operator.dev/runbooks/node/nodeclockskewdetected</span><br><span class="line">        summary: 检测到时钟偏差。</span><br><span class="line">      expr: |</span><br><span class="line">        (</span><br><span class="line">          node_timex_offset_seconds&#123;job=&quot;node-exporter&quot;&#125; &gt; 0.05</span><br><span class="line">        and</span><br><span class="line">          deriv(node_timex_offset_seconds&#123;job=&quot;node-exporter&quot;&#125;[5m]) &gt;= 0</span><br><span class="line">        )</span><br><span class="line">        or</span><br><span class="line">        (</span><br><span class="line">          node_timex_offset_seconds&#123;job=&quot;node-exporter&quot;&#125; &lt; -0.05</span><br><span class="line">        and</span><br><span class="line">          deriv(node_timex_offset_seconds&#123;job=&quot;node-exporter&quot;&#125;[5m]) &lt;= 0</span><br><span class="line">        )</span><br><span class="line">      for: 10m</span><br><span class="line">      labels:</span><br><span class="line">        severity: warning</span><br><span class="line">    - alert: 节点时钟未同步</span><br><span class="line">      annotations:</span><br><span class="line">        description: $labels.instance 的时钟未同步。请确保该主机配置了 NTP。</span><br><span class="line">        runbook_url: https://runbooks.prometheus-operator.dev/runbooks/node/nodeclocknotsynchronising</span><br><span class="line">        summary: 时钟未同步。</span><br><span class="line">      expr: |</span><br><span class="line">        min_over_time(node_timex_sync_status&#123;job=&quot;node-exporter&quot;&#125;[5m]) == 0</span><br><span class="line">        and</span><br><span class="line">        node_timex_maxerror_seconds&#123;job=&quot;node-exporter&quot;&#125; &gt;= 16</span><br><span class="line">      for: 10m</span><br><span class="line">      labels:</span><br><span class="line">        severity: warning</span><br><span class="line">    - alert: 节点 RAID 阵列降级</span><br><span class="line">      annotations:</span><br><span class="line">        description: RAID 阵列 $labels.device 在 $labels.instance 上处于降级状态，由于一个或多个磁盘故障。备用磁盘数量不足以自动修复问题。</span><br><span class="line">        runbook_url: https://runbooks.prometheus-operator.dev/runbooks/node/noderaiddegraded</span><br><span class="line">        summary: RAID 阵列降级。</span><br><span class="line">      expr: |</span><br><span class="line">        node_md_disks_required&#123;job=&quot;node-exporter&quot;,device=~&quot;(/dev/)?(mmcblk.p.+|nvme.+|rbd.+|sd.+|vd.+|xvd.+|dm-.+|md.+|dasd.+)&quot;&#125; - ignoring (state) (node_md_disks&#123;state=&quot;active&quot;,job=&quot;node-exporter&quot;,device=~&quot;(/dev/)?(mmcblk.p.+|nvme.+|rbd.+|sd.+|vd.+|xvd.+|dm-.+|md.+|dasd.+)&quot;&#125;) &gt; 0</span><br><span class="line">      for: 15m</span><br><span class="line">      labels:</span><br><span class="line">        severity: critical</span><br><span class="line">    - alert: 节点 RAID 磁盘故障</span><br><span class="line">      annotations:</span><br><span class="line">        description: RAID 阵列在 $labels.instance 上至少有一个设备故障。阵列 $labels.device 需要关注并可能需要更换磁盘。</span><br><span class="line">        runbook_url: https://runbooks.prometheus-operator.dev/runbooks/node/noderaiddiskfailure</span><br><span class="line">        summary: RAID 阵列中有设备故障。</span><br><span class="line">      expr: |</span><br><span class="line">        node_md_disks&#123;state=&quot;failed&quot;,job=&quot;node-exporter&quot;,device=~&quot;(/dev/)?(mmcblk.p.+|nvme.+|rbd.+|sd.+|vd.+|xvd.+|dm-.+|md.+|dasd.+)&quot;&#125; &gt; 0</span><br><span class="line">      labels:</span><br><span class="line">        severity: warning</span><br><span class="line">    - alert: 节点文件描述符限制</span><br><span class="line">      annotations:</span><br><span class="line">        description: $labels.instance 的文件描述符限制目前为 $value%。</span><br><span class="line">        runbook_url: https://runbooks.prometheus-operator.dev/runbooks/node/nodefiledescriptorlimit</span><br><span class="line">        summary: 内核即将耗尽文件描述符限制。</span><br><span class="line">      expr: |</span><br><span class="line">        (</span><br><span class="line">          node_filefd_allocated&#123;job=&quot;node-exporter&quot;&#125; * 100 / node_filefd_maximum&#123;job=&quot;node-exporter&quot;&#125; &gt; 70</span><br><span class="line">        )</span><br><span class="line">      for: 15m</span><br><span class="line">      labels:</span><br><span class="line">        severity: warning</span><br><span class="line">    - alert: 节点文件描述符限制</span><br><span class="line">      annotations:</span><br><span class="line">        description: $labels.instance 的文件描述符限制目前为 $value%。</span><br><span class="line">        runbook_url: https://runbooks.prometheus-operator.dev/runbooks/node/nodefiledescriptorlimit</span><br><span class="line">        summary: 内核即将耗尽文件描述符限制。</span><br><span class="line">      expr: |</span><br><span class="line">        (</span><br><span class="line">          node_filefd_allocated&#123;job=&quot;node-exporter&quot;&#125; * 100 / node_filefd_maximum&#123;job=&quot;node-exporter&quot;&#125; &gt; 90</span><br><span class="line">        )</span><br><span class="line">      for: 15m</span><br><span class="line">      labels:</span><br><span class="line">        severity: critical</span><br><span class="line">    - alert: 节点 CPU 使用率过高</span><br><span class="line">      annotations:</span><br><span class="line">        description: |</span><br><span class="line">          $labels.instance 的 CPU 使用率在过去 15 分钟内一直高于 90%，目前为 $value%。</span><br><span class="line">        runbook_url: https://runbooks.prometheus-operator.dev/runbooks/node/nodecpuhighusage</span><br><span class="line">        summary: CPU 使用率过高。</span><br><span class="line">      expr: |</span><br><span class="line">        sum without(mode) (avg without (cpu) (rate(node_cpu_seconds_total&#123;job=&quot;node-exporter&quot;, mode!=&quot;idle&quot;&#125;[2m]))) * 100 &gt; 90</span><br><span class="line">      for: 15m</span><br><span class="line">      labels:</span><br><span class="line">        severity: info</span><br><span class="line">    - alert: 节点系统饱和</span><br><span class="line">      annotations:</span><br><span class="line">        description: |</span><br><span class="line">          $labels.instance 的系统负载每核在过去 15 分钟内一直高于 2，目前为 $value。</span><br><span class="line">          这可能表明该实例资源饱和，可能导致实例变得无响应。</span><br><span class="line">        runbook_url: https://runbooks.prometheus-operator.dev/runbooks/node/nodesystemsaturation</span><br><span class="line">        summary: 系统饱和，每核负载过高。</span><br><span class="line">      expr: |</span><br><span class="line">        node_load1&#123;job=&quot;node-exporter&quot;&#125;</span><br><span class="line">        / count without (cpu, mode) (node_cpu_seconds_total&#123;job=&quot;node-exporter&quot;, mode=&quot;idle&quot;&#125;) &gt; 2</span><br><span class="line">      for: 15m</span><br><span class="line">      labels:</span><br><span class="line">        severity: warning</span><br><span class="line">    - alert: 节点内存重大页面错误</span><br><span class="line">      annotations:</span><br><span class="line">        description: |</span><br><span class="line">          $labels.instance 的内存重大页面错误发生率非常高，在过去 15 分钟内每秒发生 500 次重大页面错误，目前为 $value。</span><br><span class="line">          请检查该实例是否有足够的内存可用。</span><br><span class="line">        runbook_url: https://runbooks.prometheus-operator.dev/runbooks/node/nodememorymajorpagesfaults</span><br><span class="line">        summary: 内存重大页面错误发生率非常高。</span><br><span class="line">      expr: |</span><br><span class="line">        rate(node_vmstat_pgmajfault&#123;job=&quot;node-exporter&quot;&#125;[5m]) &gt; 500</span><br><span class="line">      for: 15m</span><br><span class="line">      labels:</span><br><span class="line">        severity: warning</span><br><span class="line">    - alert: 节点内存使用率过高</span><br><span class="line">      annotations:</span><br><span class="line">        description: |</span><br><span class="line">          $labels.instance 的内存已满，在过去 15 分钟内一直高于 90%，目前为 $value%。</span><br><span class="line">        runbook_url: https://runbooks.prometheus-operator.dev/runbooks/node/nodememoryhighutilization</span><br><span class="line">        summary: 主机内存不足。</span><br><span class="line">      expr: |</span><br><span class="line">        100 - (node_memory_MemAvailable_bytes&#123;job=&quot;node-exporter&quot;&#125; / node_memory_MemTotal_bytes&#123;job=&quot;node-exporter&quot;&#125; * 100) &gt; 90</span><br><span class="line">      for: 15m</span><br><span class="line">      labels:</span><br><span class="line">        severity: warning</span><br><span class="line">    - alert: 节点磁盘 IO 饱和</span><br><span class="line">      annotations:</span><br><span class="line">        description: |</span><br><span class="line">          $labels.instance 的磁盘 IO 队列（aqu-sq）在 $labels.device 上非常高，在过去 30 分钟内一直高于 10，目前为 $value。</span><br><span class="line">          此症状可能表明磁盘饱和。</span><br><span class="line">        runbook_url: https://runbooks.prometheus-operator.dev/runbooks/node/nodediskiosaturation</span><br><span class="line">        summary: 磁盘 IO 队列过高。</span><br><span class="line">      expr: |</span><br><span class="line">        rate(node_disk_io_time_weighted_seconds_total&#123;job=&quot;node-exporter&quot;, device=~&quot;(/dev/)?(mmcblk.p.+|nvme.+|rbd.+|sd.+|vd.+|xvd.+|dm-.+|md.+|dasd.+)&quot;&#125;[5m]) &gt; 10</span><br><span class="line">      for: 30m</span><br><span class="line">      labels:</span><br><span class="line">        severity: warning</span><br><span class="line">    - alert: 节点 systemd 服务失败</span><br><span class="line">      annotations:</span><br><span class="line">        description: systemd 服务 $labels.name 在 $labels.instance 上进入失败状态。</span><br><span class="line">        runbook_url: https://runbooks.prometheus-operator.dev/runbooks/node/nodesystemdservicefailed</span><br><span class="line">        summary: systemd 服务进入失败状态。</span><br><span class="line">      expr: |</span><br><span class="line">        node_systemd_unit_state&#123;job=&quot;node-exporter&quot;, state=&quot;failed&quot;&#125; == 1</span><br><span class="line">      for: 5m</span><br><span class="line">      labels:</span><br><span class="line">        severity: warning</span><br><span class="line">    - alert: 节点绑定接口降级</span><br><span class="line">      annotations:</span><br><span class="line">        description: 绑定接口 $labels.master 在 $labels.instance 上由于一个或多个从设备故障而处于降级状态。</span><br><span class="line">        runbook_url: https://runbooks.prometheus-operator.dev/runbooks/node/nodebondingdegraded</span><br><span class="line">        summary: 绑定接口降级。</span><br><span class="line">      expr: |</span><br><span class="line">        (node_bonding_slaves - node_bonding_active) != 0</span><br><span class="line">      for: 5m</span><br><span class="line">      labels:</span><br><span class="line">        severity: warning</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;&lt;code&gt;rbac.yaml&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;组件使用的集群权限&lt;/p&gt;
&lt;figure class=&quot;highlight plaintext&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/</summary>
      
    
    
    
    <category term="云原生" scheme="https://sreok.cn/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/"/>
    
    
    <category term="Kubernetes" scheme="https://sreok.cn/tags/Kubernetes/"/>
    
    <category term="Prometheus" scheme="https://sreok.cn/tags/Prometheus/"/>
    
  </entry>
  
  <entry>
    <title>【云原生】云原生监控方案（二）：基于Prometheus-Operator部署Prometheus、AlertManager</title>
    <link href="https://sreok.cn/2025/09/13/%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91%E4%BA%91%E5%8E%9F%E7%94%9F%E7%9B%91%E6%8E%A7%E6%96%B9%E6%A1%88%EF%BC%88%E4%BA%8C%EF%BC%89%EF%BC%9A%E5%9F%BA%E4%BA%8EPrometheus-Operator%E9%83%A8%E7%BD%B2Prometheus%E3%80%81AlertManager/"/>
    <id>https://sreok.cn/2025/09/13/%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91%E4%BA%91%E5%8E%9F%E7%94%9F%E7%9B%91%E6%8E%A7%E6%96%B9%E6%A1%88%EF%BC%88%E4%BA%8C%EF%BC%89%EF%BC%9A%E5%9F%BA%E4%BA%8EPrometheus-Operator%E9%83%A8%E7%BD%B2Prometheus%E3%80%81AlertManager/</id>
    <published>2025-09-13T12:28:39.393Z</published>
    <updated>2025-09-13T12:28:39.393Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Prometheus社区提供了在k8s部署的三种方式："><a href="#Prometheus社区提供了在k8s部署的三种方式：" class="headerlink" title="Prometheus社区提供了在k8s部署的三种方式："></a>Prometheus社区提供了在k8s部署的三种方式：</h2><ol><li>部署Prometheus-Operator，自定义部署（yaml方式，本文）</li><li>通过kube-Prometheus部署通用监控环境</li><li>通过kube-prometheus-stack部署（helm方式，简化第二种方式）</li></ol><p>上文使用了第二种方式快速部署了Prometheus集成监控方案</p><p>优点是快速和全面，但对于定制化需求不能得到满足，内置的规则和模板也比较杂</p><p>本文和后续都使用Prometheus-Operator方式集成，精简和高度定制一套属于自己的监控方案</p><h2 id="开始部署"><a href="#开始部署" class="headerlink" title="开始部署"></a>开始部署</h2><h3 id="兼容性"><a href="#兼容性" class="headerlink" title="兼容性"></a>兼容性</h3><p>Prometheus-Operator不再像kube-Prometheus需要关注版本信息</p><p>由于使用了 apiextensions.k8s.io&#x2F;v1 CustomResourceDefinitions，prometheus-operator 需要 Kubernetes &gt;&#x3D; v1.16.0。</p><h3 id="部署Prometheus-Operator"><a href="#部署Prometheus-Operator" class="headerlink" title="部署Prometheus-Operator"></a>部署Prometheus-Operator</h3><p>官方文档：<a href="https://prometheus-operator.dev/docs/getting-started/installation">https://prometheus-operator.dev/docs/getting-started/installation</a></p><p>获取最新版</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LATEST=$(curl -s https://api.github.com/repos/prometheus-operator/prometheus-operator/releases/latest | jq -cr .tag_name)</span><br></pre></td></tr></table></figure><p>下载</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl -sL https://github.com/prometheus-operator/prometheus-operator/releases/download/$&#123;LATEST&#125;/bundle.yaml </span><br><span class="line"># 这将下载一个bundle.yaml</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 创建命名空间</span><br><span class="line">kubectl create ns monitoring</span><br><span class="line"></span><br><span class="line"># 修改命名空间</span><br><span class="line">sed -i &#x27;s/namespace: default/namespace: monitoring/g&#x27; bundle.yaml</span><br><span class="line"># 查看 grep -r &#x27;namespace: monitoring&#x27; bundle.yaml</span><br><span class="line"></span><br><span class="line"># 安装operator</span><br><span class="line">kubectl create -f bundle.yaml </span><br></pre></td></tr></table></figure><h2 id="部署Prometheus"><a href="#部署Prometheus" class="headerlink" title="部署Prometheus"></a>部署Prometheus</h2><p><code>rbac.yaml</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: monitoring</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: [&quot;&quot;]</span><br><span class="line">  resources:</span><br><span class="line">  - nodes</span><br><span class="line">  - nodes/metrics</span><br><span class="line">  - services</span><br><span class="line">  - endpoints</span><br><span class="line">  - pods</span><br><span class="line">  verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;]</span><br><span class="line">- apiGroups: [&quot;&quot;]</span><br><span class="line">  resources:</span><br><span class="line">  - configmaps</span><br><span class="line">  verbs: [&quot;get&quot;]</span><br><span class="line">- apiGroups:</span><br><span class="line">  - discovery.k8s.io</span><br><span class="line">  resources:</span><br><span class="line">  - endpointslices</span><br><span class="line">  verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;]</span><br><span class="line">- apiGroups:</span><br><span class="line">  - networking.k8s.io</span><br><span class="line">  resources:</span><br><span class="line">  - ingresses</span><br><span class="line">  verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;]</span><br><span class="line">- nonResourceURLs: [&quot;/metrics&quot;]</span><br><span class="line">  verbs: [&quot;get&quot;]</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: prometheus</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: monitoring</span><br></pre></td></tr></table></figure><p><code>prometheus.yaml</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: monitoring.coreos.com/v1</span><br><span class="line">kind: Prometheus</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3  # Prometheus 实例副本数，设置为 3 表示高可用部署</span><br><span class="line">  image: quay.io/prometheus/prometheus:v3.4.2  # 使用的 Prometheus 镜像版本</span><br><span class="line">  version: v3.4.2  # 指定 Prometheus 版本，供 Operator 使用</span><br><span class="line">  serviceAccountName: prometheus  # 指定使用的 ServiceAccount 名称</span><br><span class="line">  ruleSelector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      role: alert-rules  # 选择带有 role=alert-rules 标签的 PrometheusRule 资源</span><br><span class="line">  scrapeInterval: 5s  # 抓取指标的时间间隔</span><br><span class="line">  alerting:</span><br><span class="line">    alertmanagers:</span><br><span class="line">    - apiVersion: v2</span><br><span class="line">      name: alertmanager  # 关联的 Alertmanager 名称</span><br><span class="line">      namespace: monitoring  # Alertmanager 所在命名空间</span><br><span class="line">      port: web  # 使用的端口名称，与service的ports下name对应</span><br><span class="line">  enableFeatures: []  # 启用的 Prometheus 特性列表，默认不启用额外特性</span><br><span class="line">  externalLabels: &#123;&#125;  # 添加在每条时间序列上的外部标签</span><br><span class="line">  nodeSelector:</span><br><span class="line">    kubernetes.io/os: linux  # 指定调度到运行 Linux 系统的节点</span><br><span class="line">  podMonitorNamespaceSelector: &#123;&#125;  # 选择哪些命名空间下的 PodMonitor 生效（空表示所有）</span><br><span class="line">  podMonitorSelector: &#123;&#125;  # 选择哪些 PodMonitor 生效（空表示所有）</span><br><span class="line">  probeNamespaceSelector: &#123;&#125;  # 选择哪些命名空间下的 Probe 生效（空表示所有）</span><br><span class="line">  probeSelector: &#123;&#125;  # 选择哪些 Probe 生效（空表示所有）</span><br><span class="line">  ruleNamespaceSelector: &#123;&#125;  # 选择哪些命名空间下的 PrometheusRule 生效（空表示所有）</span><br><span class="line">  ruleSelector: &#123;&#125;  # 选择哪些 PrometheusRule 生效（空表示所有）</span><br><span class="line">  scrapeConfigNamespaceSelector: &#123;&#125;  # 选择哪些命名空间下的 ScrapeConfig 生效（空表示所有）</span><br><span class="line">  scrapeConfigSelector: &#123;&#125;  # 选择哪些 ScrapeConfig 生效（空表示所有）</span><br><span class="line">  securityContext:</span><br><span class="line">    fsGroup: 2000  # 设置 Pod 的文件系统组 ID</span><br><span class="line">    runAsNonRoot: true  # 禁止以 root 用户运行</span><br><span class="line">    runAsUser: 1000  # 指定运行用户 ID</span><br><span class="line">  serviceMonitorNamespaceSelector: &#123;&#125;  # 选择哪些命名空间下的 ServiceMonitor 生效（空表示所有）</span><br><span class="line">  serviceMonitorSelector: &#123;&#125;  # 选择哪些 ServiceMonitor 生效（空表示所有）</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      memory: &quot;400Mi&quot;  # 请求的内存资源</span><br><span class="line">      cpu: &quot;500m&quot;      # 请求的 CPU 资源（500m = 0.5 核）</span><br><span class="line">  storage:</span><br><span class="line">    volumeClaimTemplate:</span><br><span class="line">      spec:</span><br><span class="line">        storageClassName: &quot;nfs-storage&quot;  # 使用的 StorageClass 名称</span><br><span class="line">        accessModes: [ &quot;ReadWriteOnce&quot; ]  # 访问模式，ReadWriteOnce 表示单节点读写</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            storage: 5Gi  # 请求的存储大小</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: prometheus</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - name: web</span><br><span class="line">    nodePort: 30900</span><br><span class="line">    port: 9090</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: web</span><br><span class="line">  - name: reloader-web</span><br><span class="line">    port: 8080</span><br><span class="line">    targetPort: reloader-web</span><br><span class="line">  selector:</span><br><span class="line">    prometheus: prometheus</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"># Prometheus自身指标</span><br><span class="line">apiVersion: monitoring.coreos.com/v1</span><br><span class="line">kind: ServiceMonitor</span><br><span class="line">metadata:</span><br><span class="line">  name: prometheus</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  endpoints:</span><br><span class="line">  - interval: 30s</span><br><span class="line">    port: web</span><br><span class="line">  - interval: 30s</span><br><span class="line">    port: reloader-web</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: prometheus</span><br></pre></td></tr></table></figure><h2 id="部署AlertManager"><a href="#部署AlertManager" class="headerlink" title="部署AlertManager"></a>部署AlertManager</h2><p><code>alertmanager.yaml</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: monitoring.coreos.com/v1</span><br><span class="line">kind: Alertmanager</span><br><span class="line">metadata:</span><br><span class="line">  name: alertmanager</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  version: 0.28.1</span><br><span class="line">  image: quay.io/prometheus/alertmanager:v0.28.1</span><br><span class="line">  nodeSelector:</span><br><span class="line">    kubernetes.io/os: linux</span><br><span class="line">  podMetadata:</span><br><span class="line">    labels:</span><br><span class="line">      app: alertmanager</span><br><span class="line">  resources:</span><br><span class="line">    limits:</span><br><span class="line">      cpu: 100m</span><br><span class="line">      memory: 100Mi</span><br><span class="line">    requests:</span><br><span class="line">      cpu: 4m</span><br><span class="line">      memory: 100Mi</span><br><span class="line">  #alertmanagerConfiguration: # alertmanager全局配置</span><br><span class="line">  #  name: alertroute</span><br><span class="line">  alertmanagerConfigSelector: # alertmanager配置</span><br><span class="line">    matchLabels:</span><br><span class="line">      alert: alert-config</span><br><span class="line">  secrets: []</span><br><span class="line">  securityContext:</span><br><span class="line">    fsGroup: 2000</span><br><span class="line">    runAsNonRoot: true</span><br><span class="line">    runAsUser: 1000</span><br><span class="line">  storage:</span><br><span class="line">    volumeClaimTemplate:</span><br><span class="line">      spec:</span><br><span class="line">        storageClassName: nfs-storage</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            storage: 5Gi</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: alertmanager</span><br><span class="line">  name: alertmanager</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - name: web</span><br><span class="line">    port: 9093</span><br><span class="line">    targetPort: web</span><br><span class="line">    nodePort: 30903</span><br><span class="line">  - name: reloader-web</span><br><span class="line">    port: 8080</span><br><span class="line">    targetPort: reloader-web</span><br><span class="line">    nodePort: 30980</span><br><span class="line">  selector:</span><br><span class="line">    app: alertmanager</span><br><span class="line">  sessionAffinity: ClientIP</span><br><span class="line">  type: NodePort</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"># alertmanager暴露指标给alertmanager</span><br><span class="line">apiVersion: monitoring.coreos.com/v1</span><br><span class="line">kind: ServiceMonitor</span><br><span class="line">metadata:</span><br><span class="line">  name: alertmanager</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  endpoints:</span><br><span class="line">  - interval: 30s</span><br><span class="line">    port: web</span><br><span class="line">  - interval: 30s</span><br><span class="line">    port: reloader-web</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: alertmanager</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"># alertmanager配置</span><br><span class="line">apiVersion: monitoring.coreos.com/v1alpha1</span><br><span class="line">kind: AlertmanagerConfig</span><br><span class="line">metadata:</span><br><span class="line">  name: config-example</span><br><span class="line">  namespace: monitoring</span><br><span class="line">  labels:</span><br><span class="line">    alert: alert-config</span><br><span class="line">spec:</span><br><span class="line">  route:</span><br><span class="line">    groupBy: [&#x27;job&#x27;]</span><br><span class="line">    groupWait: 30s</span><br><span class="line">    groupInterval: 5m</span><br><span class="line">    repeatInterval: 12h</span><br><span class="line">    receiver: &#x27;webhook&#x27;</span><br><span class="line">  receivers:</span><br><span class="line">  - name: &#x27;webhook&#x27;</span><br><span class="line">    webhookConfigs:</span><br><span class="line">    - url: &#x27;http://example.com/&#x27;</span><br></pre></td></tr></table></figure><p>查看pod</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod -n monitoring</span><br><span class="line"></span><br><span class="line">NAME                                   READY   STATUS    RESTARTS   AGE</span><br><span class="line">alertmanager-alertmanager-0            2/2     Running   0          3m6s</span><br><span class="line">prometheus-operator-7587858ff6-pcncq   1/1     Running   0          31m</span><br><span class="line">prometheus-prometheus-0                2/2     Running   0          27m</span><br><span class="line">prometheus-prometheus-1                2/2     Running   0          27m</span><br><span class="line">prometheus-prometheus-2                2/2     Running   0          27m</span><br></pre></td></tr></table></figure><p>访问<a href="http://nodeip:30900/targets">http://nodeip:30900/targets</a></p><p>验证服务可以访问，并且已经通过<code>serviceMonitor</code>获取到alertmanager指标（下一篇详解）</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;Prometheus社区提供了在k8s部署的三种方式：&quot;&gt;&lt;a href=&quot;#Prometheus社区提供了在k8s部署的三种方式：&quot; class=&quot;headerlink&quot; title=&quot;Prometheus社区提供了在k8s部署的三种方式：&quot;&gt;&lt;/a&gt;Prome</summary>
      
    
    
    
    <category term="云原生" scheme="https://sreok.cn/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/"/>
    
    
    <category term="Kubernetes" scheme="https://sreok.cn/tags/Kubernetes/"/>
    
    <category term="AlertManager" scheme="https://sreok.cn/tags/AlertManager/"/>
    
    <category term="Prometheus" scheme="https://sreok.cn/tags/Prometheus/"/>
    
  </entry>
  
  <entry>
    <title>【云原生】云原生监控方案（三）：使用serviceMonitor监控微服务</title>
    <link href="https://sreok.cn/2025/09/13/%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91%E4%BA%91%E5%8E%9F%E7%94%9F%E7%9B%91%E6%8E%A7%E6%96%B9%E6%A1%88%EF%BC%88%E4%B8%89%EF%BC%89%EF%BC%9A%E4%BD%BF%E7%94%A8serviceMonitor%E7%9B%91%E6%8E%A7%E5%BE%AE%E6%9C%8D%E5%8A%A1/"/>
    <id>https://sreok.cn/2025/09/13/%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91%E4%BA%91%E5%8E%9F%E7%94%9F%E7%9B%91%E6%8E%A7%E6%96%B9%E6%A1%88%EF%BC%88%E4%B8%89%EF%BC%89%EF%BC%9A%E4%BD%BF%E7%94%A8serviceMonitor%E7%9B%91%E6%8E%A7%E5%BE%AE%E6%9C%8D%E5%8A%A1/</id>
    <published>2025-09-13T12:28:39.319Z</published>
    <updated>2025-09-13T12:28:39.319Z</updated>
    
    <content type="html"><![CDATA[<h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>上一篇基于Prometheus-Operator部署了Prometheus、AlertManager：<a href="./%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91%E4%BA%91%E5%8E%9F%E7%94%9F%E7%9B%91%E6%8E%A7%E6%96%B9%E6%A1%88%EF%BC%88%E4%BA%8C%EF%BC%89%EF%BC%9A%E5%9F%BA%E4%BA%8EPrometheus-Operator%E9%83%A8%E7%BD%B2Prometheus%E3%80%81AlertManager.md">原文地址</a></p><h3 id="部署微服务"><a href="#部署微服务" class="headerlink" title="部署微服务"></a>部署微服务</h3><p>采用Prometheus官方提供的基于golang编写的微服务示例</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: example-app</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: example-app</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: example-app</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: example-app</span><br><span class="line">        image: quay.io/brancz/prometheus-example-app:v0.5.0</span><br><span class="line">        ports:</span><br><span class="line">        - name: web</span><br><span class="line">          containerPort: 8080</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">kind: Service</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">  name: example-app</span><br><span class="line">  labels:</span><br><span class="line">    app: example-app</span><br><span class="line">    jobname: app # servicemonitor 使用</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: example-app</span><br><span class="line">  ports:</span><br><span class="line">  - name: web</span><br><span class="line">    port: 8080</span><br><span class="line">    nodePort: 30080 # 外部端口</span><br><span class="line">  type: NodePort  # 演示用，实际微服务为ClusterIP</span><br></pre></td></tr></table></figure><p>访问：<a href="http://nodeip:30080/metrics">http://nodeip:30080/metrics</a></p><p>可以看到已经将微服务本身的监控信息暴露出去</p><h3 id="部署ServiceMonitor"><a href="#部署ServiceMonitor" class="headerlink" title="部署ServiceMonitor"></a>部署ServiceMonitor</h3><p>告诉Prometheus基于service获取</p><p>官方api参考：<a href="https://prometheus-operator.dev/docs/api-reference/api/#monitoring.coreos.com/v1.ServiceMonitor">https://prometheus-operator.dev/docs/api-reference/api/#monitoring.coreos.com/v1.ServiceMonitor</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: monitoring.coreos.com/v1</span><br><span class="line">kind: ServiceMonitor</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: example-app  # ServiceMonitor 的标签，用于标识和选择</span><br><span class="line">  name: example-app   # ServiceMonitor 的名称</span><br><span class="line">spec:</span><br><span class="line">  endpoints:</span><br><span class="line">  - port: web       # 抓取指标的端口名称（对应 Service 中定义的端口名称）</span><br><span class="line">    interval: 15s   # 抓取指标的间隔时间</span><br><span class="line">    path: /metrics  # 指定自定义路径</span><br><span class="line">    scheme: http    # 使用 HTTP 协议抓取指标</span><br><span class="line">    tlsConfig:</span><br><span class="line">      insecureSkipVerify: true # 跳过 TLS 证书验证（用于自签名证书场景）</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: example-app</span><br><span class="line">  jobLabel: jobname  # 用于 Prometheus 中 job 标签的值，取自 Service 的该标签，不指定时，默认使用service名称</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: example-app  # 选择带有 app=example-app 标签的 Service</span><br></pre></td></tr></table></figure><p>访问：<a href="http://nodeip:30900/targets">http://nodeip:30900/targets</a></p><p>查看servicemonitor已经将指标获取到,并且job名称为service标签中设置的名称</p><p><img src="/../images/Prometheus-targer-servicemonitor-example-app.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;介绍&quot;&gt;&lt;a href=&quot;#介绍&quot; class=&quot;headerlink&quot; title=&quot;介绍&quot;&gt;&lt;/a&gt;介绍&lt;/h3&gt;&lt;p&gt;上一篇基于Prometheus-Operator部署了Prometheus、AlertManager：&lt;a href=&quot;./%E3%80%9</summary>
      
    
    
    
    <category term="云原生" scheme="https://sreok.cn/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/"/>
    
    
    <category term="Kubernetes" scheme="https://sreok.cn/tags/Kubernetes/"/>
    
    <category term="Prometheus" scheme="https://sreok.cn/tags/Prometheus/"/>
    
  </entry>
  
  <entry>
    <title>【云原生】云原生监控方案（七）：AlertManagerConfig集成邮箱告警</title>
    <link href="https://sreok.cn/2025/09/13/%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91%E4%BA%91%E5%8E%9F%E7%94%9F%E7%9B%91%E6%8E%A7%E6%96%B9%E6%A1%88%EF%BC%88%E4%B8%83%EF%BC%89%EF%BC%9AAlertManagerConfig%E9%9B%86%E6%88%90%E9%82%AE%E7%AE%B1%E5%91%8A%E8%AD%A6/"/>
    <id>https://sreok.cn/2025/09/13/%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91%E4%BA%91%E5%8E%9F%E7%94%9F%E7%9B%91%E6%8E%A7%E6%96%B9%E6%A1%88%EF%BC%88%E4%B8%83%EF%BC%89%EF%BC%9AAlertManagerConfig%E9%9B%86%E6%88%90%E9%82%AE%E7%AE%B1%E5%91%8A%E8%AD%A6/</id>
    <published>2025-09-13T12:28:39.249Z</published>
    <updated>2025-09-13T12:28:39.250Z</updated>
    
    <content type="html"><![CDATA[<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>在第二篇中（<a href="./%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91%E4%BA%91%E5%8E%9F%E7%94%9F%E7%9B%91%E6%8E%A7%E6%96%B9%E6%A1%88%EF%BC%88%E4%BA%8C%EF%BC%89%EF%BC%9A%E5%9F%BA%E4%BA%8EPrometheus-Operator%E9%83%A8%E7%BD%B2Prometheus%E3%80%81AlertManager.md">原文链接</a>）介绍了alert manager的安装，这篇文章是基于这个内容的扩展</p><h3 id="AlertManager-Config"><a href="#AlertManager-Config" class="headerlink" title="AlertManager Config"></a>AlertManager Config</h3><p>使用Alertmanager CRD 创建AlertManager时，有两种加载配置文件方式</p><p>官方文档：<a href="https://prometheus-operator.dev/docs/developer/alerting/">https://prometheus-operator.dev/docs/developer/alerting/</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">alertmanagerConfiguration:</span><br><span class="line">  name: alert-global</span><br><span class="line">alertmanagerConfigSelector:</span><br><span class="line">  matchLabels:</span><br><span class="line">    alert: alert-config</span><br></pre></td></tr></table></figure><p><code>alertmanagerConfiguration</code>：全局配置</p><p><code>alertmanagerConfigSelector</code>：基于命名空间的配置</p><p>非全局会添加基于命名空间的条件，告警规则必须存在这个lable，以下两者生成alertmanager配置的区别</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">route:</span><br><span class="line">&lt;&lt;&lt;&lt;&lt;&lt;&lt; 基于命名空间的配置</span><br><span class="line">  receiver: &quot;null&quot;</span><br><span class="line">  continue: false</span><br><span class="line">  routes:</span><br><span class="line">  - receiver: monitoring/config-example/email</span><br><span class="line">    group_by:</span><br><span class="line">    - alertname</span><br><span class="line">    matchers:</span><br><span class="line">    - namespace=&quot;monitoring&quot;</span><br><span class="line">    continue: true</span><br><span class="line">    group_wait: 10s</span><br><span class="line">    group_interval: 5m</span><br><span class="line">    repeat_interval: 12h</span><br><span class="line">&gt;&gt;&gt;&gt;&gt;&gt;&gt; 全局配置</span><br><span class="line">  receiver: monitoring/alert-global/email</span><br><span class="line">  group_by:</span><br><span class="line">  - alertname</span><br><span class="line">  continue: false</span><br><span class="line">  group_wait: 10s</span><br><span class="line">  group_interval: 1m</span><br><span class="line">  repeat_interval: 1m</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">inhibit_rules:</span><br><span class="line">&lt;&lt;&lt;&lt;&lt;&lt;&lt; 基于命名空间的配置</span><br><span class="line">- source_matchers:</span><br><span class="line">  - namespace=&quot;monitoring&quot;</span><br><span class="line">  - severity=&quot;critical&quot;</span><br><span class="line">  target_matchers:</span><br><span class="line">  - namespace=&quot;monitoring&quot;</span><br><span class="line">  - severity=&quot;warning&quot;</span><br><span class="line">  equal:</span><br><span class="line">  - instance</span><br><span class="line">&gt;&gt;&gt;&gt;&gt;&gt;&gt; 全局配置</span><br><span class="line">- source_matchers:</span><br><span class="line">  - severity=&quot;critical&quot;</span><br><span class="line">  target_matchers:</span><br><span class="line">  - severity=&quot;warning&quot;</span><br><span class="line">  equal:</span><br><span class="line">  - instance</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="邮件告警"><a href="#邮件告警" class="headerlink" title="邮件告警"></a>邮件告警</h2><ol><li><p>创建发件邮箱</p><p>略</p></li><li><p>测试邮箱发件（阿里邮箱）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl --url &#x27;smtps://smtp.vsoul.cn&#x27; \</span><br><span class="line">     --mail-from &#x27;notify@vsoul.cn&#x27; \</span><br><span class="line">     --mail-rcpt &#x27;lihaoxuan@vsoul.cn&#x27; \</span><br><span class="line">     --user &#x27;notify@vsoul.cn:YOUR_PASSWORD&#x27; \</span><br><span class="line">     --ssl-reqd --insecure \</span><br><span class="line">     -T &lt;(printf &#x27;From: VSoul 通知 &lt;notify@vsoul.cn&gt;\nTo: lihaoxuan@vsoul.cn\nSubject: 测试邮件发送&#x27;)</span><br></pre></td></tr></table></figure></li></ol><h3 id="创建AlertManagerConfig"><a href="#创建AlertManagerConfig" class="headerlink" title="创建AlertManagerConfig"></a>创建AlertManagerConfig</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: monitoring.coreos.com/v1alpha1</span><br><span class="line">kind: AlertmanagerConfig</span><br><span class="line">metadata:</span><br><span class="line">  name: email</span><br><span class="line">  namespace: monitoring</span><br><span class="line">  labels:     # 创建Prometheus时指定alertmanager labels</span><br><span class="line">    alert: alert-config</span><br><span class="line">spec:</span><br><span class="line">  # 路由</span><br><span class="line">  # 官方API：https://prometheus-operator.dev/docs/api-reference/api/#monitoring.coreos.com/v1alpha1.Route</span><br><span class="line">  route:</span><br><span class="line">    groupBy: [&#x27;alertname&#x27;]  # 告警分组依据，通常按alertname分组，相同名称的告警会被合并</span><br><span class="line">    groupWait: 10s         # 初始等待时间，同一组的告警首次触发后等待10秒再发送（用于收集同组其他告警）</span><br><span class="line">    groupInterval: 5m      # 同一组告警的间隔时间（当有新告警触发时，距离上次发送至少5分钟才会再通知）</span><br><span class="line">    repeatInterval: 12h    # 重复告警的发送间隔（相同告警未解决时，每隔12小时重复通知一次）</span><br><span class="line">    receiver: &#x27;email&#x27;      # 默认接收器名称（需与receivers中的name对应）</span><br><span class="line">  # 接收器</span><br><span class="line">  # 官方API：https://prometheus-operator.dev/docs/api-reference/api/#monitoring.coreos.com/v1alpha1.Receiver</span><br><span class="line">  receivers:</span><br><span class="line">  - name: &#x27;email&#x27;</span><br><span class="line">    # 邮箱配置</span><br><span class="line">    emailConfigs:</span><br><span class="line">    - to: &#x27;lihaoxuan@vsoul.cn&#x27;</span><br><span class="line">      from: &#x27;notify@vsoul.cn&#x27;</span><br><span class="line">      smarthost: &#x27;smtp.qiye.aliyun.com:465&#x27;</span><br><span class="line">      authUsername: &#x27;notify@vsoul.cn&#x27;</span><br><span class="line">      authPassword:</span><br><span class="line">        name: smtp-secret</span><br><span class="line">        key: password</span><br><span class="line">      requireTLS: false</span><br><span class="line">      sendResolved: true</span><br><span class="line">      tlsConfig:</span><br><span class="line">        insecureSkipVerify: false</span><br><span class="line">  # 抑制规则</span><br><span class="line">  # 官方API：https://prometheus-operator.dev/docs/api-reference/api/#monitoring.coreos.com/v1alpha1.InhibitRule</span><br><span class="line">  inhibitRules:</span><br><span class="line">  - sourceMatch:</span><br><span class="line">    - name: severity</span><br><span class="line">      value: critical</span><br><span class="line">    targetMatch:</span><br><span class="line">    - name: severity</span><br><span class="line">      value: warning</span><br><span class="line">    equal:</span><br><span class="line">    - instance</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Secret</span><br><span class="line">metadata:</span><br><span class="line">  name: smtp-secret</span><br><span class="line">  namespace: monitoring</span><br><span class="line">type: Opaque</span><br><span class="line">stringData:</span><br><span class="line">  password: YOUR_PASSWORD</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="创建告警规则"><a href="#创建告警规则" class="headerlink" title="创建告警规则"></a>创建告警规则</h3><p>测试规则</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: monitoring.coreos.com/v1</span><br><span class="line">kind: PrometheusRule</span><br><span class="line">metadata:</span><br><span class="line">  name: test-email-alert</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  groups:</span><br><span class="line">  - name: test-email</span><br><span class="line">    rules:</span><br><span class="line">    - alert: TestEmailAlert</span><br><span class="line">      expr: vector(1) # 永远为真</span><br><span class="line">      for: 0m</span><br><span class="line">      labels:</span><br><span class="line">        # 如果时基于命名空间的配置需要加上namespace label，因为测试PromQL的条件永远为真，没有指标，所以获取不到namespace的label</span><br><span class="line">        namespace: monitor </span><br><span class="line">        severity: critical</span><br><span class="line">      annotations:</span><br><span class="line">        summary: &quot;测试邮件告警&quot;</span><br><span class="line">        description: &quot;这是一条来自 PrometheusRule 的测试告警&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>收到告警即为成功</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;介绍&quot;&gt;&lt;a href=&quot;#介绍&quot; class=&quot;headerlink&quot; title=&quot;介绍&quot;&gt;&lt;/a&gt;介绍&lt;/h2&gt;&lt;p&gt;在第二篇中（&lt;a href=&quot;./%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91%E4%BA%9</summary>
      
    
    
    
    <category term="云原生" scheme="https://sreok.cn/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/"/>
    
    
    <category term="Kubernetes" scheme="https://sreok.cn/tags/Kubernetes/"/>
    
    <category term="AlertManager" scheme="https://sreok.cn/tags/AlertManager/"/>
    
  </entry>
  
  <entry>
    <title>【云原生】云原生监控方案（一）：基于kube-Prometheus部署Prometheus集成监控</title>
    <link href="https://sreok.cn/2025/09/13/%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91%E4%BA%91%E5%8E%9F%E7%94%9F%E7%9B%91%E6%8E%A7%E6%96%B9%E6%A1%88%EF%BC%88%E4%B8%80%EF%BC%89%EF%BC%9A%E5%9F%BA%E4%BA%8Ekube-Prometheus%E9%83%A8%E7%BD%B2Prometheus%E9%9B%86%E6%88%90%E7%9B%91%E6%8E%A7/"/>
    <id>https://sreok.cn/2025/09/13/%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91%E4%BA%91%E5%8E%9F%E7%94%9F%E7%9B%91%E6%8E%A7%E6%96%B9%E6%A1%88%EF%BC%88%E4%B8%80%EF%BC%89%EF%BC%9A%E5%9F%BA%E4%BA%8Ekube-Prometheus%E9%83%A8%E7%BD%B2Prometheus%E9%9B%86%E6%88%90%E7%9B%91%E6%8E%A7/</id>
    <published>2025-09-13T12:28:39.175Z</published>
    <updated>2025-09-13T12:28:39.176Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Prometheus社区提供了在k8s部署的三种方式："><a href="#Prometheus社区提供了在k8s部署的三种方式：" class="headerlink" title="Prometheus社区提供了在k8s部署的三种方式："></a>Prometheus社区提供了在k8s部署的三种方式：</h2><ol><li>部署Prometheus-Operator，自定义部署</li><li>通过kube-Prometheus部署通用监控环境（yaml方式，本文）</li><li>通过kube-prometheus-stack部署（helm方式，简化第二种方式）</li></ol><p>后两者都是基于第一种Prometheus-Operator的扩展版，内置了监控规则和模板</p><p>本文先使用第二种方式快速部署</p><h2 id="开始部署"><a href="#开始部署" class="headerlink" title="开始部署"></a>开始部署</h2><h3 id="版本信息"><a href="#版本信息" class="headerlink" title="版本信息"></a>版本信息</h3><table><thead><tr><th>kube-prometheus stack</th><th>Kubernetes 1.27</th><th>Kubernetes 1.28</th><th>Kubernetes 1.29</th><th>Kubernetes 1.30</th><th>Kubernetes 1.31</th><th>Kubernetes 1.32</th><th>Kubernetes 1.33</th></tr></thead><tbody><tr><td><a href="https://github.com/prometheus-operator/kube-prometheus/tree/release-0.13"><code>release-0.13</code></a></td><td>✔</td><td>✔</td><td>x</td><td>x</td><td>x</td><td>x</td><td>x</td></tr><tr><td><a href="https://github.com/prometheus-operator/kube-prometheus/tree/release-0.14"><code>release-0.14</code></a></td><td>x</td><td>x</td><td>✔</td><td>✔</td><td>✔</td><td>x</td><td>x</td></tr><tr><td><a href="https://github.com/prometheus-operator/kube-prometheus/tree/release-0.15"><code>release-0.15</code></a></td><td>x</td><td>x</td><td>x</td><td>x</td><td>✔</td><td>✔</td><td>✔</td></tr><tr><td><a href="https://github.com/prometheus-operator/kube-prometheus/tree/main"><code>main</code></a></td><td>x</td><td>x</td><td>x</td><td>x</td><td>✔</td><td>✔</td><td>✔</td></tr></tbody></table><h3 id="拉取代码"><a href="#拉取代码" class="headerlink" title="拉取代码"></a>拉取代码</h3><p>手动下载：<a href="https://github.com/prometheus-operator/kube-prometheus/releases">下载地址</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone https://github.com/prometheus-operator/kube-prometheus.git -b release-0.14</span><br><span class="line">cd kube-prometheus/</span><br></pre></td></tr></table></figure><h3 id="部署kube-Prometheus"><a href="#部署kube-Prometheus" class="headerlink" title="部署kube-Prometheus"></a>部署kube-Prometheus</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply --server-side -f manifests/setup</span><br><span class="line"># 如果是1.22以前的版本，使用kubectl create -f manifests/setup</span><br></pre></td></tr></table></figure><h4 id="部署Prometheus、alertmanager、grafana、kube-state-metrics、Prometheus-adapter、blackbox-exporter、node-exporter"><a href="#部署Prometheus、alertmanager、grafana、kube-state-metrics、Prometheus-adapter、blackbox-exporter、node-exporter" class="headerlink" title="部署Prometheus、alertmanager、grafana、kube-state-metrics、Prometheus-adapter、blackbox-exporter、node-exporter"></a>部署Prometheus、alertmanager、grafana、kube-state-metrics、Prometheus-adapter、blackbox-exporter、node-exporter</h4><p>这是kube-Prometheus基于Prometheus-operator为通用k8s环境提供的一整套监控方案</p><p>这整套方案都配置了PrometheusRule告警规则</p><p>并且kube-Prometheus为grafana内置了多个dashboard</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f manifests/</span><br></pre></td></tr></table></figure><hr><h3 id="镜像问题"><a href="#镜像问题" class="headerlink" title="镜像问题"></a>镜像问题</h3><p>镜像查询：<a href="https://docker.aityp.com/">https://docker.aityp.com/</a></p><h4 id="打tag方式"><a href="#打tag方式" class="headerlink" title="打tag方式"></a>打tag方式</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">crictl pull swr.cn-north-4.myhuaweicloud.com/ddn-k8s/registry.k8s.io/kube-state-metrics/kube-state-metrics:v2.13.0</span><br><span class="line">crictl pull swr.cn-north-4.myhuaweicloud.com/ddn-k8s/registry.k8s.io/prometheus-adapter/prometheus-adapter:v0.12.0</span><br><span class="line"></span><br><span class="line"># 打tag</span><br><span class="line">ctr -n k8s.io i tag swr.cn-north-4.myhuaweicloud.com/ddn-k8s/registry.k8s.io/kube-state-metrics/kube-state-metrics:v2.13.0 registry.k8s.io/kube-state-metrics/kube-state-metrics:v2.13.0</span><br><span class="line">ctr -n k8s.io i tag swr.cn-north-4.myhuaweicloud.com/ddn-k8s/registry.k8s.io/prometheus-adapter/prometheus-adapter:v0.12.0 registry.k8s.io/prometheus-adapter/prometheus-adapter:v0.12.0</span><br></pre></td></tr></table></figure><h4 id="yaml修改镜像地址"><a href="#yaml修改镜像地址" class="headerlink" title="yaml修改镜像地址"></a>yaml修改镜像地址</h4><p>进<code>kube-prometheus/manifests</code>对应的yaml文件中修改即可</p><hr><h3 id="外部访问"><a href="#外部访问" class="headerlink" title="外部访问"></a>外部访问</h3><p>这套方案应用了networkPolicy，取消即可</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f prometheus-networkPolicy.yaml -f grafana-networkPolicy.yaml -f alertmanager-networkPolicy.yaml</span><br></pre></td></tr></table></figure><p>修改service</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit svc -n monitoring prometheus-k8s</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">type: ClusterIP</span><br><span class="line"># 改为</span><br><span class="line">type: NodePort</span><br></pre></td></tr></table></figure><hr><h3 id="持久化存储"><a href="#持久化存储" class="headerlink" title="持久化存储"></a>持久化存储</h3><h4 id="Prometheus"><a href="#Prometheus" class="headerlink" title="Prometheus"></a>Prometheus</h4><p>修改<code>kube-prometheus/manifests/prometheus-prometheus.yaml</code>文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">storage:</span><br><span class="line">  volumeClaimTemplate:</span><br><span class="line">    spec:</span><br><span class="line">      storageClassName: nfs-storage # 实际sc名称</span><br><span class="line">      resources:</span><br><span class="line">        requests:</span><br><span class="line">          storage: 50Gi # 可根据需要调整</span><br></pre></td></tr></table></figure><h4 id="Alertmanager"><a href="#Alertmanager" class="headerlink" title="Alertmanager"></a>Alertmanager</h4><p>与Prometheus一样</p><p>修改<code>kube-prometheus/manifests/alertmanager-alertmanager.yaml</code>文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">storage:</span><br><span class="line">  volumeClaimTemplate:</span><br><span class="line">    spec:</span><br><span class="line">      storageClassName: nfs-storage # 实际sc名称</span><br><span class="line">      resources:</span><br><span class="line">        requests:</span><br><span class="line">          storage: 50Gi # 可根据需要调整</span><br></pre></td></tr></table></figure><h4 id="grafana"><a href="#grafana" class="headerlink" title="grafana"></a>grafana</h4><p>修改<code>kube-prometheus/manifests/grafana-deployment.yaml</code>文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">      volumes:</span><br><span class="line">      - emptyDir: &#123;&#125;</span><br><span class="line">        name: grafana-storage</span><br><span class="line"># 改为</span><br><span class="line">      volumes:</span><br><span class="line">      - name: grafana-storage</span><br><span class="line">        persistentVolumeClaim:</span><br><span class="line">          claimName: grafana</span><br></pre></td></tr></table></figure><p>底部新增</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: grafana</span><br><span class="line">  namespace: monitoring</span><br><span class="line">spec:</span><br><span class="line">  storageClassName: nfs-storage # 实际sc名称</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 5Gi  # 可根据需要调整</span><br></pre></td></tr></table></figure><p>应用更改</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f prometheus-prometheus.yaml</span><br><span class="line">kubectl apply -f alertmanager-alertmanager.yaml</span><br><span class="line">kubectl apply -f grafana-deployment.yaml</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h2 id=&quot;Prometheus社区提供了在k8s部署的三种方式：&quot;&gt;&lt;a href=&quot;#Prometheus社区提供了在k8s部署的三种方式：&quot; class=&quot;headerlink&quot; title=&quot;Prometheus社区提供了在k8s部署的三种方式：&quot;&gt;&lt;/a&gt;Prome</summary>
      
    
    
    
    <category term="云原生" scheme="https://sreok.cn/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/"/>
    
    
    <category term="Kubernetes" scheme="https://sreok.cn/tags/Kubernetes/"/>
    
    <category term="Prometheus" scheme="https://sreok.cn/tags/Prometheus/"/>
    
  </entry>
  
  <entry>
    <title>【笔记】基于github Page创建hexo个人博客</title>
    <link href="https://sreok.cn/2025/05/27/%E3%80%90%E7%AC%94%E8%AE%B0%E3%80%91%E5%9F%BA%E4%BA%8Egithub%20page%E5%88%9B%E5%BB%BAhexo%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/"/>
    <id>https://sreok.cn/2025/05/27/%E3%80%90%E7%AC%94%E8%AE%B0%E3%80%91%E5%9F%BA%E4%BA%8Egithub%20page%E5%88%9B%E5%BB%BAhexo%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2/</id>
    <published>2025-05-27T09:06:03.000Z</published>
    <updated>2025-09-13T12:28:42.029Z</updated>
    
    <content type="html"><![CDATA[<h3 id="安装环境"><a href="#安装环境" class="headerlink" title="安装环境"></a>安装环境</h3><ul><li>Node.js：<a href="https://nodejs.org/zh-cn">https://nodejs.org/zh-cn</a></li><li>Git：<a href="https://git-scm.com/downloads">https://git-scm.com/downloads</a></li></ul><h3 id="链接Github"><a href="#链接Github" class="headerlink" title="链接Github"></a>链接Github</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git config --global user.name &quot;GitHub 用户名&quot;</span><br><span class="line">git config --global user.email &quot;GitHub 邮箱&quot;</span><br></pre></td></tr></table></figure><h3 id="创建SSH密钥"><a href="#创建SSH密钥" class="headerlink" title="创建SSH密钥"></a>创建SSH密钥</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -C &quot;GitHub 邮箱&quot;</span><br></pre></td></tr></table></figure><h3 id="添加密匙"><a href="#添加密匙" class="headerlink" title="添加密匙"></a>添加密匙</h3><p>进入 [C:\Users\用户名.ssh] 目录（要勾选显示“隐藏的项目”），用记事本打开公钥 id_rsa.pub 文件并复制里面的内容。</p><p>登陆 GitHub ，进入 Settings 页面，选择左边栏的 SSH and GPG keys，点击 New SSH key。</p><p>Title 随便取个名字，粘贴复制的 id_rsa.pub 内容到 Key 中，点击 Add SSH key 完成添加。</p><h3 id="验证连接"><a href="#验证连接" class="headerlink" title="验证连接"></a>验证连接</h3><p>打开 Git Bash，输入 ssh -T <a href="mailto:&#x67;&#105;&#x74;&#64;&#x67;&#x69;&#x74;&#104;&#117;&#x62;&#x2e;&#99;&#x6f;&#109;">&#x67;&#105;&#x74;&#64;&#x67;&#x69;&#x74;&#104;&#117;&#x62;&#x2e;&#99;&#x6f;&#109;</a> 出现 “Are you sure……”，输入 yes 回车确认。</p><h3 id="创建仓库"><a href="#创建仓库" class="headerlink" title="创建仓库"></a>创建仓库</h3><p>填写仓库名，格式必须为<code>&lt;用户名&gt;.github.io</code>，然后点击<code>Create repository</code>。</p><h3 id="安装-Hexo"><a href="#安装-Hexo" class="headerlink" title="安装 Hexo"></a>安装 Hexo</h3><p>使用 npm 一键安装 Hexo 博客程序</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g hexo-cli</span><br></pre></td></tr></table></figure><p>Mac 用户需要管理员权限（sudo）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo npm install -g hexo-cli</span><br></pre></td></tr></table></figure><h3 id="初始化hexo"><a href="#初始化hexo" class="headerlink" title="初始化hexo"></a>初始化hexo</h3><p>创建blog文件夹<br>进入并输入以下命令完成初始化</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hexo init      # 初始化</span><br><span class="line">npm install    # 安装组件</span><br></pre></td></tr></table></figure><h3 id="启动本地服务器进行预览"><a href="#启动本地服务器进行预览" class="headerlink" title="启动本地服务器进行预览"></a>启动本地服务器进行预览</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hexo g   # 生成页面</span><br><span class="line">hexo s   # 启动预览,访问 http://localhost:4000</span><br></pre></td></tr></table></figure><h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><h4 id="创建新页面"><a href="#创建新页面" class="headerlink" title="创建新页面"></a>创建新页面</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo new [layout] &lt;title&gt;</span><br></pre></td></tr></table></figure><h4 id="写作"><a href="#写作" class="headerlink" title="写作"></a>写作</h4><p><code>source/_posts</code>目录下创建markdown文章</p><p>了解更多：<a href="https://hexo.io/zh-cn/docs/writing">https://hexo.io/zh-cn/docs/writing</a></p><h3 id="修改主题"><a href="#修改主题" class="headerlink" title="修改主题"></a>修改主题</h3><p>本博客主题：<a href="https://github.com/sreok/hexo-theme-Anatole2">hexo-theme-Anatole2</a>，文档在README.md<br>官方主题：<a href="https://hexo.io/themes/">https://hexo.io/themes/</a></p><h3 id="部署-Hexo-到-GitHub-Pages"><a href="#部署-Hexo-到-GitHub-Pages" class="headerlink" title="部署 Hexo 到 GitHub Pages"></a>部署 Hexo 到 GitHub Pages</h3><p>安装 hexo-deployer-git</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install hexo-deployer-git --save</span><br></pre></td></tr></table></figure><p>然后修改 _config.yml 文件末尾的 Deployment 部分，修改成如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">deploy:</span><br><span class="line">  type: &#x27;git&#x27;</span><br><span class="line">  repo: &#x27;https://github.com/用户名/用户名.github.io.git&#x27;</span><br><span class="line">  branch: master</span><br></pre></td></tr></table></figure><p>完成后运行<code>hexo d</code>将网站上传部署到 GitHub Pages。</p><h3 id="常见问题"><a href="#常见问题" class="headerlink" title="常见问题"></a>常见问题</h3><ol><li>npm 下载速度慢<br> 临时更换方法：在 npm 安装命令后面加上： <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--registry https://registry.npm.taobao.org </span><br></pre></td></tr></table></figure></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;安装环境&quot;&gt;&lt;a href=&quot;#安装环境&quot; class=&quot;headerlink&quot; title=&quot;安装环境&quot;&gt;&lt;/a&gt;安装环境&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;Node.js：&lt;a href=&quot;https://nodejs.org/zh-cn&quot;&gt;https://nodej</summary>
      
    
    
    
    <category term="Linux" scheme="https://sreok.cn/categories/Linux/"/>
    
    
    <category term="hexo" scheme="https://sreok.cn/tags/hexo/"/>
    
    <category term="Github Page" scheme="https://sreok.cn/tags/Github-Page/"/>
    
  </entry>
  
  <entry>
    <title>【云原生】基于Percona Operator支持全命名空间创建PXC集群（manifest方式）</title>
    <link href="https://sreok.cn/2025/02/26/%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91%E5%9F%BA%E4%BA%8EPercona%20Operator%E6%94%AF%E6%8C%81%E5%85%A8%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E5%88%9B%E5%BB%BAPXC%E9%9B%86%E7%BE%A4%EF%BC%88manifest%E6%96%B9%E5%BC%8F%EF%BC%89/"/>
    <id>https://sreok.cn/2025/02/26/%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91%E5%9F%BA%E4%BA%8EPercona%20Operator%E6%94%AF%E6%8C%81%E5%85%A8%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4%E5%88%9B%E5%BB%BAPXC%E9%9B%86%E7%BE%A4%EF%BC%88manifest%E6%96%B9%E5%BC%8F%EF%BC%89/</id>
    <published>2025-02-26T09:06:03.000Z</published>
    <updated>2025-09-13T12:28:40.273Z</updated>
    
    <content type="html"><![CDATA[<p>官方文档：<a href="https://docs.percona.com/percona-operator-for-mysql/pxc/kubernetes.html">通用 Kubernetes 安装 - Percona Operator for MySQL — Generic Kubernetes installation - Percona Operator for MySQL</a></p><h3 id="安装Operator"><a href="#安装Operator" class="headerlink" title="安装Operator"></a><strong>安装Operator</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git clone -b v1.14.0 https://github.com/percona/percona-xtradb-cluster-operator</span><br><span class="line">cd percona-xtradb-cluster-operator</span><br></pre></td></tr></table></figure><h4 id="方式一：分步安装"><a href="#方式一：分步安装" class="headerlink" title="方式一：分步安装"></a><strong>方式一：分步安装</strong></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f deploy/crd.yaml</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f deploy/cw-operator.yaml -n kube-system</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sed -i &quot;s/pxc-operator/kube-system/g&quot; deploy/cw-rbac.yaml</span><br><span class="line">sed -i &quot;s/imagePullPolicy: Always/imagePullPolicy: IfNotPresent/g&quot; deploy/cw-operator.yaml</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f deploy/cw-rbac.yaml -n kube-system</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f deploy/secrets.yaml -n kube-system</span><br></pre></td></tr></table></figure><h4 id="方式二：简易安装"><a href="#方式二：简易安装" class="headerlink" title="方式二：简易安装"></a><strong>方式二：简易安装</strong></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sed -i &quot;s/pxc-operator/kube-system/g&quot; deploy/cw-bundle.yaml</span><br><span class="line">sed -i &quot;s/imagePullPolicy: Always/imagePullPolicy: IfNotPresent/g&quot; deploy/cw-bundle.yaml</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f deploy/crd.yaml</span><br><span class="line">kubectl apply -f deploy/cw-bundle.yaml -n kube-system</span><br></pre></td></tr></table></figure><h3 id="安装pxc集群"><a href="#安装pxc集群" class="headerlink" title="安装pxc集群"></a><strong>安装pxc集群</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim deploy/cr.yaml</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: pxc.percona.com/v1</span><br><span class="line">kind: PerconaXtraDBCluster</span><br><span class="line">metadata:</span><br><span class="line">  name: cluster1</span><br><span class="line">  finalizers:</span><br><span class="line">    - delete-pxc-pods-in-order</span><br><span class="line">spec:</span><br><span class="line">  crVersion: 1.14.0</span><br><span class="line">  allowUnsafeConfigurations: false</span><br><span class="line">  updateStrategy: SmartUpdate</span><br><span class="line">  upgradeOptions:</span><br><span class="line">    versionServiceEndpoint: https://check.percona.com</span><br><span class="line">    apply: disabled</span><br><span class="line">    schedule: &quot;0 4 * * *&quot;</span><br><span class="line">  pxc:</span><br><span class="line">    size: 3</span><br><span class="line">    image: percona/percona-xtradb-cluster:8.0.35-27.1</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    autoRecovery: true</span><br><span class="line">    resources:</span><br><span class="line">      requests:</span><br><span class="line">        memory: 1G</span><br><span class="line">        cpu: 600m</span><br><span class="line">    affinity:</span><br><span class="line">      antiAffinityTopologyKey: &quot;kubernetes.io/hostname&quot;</span><br><span class="line">    podDisruptionBudget:</span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">    volumeSpec:</span><br><span class="line">      persistentVolumeClaim:</span><br><span class="line">        storageClassName: nfs-storage # 改为实际storageclass</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            storage: 6G</span><br><span class="line">    gracePeriod: 600</span><br><span class="line">  haproxy:</span><br><span class="line">    enabled: true</span><br><span class="line">    size: 3</span><br><span class="line">    image: percona/percona-xtradb-cluster-operator:1.14.0-haproxy</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    resources:</span><br><span class="line">      requests:</span><br><span class="line">        memory: 1G</span><br><span class="line">        cpu: 600m</span><br><span class="line">    affinity:</span><br><span class="line">      antiAffinityTopologyKey: &quot;kubernetes.io/hostname&quot;</span><br><span class="line">    podDisruptionBudget:</span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">    gracePeriod: 30</span><br><span class="line">  proxysql:</span><br><span class="line">    enabled: false</span><br><span class="line">    size: 3</span><br><span class="line">    image: percona/percona-xtradb-cluster-operator:1.14.0-proxysql</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    resources:</span><br><span class="line">      requests:</span><br><span class="line">        memory: 1G</span><br><span class="line">        cpu: 600m</span><br><span class="line">    affinity:</span><br><span class="line">      antiAffinityTopologyKey: &quot;kubernetes.io/hostname&quot;</span><br><span class="line">    volumeSpec:</span><br><span class="line">      persistentVolumeClaim:</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            storage: 2G</span><br><span class="line">    podDisruptionBudget:</span><br><span class="line">      maxUnavailable: 1</span><br><span class="line">    gracePeriod: 30</span><br><span class="line">  logcollector:</span><br><span class="line">    enabled: true</span><br><span class="line">    image: percona/percona-xtradb-cluster-operator:1.14.0-logcollector</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    resources:</span><br><span class="line">      requests:</span><br><span class="line">        memory: 100M</span><br><span class="line">        cpu: 200m</span><br><span class="line">  pmm:</span><br><span class="line">    enabled: false</span><br><span class="line">    image: percona/pmm-client:2.41.1</span><br><span class="line">    serverHost: monitoring-service</span><br><span class="line">    resources:</span><br><span class="line">      requests:</span><br><span class="line">        memory: 150M</span><br><span class="line">        cpu: 300m</span><br><span class="line">  backup:</span><br><span class="line">    image: percona/percona-xtradb-cluster-operator:1.14.0-pxc8.0-backup-pxb8.0.35</span><br><span class="line">    pitr:</span><br><span class="line">      enabled: false</span><br><span class="line">      storageName: STORAGE-NAME-HERE</span><br><span class="line">      timeBetweenUploads: 60</span><br><span class="line">      timeoutSeconds: 60</span><br><span class="line">    storages:</span><br><span class="line">      s3-us-west:</span><br><span class="line">        type: s3</span><br><span class="line">        verifyTLS: true</span><br><span class="line">        s3:</span><br><span class="line">          bucket: S3-BACKUP-BUCKET-NAME-HERE</span><br><span class="line">          credentialsSecret: my-cluster-name-backup-s3</span><br><span class="line">          region: us-west-2</span><br><span class="line">      azure-blob:</span><br><span class="line">        type: azure</span><br><span class="line">        azure:</span><br><span class="line">          credentialsSecret: azure-secret</span><br><span class="line">          container: test</span><br><span class="line">      fs-pvc:</span><br><span class="line">        type: filesystem</span><br><span class="line">        volume:</span><br><span class="line">          persistentVolumeClaim:</span><br><span class="line">            storageClassName: nfs-storage  # 改为实际storageclass</span><br><span class="line">            accessModes: [ &quot;ReadWriteOnce&quot; ]</span><br><span class="line">            resources:</span><br><span class="line">              requests:</span><br><span class="line">                storage: 6G</span><br><span class="line">    schedule:</span><br><span class="line">      - name: &quot;daily-backup&quot;</span><br><span class="line">        schedule: &quot;0 0 * * *&quot;</span><br><span class="line">        keep: 5</span><br><span class="line">        storageName: fs-pvc</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl create ns pxc</span><br><span class="line">kubectl apply -f cr.yaml -n pxc</span><br></pre></td></tr></table></figure><h3 id="最小化pxc集群"><a href="#最小化pxc集群" class="headerlink" title="最小化pxc集群"></a><strong>最小化pxc集群</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim cr-minimal.yaml</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: pxc.percona.com/v1</span><br><span class="line">kind: PerconaXtraDBCluster</span><br><span class="line">metadata:</span><br><span class="line">  name: minimal-cluster</span><br><span class="line">spec:</span><br><span class="line">  crVersion: 1.14.0</span><br><span class="line">  secretsName: minimal-cluster-secrets</span><br><span class="line">  allowUnsafeConfigurations: true</span><br><span class="line">  upgradeOptions:</span><br><span class="line">    apply: disabled</span><br><span class="line">    schedule: &quot;0 4 * * *&quot;</span><br><span class="line">  pxc:</span><br><span class="line">    size: 1</span><br><span class="line">    image: percona/percona-xtradb-cluster:8.0.35-27.1</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    volumeSpec:</span><br><span class="line">      persistentVolumeClaim:</span><br><span class="line">        storageClassName: nfs-storage</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            storage: 6G</span><br><span class="line">  haproxy:</span><br><span class="line">    enabled: true</span><br><span class="line">    size: 1</span><br><span class="line">    image: percona/percona-xtradb-cluster-operator:1.14.0-haproxy</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">  logcollector:</span><br><span class="line">    enabled: true</span><br><span class="line">    image: percona/percona-xtradb-cluster-operator:1.14.0-logcollector</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f cr-minimal.yaml</span><br></pre></td></tr></table></figure><h3 id="卸载"><a href="#卸载" class="headerlink" title="卸载"></a><strong>卸载</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete pxc &lt;pxc集群名称&gt;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -f deploy/cw-bundle.yaml</span><br><span class="line">kubectl delete -f deploy/crd.yaml</span><br><span class="line">kubectl delete validatingwebhookconfigurations percona-xtradbcluster-webhook</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;官方文档：&lt;a href=&quot;https://docs.percona.com/percona-operator-for-mysql/pxc/kubernetes.html&quot;&gt;通用 Kubernetes 安装 - Percona Operator for MySQL — Ge</summary>
      
    
    
    
    <category term="云原生" scheme="https://sreok.cn/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/"/>
    
    
    <category term="MySQL" scheme="https://sreok.cn/tags/MySQL/"/>
    
    <category term="PXC" scheme="https://sreok.cn/tags/PXC/"/>
    
  </entry>
  
  <entry>
    <title>【云原生】基于 PostgreSQL Operator 在 k8s 集群中部署Postgres 集群并启动 PostGIS（kustomize方式）</title>
    <link href="https://sreok.cn/2025/02/17/%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91%E5%9F%BA%E4%BA%8E%20PostgreSQL%20Operator%20%E5%9C%A8%20k8s%20%E9%9B%86%E7%BE%A4%E4%B8%AD%E9%83%A8%E7%BD%B2Postgres%20%E9%9B%86%E7%BE%A4%E5%B9%B6%E5%90%AF%E5%8A%A8%20PostGIS%EF%BC%88kustomize%E6%96%B9%E5%BC%8F%EF%BC%89/"/>
    <id>https://sreok.cn/2025/02/17/%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91%E5%9F%BA%E4%BA%8E%20PostgreSQL%20Operator%20%E5%9C%A8%20k8s%20%E9%9B%86%E7%BE%A4%E4%B8%AD%E9%83%A8%E7%BD%B2Postgres%20%E9%9B%86%E7%BE%A4%E5%B9%B6%E5%90%AF%E5%8A%A8%20PostGIS%EF%BC%88kustomize%E6%96%B9%E5%BC%8F%EF%BC%89/</id>
    <published>2025-02-17T09:06:03.000Z</published>
    <updated>2025-09-13T12:28:40.204Z</updated>
    
    <content type="html"><![CDATA[<h3 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> --depth 1 <span class="string">&quot;https://github.com/CrunchyData/postgres-operator-examples.git&quot;</span></span><br><span class="line"><span class="built_in">cd</span> postgres-operator-examples</span><br></pre></td></tr></table></figure><h3 id="安装PGO"><a href="#安装PGO" class="headerlink" title="安装PGO"></a><strong>安装PGO</strong></h3><p>官方地址：<a href="https://access.crunchydata.com/documentation/postgres-operator/latest/quickstart">https://access.crunchydata.com/documentation/postgres-operator/latest/quickstart</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -k kustomize/install/namespace</span><br><span class="line">kubectl apply --server-side -k kustomize/install/default</span><br></pre></td></tr></table></figure><h3 id="配置集群"><a href="#配置集群" class="headerlink" title="配置集群"></a><strong>配置集群</strong></h3><p>参考地址：<a href="https://www.crunchydata.com/blog/postgis-with-postgresql-operator">https://www.crunchydata.com/blog/postgis-with-postgresql-operator</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim kustomize/postgres/postgres.yaml</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: postgres-operator.crunchydata.com/v1beta1</span><br><span class="line">kind: PostgresCluster</span><br><span class="line">metadata:</span><br><span class="line">  name: hippo</span><br><span class="line">spec:</span><br><span class="line">  #image: registry.developers.crunchydata.com/crunchydata/crunchy-postgres:ubi8-16.3-0</span><br><span class="line">  image : registry.developers.crunchydata.com/crunchydata/crunchy-postgres-gis:ubi8-16.3-3.4-0</span><br><span class="line">  #image: RELATED_IMAGE_POSTGRES_16_GIS_3.4</span><br><span class="line">  postgresVersion: 16</span><br><span class="line">  postGISVersion: &quot;3.4&quot;</span><br><span class="line">  instances:</span><br><span class="line">    - name: instance1</span><br><span class="line">      dataVolumeClaimSpec:</span><br><span class="line">        accessModes:</span><br><span class="line">        - &quot;ReadWriteOnce&quot;</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            storage: 100Gi</span><br><span class="line">  users:</span><br><span class="line">  - name: &quot;hippo&quot;</span><br><span class="line">    options: &#x27;SUPERUSER&#x27;</span><br><span class="line">  backups:</span><br><span class="line">    pgbackrest:</span><br><span class="line">      image: registry.developers.crunchydata.com/crunchydata/crunchy-pgbackrest:ubi8-2.51-0</span><br><span class="line">      repos:</span><br><span class="line">      - name: repo1</span><br><span class="line">        volume:</span><br><span class="line">          volumeClaimSpec:</span><br><span class="line">            accessModes:</span><br><span class="line">            - &quot;ReadWriteOnce&quot;</span><br><span class="line">            resources:</span><br><span class="line">              requests:</span><br><span class="line">                storage: 100Gi</span><br></pre></td></tr></table></figure><h3 id="安装集群"><a href="#安装集群" class="headerlink" title="安装集群"></a><strong>安装集群</strong></h3><p>官方地址：<a href="https://access.crunchydata.com/documentation/postgres-operator/latest/tutorials/basic-setup/create-cluster">Create a Postgres Cluster (</a><a href="http://crunchydata.com/">crunchydata.com</a><a href="https://access.crunchydata.com/documentation/postgres-operator/latest/tutorials/basic-setup/create-cluster">)</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -k kustomize/postgres</span><br></pre></td></tr></table></figure><h4 id="已知问题"><a href="#已知问题" class="headerlink" title="已知问题"></a><strong>已知问题</strong></h4><h5 id="问题1"><a href="#问题1" class="headerlink" title="问题1:"></a><strong>问题1:</strong></h5><p>storageclass调用nfs失败</p><p>原因： 没有应用nfs_provisioner</p><p>解决： yaml文件放在&#x2F;data&#x2F;nfsyml目录下。</p><hr><h5 id="问题2"><a href="#问题2" class="headerlink" title="问题2:"></a><strong>问题2:</strong></h5><p>Output: mount: &#x2F;var&#x2F;lib&#x2F;kubelet&#x2F;pods&#x2F;bd8b92ad-3311-4743-8154-0e75e5298fbe&#x2F;volumes&#x2F;<a href="http://kubernetes.io/">kubernetes.io</a>~nfs&#x2F;pvc-db9f2bae-9eae-4f5a-91d0-831cf832389c: bad option; for several filesystems (e.g. nfs, cifs) you might need a &#x2F;sbin&#x2F;mount.&lt;type&gt; helper program.</p><p>原因： node节点没有客户端，ubuntu高版本必须安装utils和common centos系统安装utils即可</p><p>解决： 节点安装nfs客户端 <code>apt install nfs-common -y</code></p><hr><h5 id="问题3："><a href="#问题3：" class="headerlink" title="问题3："></a><strong>问题3：</strong></h5><p>Output: mount.nfs: access denied by server while mounting 192.168.0.170:&#x2F;postgres-data</p><p>原因：nfs server配置错误</p><p>解决：确认nfs的ip和端口，重启nfs-server</p><h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a><strong>配置</strong></h3><blockquote><p>pgo使用PostgresCluster资源说明，官方地址：<a href="https://access.crunchydata.com/documentation/postgres-operator/latest/references/crd/5.5.x/postgrescluster">PostgresCluster (</a><a href="http://crunchydata.com/">crunchydata.com</a><a href="https://access.crunchydata.com/documentation/postgres-operator/latest/references/crd/5.5.x/postgrescluster">)</a></p></blockquote><h4 id="高可用"><a href="#高可用" class="headerlink" title="高可用"></a><strong>高可用</strong></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit postgresclusters.postgres-operator.crunchydata.com -n postgres-operator hippo # 修改replicas = 2</span><br></pre></td></tr></table></figure><h4 id="PostGIS"><a href="#PostGIS" class="headerlink" title="PostGIS"></a><strong>PostGIS</strong></h4><blockquote><p>如果安装时制定了gis的地址就不需要这一步</p></blockquote><h5 id="修改镜像"><a href="#修改镜像" class="headerlink" title="修改镜像"></a><strong>修改镜像</strong></h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit postgresclusters -n postgres-operator hippo</span><br></pre></td></tr></table></figure><h5 id="查看镜像"><a href="#查看镜像" class="headerlink" title="查看镜像"></a><strong>查看镜像</strong></h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat kustomize/install/manager/manager.yaml</span><br></pre></td></tr></table></figure><h5 id="替换spec-image镜像地址"><a href="#替换spec-image镜像地址" class="headerlink" title="替换spec.image镜像地址"></a><strong>替换spec.image镜像地址</strong></h5><blockquote><p>这里使用postgre v16和gis v3.4</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">registry.developers.crunchydata.com/crunchydata/crunchy-postgres-gis:ubi8-16.3-3.4-0</span><br></pre></td></tr></table></figure><h3 id="连接"><a href="#连接" class="headerlink" title="连接"></a><strong>连接</strong></h3><h4 id="直接连接"><a href="#直接连接" class="headerlink" title="直接连接"></a><strong>直接连接</strong></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql $(kubectl -n postgres-operator get secrets hippo-pguser-hippo -o go-template=&#x27;&#123;&#123;.data.uri | base64decode&#125;&#125;&#x27;)</span><br></pre></td></tr></table></figure><h4 id="端口转发连接"><a href="#端口转发连接" class="headerlink" title="端口转发连接"></a><strong>端口转发连接</strong></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PG_CLUSTER_PRIMARY_POD=$(kubectl get pod \</span><br><span class="line">  -n postgres-operator \</span><br><span class="line">  -o name \</span><br><span class="line">  -l postgres-operator.crunchydata.com/cluster=hippo,postgres-operator.crunchydata.com/role=master)</span><br><span class="line">​</span><br><span class="line">kubectl -n postgres-operator port-forward &quot;$&#123;PG_CLUSTER_PRIMARY_POD&#125;&quot; --address 0.0.0.0 5432:5432</span><br></pre></td></tr></table></figure><h5 id="获取密码"><a href="#获取密码" class="headerlink" title="获取密码"></a><strong>获取密码</strong></h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get secrets -n postgres-operator &quot;hippo-pguser-hippo&quot; -o go-template=&#x27;&#123;&#123;.data.password | base64decode&#125;&#125;&#x27;</span><br></pre></td></tr></table></figure><h5 id="获取用户"><a href="#获取用户" class="headerlink" title="获取用户"></a><strong>获取用户</strong></h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get secrets -n postgres-operator &quot;hippo-pguser-hippo&quot; -o go-template=&#x27;&#123;&#123;.data.user | base64decode&#125;&#125;&#x27;</span><br></pre></td></tr></table></figure><h5 id="获取数据库"><a href="#获取数据库" class="headerlink" title="获取数据库"></a><strong>获取数据库</strong></h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get secrets -n postgres-operator &quot;hippo-pguser-hippo&quot; -o go-template=&#x27;&#123;&#123;.data.dbname | base64decode&#125;&#125;&#x27;</span><br></pre></td></tr></table></figure><h5 id="连接数据库"><a href="#连接数据库" class="headerlink" title="连接数据库"></a>连接数据库</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">psql -h localhost -U hippo </span><br></pre></td></tr></table></figure><blockquote><p>输入密码</p></blockquote><h3 id="删除集群"><a href="#删除集群" class="headerlink" title="删除集群"></a><strong>删除集群</strong></h3><h4 id="卸载集群"><a href="#卸载集群" class="headerlink" title="卸载集群"></a><strong>卸载集群</strong></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -k kustomize/postgres</span><br></pre></td></tr></table></figure><h4 id="卸载pgo"><a href="#卸载pgo" class="headerlink" title="卸载pgo"></a><strong>卸载pgo</strong></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl delete -k kustomize/install/default</span><br><span class="line">kubectl delete -k kustomize/install/namespace</span><br></pre></td></tr></table></figure><h4 id="已知问题-1"><a href="#已知问题-1" class="headerlink" title="已知问题"></a><strong>已知问题</strong></h4><h5 id="namespace-terminal"><a href="#namespace-terminal" class="headerlink" title="namespace terminal"></a><strong>namespace terminal</strong></h5><p>强制删除ns</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl proxy --port=8081</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl get ns postgres-operator -o json &gt; 1.json</span><br><span class="line">​</span><br><span class="line">​</span><br><span class="line">curl -k -H &quot;Content-Type: application/json&quot; -X PUT --data-binary @1.json http://127.0.0.1:8081/api/v1/namespaces/postgres-operator/finalize</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;准备&quot;&gt;&lt;a href=&quot;#准备&quot; class=&quot;headerlink&quot; title=&quot;准备&quot;&gt;&lt;/a&gt;准备&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span c</summary>
      
    
    
    
    <category term="云原生" scheme="https://sreok.cn/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/"/>
    
    
    <category term="Kubernetes" scheme="https://sreok.cn/tags/Kubernetes/"/>
    
    <category term="PostgreSQL" scheme="https://sreok.cn/tags/PostgreSQL/"/>
    
  </entry>
  
  <entry>
    <title>【云原生】Kubernetes通过device-plugin调度GPU资源-NVIDIA</title>
    <link href="https://sreok.cn/2025/02/03/%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91Kubernetes%E9%80%9A%E8%BF%87device-plugin%E8%B0%83%E5%BA%A6GPU%E8%B5%84%E6%BA%90-NVIDIA/"/>
    <id>https://sreok.cn/2025/02/03/%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91Kubernetes%E9%80%9A%E8%BF%87device-plugin%E8%B0%83%E5%BA%A6GPU%E8%B5%84%E6%BA%90-NVIDIA/</id>
    <published>2025-02-03T09:06:03.000Z</published>
    <updated>2025-09-13T12:28:38.604Z</updated>
    
    <content type="html"><![CDATA[<p>NVIDIA官方文档：<a href="https://github.com/NVIDIA/k8s-device-plugin?tab=readme-ov-file#nvidia-device-plugin-for-kubernetes">NVIDIA&#x2F;k8s-device-plugin：用于 Kubernetes 的 NVIDIA 设备插件</a></p><h3 id="前提条件"><a href="#前提条件" class="headerlink" title="前提条件"></a>前提条件</h3><ul><li>安装驱动，原文地址：<a href="https://sreok.cn/archives/1723448671609">Linux Kernel 3.10安装NVIDIA 550.107.02驱动GeForce RTX 2080 Ti - Elijah Blog (</a><a href="http://sreok.cn/">sreok.cn</a><a href="https://sreok.cn/archives/1723448671609">)</a></li></ul><h3 id="安装NVIDIA-Container-Toolkit"><a href="#安装NVIDIA-Container-Toolkit" class="headerlink" title="安装NVIDIA Container Toolkit"></a>安装NVIDIA Container Toolkit</h3><p>官方地址：<a href="https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html">https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html</a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">curl -s -L https://nvidia.github.io/libnvidia-container/stable/rpm/nvidia-container-toolkit.repo | \</span><br><span class="line">  sudo tee /etc/yum.repos.d/nvidia-container-toolkit.repo</span><br><span class="line">yum install -y nvidia-container-toolkit</span><br></pre></td></tr></table></figure><h3 id="更新运行时"><a href="#更新运行时" class="headerlink" title="更新运行时"></a>更新运行时</h3><h4 id="docker"><a href="#docker" class="headerlink" title="docker"></a>docker</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nvidia-ctk runtime configure --runtime=docker</span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure><p>无根模式下运行的docker</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nvidia-ctk runtime configure --runtime=docker --config=$HOME/.config/docker/daemon.json</span><br><span class="line">systemctl --user restart docker</span><br><span class="line">nvidia-ctk config --set nvidia-container-cli.no-cgroups --in-place</span><br></pre></td></tr></table></figure><h4 id="Containerd"><a href="#Containerd" class="headerlink" title="Containerd"></a>Containerd</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">nvidia-ctk runtime configure --runtime=containerd</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart containerd</span><br></pre></td></tr></table></figure><p>仅用于nerdctl无需配置，直接运行<code>nerdctl run --gpus=all</code></p><p>如果以上修改不生效，修改默认运行时</p><blockquote><p># 编辑 <code>/etc/containerd/config.toml</code></p><p>搜索 <code>plugins.&quot;io.containerd.grpc.v1.cri&quot;.containerd.runtimes.runc</code></p><p><code>runtime_type = &quot;io.containerd.runc.v2&quot;</code> 改成 <code>io.containerd.runtime.v1.linux</code></p><p>搜索<code>io.containerd.runtime.v1.linux</code></p><p><code>runtime = &quot;runc&quot;</code>改成<code>runtime = &quot;nvidia-container-runtime&quot;</code></p></blockquote><p><img src="/images/image-mzdz.png"></p><p><img src="/images/image-vhrk.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart containerd</span><br></pre></td></tr></table></figure><h4 id="CRI-O"><a href="#CRI-O" class="headerlink" title="CRI-O"></a>CRI-O</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">nvidia-ctk runtime configure --runtime=crio</span><br><span class="line">systemctl restart crio</span><br></pre></td></tr></table></figure><h3 id="部署nvidia-device-plugin"><a href="#部署nvidia-device-plugin" class="headerlink" title="部署nvidia-device-plugin"></a>部署nvidia-device-plugin</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f https://raw.githubusercontent.com/NVIDIA/k8s-device-plugin/v0.16.2/deployments/static/nvidia-device-plugin.yml</span><br></pre></td></tr></table></figure><h4 id="查看GPU所在节点的pod日志"><a href="#查看GPU所在节点的pod日志" class="headerlink" title="查看GPU所在节点的pod日志"></a>查看GPU所在节点的pod日志</h4><p>正常情况（将GPU注册到kubelet）：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">I0820 08:26:47.926058       1 main.go:317] Retrieving plugins.</span><br><span class="line">I0820 08:26:51.674618       1 server.go:216] Starting GRPC server for &#x27;nvidia.com/gpu&#x27;</span><br><span class="line">I0820 08:26:51.682183       1 server.go:147] Starting to serve &#x27;nvidia.com/gpu&#x27; on /var/lib/kubelet/device-plugins/nvidia-gpu.sock</span><br><span class="line">I0820 08:26:51.690851       1 server.go:154] Registered device plugin for &#x27;nvidia.com/gpu&#x27; with Kubelet</span><br></pre></td></tr></table></figure><p>未找到GPU（尝试将nvidia修改为默认运行时）：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">I0820 08:26:53.370854       1 main.go:317] Retrieving plugins.</span><br><span class="line">E0820 08:26:53.370997       1 factory.go:87] Incompatible strategy detected auto</span><br><span class="line">E0820 08:26:53.371004       1 factory.go:88] If this is a GPU node, did you configure the NVIDIA Container Toolkit?</span><br><span class="line">E0820 08:26:53.371010       1 factory.go:89] You can check the prerequisites at: https://github.com/NVIDIA/k8s-device-plugin#prerequisites</span><br><span class="line">E0820 08:26:53.371016       1 factory.go:90] You can learn how to set the runtime at: https://github.com/NVIDIA/k8s-device-plugin#quick-start</span><br><span class="line">E0820 08:26:53.371021       1 factory.go:91] If this is not a GPU node, you should set up a toleration or nodeSelector to only deploy this plugin on GPU nodes</span><br><span class="line">I0820 08:26:53.371029       1 main.go:346] No devices found. Waiting indefinitely.</span><br></pre></td></tr></table></figure><p>更新运行时后，重启device-plugin daemonset</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl rollout restart ds -n kube-system nvidia-device-plugin-daemonset</span><br></pre></td></tr></table></figure><h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># gpu节点打标签</span><br><span class="line">kubectl label nodes k8s-dell-r740-worker01 nvidia.com/gpu=true</span><br></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">gpu-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cuda-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">nvcr.io/nvidia/k8s/cuda-sample:vectoradd-cuda10.2</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">limits:</span></span><br><span class="line">          <span class="attr">nvidia.com/gpu:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&#x27;nvidia-smi&#x27;</span>]</span><br><span class="line">  <span class="attr">tolerations:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">nvidia.com/gpu</span></span><br><span class="line">    <span class="attr">operator:</span> <span class="string">Exists</span></span><br><span class="line">    <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">  <span class="comment">#nodeSelector:</span></span><br><span class="line">  <span class="comment">#  viadia.com/gpu: &quot;true&quot;</span></span><br></pre></td></tr></table></figure><h4 id="查看pod日志"><a href="#查看pod日志" class="headerlink" title="查看pod日志"></a>查看pod日志</h4><p><img src="/images/image-ssaz.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;NVIDIA官方文档：&lt;a href=&quot;https://github.com/NVIDIA/k8s-device-plugin?tab=readme-ov-file#nvidia-device-plugin-for-kubernetes&quot;&gt;NVIDIA&amp;#x2F;k8s-d</summary>
      
    
    
    
    <category term="云原生" scheme="https://sreok.cn/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/"/>
    
    
    <category term="Kubernetes" scheme="https://sreok.cn/tags/Kubernetes/"/>
    
    <category term="GPU" scheme="https://sreok.cn/tags/GPU/"/>
    
  </entry>
  
  <entry>
    <title>【云原生】K8sGPT + LocalAI 开源自动化诊断工具（GPT4All-j模型）</title>
    <link href="https://sreok.cn/2024/12/27/%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91K8sGPT%20+%20LocalAI%20%E5%BC%80%E6%BA%90%E8%87%AA%E5%8A%A8%E5%8C%96%E8%AF%8A%E6%96%AD%E5%B7%A5%E5%85%B7%EF%BC%88GPT4All-j%E6%A8%A1%E5%9E%8B%EF%BC%89/"/>
    <id>https://sreok.cn/2024/12/27/%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91K8sGPT%20+%20LocalAI%20%E5%BC%80%E6%BA%90%E8%87%AA%E5%8A%A8%E5%8C%96%E8%AF%8A%E6%96%AD%E5%B7%A5%E5%85%B7%EF%BC%88GPT4All-j%E6%A8%A1%E5%9E%8B%EF%BC%89/</id>
    <published>2024-12-27T09:06:03.000Z</published>
    <updated>2025-09-13T12:28:37.681Z</updated>
    
    <content type="html"><![CDATA[<p>k8sgpt官方文档：<a href="https://docs.k8sgpt.ai/getting-started/in-cluster-operator/"><em>In-Cluster Operator - k8sgpt</em></a></p><p>localai官方文档：<a href="https://localai.io/basics/kubernetes/"><em>Run with Kubernetes | LocalAI documentation</em></a></p><p>参考文献：<a href="https://itnext.io/k8sgpt-localai-unlock-kubernetes-superpowers-for-free-584790de9b65"><em>K8sGPT + LocalAI: Unlock Kubernetes superpowers for free! | by Tyler | ITNEXT</em></a></p><h3 id="安装LocalAI"><a href="#安装LocalAI" class="headerlink" title="安装LocalAI"></a><strong>安装LocalAI</strong></h3><h4 id="可选一：（kubectl方式）"><a href="#可选一：（kubectl方式）" class="headerlink" title="可选一：（kubectl方式）"></a>可选一：（kubectl方式）</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; local-ai.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Namespace</span><br><span class="line">metadata:</span><br><span class="line">  name: local-ai</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: PersistentVolumeClaim</span><br><span class="line">metadata:</span><br><span class="line">  name: models-pvc</span><br><span class="line">  namespace: local-ai</span><br><span class="line">spec:</span><br><span class="line">  storageClassName: nfs-storage # 实际的storageclass</span><br><span class="line">  accessModes:</span><br><span class="line">    - ReadWriteOnce</span><br><span class="line">  resources:</span><br><span class="line">    requests:</span><br><span class="line">      storage: 10Gi</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: local-ai</span><br><span class="line">  namespace: local-ai</span><br><span class="line">  labels:</span><br><span class="line">    app: local-ai</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: local-ai</span><br><span class="line">  replicas: 1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: local-ai</span><br><span class="line">      name: local-ai</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">        - env:</span><br><span class="line">          - name: DEBUG</span><br><span class="line">            value: &quot;true&quot;</span><br><span class="line">          name: local-ai</span><br><span class="line">          #image: quay.io/go-skynet/local-ai:latest</span><br><span class="line">          image: quay.io/go-skynet/local-ai:master-ffmpeg-core</span><br><span class="line">          imagePullPolicy: IfNotPresent</span><br><span class="line">          volumeMounts:</span><br><span class="line">            - name: models-volume</span><br><span class="line">              mountPath: /build/models</span><br><span class="line">      volumes:</span><br><span class="line">        - name: models-volume</span><br><span class="line">          persistentVolumeClaim:</span><br><span class="line">            claimName: models-pvc</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: local-ai</span><br><span class="line">  namespace: local-ai</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: local-ai</span><br><span class="line">  type: LoadBalancer</span><br><span class="line">  ports:</span><br><span class="line">    - protocol: TCP</span><br><span class="line">      port: 8080</span><br><span class="line">      targetPort: 8080</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f local-ai.yaml</span><br></pre></td></tr></table></figure><h4 id="可选二：（helm方式）"><a href="#可选二：（helm方式）" class="headerlink" title="可选二：（helm方式）"></a>可选二：（helm方式）</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">helm repo add go-skynet https://go-skynet.github.io/helm-charts/</span><br><span class="line">helm show values go-skynet/local-ai &gt; values.yaml</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim values.yaml</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">replicaCount: 1</span><br><span class="line">​</span><br><span class="line">deployment:</span><br><span class="line">  image:</span><br><span class="line">    repository: quay.io/go-skynet/local-ai</span><br><span class="line">    tag: latest    # latest镜像23.5G</span><br><span class="line">    # tag: master-ffmpeg-core</span><br><span class="line">  env:</span><br><span class="line">    threads: 8  # 最好8cpu</span><br><span class="line">    context_size: 512</span><br><span class="line">  modelsPath: &quot;/models&quot;</span><br><span class="line">  download_model:</span><br><span class="line">    image: busybox</span><br><span class="line">  prompt_templates:</span><br><span class="line">    image: busybox</span><br><span class="line">  pullPolicy: IfNotPresent</span><br><span class="line">  imagePullSecrets: []</span><br><span class="line">resources: &#123;&#125;</span><br><span class="line">promptTemplates: &#123;&#125;</span><br><span class="line">models:</span><br><span class="line">  forceDownload: false</span><br><span class="line">  list:</span><br><span class="line">    - url: &quot;https://gpt4all.io/models/ggml-gpt4all-j.bin&quot; # 提前下载，放到models的pvc里</span><br><span class="line">      # basicAuth: base64EncodedCredentials</span><br><span class="line">initContainers: []</span><br><span class="line">sidecarContainers: []</span><br><span class="line">persistence:</span><br><span class="line">  models: </span><br><span class="line">    enabled: true</span><br><span class="line">    annotations: &#123;&#125;</span><br><span class="line">    storageClass: nfs-storage # 实际的storageclassName</span><br><span class="line">    accessModes: ReadWriteMany</span><br><span class="line">    size: 10Gi</span><br><span class="line">    globalMount: /models</span><br><span class="line">  output:</span><br><span class="line">    enabled: true</span><br><span class="line">    annotations: &#123;&#125;</span><br><span class="line">    storageClass: nfs-storage # 实际的storageclassName</span><br><span class="line">    accessModes: ReadWriteMany</span><br><span class="line">    size: 5Gi</span><br><span class="line">    globalMount: /tmp/generated</span><br><span class="line">service:</span><br><span class="line">  type: ClusterIP</span><br><span class="line">  port: 80</span><br><span class="line">  annotations: &#123;&#125;</span><br><span class="line">ingress:</span><br><span class="line">  enabled: false</span><br><span class="line">  className: &quot;&quot;</span><br><span class="line">  annotations: &#123;&#125;</span><br><span class="line">  hosts:</span><br><span class="line">    - host: chart-example.local</span><br><span class="line">      paths:</span><br><span class="line">        - path: /</span><br><span class="line">          pathType: ImplementationSpecific</span><br><span class="line">  tls: []</span><br><span class="line">  #  - secretName: chart-example-tls</span><br><span class="line">  #    hosts:</span><br><span class="line">  #      - chart-example.local</span><br><span class="line">nodeSelector: &#123;&#125;</span><br><span class="line">tolerations: []</span><br><span class="line">affinity: &#123;&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm install local-ai go-skynet/local-ai -f values.yaml</span><br></pre></td></tr></table></figure><h3 id="下载模型"><a href="#下载模型" class="headerlink" title="下载模型"></a><strong>下载模型</strong></h3><p>GPT4all-j下载地址（3.52G）：<a href="https://gpt4all.io/models/ggml-gpt4all-j.bin"><em>https://gpt4all.io/models/ggml-gpt4all-j.bin</em></a></p><p>下载后安装到models的pvc下</p><h4 id="测试LocalAI-GPT4All模型"><a href="#测试LocalAI-GPT4All模型" class="headerlink" title="测试LocalAI GPT4All模型"></a>测试LocalAI GPT4All模型</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://10.20.13.140:27410/v1/models</span><br></pre></td></tr></table></figure><p><img src="/images/image-vwti.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">curl http://10.20.13.140:27410/v1/chat/completions -H &quot;Content-Type: application/json&quot; -d &#x27;&#123;</span><br><span class="line">  &quot;model&quot;: &quot;ggml-gpt4all-j.bin&quot;,</span><br><span class="line">  &quot;messages&quot;: [&#123;&quot;role&quot;: &quot;user&quot;, &quot;content&quot;: &quot;How are you?&quot;&#125;],</span><br><span class="line">  &quot;temperature&quot;: 0.7</span><br><span class="line">&#125;&#x27;</span><br></pre></td></tr></table></figure><p><img src="/images/image-xjyf.png"></p><h3 id="安装k8sgpt客户端，诊断集群"><a href="#安装k8sgpt客户端，诊断集群" class="headerlink" title="安装k8sgpt客户端，诊断集群"></a><strong>安装k8sgpt客户端，诊断集群</strong></h3><p>下载地址：<a href="https://docs.k8sgpt.ai/getting-started/installation/"><em>Installation - k8sgpt</em></a></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -ivh -i k8sgpt_amd64.rpm</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">k8sgpt auth add --backend localai --model ggml-gpt4all-j.bin --baseurl http://10.20.13.140:27410/v1</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">k8sgpt analyze --explain -b localai # 如果这一步卡住，很可能你的资源问题不能被确认</span><br></pre></td></tr></table></figure><p><img src="/images/image-riug.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">k8sgpt analyze --explain -b localai --filter Pod # 只过滤Pod</span><br></pre></td></tr></table></figure><p><img src="/images/image-mmzs.png"></p><h4 id="资源使用问题"><a href="#资源使用问题" class="headerlink" title="资源使用问题"></a>资源使用问题</h4><p><img src="/images/image-wvvc.png"></p><p>查看local-ai的pod在node01节点，如果正在运算可以看到top使用率</p><p><img src="/images/image-zuwt.png"></p><h3 id="集成k8sgpt-operator配置自动诊断"><a href="#集成k8sgpt-operator配置自动诊断" class="headerlink" title="集成k8sgpt-operator配置自动诊断"></a><strong>集成k8sgpt-operator配置自动诊断</strong></h3><h3 id="安装k8sgpt-operator"><a href="#安装k8sgpt-operator" class="headerlink" title="安装k8sgpt-operator"></a><strong>安装k8sgpt-operator</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">helm repo add k8sgpt https://charts.k8sgpt.ai/</span><br><span class="line">helm repo update</span><br><span class="line">helm install release k8sgpt/k8sgpt-operator -n k8sgpt-operator-system --create-namespace</span><br></pre></td></tr></table></figure><h3 id="创建K8sGPT"><a href="#创建K8sGPT" class="headerlink" title="创建K8sGPT"></a><strong>创建K8sGPT</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim k8sgpt.yaml</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">apiVersion: core.k8sgpt.ai/v1alpha1</span><br><span class="line">kind: K8sGPT</span><br><span class="line">metadata:</span><br><span class="line">  name: k8sgpt-local</span><br><span class="line">  namespace: k8sgpt-operator-system</span><br><span class="line">spec:</span><br><span class="line">  ai:</span><br><span class="line">    enabled: true</span><br><span class="line">    backend: localai</span><br><span class="line">    model: ggml-gpt4all-j.bin</span><br><span class="line">    baseUrl: http://local-ai.local-ai.svc.cluster.local:8080/v1</span><br><span class="line">  noCache: false</span><br><span class="line">  version: v0.3.8</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f k8sgpt.yaml</span><br></pre></td></tr></table></figure><h4 id="测试自动诊断"><a href="#测试自动诊断" class="headerlink" title="测试自动诊断"></a>测试自动诊断</h4><p>创建一个错误的pod，镜像tag故意写一个不存在的</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">cat &gt; broken-pod.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: broken-pod</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">    - name: broken-pod</span><br><span class="line">      image: nginx:1.a.b.c</span><br><span class="line">      livenessProbe:</span><br><span class="line">        httpGet:</span><br><span class="line">          path: /</span><br><span class="line">          port: 90</span><br><span class="line">        initialDelaySeconds: 3</span><br><span class="line">        periodSeconds: 3</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p><img src="/images/image-ycna.png"></p><p>查看results</p><p><img src="/images/image-qjeq.png"></p><p>查看详情</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get results -n k8sgpt-operator-system xxxxxxxxx -o json</span><br></pre></td></tr></table></figure><p><img src="/images/image-rdoz.png"></p><p>创建一个没有绑定的svc</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create svc clusterip no-endpoint --tcp=80:80</span><br></pre></td></tr></table></figure><p>查看result</p><p><img src="/images/image-nnat.png"></p><p><img src="/images/image-gbbr.png"></p><h3 id="注意："><a href="#注意：" class="headerlink" title="注意："></a><strong>注意：</strong></h3><p>ai的回答不是统一的，有时候会有弱智回答，这个看主要大模型和机器的资源，如果回答比较模糊，可以删掉results，等待重建后再查看details</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;k8sgpt官方文档：&lt;a href=&quot;https://docs.k8sgpt.ai/getting-started/in-cluster-operator/&quot;&gt;&lt;em&gt;In-Cluster Operator - k8sgpt&lt;/em&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;localai</summary>
      
    
    
    
    
    <category term="localAI" scheme="https://sreok.cn/tags/localAI/"/>
    
  </entry>
  
  <entry>
    <title>【云原生】istio服务网格进阶-故障注入与请求超时（详解）</title>
    <link href="https://sreok.cn/2024/12/13/%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91istio%E6%9C%8D%E5%8A%A1%E7%BD%91%E6%A0%BC%E8%BF%9B%E9%98%B6-%E6%95%85%E9%9A%9C%E6%B3%A8%E5%85%A5%E4%B8%8E%E8%AF%B7%E6%B1%82%E8%B6%85%E6%97%B6%EF%BC%88%E8%AF%A6%E8%A7%A3%EF%BC%89/"/>
    <id>https://sreok.cn/2024/12/13/%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91istio%E6%9C%8D%E5%8A%A1%E7%BD%91%E6%A0%BC%E8%BF%9B%E9%98%B6-%E6%95%85%E9%9A%9C%E6%B3%A8%E5%85%A5%E4%B8%8E%E8%AF%B7%E6%B1%82%E8%B6%85%E6%97%B6%EF%BC%88%E8%AF%A6%E8%A7%A3%EF%BC%89/</id>
    <published>2024-12-13T09:06:03.000Z</published>
    <updated>2025-09-13T12:28:37.537Z</updated>
    
    <content type="html"><![CDATA[<p>官方文档：<a href="https://istio.io/latest/zh/docs/tasks/traffic-management/fault-injection/"><em>Istio &#x2F; 故障注入</em></a>、<a href="https://istio.io/latest/zh/docs/tasks/traffic-management/request-timeouts/"><em>Istio &#x2F; 设置请求超时</em></a></p><p>前提条件：</p><ul><li><p>部署服务（我这里是官方bookinfo程序）</p></li><li><p>服务注入sidecar</p></li></ul><p>部署在这里提到过，原文地址：<a href="https://sreok.cn/archives/1b49e9ee-2a71-4239-913a-fc8913b985b4"><em>istio服务网格入门-灰度发布 - (</em></a><a href="http://sreok.cn/"><em>sreok.cn</em></a><a href="https://sreok.cn/archives/1b49e9ee-2a71-4239-913a-fc8913b985b4"><em>)</em></a></p><h2 id="故障注入"><a href="#故障注入" class="headerlink" title="故障注入"></a><strong>故障注入</strong></h2><h3 id="将请求转发给reviews-v2版本"><a href="#将请求转发给reviews-v2版本" class="headerlink" title="将请求转发给reviews v2版本"></a><strong>将请求转发给reviews v2版本</strong></h3><p>只有这个版本才会调用ratings服务</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f - &lt;&lt; EOF</span><br><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: VirtualService</span><br><span class="line">metadata:</span><br><span class="line">  name: reviews</span><br><span class="line">spec:</span><br><span class="line">  hosts:</span><br><span class="line">    - reviews</span><br><span class="line">  http:</span><br><span class="line">  - route:</span><br><span class="line">    - destination:</span><br><span class="line">        host: reviews</span><br><span class="line">        subset: v2</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="设置ratings服务注入延迟"><a href="#设置ratings服务注入延迟" class="headerlink" title="设置ratings服务注入延迟"></a><strong>设置ratings服务注入延迟</strong></h3><p>如果是jason用户的请求，就注入3秒的延迟，比例是100%请求</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f - &lt;&lt; EOF</span><br><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: VirtualService</span><br><span class="line">metadata:</span><br><span class="line">  name: ratings</span><br><span class="line">spec:</span><br><span class="line">  hosts:</span><br><span class="line">  - ratings</span><br><span class="line">  http:</span><br><span class="line">  - match:</span><br><span class="line">    - headers:</span><br><span class="line">        end-user:</span><br><span class="line">          exact: jason</span><br><span class="line">    fault:</span><br><span class="line">      delay:</span><br><span class="line">        fixedDelay: 3s</span><br><span class="line">        percentage:</span><br><span class="line">          value: 100</span><br><span class="line">    route:</span><br><span class="line">    - destination:</span><br><span class="line">        host: ratings</span><br><span class="line">        subset: v1</span><br><span class="line">  - route:</span><br><span class="line">    - destination:</span><br><span class="line">        host: ratings</span><br><span class="line">        subset: v1</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p><img src="/images/image-eqtw.png"></p><p>此时请求bookinfo程序，流量被转移到reviews v2版本，没有任何问题</p><p><img src="/images/image-oesh.png"></p><p>当登录用户为jason时，延迟被注入，按照预期，我们引入的3秒延迟不会影响到 <code>reviews</code> 服务，但是因为 <code>reviews</code> 和 <code>ratings</code> 服务间的超时被硬编码为 10 秒。 但是，在 <code>productpage</code> 和 <code>reviews</code> 服务之间也有一个 3 秒的硬编码的超时，再加 1 次重试，一共 6 秒。 结果，<code>productpage</code> 对 <code>reviews</code> 的调用在 6 秒后提前超时并抛出错误了。</p><p>简单来说，productpage在等待reviews，reviews在等待ratings，productpage最多等待3秒就会重试，每次重试都会让reviews 重新请求ratings，所以reviews 与ratings直接的请求<code>必须在3秒内响应</code>，否则就会抛出错误</p><p>可以再次尝试将注入延迟改为2.9秒（只要不超过3秒就会成功，但存在一定误差，这个误差可能时大量请求导致的，我这里是测试，没有其他人的请求，所有可以设置2.9秒）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f - &lt;&lt; EOF</span><br><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: VirtualService</span><br><span class="line">metadata:</span><br><span class="line">  name: ratings</span><br><span class="line">spec:</span><br><span class="line">  hosts:</span><br><span class="line">  - ratings</span><br><span class="line">  http:</span><br><span class="line">  - match:</span><br><span class="line">    - headers:</span><br><span class="line">        end-user:</span><br><span class="line">          exact: jason</span><br><span class="line">    fault:</span><br><span class="line">      delay:</span><br><span class="line">        fixedDelay: 2.9s</span><br><span class="line">        percentage:</span><br><span class="line">          value: 100</span><br><span class="line">    route:</span><br><span class="line">    - destination:</span><br><span class="line">        host: ratings</span><br><span class="line">        subset: v1</span><br><span class="line">  - route:</span><br><span class="line">    - destination:</span><br><span class="line">        host: ratings</span><br><span class="line">        subset: v1</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p><img src="/images/image-qdhw.png"></p><p>这是实际上是官方提供给我们测试的BUG，reviews v3修复了这BUG，将ratings的超时时间设置为2.5秒</p><h3 id="更新reviews"><a href="#更新reviews" class="headerlink" title="更新reviews"></a><strong>更新reviews</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f - &lt;&lt; EOF</span><br><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: VirtualService</span><br><span class="line">metadata:</span><br><span class="line">  name: reviews</span><br><span class="line">spec:</span><br><span class="line">  hosts:</span><br><span class="line">    - reviews</span><br><span class="line">  http:</span><br><span class="line">  - route:</span><br><span class="line">    - destination:</span><br><span class="line">        host: reviews</span><br><span class="line">        subset: v3</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>此时将流量转发给reviews v3版本，ratings响应时间只要超过2.5秒，reviews就不会继续等待，立即返回给productpage，避免ratings故障影响reviews服务</p><p>延迟如果在2.5秒内，响应没问题，超过2.5秒，抛出异常</p><p>这个时候ratings服务还是设置3s延迟，模拟ratings故障导致无法响应reviews服务，reviews服务也会在2.5秒后，将响应返回给productpage服务，不会影响reviews服务。</p><p><img src="/images/image-dqov.png"></p><h2 id="请求超时"><a href="#请求超时" class="headerlink" title="请求超时"></a><strong>请求超时</strong></h2><p>保留ratings 服务的延迟注入，我设置了3秒，这时设置reviews超时时间</p><h3 id="设置reviews-超时时间"><a href="#设置reviews-超时时间" class="headerlink" title="设置reviews 超时时间"></a><strong>设置reviews 超时时间</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f - &lt;&lt;EOF</span><br><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: VirtualService</span><br><span class="line">metadata:</span><br><span class="line">  name: reviews</span><br><span class="line">spec:</span><br><span class="line">  hosts:</span><br><span class="line">  - reviews</span><br><span class="line">  http:</span><br><span class="line">  - route:</span><br><span class="line">    - destination:</span><br><span class="line">        host: reviews</span><br><span class="line">        subset: v3</span><br><span class="line">    timeout: 1s</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>过程：</p><p>=&gt; productpage v1（硬编码3s超时，1次重试）</p><p>=&gt; reviews v3（硬编码2.5s超时，设置超时1s，此时会提前超时）</p><p>=&gt; ratings v1（设置延时3s响应，延时只要大于等于超时就会响应失败）</p><p>解析：</p><ol><li><p>productpage请求reviews服务，reviews请求ratings服务，ratings服务延时3s响应</p></li><li><p>1秒后reviews服务超时，因为reviews还在等待reviews响应，而ratings要3s后才会响应</p></li><li><p>productpage因为硬编码会再次重试，还是以上步骤，1秒后reviews服务再次返回超时</p></li><li><p>productpage发送两次请求，共等待了2秒后返回给客户端，并且此时reviews是不可用的</p></li></ol><p>注意：</p><p>productpage硬编码的3s超时没有触发，是因为reviews返回了超时</p><p>reviews硬编码2.5s超时没有触发，是因为设置了超时时间（作用就是这个）</p><p>结果：</p><p>2秒后抛出错误：<code>Sorry, product reviews are currently unavailable for this book.</code></p><p><img src="/images/image-rofb.png"></p><p>原因：</p><p>reviews服务1秒内没有收到ratings服务的响应，reviews服务超时</p><p>这个能解决什么问题？</p><p>在故障注入时，我们发现一个bug，就是调用链的下游超时时间大于上游，此时站在架构层解决的方式就可以使用timeout来拦截流量使下游小于上游的超时时间。避免影响中间层服务。</p><p>注意：</p><ol><li><p>超时时间只能设置小于硬编码的超时时间</p></li><li><p>如遇到上面的bug问题，应及时提交并协助修复，高耦合istio并不是最佳方案</p></li></ol>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;官方文档：&lt;a href=&quot;https://istio.io/latest/zh/docs/tasks/traffic-management/fault-injection/&quot;&gt;&lt;em&gt;Istio &amp;#x2F; 故障注入&lt;/em&gt;&lt;/a&gt;、&lt;a href=&quot;https://</summary>
      
    
    
    
    
    <category term="istio" scheme="https://sreok.cn/tags/istio/"/>
    
  </entry>
  
  <entry>
    <title>【云原生】istio服务网格入门-灰度发布</title>
    <link href="https://sreok.cn/2024/12/11/%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91istio%E6%9C%8D%E5%8A%A1%E7%BD%91%E6%A0%BC%E5%85%A5%E9%97%A8-%E7%81%B0%E5%BA%A6%E5%8F%91%E5%B8%83/"/>
    <id>https://sreok.cn/2024/12/11/%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91istio%E6%9C%8D%E5%8A%A1%E7%BD%91%E6%A0%BC%E5%85%A5%E9%97%A8-%E7%81%B0%E5%BA%A6%E5%8F%91%E5%B8%83/</id>
    <published>2024-12-11T09:06:03.000Z</published>
    <updated>2025-09-13T12:28:37.460Z</updated>
    
    <content type="html"><![CDATA[<p>官方文档：<a href="https://istio.io/latest/zh/docs/tasks/traffic-management/traffic-shifting/"><em>Istio &#x2F; 流量转移</em></a></p><p>前提条件：</p><ul><li>微服务使用deployment+service部署到集群</li></ul><h3 id="1、配置命名空间自动注入sidecar"><a href="#1、配置命名空间自动注入sidecar" class="headerlink" title="1、配置命名空间自动注入sidecar"></a><strong>1、配置命名空间自动注入sidecar</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl label namespace default istio-injection=enabled</span><br></pre></td></tr></table></figure><p>我这里使用istio官方提供的bookinfo程序演示</p><h3 id="2、部署bookinfo示例程序"><a href="#2、部署bookinfo示例程序" class="headerlink" title="2、部署bookinfo示例程序"></a><strong>2、部署bookinfo示例程序</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; bookinfo.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: details</span><br><span class="line">  labels:</span><br><span class="line">    app: details</span><br><span class="line">    service: details</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 9080</span><br><span class="line">    name: http</span><br><span class="line">  selector:</span><br><span class="line">    app: details</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: bookinfo-details</span><br><span class="line">  labels:</span><br><span class="line">    account: details</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: details-v1</span><br><span class="line">  labels:</span><br><span class="line">    app: details</span><br><span class="line">    version: v1</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: details</span><br><span class="line">      version: v1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: details</span><br><span class="line">        version: v1</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: bookinfo-details</span><br><span class="line">      containers:</span><br><span class="line">      - name: details</span><br><span class="line">        image: docker.io/istio/examples-bookinfo-details-v1:1.18.0</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9080</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: ratings</span><br><span class="line">  labels:</span><br><span class="line">    app: ratings</span><br><span class="line">    service: ratings</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 9080</span><br><span class="line">    name: http</span><br><span class="line">  selector:</span><br><span class="line">    app: ratings</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: bookinfo-ratings</span><br><span class="line">  labels:</span><br><span class="line">    account: ratings</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: ratings-v1</span><br><span class="line">  labels:</span><br><span class="line">    app: ratings</span><br><span class="line">    version: v1</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: ratings</span><br><span class="line">      version: v1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: ratings</span><br><span class="line">        version: v1</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: bookinfo-ratings</span><br><span class="line">      containers:</span><br><span class="line">      - name: ratings</span><br><span class="line">        image: docker.io/istio/examples-bookinfo-ratings-v1:1.18.0</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9080</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: reviews</span><br><span class="line">  labels:</span><br><span class="line">    app: reviews</span><br><span class="line">    service: reviews</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 9080</span><br><span class="line">    name: http</span><br><span class="line">  selector:</span><br><span class="line">    app: reviews</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: bookinfo-reviews</span><br><span class="line">  labels:</span><br><span class="line">    account: reviews</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: reviews-v1</span><br><span class="line">  labels:</span><br><span class="line">    app: reviews</span><br><span class="line">    version: v1</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: reviews</span><br><span class="line">      version: v1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: reviews</span><br><span class="line">        version: v1</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: bookinfo-reviews</span><br><span class="line">      containers:</span><br><span class="line">      - name: reviews</span><br><span class="line">        image: docker.io/istio/examples-bookinfo-reviews-v1:1.18.0</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        env:</span><br><span class="line">        - name: LOG_DIR</span><br><span class="line">          value: &quot;/tmp/logs&quot;</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9080</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: tmp</span><br><span class="line">          mountPath: /tmp</span><br><span class="line">        - name: wlp-output</span><br><span class="line">          mountPath: /opt/ibm/wlp/output</span><br><span class="line">      volumes:</span><br><span class="line">      - name: wlp-output</span><br><span class="line">        emptyDir: &#123;&#125;</span><br><span class="line">      - name: tmp</span><br><span class="line">        emptyDir: &#123;&#125;</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: reviews-v2</span><br><span class="line">  labels:</span><br><span class="line">    app: reviews</span><br><span class="line">    version: v2</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: reviews</span><br><span class="line">      version: v2</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: reviews</span><br><span class="line">        version: v2</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: bookinfo-reviews</span><br><span class="line">      containers:</span><br><span class="line">      - name: reviews</span><br><span class="line">        image: docker.io/istio/examples-bookinfo-reviews-v2:1.18.0</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        env:</span><br><span class="line">        - name: LOG_DIR</span><br><span class="line">          value: &quot;/tmp/logs&quot;</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9080</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: tmp</span><br><span class="line">          mountPath: /tmp</span><br><span class="line">        - name: wlp-output</span><br><span class="line">          mountPath: /opt/ibm/wlp/output</span><br><span class="line">      volumes:</span><br><span class="line">      - name: wlp-output</span><br><span class="line">        emptyDir: &#123;&#125;</span><br><span class="line">      - name: tmp</span><br><span class="line">        emptyDir: &#123;&#125;</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: reviews-v3</span><br><span class="line">  labels:</span><br><span class="line">    app: reviews</span><br><span class="line">    version: v3</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: reviews</span><br><span class="line">      version: v3</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: reviews</span><br><span class="line">        version: v3</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: bookinfo-reviews</span><br><span class="line">      containers:</span><br><span class="line">      - name: reviews</span><br><span class="line">        image: docker.io/istio/examples-bookinfo-reviews-v3:1.18.0</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        env:</span><br><span class="line">        - name: LOG_DIR</span><br><span class="line">          value: &quot;/tmp/logs&quot;</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9080</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: tmp</span><br><span class="line">          mountPath: /tmp</span><br><span class="line">        - name: wlp-output</span><br><span class="line">          mountPath: /opt/ibm/wlp/output</span><br><span class="line">      volumes:</span><br><span class="line">      - name: wlp-output</span><br><span class="line">        emptyDir: &#123;&#125;</span><br><span class="line">      - name: tmp</span><br><span class="line">        emptyDir: &#123;&#125;</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: productpage</span><br><span class="line">  labels:</span><br><span class="line">    app: productpage</span><br><span class="line">    service: productpage</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 9080</span><br><span class="line">    name: http</span><br><span class="line">  selector:</span><br><span class="line">    app: productpage</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: bookinfo-productpage</span><br><span class="line">  labels:</span><br><span class="line">    account: productpage</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: productpage-v1</span><br><span class="line">  labels:</span><br><span class="line">    app: productpage</span><br><span class="line">    version: v1</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: productpage</span><br><span class="line">      version: v1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      annotations:</span><br><span class="line">        prometheus.io/scrape: &quot;true&quot;</span><br><span class="line">        prometheus.io/port: &quot;9080&quot;</span><br><span class="line">        prometheus.io/path: &quot;/metrics&quot;</span><br><span class="line">      labels:</span><br><span class="line">        app: productpage</span><br><span class="line">        version: v1</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: bookinfo-productpage</span><br><span class="line">      containers:</span><br><span class="line">      - name: productpage</span><br><span class="line">        image: docker.io/istio/examples-bookinfo-productpage-v1:1.18.0</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9080</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: tmp</span><br><span class="line">          mountPath: /tmp</span><br><span class="line">      volumes:</span><br><span class="line">      - name: tmp</span><br><span class="line">        emptyDir: &#123;&#125;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f bookinfo.yaml</span><br></pre></td></tr></table></figure><p><img src="/images/image-jxrm.png"></p><p>所有pod运行时2&#x2F;2即为部署成功，sidecar也以容器形式注入到pod内。</p><h3 id="3、部署网关"><a href="#3、部署网关" class="headerlink" title="3、部署网关"></a><strong>3、部署网关</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; bookinfo-gateway.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: Gateway</span><br><span class="line">metadata:</span><br><span class="line">  name: bookinfo-gateway</span><br><span class="line">spec:</span><br><span class="line">  # The selector matches the ingress gateway pod labels.</span><br><span class="line">  # If you installed Istio using Helm following the standard documentation, this would be &quot;istio=ingress&quot;</span><br><span class="line">  selector:</span><br><span class="line">    istio: ingressgateway # use istio default controller</span><br><span class="line">  servers:</span><br><span class="line">  - port:</span><br><span class="line">      number: 8080</span><br><span class="line">      name: http</span><br><span class="line">      protocol: HTTP</span><br><span class="line">    hosts:</span><br><span class="line">    # 允许所有域名通过gateway</span><br><span class="line">    - &quot;*&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f bookinfo-gateway.yaml</span><br></pre></td></tr></table></figure><h3 id="4、部署前端virtual-service"><a href="#4、部署前端virtual-service" class="headerlink" title="4、部署前端virtual service"></a><strong>4、部署前端virtual service</strong></h3><p>这里的前端指的时发送请求的服务，可以是中间件也可以是后端的接口，我这里使用<code>productpage</code>服务</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; virtual-service-productpage.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: VirtualService</span><br><span class="line">metadata:</span><br><span class="line">  name: bookinfo</span><br><span class="line">spec:</span><br><span class="line">  hosts:</span><br><span class="line">  # 访问时服务使用的域名，*表示允许所有访问</span><br><span class="line">  - &quot;*&quot;</span><br><span class="line">  # 外部访问时需要指定gateways，选择入口网关</span><br><span class="line">  gateways:</span><br><span class="line">  - bookinfo-gateway</span><br><span class="line">  http:</span><br><span class="line">  # 匹配规则</span><br><span class="line">  - match:</span><br><span class="line">    - uri:</span><br><span class="line">        # uri 完全 匹配时走下面路由</span><br><span class="line">        exact: /productpage</span><br><span class="line">    - uri:</span><br><span class="line">        # uri 前缀 匹配时走下面路由</span><br><span class="line">        prefix: /static</span><br><span class="line">    - uri:</span><br><span class="line">        exact: /login</span><br><span class="line">    - uri:</span><br><span class="line">        exact: /logout</span><br><span class="line">    - uri:</span><br><span class="line">        prefix: /api/v1/products</span><br><span class="line">    route:</span><br><span class="line">    # 目标路由</span><br><span class="line">    - destination:</span><br><span class="line">        # service名称</span><br><span class="line">        host: productpage</span><br><span class="line">        # service端口</span><br><span class="line">        port:</span><br><span class="line">          number: 9080</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f virtual-service-productpage.yaml</span><br></pre></td></tr></table></figure><h3 id="5、访问"><a href="#5、访问" class="headerlink" title="5、访问"></a><strong>5、访问</strong></h3><p><img src="/images/image-wfga.png"></p><p>通过istio-ingress服务的外部IP访问<code>http://10.20.12.190/productpage</code>，如果没有部署MetalLB可以使用nodeIP+30271（istio-ingress服务80端口的映射端口）访问<code>http://10.20.12.10:30271/productpage</code></p><p><img src="/images/image-fokw.png"></p><p>访问后刷新页面，发现reviews服务时每次刷新都会请求不同的版本，这是因为后端服务还没有被纳管，此时的请求是通过<code>productpage</code>请求reviews服务的service返回的</p><h3 id="6、创建目标规则"><a href="#6、创建目标规则" class="headerlink" title="6、创建目标规则"></a><strong>6、创建目标规则</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; destination-rule-all.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: DestinationRule</span><br><span class="line">metadata:</span><br><span class="line">  name: productpage</span><br><span class="line">spec:</span><br><span class="line">  host: productpage</span><br><span class="line">  subsets:</span><br><span class="line">  - name: v1</span><br><span class="line">    labels:</span><br><span class="line">      version: v1</span><br><span class="line">---</span><br><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: DestinationRule</span><br><span class="line">metadata:</span><br><span class="line">  name: reviews</span><br><span class="line">spec:</span><br><span class="line">  host: reviews</span><br><span class="line">  subsets:</span><br><span class="line">  - name: v1</span><br><span class="line">    labels:</span><br><span class="line">      version: v1</span><br><span class="line">  - name: v2</span><br><span class="line">    labels:</span><br><span class="line">      version: v2</span><br><span class="line">  - name: v3</span><br><span class="line">    labels:</span><br><span class="line">      version: v3</span><br><span class="line">---</span><br><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: DestinationRule</span><br><span class="line">metadata:</span><br><span class="line">  name: ratings</span><br><span class="line">spec:</span><br><span class="line">  host: ratings</span><br><span class="line">  subsets:</span><br><span class="line">  - name: v1</span><br><span class="line">    labels:</span><br><span class="line">      version: v1</span><br><span class="line">  - name: v2</span><br><span class="line">    labels:</span><br><span class="line">      version: v2</span><br><span class="line">  - name: v2-mysql</span><br><span class="line">    labels:</span><br><span class="line">      version: v2-mysql</span><br><span class="line">  - name: v2-mysql-vm</span><br><span class="line">    labels:</span><br><span class="line">      version: v2-mysql-vm</span><br><span class="line">---</span><br><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: DestinationRule</span><br><span class="line">metadata:</span><br><span class="line">  name: details</span><br><span class="line">spec:</span><br><span class="line">  host: details</span><br><span class="line">  subsets:</span><br><span class="line">  - name: v1</span><br><span class="line">    labels:</span><br><span class="line">      version: v1</span><br><span class="line">  - name: v2</span><br><span class="line">    labels:</span><br><span class="line">      version: v2</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f destination-rule-all.yaml</span><br></pre></td></tr></table></figure><p>此时将所有服务都设置了规则，按照pod label为version 的识别出来，这一步并不会对请求发生变化，这是为了方便后面调整变化时使用的。</p><h3 id="7、创建后端virtual-service"><a href="#7、创建后端virtual-service" class="headerlink" title="7、创建后端virtual service"></a><strong>7、创建后端virtual service</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; virtual-service-all-v1.yaml &lt;&lt;EOF</span><br><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: VirtualService</span><br><span class="line">metadata:</span><br><span class="line">  name: productpage</span><br><span class="line">spec:</span><br><span class="line">  hosts:</span><br><span class="line">  - productpage</span><br><span class="line">  http:</span><br><span class="line">  - route:</span><br><span class="line">    - destination:</span><br><span class="line">        host: productpage</span><br><span class="line">        subset: v1</span><br><span class="line">---</span><br><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: VirtualService</span><br><span class="line">metadata:</span><br><span class="line">  name: reviews</span><br><span class="line">spec:</span><br><span class="line">  hosts:</span><br><span class="line">  - reviews</span><br><span class="line">  http:</span><br><span class="line">  - route:</span><br><span class="line">    - destination:</span><br><span class="line">        host: reviews</span><br><span class="line">        subset: v1</span><br><span class="line">---</span><br><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: VirtualService</span><br><span class="line">metadata:</span><br><span class="line">  name: ratings</span><br><span class="line">spec:</span><br><span class="line">  hosts:</span><br><span class="line">  - ratings</span><br><span class="line">  http:</span><br><span class="line">  - route:</span><br><span class="line">    - destination:</span><br><span class="line">        host: ratings</span><br><span class="line">        subset: v1</span><br><span class="line">---</span><br><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: VirtualService</span><br><span class="line">metadata:</span><br><span class="line">  name: details</span><br><span class="line">spec:</span><br><span class="line">  hosts:</span><br><span class="line">  - details</span><br><span class="line">  http:</span><br><span class="line">  - route:</span><br><span class="line">    - destination:</span><br><span class="line">        host: details</span><br><span class="line">        subset: v1</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f virtual-service-all-v1.yaml</span><br></pre></td></tr></table></figure><p>此时后端服务都被istio纳管，并将路由目标指向v1版本，现在不管怎么请求，reviews服务都是v1版本</p><p><img src="/images/image-nqyu.png"></p><h3 id="8、灰度发布"><a href="#8、灰度发布" class="headerlink" title="8、灰度发布"></a><strong>8、灰度发布</strong></h3><p>之前的操作都是为了能模拟一个正常使用的业务，并将服务通过istio的virtual service管理，接下来才是灰度发布的操作</p><p>要升级Review服务从v1到v2版本，首先部署这个deployment，这个demo中已经部署了，并且之前访问时也看到了</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; virtual-service-reviews.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: VirtualService</span><br><span class="line">metadata:</span><br><span class="line">  name: reviews</span><br><span class="line">spec:</span><br><span class="line">  hosts:</span><br><span class="line">    - reviews</span><br><span class="line">  http:</span><br><span class="line">  - route:</span><br><span class="line">    - destination:</span><br><span class="line">        host: reviews</span><br><span class="line">        subset: v1</span><br><span class="line">      weight: 80</span><br><span class="line">    - destination:</span><br><span class="line">        host: reviews</span><br><span class="line">        subset: v2</span><br><span class="line">      weight: 20</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f virtual-service-reviews.yaml</span><br></pre></td></tr></table></figure><p>再次刷新页面模拟请求，发现80%的流量在v1，20%流量分配到v2</p><p>在kiali中也可以看到流量分配情况</p><p><img src="/images/image-scse.png"></p><p>运行一段时间再次调整v2流量的比例直到100%流量到v2，这时可以下线v1版本。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;官方文档：&lt;a href=&quot;https://istio.io/latest/zh/docs/tasks/traffic-management/traffic-shifting/&quot;&gt;&lt;em&gt;Istio &amp;#x2F; 流量转移&lt;/em&gt;&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;前提条件：&lt;/p&gt;</summary>
      
    
    
    
    
    <category term="istio" scheme="https://sreok.cn/tags/istio/"/>
    
  </entry>
  
  <entry>
    <title>【云原生】istio服务网格入门-流量熔断</title>
    <link href="https://sreok.cn/2024/12/10/%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91istio%E6%9C%8D%E5%8A%A1%E7%BD%91%E6%A0%BC%E5%85%A5%E9%97%A8-%E6%B5%81%E9%87%8F%E7%86%94%E6%96%AD/"/>
    <id>https://sreok.cn/2024/12/10/%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91istio%E6%9C%8D%E5%8A%A1%E7%BD%91%E6%A0%BC%E5%85%A5%E9%97%A8-%E6%B5%81%E9%87%8F%E7%86%94%E6%96%AD/</id>
    <published>2024-12-10T09:06:03.000Z</published>
    <updated>2025-09-13T12:28:37.318Z</updated>
    
    <content type="html"><![CDATA[<p>前提条件：</p><ul><li>部署服务（deployment、service）并注入sidecar</li></ul><p>我这里还是使用官方提供的bookinfo程序，选择productpage作为熔断目标</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f - &lt;&lt; EOF</span><br><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: DestinationRule</span><br><span class="line">metadata:</span><br><span class="line">  name: productpage</span><br><span class="line">spec:</span><br><span class="line">  host: productpage</span><br><span class="line">  subsets:</span><br><span class="line">  - name: v1</span><br><span class="line">    labels:</span><br><span class="line">      version: v1</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><blockquote><p>在之前的文档中，设置了目标路由的subset，使virtual service能够识别版本，本文中流量熔断是基于目标路由配置的设置。</p></blockquote><h3 id="测试工具"><a href="#测试工具" class="headerlink" title="测试工具"></a><strong>测试工具</strong></h3><p>这是一个名为 <a href="https://github.com/istio/fortio"><em>Fortio</em></a> 的负载测试客户端， 它可以控制连接数、并发数及发送 HTTP 请求的延迟。 通过 Fortio 能够有效的触发前面在 <code>DestinationRule</code> 中设置的熔断策略</p><p><code>注意：Fortio也需要注入sidecar</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f - &lt;&lt; EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: fortio</span><br><span class="line">  labels:</span><br><span class="line">    app: fortio</span><br><span class="line">    service: fortio</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 8080</span><br><span class="line">    name: http</span><br><span class="line">  selector:</span><br><span class="line">    app: fortio</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: fortio-deploy</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: fortio</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      annotations:</span><br><span class="line">        # This annotation causes Envoy to serve cluster.outbound statistics via 15000/stats</span><br><span class="line">        # in addition to the stats normally served by Istio. The Circuit Breaking example task</span><br><span class="line">        # gives an example of inspecting Envoy stats via proxy config.</span><br><span class="line">        proxy.istio.io/config: |-</span><br><span class="line">          proxyStatsMatcher:</span><br><span class="line">            inclusionPrefixes:</span><br><span class="line">            - &quot;cluster.outbound&quot;</span><br><span class="line">            - &quot;cluster_manager&quot;</span><br><span class="line">            - &quot;listener_manager&quot;</span><br><span class="line">            - &quot;server&quot;</span><br><span class="line">            - &quot;cluster.xds-grpc&quot;</span><br><span class="line">      labels:</span><br><span class="line">        app: fortio</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: fortio</span><br><span class="line">        image: fortio/fortio:latest_release</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">          name: http-fortio</span><br><span class="line">        - containerPort: 8079</span><br><span class="line">          name: grpc-ping</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="测试并发数"><a href="#测试并发数" class="headerlink" title="测试并发数"></a><strong>测试并发数</strong></h3><ol><li><p>获取Fortio pod名称</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export FORTIO_POD=$(kubectl get pods -l app=fortio -o &#x27;jsonpath=&#123;.items[0].metadata.name&#125;&#x27;)</span><br></pre></td></tr></table></figure></li><li><p>测试并发</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec &quot;$FORTIO_POD&quot; -c fortio -- /usr/bin/fortio load -c 10 -qps 0 -n 1 -loglevel Warning http://productpage:9080/productpage</span><br></pre></td></tr></table></figure><blockquote><p>-c ： 每次连接的并发连接数</p><p>-n ： 发送连接次数</p></blockquote><p><img src="/images/image-mdhb.png"></p></li></ol><h3 id="配置Destination-Rule"><a href="#配置Destination-Rule" class="headerlink" title="配置Destination Rule"></a><strong>配置Destination Rule</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f - &lt;&lt;EOF</span><br><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: DestinationRule</span><br><span class="line">metadata:</span><br><span class="line">  name: productpage</span><br><span class="line">spec:</span><br><span class="line">  host: productpage</span><br><span class="line">  subsets:</span><br><span class="line">  - name: v1</span><br><span class="line">    labels:</span><br><span class="line">      version: v1</span><br><span class="line">  # 以下是新增的流量策略</span><br><span class="line">  trafficPolicy:</span><br><span class="line">    # 设置连接池</span><br><span class="line">    connectionPool:</span><br><span class="line">      tcp:</span><br><span class="line">        # tcp最大链接数为1</span><br><span class="line">        maxConnections: 1</span><br><span class="line">      http:</span><br><span class="line">        # http最大等待请求数为1</span><br><span class="line">        http1MaxPendingRequests: 1</span><br><span class="line">        # 每个连接的最大请求数为1</span><br><span class="line">        maxRequestsPerConnection: 1</span><br><span class="line">    # 异常检测，用于自动检测并排除异常的服务实例</span><br><span class="line">    outlierDetection:</span><br><span class="line">      # 连续的 5xx 错误计数，当达到这个阈值时，实例会被标记为异常</span><br><span class="line">      consecutive5xxErrors: 1</span><br><span class="line">      # 检测的时间窗口，这里是每秒检测一次</span><br><span class="line">      interval: 1s</span><br><span class="line">      # 基础排除时间，当实例被标记为异常后，它会在这段时间内被排除，这里是 3 分钟</span><br><span class="line">      baseEjectionTime: 3m</span><br><span class="line">      # 允许被排除的最大实例百分比，这里是 100%，意味着所有实例都可能被排除</span><br><span class="line">      maxEjectionPercent: 100</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="再次测试"><a href="#再次测试" class="headerlink" title="再次测试"></a><strong>再次测试</strong></h3><ol><li><p>获取Fortio pod名称</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export FORTIO_POD=$(kubectl get pods -l app=fortio -o &#x27;jsonpath=&#123;.items[0].metadata.name&#125;&#x27;)</span><br></pre></td></tr></table></figure></li><li><p>测试并发</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec &quot;$FORTIO_POD&quot; -c fortio -- /usr/bin/fortio load -c 10 -qps 0 -n 1 -loglevel Warning http://productpage:9080/productpage</span><br></pre></td></tr></table></figure></li></ol><p><img src="/images/image-ugvn.png"></p><p><img src="/images/image-eonx.png"></p><blockquote><p>istio-proxy 允许存在一些误差，所以偶尔会出现拦截9个请求偶尔拦截8个请求，这与各种因素有关，只需要关心大概范围即可。</p></blockquote><h4 id="查看详细熔断日志"><a href="#查看详细熔断日志" class="headerlink" title="查看详细熔断日志"></a>查看详细熔断日志</h4><p>多次并发测试后可以通过日志了解更多熔断详情</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl exec &quot;$FORTIO_POD&quot; -c istio-proxy -- pilot-agent request GET stats | grep productpage | grep pending</span><br></pre></td></tr></table></figure><p><img src="/images/image-mzti.png"></p><blockquote><p>其中110个被请求标记为熔断，20个请求通过</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;前提条件：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;部署服务（deployment、service）并注入sidecar&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;我这里还是使用官方提供的bookinfo程序，选择productpage作为熔断目标&lt;/p&gt;
&lt;figure class=&quot;highlig</summary>
      
    
    
    
    
    <category term="istio" scheme="https://sreok.cn/tags/istio/"/>
    
  </entry>
  
  <entry>
    <title>【云原生】istio服务网格入门-流量镜像</title>
    <link href="https://sreok.cn/2024/12/08/%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91istio%E6%9C%8D%E5%8A%A1%E7%BD%91%E6%A0%BC%E5%85%A5%E9%97%A8-%E6%B5%81%E9%87%8F%E9%95%9C%E5%83%8F/"/>
    <id>https://sreok.cn/2024/12/08/%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91istio%E6%9C%8D%E5%8A%A1%E7%BD%91%E6%A0%BC%E5%85%A5%E9%97%A8-%E6%B5%81%E9%87%8F%E9%95%9C%E5%83%8F/</id>
    <published>2024-12-08T09:06:03.000Z</published>
    <updated>2025-09-13T12:28:37.388Z</updated>
    
    <content type="html"><![CDATA[<p>官方文档：<a href="https://istio.io/latest/zh/docs/tasks/traffic-management/mirroring/"><em>Istio &#x2F; 镜像</em></a></p><h3 id="启动httpbin服务（演示服务）"><a href="#启动httpbin服务（演示服务）" class="headerlink" title="启动httpbin服务（演示服务）"></a><strong>启动httpbin服务（演示服务）</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># v1版本</span><br><span class="line">cat &lt;&lt;EOF | istioctl kube-inject -f - | kubectl create -f -</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: httpbin-v1</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: httpbin</span><br><span class="line">      version: v1</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: httpbin</span><br><span class="line">        version: v1</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: docker.io/kennethreitz/httpbin</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        name: httpbin</span><br><span class="line">        command: [&quot;gunicorn&quot;, &quot;--access-logfile&quot;, &quot;-&quot;, &quot;-b&quot;, &quot;0.0.0.0:80&quot;, &quot;httpbin:app&quot;]</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># v2版本</span><br><span class="line">cat &lt;&lt;EOF | istioctl kube-inject -f - | kubectl create -f -</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: httpbin-v2</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: httpbin</span><br><span class="line">      version: v2</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: httpbin</span><br><span class="line">        version: v2</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: docker.io/kennethreitz/httpbin</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        name: httpbin</span><br><span class="line">        command: [&quot;gunicorn&quot;, &quot;--access-logfile&quot;, &quot;-&quot;, &quot;-b&quot;, &quot;0.0.0.0:80&quot;, &quot;httpbin:app&quot;]</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="创建服务"><a href="#创建服务" class="headerlink" title="创建服务"></a><strong>创建服务</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f - &lt;&lt;EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: httpbin</span><br><span class="line">  labels:</span><br><span class="line">    app: httpbin</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - name: http</span><br><span class="line">    port: 8000</span><br><span class="line">    targetPort: 80</span><br><span class="line">  selector:</span><br><span class="line">    app: httpbin</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="创建网关"><a href="#创建网关" class="headerlink" title="创建网关"></a><strong>创建网关</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f - &lt;&lt;EOF</span><br><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: Gateway</span><br><span class="line">metadata:</span><br><span class="line">  name: httpbin-gw</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: httpbin</span><br><span class="line">  servers:</span><br><span class="line">  - port:</span><br><span class="line">      number: 80</span><br><span class="line">      name: http</span><br><span class="line">      protocol: HTTP</span><br><span class="line">    hosts:</span><br><span class="line">    - &quot;*&quot;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="创建目标规则"><a href="#创建目标规则" class="headerlink" title="创建目标规则"></a><strong>创建目标规则</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f - &lt;&lt;EOF</span><br><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: DestinationRule</span><br><span class="line">metadata:</span><br><span class="line">  name: httpbin</span><br><span class="line">spec:</span><br><span class="line">  host: httpbin</span><br><span class="line">  subsets:</span><br><span class="line">  - name: v1</span><br><span class="line">    labels:</span><br><span class="line">      version: v1</span><br><span class="line">  - name: v2</span><br><span class="line">    labels:</span><br><span class="line">      version: v2</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h3 id="创建虚拟服务"><a href="#创建虚拟服务" class="headerlink" title="创建虚拟服务"></a><strong>创建虚拟服务</strong></h3><p>将流量全部转发到v1版本</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f - &lt;&lt;EOF</span><br><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: VirtualService</span><br><span class="line">metadata:</span><br><span class="line">  name: httpbin</span><br><span class="line">spec:</span><br><span class="line">  gateways:</span><br><span class="line">  - bookinfo-gateway</span><br><span class="line">  hosts:</span><br><span class="line">  - &quot;*&quot;</span><br><span class="line">  http:</span><br><span class="line">  - match:</span><br><span class="line">    - uri:</span><br><span class="line">        exact: /headers</span><br><span class="line">    route:</span><br><span class="line">    - destination:</span><br><span class="line">        host: httpbin</span><br><span class="line">        subset: v1</span><br><span class="line">      weight: 100</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="浏览器访问"><a href="#浏览器访问" class="headerlink" title="浏览器访问"></a>浏览器访问</h4><p><img src="/images/image-tjnh.png"></p><h3 id="流量镜像"><a href="#流量镜像" class="headerlink" title="流量镜像"></a><strong>流量镜像</strong></h3><p>将转发到v1的流量克隆一份到v2版本</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f - &lt;&lt;EOF</span><br><span class="line">apiVersion: networking.istio.io/v1alpha3</span><br><span class="line">kind: VirtualService</span><br><span class="line">metadata:</span><br><span class="line">  name: httpbin</span><br><span class="line">spec:</span><br><span class="line">  gateways:</span><br><span class="line">  - bookinfo-gateway</span><br><span class="line">  hosts:</span><br><span class="line">  - &quot;*&quot;</span><br><span class="line">  http:</span><br><span class="line">  - match:</span><br><span class="line">    - uri:</span><br><span class="line">        exact: /headers</span><br><span class="line">    route:</span><br><span class="line">    - destination:</span><br><span class="line">        host: httpbin</span><br><span class="line">        subset: v1</span><br><span class="line">      weight: 100</span><br><span class="line">    mirror:</span><br><span class="line">      # 镜像目标</span><br><span class="line">      host: httpbin</span><br><span class="line">      subset: v2</span><br><span class="line">    # 镜像比例100%</span><br><span class="line">    mirrorPercentage:</span><br><span class="line">      value: 100.0</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><h4 id="再次访问"><a href="#再次访问" class="headerlink" title="再次访问"></a>再次访问</h4><p><img src="/images/image-hvnz.png"></p><blockquote><p>重点注意这些被镜像的流量是『即发即弃』的，就是说镜像请求的响应会被丢弃，服务响应还是v1版本的</p></blockquote>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;官方文档：&lt;a href=&quot;https://istio.io/latest/zh/docs/tasks/traffic-management/mirroring/&quot;&gt;&lt;em&gt;Istio &amp;#x2F; 镜像&lt;/em&gt;&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;启动httpbin服务（演</summary>
      
    
    
    
    
    <category term="istio" scheme="https://sreok.cn/tags/istio/"/>
    
  </entry>
  
  <entry>
    <title>【云原生】Kubernetes部署Zookeeper v3.9 + Kafka v3.7.0 集群 （manifest方式）</title>
    <link href="https://sreok.cn/2024/09/02/%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91Kubernetes%E9%83%A8%E7%BD%B2Zookeeper%20v3.9%20+%20Kafka%20v3.7.0%20%E9%9B%86%E7%BE%A4%20%EF%BC%88manifest%E6%96%B9%E5%BC%8F%EF%BC%89/"/>
    <id>https://sreok.cn/2024/09/02/%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91Kubernetes%E9%83%A8%E7%BD%B2Zookeeper%20v3.9%20+%20Kafka%20v3.7.0%20%E9%9B%86%E7%BE%A4%20%EF%BC%88manifest%E6%96%B9%E5%BC%8F%EF%BC%89/</id>
    <published>2024-09-02T09:06:03.000Z</published>
    <updated>2025-09-13T12:28:38.810Z</updated>
    
    <content type="html"><![CDATA[<h3 id="部署zookeeper（三节点）"><a href="#部署zookeeper（三节点）" class="headerlink" title="部署zookeeper（三节点）"></a>部署zookeeper（三节点）</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: zookeeper-headless</span><br><span class="line">  namespace: kafka</span><br><span class="line">  labels:</span><br><span class="line">    app: zookeeper</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">    - port: 2181</span><br><span class="line">      name: client</span><br><span class="line">    - port: 2888</span><br><span class="line">      name: fllower</span><br><span class="line">    - port: 3888</span><br><span class="line">      name: election</span><br><span class="line">  clusterIP: None</span><br><span class="line">  selector:</span><br><span class="line">    app: zookeeper</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: zookeeper-adminserver</span><br><span class="line">  namespace: kafka</span><br><span class="line">  labels:</span><br><span class="line">    app: zookeeper</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort</span><br><span class="line">  ports:</span><br><span class="line">    - port: 8080</span><br><span class="line">      name: adminserver</span><br><span class="line">      nodePort: 31801</span><br><span class="line">  selector:</span><br><span class="line">    app: zookeeper</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ConfigMap</span><br><span class="line">metadata:</span><br><span class="line">  name: zookeeper-config</span><br><span class="line">  namespace: kafka</span><br><span class="line">  labels:</span><br><span class="line">    app: zookeeper</span><br><span class="line">data:</span><br><span class="line">  zoo.cfg: |+</span><br><span class="line">    tickTime=2000</span><br><span class="line">    initLimit=10</span><br><span class="line">    syncLimit=5</span><br><span class="line">    dataDir=/data</span><br><span class="line">    dataLogDir=/datalog</span><br><span class="line">    clientPort=2181</span><br><span class="line">    server.1=zookeeper-0.zookeeper-headless.kafka.svc.cluster.local:2888:3888</span><br><span class="line">    server.2=zookeeper-1.zookeeper-headless.kafka.svc.cluster.local:2888:3888</span><br><span class="line">    server.3=zookeeper-2.zookeeper-headless.kafka.svc.cluster.local:2888:3888</span><br><span class="line">    4lw.commands.whitelist=*</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: zookeeper</span><br><span class="line">  namespace: kafka</span><br><span class="line">spec:</span><br><span class="line">  serviceName: &quot;zookeeper-headless&quot;</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: zookeeper</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: zookeeper</span><br><span class="line">    spec:</span><br><span class="line">      initContainers:</span><br><span class="line">      - name: set-id</span><br><span class="line">        # 源镜像地址：busybox:latest</span><br><span class="line">        image: harbor.basepoint.net/library/busybox:latest</span><br><span class="line">        command: [&#x27;sh&#x27;, &#x27;-c&#x27;, &quot;hostname | cut -d &#x27;-&#x27; -f 2 | awk &#x27;&#123;print $0 + 1&#125;&#x27; &gt; /data/myid&quot;]</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - name: data</span><br><span class="line">          mountPath: /data</span><br><span class="line">      containers:</span><br><span class="line">      - name: zookeeper</span><br><span class="line">        # 源镜像地址：zookeeper:3.9</span><br><span class="line">        image: harbor.basepoint.net/library/zookeeper:3.9</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            memory: &quot;500Mi&quot;</span><br><span class="line">            cpu: &quot;500m&quot;</span><br><span class="line">          limits:</span><br><span class="line">            memory: &quot;1000Mi&quot;</span><br><span class="line">            cpu: &quot;1000m&quot;</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 2181</span><br><span class="line">          name: client</span><br><span class="line">        - containerPort: 2888</span><br><span class="line">          name: fllower</span><br><span class="line">        - containerPort: 3888</span><br><span class="line">          name: election</span><br><span class="line">        volumeMounts:</span><br><span class="line">          - name: zook-config</span><br><span class="line">            mountPath: /conf/zoo.cfg</span><br><span class="line">            subPath: zoo.cfg</span><br><span class="line">          - name: data</span><br><span class="line">            mountPath: /data</span><br><span class="line">        env:</span><br><span class="line">        - name: MY_POD_NAME</span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: metadata.name</span><br><span class="line">      volumes:</span><br><span class="line">      - name: zook-config</span><br><span class="line">        configMap:</span><br><span class="line">          name: zookeeper-config</span><br><span class="line">  volumeClaimTemplates:</span><br><span class="line">    - metadata:</span><br><span class="line">        name: data</span><br><span class="line">      spec:</span><br><span class="line">        accessModes: [&quot;ReadWriteMany&quot;]</span><br><span class="line">        storageClassName: longhorn</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            storage: 10Gi</span><br></pre></td></tr></table></figure><h3 id="部署Kafka（三节点）"><a href="#部署Kafka（三节点）" class="headerlink" title="部署Kafka（三节点）"></a>部署Kafka（三节点）</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: kafka-headless</span><br><span class="line">  namespace: kafka</span><br><span class="line">  labels:</span><br><span class="line">    app: kafka</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">    - port: 9092</span><br><span class="line">      name: server</span><br><span class="line">  clusterIP: None</span><br><span class="line">  selector:</span><br><span class="line">    app: kafka</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: kafka</span><br><span class="line">  namespace: kafka</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort</span><br><span class="line">  selector:</span><br><span class="line">    app: kafka</span><br><span class="line">  ports:</span><br><span class="line">    - protocol: TCP</span><br><span class="line">      port: 9092</span><br><span class="line">      targetPort: 9092</span><br><span class="line">      nodePort: 30092</span><br><span class="line">      name: bootstrap</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: kafka</span><br><span class="line">  namespace: kafka</span><br><span class="line">spec:</span><br><span class="line">  serviceName: &quot;kafka-headless&quot;</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: kafka</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: kafka</span><br><span class="line">    spec:</span><br><span class="line">      affinity:</span><br><span class="line">        podAntiAffinity:</span><br><span class="line">          preferredDuringSchedulingIgnoredDuringExecution:</span><br><span class="line">          - weight: 1</span><br><span class="line">            podAffinityTerm:</span><br><span class="line">              labelSelector:</span><br><span class="line">                matchExpressions:</span><br><span class="line">                  - key: &quot;app&quot;</span><br><span class="line">                    operator: In</span><br><span class="line">                    values:</span><br><span class="line">                      - kafka</span><br><span class="line">              topologyKey: &quot;kubernetes.io/hostname&quot;</span><br><span class="line">      securityContext:</span><br><span class="line">        runAsUser: 0</span><br><span class="line">      containers:</span><br><span class="line">      - name: kafka</span><br><span class="line">        # 源镜像地址：apache/kafka:3.7.0</span><br><span class="line">        image: harbor.basepoint.net/library/kafka:3.7.0</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            memory: &quot;500Mi&quot;</span><br><span class="line">            cpu: &quot;500m&quot;</span><br><span class="line">          limits:</span><br><span class="line">            memory: &quot;1000Mi&quot;</span><br><span class="line">            cpu: &quot;2000m&quot;</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9092</span><br><span class="line">          name: server</span><br><span class="line">        #env:</span><br><span class="line">        #  KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://172.25.2.4:30092</span><br><span class="line">        #  --override advertised.listeners=PLAINTEXT://172.25.2.4:30092 \</span><br><span class="line">        command:</span><br><span class="line">        - sh</span><br><span class="line">        - -c</span><br><span class="line">        - &quot;exec /opt/kafka/bin/kafka-server-start.sh /opt/kafka/config/server.properties --override broker.id=$&#123;HOSTNAME##*-&#125; \</span><br><span class="line">          --override listeners=PLAINTEXT://:9092 \</span><br><span class="line">          --override zookeeper.connect=zookeeper-0.zookeeper-headless:2181,zookeeper-1.zookeeper-headless:2181,zookeeper-2.zookeeper-headless:2181 \</span><br><span class="line">          --override log.dirs=/var/lib/kafka/data/logs \</span><br><span class="line">          --override auto.create.topics.enable=true \</span><br><span class="line">          --override auto.leader.rebalance.enable=true \</span><br><span class="line">          --override background.threads=10 \</span><br><span class="line">          --override compression.type=producer \</span><br><span class="line">          --override delete.topic.enable=true \</span><br><span class="line">          --override leader.imbalance.check.interval.seconds=300 \</span><br><span class="line">          --override leader.imbalance.per.broker.percentage=10 \</span><br><span class="line">          --override log.flush.interval.messages=9223372036854775807 \</span><br><span class="line">          --override log.flush.offset.checkpoint.interval.ms=60000 \</span><br><span class="line">          --override log.flush.scheduler.interval.ms=9223372036854775807 \</span><br><span class="line">          --override log.retention.bytes=-1 \</span><br><span class="line">          --override log.retention.hours=168 \</span><br><span class="line">          --override log.roll.hours=168 \</span><br><span class="line">          --override log.roll.jitter.hours=0 \</span><br><span class="line">          --override log.segment.bytes=1073741824 \</span><br><span class="line">          --override log.segment.delete.delay.ms=60000 \</span><br><span class="line">          --override message.max.bytes=1000012 \</span><br><span class="line">          --override min.insync.replicas=1 \</span><br><span class="line">          --override num.io.threads=8 \</span><br><span class="line">          --override num.network.threads=3 \</span><br><span class="line">          --override num.recovery.threads.per.data.dir=1 \</span><br><span class="line">          --override num.replica.fetchers=1 \</span><br><span class="line">          --override offset.metadata.max.bytes=4096 \</span><br><span class="line">          --override offsets.commit.required.acks=-1 \</span><br><span class="line">          --override offsets.commit.timeout.ms=5000 \</span><br><span class="line">          --override offsets.load.buffer.size=5242880 \</span><br><span class="line">          --override offsets.retention.check.interval.ms=600000 \</span><br><span class="line">          --override offsets.retention.minutes=1440 \</span><br><span class="line">          --override offsets.topic.compression.codec=0 \</span><br><span class="line">          --override offsets.topic.num.partitions=50 \</span><br><span class="line">          --override offsets.topic.replication.factor=3 \</span><br><span class="line">          --override offsets.topic.segment.bytes=104857600 \</span><br><span class="line">          --override queued.max.requests=500 \</span><br><span class="line">          --override quota.consumer.default=9223372036854775807 \</span><br><span class="line">          --override quota.producer.default=9223372036854775807 \</span><br><span class="line">          --override replica.fetch.min.bytes=1 \</span><br><span class="line">          --override replica.fetch.wait.max.ms=500 \</span><br><span class="line">          --override replica.high.watermark.checkpoint.interval.ms=5000 \</span><br><span class="line">          --override replica.lag.time.max.ms=10000 \</span><br><span class="line">          --override replica.socket.receive.buffer.bytes=65536 \</span><br><span class="line">          --override replica.socket.timeout.ms=30000 \</span><br><span class="line">          --override request.timeout.ms=30000 \</span><br><span class="line">          --override socket.receive.buffer.bytes=102400 \</span><br><span class="line">          --override socket.request.max.bytes=104857600 \</span><br><span class="line">          --override socket.send.buffer.bytes=102400 \</span><br><span class="line">          --override unclean.leader.election.enable=true \</span><br><span class="line">          --override zookeeper.session.timeout.ms=6000 \</span><br><span class="line">          --override zookeeper.set.acl=false \</span><br><span class="line">          --override broker.id.generation.enable=true \</span><br><span class="line">          --override connections.max.idle.ms=600000 \</span><br><span class="line">          --override controlled.shutdown.enable=true \</span><br><span class="line">          --override controlled.shutdown.max.retries=3 \</span><br><span class="line">          --override controlled.shutdown.retry.backoff.ms=5000 \</span><br><span class="line">          --override controller.socket.timeout.ms=30000 \</span><br><span class="line">          --override default.replication.factor=1 \</span><br><span class="line">          --override fetch.purgatory.purge.interval.requests=1000 \</span><br><span class="line">          --override group.max.session.timeout.ms=300000 \</span><br><span class="line">          --override group.min.session.timeout.ms=6000 \</span><br><span class="line">          --override log.cleaner.backoff.ms=15000 \</span><br><span class="line">          --override log.cleaner.dedupe.buffer.size=134217728 \</span><br><span class="line">          --override log.cleaner.delete.retention.ms=86400000 \</span><br><span class="line">          --override log.cleaner.enable=true \</span><br><span class="line">          --override log.cleaner.io.buffer.load.factor=0.9 \</span><br><span class="line">          --override log.cleaner.io.buffer.size=524288 \</span><br><span class="line">          --override log.cleaner.io.max.bytes.per.second=1.7976931348623157E308 \</span><br><span class="line">          --override log.cleaner.min.cleanable.ratio=0.5 \</span><br><span class="line">          --override log.cleaner.min.compaction.lag.ms=0 \</span><br><span class="line">          --override log.cleaner.threads=1 \</span><br><span class="line">          --override log.cleanup.policy=delete \</span><br><span class="line">          --override log.index.interval.bytes=4096 \</span><br><span class="line">          --override log.index.size.max.bytes=10485760 \</span><br><span class="line">          --override log.message.timestamp.difference.max.ms=9223372036854775807 \</span><br><span class="line">          --override log.message.timestamp.type=CreateTime \</span><br><span class="line">          --override log.preallocate=false \</span><br><span class="line">          --override log.retention.check.interval.ms=300000 \</span><br><span class="line">          --override max.connections.per.ip=2147483647 \</span><br><span class="line">          --override num.partitions=1 \</span><br><span class="line">          --override producer.purgatory.purge.interval.requests=1000 \</span><br><span class="line">          --override replica.fetch.backoff.ms=1000 \</span><br><span class="line">          --override replica.fetch.max.bytes=1048576 \</span><br><span class="line">          --override replica.fetch.response.max.bytes=10485760 \</span><br><span class="line">          --override reserved.broker.max.id=1000&quot;</span><br><span class="line">        volumeMounts:</span><br><span class="line">          - name: data</span><br><span class="line">            mountPath: /var/lib/kafka/data</span><br><span class="line">        env:</span><br><span class="line">        - name: MY_POD_NAME</span><br><span class="line">          valueFrom:</span><br><span class="line">            fieldRef:</span><br><span class="line">              fieldPath: metadata.name</span><br><span class="line">        - name: ALLOW_PLAINTEXT_LISTENER</span><br><span class="line">          value: &quot;yes&quot;</span><br><span class="line">        - name: KAFKA_HEAP_OPTS</span><br><span class="line">          value : &quot;-Xms1g -Xmx1g&quot;</span><br><span class="line">        - name: KAFKA_OPTS</span><br><span class="line">          value: &quot;-Dlogging.level=INFO&quot;</span><br><span class="line">        - name: JMX_PORT</span><br><span class="line">          value: &quot;5555&quot;</span><br><span class="line">  volumeClaimTemplates:</span><br><span class="line">    - metadata:</span><br><span class="line">        name: data</span><br><span class="line">      spec:</span><br><span class="line">        accessModes: [&quot;ReadWriteOnce&quot;]</span><br><span class="line">        storageClassName: longhorn</span><br><span class="line">        resources:</span><br><span class="line">          requests:</span><br><span class="line">            storage: 10Gi</span><br></pre></td></tr></table></figure><h4 id="检查所有pod启动无报错"><a href="#检查所有pod启动无报错" class="headerlink" title="检查所有pod启动无报错"></a>检查所有pod启动无报错</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-h3c-master01 kafka]# kubectl get pod -n kafka</span><br><span class="line">NAME          READY   STATUS    RESTARTS   AGE</span><br><span class="line">kafka-0       1/1     Running   0          1m</span><br><span class="line">kafka-1       1/1     Running   0          1m</span><br><span class="line">kafka-2       1/1     Running   0          1m</span><br><span class="line">zookeeper-0   1/1     Running   0          7m</span><br><span class="line">zookeeper-1   1/1     Running   0          7m</span><br><span class="line">zookeeper-2   1/1     Running   0          7m</span><br></pre></td></tr></table></figure><h3 id="部署Kafka-eagle可视化"><a href="#部署Kafka-eagle可视化" class="headerlink" title="部署Kafka-eagle可视化"></a>部署Kafka-eagle可视化</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: kafka-eagle</span><br><span class="line">  namespace: kafka</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: kafka-eagle</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: kafka-eagle</span><br><span class="line">    spec:</span><br><span class="line">      restartPolicy: Always</span><br><span class="line">      containers:</span><br><span class="line">          # 源镜像地址：nickzurich/efak:3.0.1</span><br><span class="line">        - image: harbor.basepoint.net/library/efak:3.0.1</span><br><span class="line">          imagePullPolicy: IfNotPresent</span><br><span class="line">          name: kafka-eagle</span><br><span class="line">          env:</span><br><span class="line">            - name: EFAK_CLUSTER_ZK_LIST</span><br><span class="line">              value: zookeeper-0.zookeeper-headless.kafka.svc.cluster.local:2181,zookeeper-1.zookeeper-headless.kafka.svc.cluster.local:2181,zookeeper-2.zookeeper-headless.kafka.svc.cluster.local:2181</span><br><span class="line">          ports:</span><br><span class="line">            - containerPort: 8048</span><br><span class="line">              name: web</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: kafka-eagle</span><br><span class="line">  namespace: kafka</span><br><span class="line">spec:</span><br><span class="line">  type: NodePort</span><br><span class="line">  ports:</span><br><span class="line">    - port: 8048</span><br><span class="line">      targetPort: 8048</span><br><span class="line">      nodePort: 30048</span><br><span class="line">      name: web</span><br><span class="line">  selector:</span><br><span class="line">    app: kafka-eagle</span><br></pre></td></tr></table></figure><h3 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h3><p>登录eagle，http:&#x2F;&#x2F;ip:30048</p><p>账户admin，密码123456</p><p><img src="/images/image-gbbm.png"></p><p><img src="/images/image-wjpu.png"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;部署zookeeper（三节点）&quot;&gt;&lt;a href=&quot;#部署zookeeper（三节点）&quot; class=&quot;headerlink&quot; title=&quot;部署zookeeper（三节点）&quot;&gt;&lt;/a&gt;部署zookeeper（三节点）&lt;/h3&gt;&lt;figure class=&quot;hi</summary>
      
    
    
    
    <category term="云原生" scheme="https://sreok.cn/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/"/>
    
    
    <category term="Kubernetes" scheme="https://sreok.cn/tags/Kubernetes/"/>
    
    <category term="kafka" scheme="https://sreok.cn/tags/kafka/"/>
    
    <category term="Zookeeper" scheme="https://sreok.cn/tags/Zookeeper/"/>
    
  </entry>
  
</feed>
