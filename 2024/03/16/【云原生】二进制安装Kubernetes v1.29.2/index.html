<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Elijah"><title>【云原生】二进制安装Kubernetes v1.29.2 · Elijah</title><meta name="description" content="系统环境配置原文地址：k8s节点系统初始化+内核优化 - (sreok.cn)
k8s基本组件安装可选一：使用Containerd作为Runtime （推荐）原文地址：使用Containerd作为Kubernetes Runtime - (sreok.cn)
可选二：使用docker作为Runtim"><meta name="keywords" content="Elijah博客,Elijah Blog,博客,Elijah,Linux,Kubernetes,Docker,DevOps"><meta content="width=device-width, initial-scale=1.0, maximum-scale=3.0, user-scalable=yes" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/links.css"><link rel="stylesheet" href="/css/search.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/font-awesome/7.0.0/css/all.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><script src="/js/mobile-menu.js"></script><!-- 代码块一键复制功能 - 现代化实现--><script>// 页面加载完成后执行
$(document).ready(function() {
  // 为所有代码块添加复制按钮
  $('.highlight').each(function() {
    // 获取当前代码块元素
    const $highlightBlock = $(this);
    
    // 创建复制按钮
    const $copyBtn = $('<button class="copy-button">复制</button>');
    
    // 设置按钮样式
    $copyBtn.css({
      'position': 'absolute',
      'top': '10px',
      'right': '10px',
      'z-index': '10',
      'background': '#4b5263',
      'color': '#abb2bf',
      'border': 'none',
      'border-radius': '4px',
      'padding': '6px 12px',
      'font-size': '12px',
      'cursor': 'pointer',
      'transition': 'all 0.3s ease'
    });
    
    // 鼠标悬停效果
    $copyBtn.hover(
      function() { $(this).css({ 'background': '#5c6370', 'color': '#e6e6e6' }); },
      function() { $(this).css({ 'background': '#4b5263', 'color': '#abb2bf' }); }
    );
    
    // 将按钮添加到代码块容器
    $highlightBlock.append($copyBtn);
    
    // 添加复制按钮的点击事件
    $copyBtn.on('click', async function() {
      try {
        // 尝试获取代码内容 (兼容不同的代码块结构)
        let codeContent = '';
        const $codeElement = $highlightBlock.find('td.code pre');
        
        if ($codeElement.length) {
          // 使用原生方法确保换行符正确保留
          codeContent = $codeElement[0].innerText;
        } else {
          // 备用选择器，以防结构不同
          const $preElement = $highlightBlock.find('pre');
          if ($preElement.length) {
            codeContent = $preElement[0].innerText;
          }
        }
        
        if (!codeContent) {
          throw new Error('未找到代码内容');
        }
        
        // 使用现代的 Clipboard API 执行复制
        if (navigator.clipboard && window.isSecureContext) {
          // 首选：现代安全上下文
          await navigator.clipboard.writeText(codeContent);
        } else {
          // 降级方案：传统方法
          const textArea = document.createElement('textarea');
          textArea.value = codeContent;
          textArea.style.position = 'fixed';
          textArea.style.left = '-999999px';
          textArea.style.top = '-999999px';
          document.body.appendChild(textArea);
          textArea.focus();
          textArea.select();
          
          try {
            const successful = document.execCommand('copy');
            if (!successful) throw new Error('execCommand failed');
          } finally {
            document.body.removeChild(textArea);
          }
        }
        
        // 显示复制成功反馈
        const originalText = $copyBtn.text();
        $copyBtn.text('已复制！');
        $copyBtn.addClass('copied');
        $copyBtn.css({ 'background': '#10b981', 'color': 'white' });
        
        // 2秒后恢复按钮状态
        setTimeout(function() {
          $copyBtn.text(originalText);
          $copyBtn.removeClass('copied');
          $copyBtn.css({ 'background': '#4b5263', 'color': '#abb2bf' });
        }, 2000);
        
      } catch (err) {
        // 显示复制失败反馈
        $copyBtn.text('复制失败');
        $copyBtn.css({ 'background': '#ef4444', 'color': 'white' });
        
        // 2秒后恢复按钮状态
        setTimeout(function() {
          $copyBtn.text('复制');
          $copyBtn.css({ 'background': '#4b5263', 'color': '#abb2bf' });
        }, 2000);
        
        console.error('复制失败:', err);
      }
    });
  });
});</script><meta name="generator" content="Hexo 7.3.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo.png" style="width:127px;"><h3 title=""><a href="/">Elijah</a></h3><div class="description"><p>Do one thing at a time, and do well</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/sreok"><i class="fa-brands fa-github"></i></a></li><li><a href="mailto:admin@vsoul.cn"><i class="fa fa-envelope"></i></a></li><li><a href="/rss.xml"><i class="fa fa-rss"></i></a></li></ul><div class="footer"><div class="p"> <span>© 2020 - 2025 Elijah All Rights Reserved.</span></div><div class="by_farbox"><span>Technical support provided by </span><a href="https://github.com/sreok" target="_blank">Elijah  </a><span> & </span><a href="https://hexo.io/zh-cn/" target="_blank">Hexo </a></div><div class="beian"><img src="/images/gongan.png" style="height:10px;margin-right: 10px;position: relative;top: 1px;"><a href="https://beian.miit.gov.cn/" target="_blank">冀ICP备2022029112号</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><!-- 汉堡菜单按钮 - 仅在移动设备显示--><div class="mobile-menu-btn"><i class="fa fa-bars"></i></div><!-- 移动设备菜单 - 默认隐藏--><div class="mobile-menu"><div class="nav mobile-nav"><li><a href="/">首页</a></li><li><a href="/archives">归档</a></li><li><a href="/tags">标签</a></li><li><a href="/about">关于</a></li><li><a href="/links">友链</a></li><li><a href="/guestbook">留言</a></li></div><!-- 移动端信息区域 - 移除了头像和搜索按钮，因为它们现在始终显示在导航栏右上角--><div class="mobile-information"><!-- 保留空的信息区域以便保持菜单结构一致--><div></div></div></div><!-- 桌面端导航 - 默认显示--><div class="nav desktop-nav"><li><a href="/">首页</a></li><li><a href="/archives">归档</a></li><li><a href="/tags">标签</a></li><li><a href="/projects">项目</a></li><li><a href="/about">关于</a></li><li><a href="/links">友链</a></li><li><a href="/guestbook">留言</a></li></div><!-- 桌面端信息区域--><div class="information desktop-information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="search_btn"><li><a id="search-button"><i class="fa fa-search"></i></a></li></div><div class="avatar"><img src="/images/favicon.png"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>【云原生】二进制安装Kubernetes v1.29.2</a></h3></div><div class="post-content"><h3 id="系统环境配置"><a href="#系统环境配置" class="headerlink" title="系统环境配置"></a><strong>系统环境配置</strong></h3><p>原文地址：<a href="https://sreok.cn/archives/942c699f-2ad0-428e-809c-9957a2e331ce">k8s节点系统初始化+内核优化 - (</a><a href="http://sreok.cn/">sreok.cn</a><a href="https://sreok.cn/archives/942c699f-2ad0-428e-809c-9957a2e331ce">)</a></p>
<h3 id="k8s基本组件安装"><a href="#k8s基本组件安装" class="headerlink" title="k8s基本组件安装"></a>k8s基本组件安装</h3><h4 id="可选一：使用Containerd作为Runtime-（推荐）"><a href="#可选一：使用Containerd作为Runtime-（推荐）" class="headerlink" title="可选一：使用Containerd作为Runtime （推荐）"></a><strong>可选一：使用Containerd作为Runtime （推荐）</strong></h4><p>原文地址：<a href="https://sreok.cn/archives/4896568f-2a8e-4a1d-bad6-de894920131d">使用Containerd作为Kubernetes Runtime - (</a><a href="http://sreok.cn/">sreok.cn</a><a href="https://sreok.cn/archives/4896568f-2a8e-4a1d-bad6-de894920131d">)</a></p>
<h4 id="可选二：使用docker作为Runtime"><a href="#可选二：使用docker作为Runtime" class="headerlink" title="可选二：使用docker作为Runtime"></a><strong>可选二：使用docker作为Runtime</strong></h4><p>原文地址：<a href="https://sreok.cn/archives/8da2f508-f580-4a8d-9b51-55856a2f7b16">使用Docker作为Kubernetes Runtime - (</a><a href="http://sreok.cn/">sreok.cn</a><a href="https://sreok.cn/archives/8da2f508-f580-4a8d-9b51-55856a2f7b16">)</a></p>
<h3 id="部署etcd集群"><a href="#部署etcd集群" class="headerlink" title="部署etcd集群"></a>部署etcd集群</h3><p>原文地址：<a href="https://sreok.cn/archives/833fedb6-428a-4110-b3c9-56f8480b9de3">etcd 入门 - 二进制部署etcd集群 - (</a><a href="http://sreok.cn/">sreok.cn</a><a href="https://sreok.cn/archives/833fedb6-428a-4110-b3c9-56f8480b9de3">)</a></p>
<h4 id="软链接etcd证书目录"><a href="#软链接etcd证书目录" class="headerlink" title="软链接etcd证书目录"></a><strong>软链接etcd证书目录</strong></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mkdir /etc/kubernetes/pki/etcd</span><br><span class="line">ln -s /etc/etcd/ssl/* /etc/kubernetes/pki/etcd/</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line"># 用于重新加载systemd管理的单位文件。当你新增或修改了某个单位文件（如.service文件、.socket文件等），需要运行该命令来刷新systemd对该文件的配置。</span><br><span class="line"></span><br><span class="line">systemctl enable --now etcd.service</span><br><span class="line"># 启用并立即启动etcd.service单元。etcd.service是etcd守护进程的systemd服务单元。</span><br><span class="line"></span><br><span class="line">systemctl restart etcd.service</span><br><span class="line"># 重启etcd.service单元，即重新启动etcd守护进程。</span><br><span class="line"></span><br><span class="line">systemctl status etcd.service</span><br><span class="line"># etcd.service单元的当前状态，包括运行状态、是否启用等信息。</span><br></pre></td></tr></table></figure>

<h3 id="解压k8s安装包"><a href="#解压k8s安装包" class="headerlink" title="解压k8s安装包"></a><strong>解压k8s安装包</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># 下载安装包</span><br><span class="line"># wget https://dl.k8s.io/v1.29.2/kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">​</span><br><span class="line"># 解压k8s安装文件</span><br><span class="line">tar -xf kubernetes-server-linux-amd64.tar.gz  --strip-components=3 -C /usr/local/bin kubernetes/server/bin/kube&#123;let,ctl,-apiserver,-controller-manager,-scheduler,-proxy&#125;</span><br><span class="line">​</span><br><span class="line"></span><br><span class="line"># 查看/usr/local/bin下内容</span><br><span class="line">ls /usr/local/bin/</span><br><span class="line">containerd               crictl       etcdctl                  kube-proxy</span><br><span class="line">containerd-shim          critest      kube-apiserver           kube-scheduler</span><br><span class="line">containerd-shim-runc-v1  ctd-decoder  kube-controller-manager</span><br><span class="line">containerd-shim-runc-v2  ctr          kubectl</span><br><span class="line">containerd-stress        etcd         kubelet</span><br></pre></td></tr></table></figure>

<h3 id="2-3-2查看版本"><a href="#2-3-2查看版本" class="headerlink" title="2.3.2查看版本"></a><strong>2.3.2查看版本</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]#  kubelet --version</span><br><span class="line">Kubernetes v1.29.2</span><br><span class="line">[root@k8s-master01 ~]# etcdctl version</span><br><span class="line">etcdctl version: 3.5.12</span><br><span class="line">API version: 3.5</span><br><span class="line">[root@k8s-master01 ~]# </span><br></pre></td></tr></table></figure>

<h3 id="2-3-3将组件发送至其他k8s节点"><a href="#2-3-3将组件发送至其他k8s节点" class="headerlink" title="2.3.3将组件发送至其他k8s节点"></a><strong>2.3.3将组件发送至其他k8s节点</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Master=&#x27;k8s-master02 k8s-master03&#x27;</span><br><span class="line">Work=&#x27;k8s-node01 k8s-node02&#x27;</span><br><span class="line">​</span><br><span class="line"># 拷贝master组件</span><br><span class="line">for NODE in $Master; do echo $NODE; scp /usr/local/bin/kube&#123;let,ctl,-apiserver,-controller-manager,-scheduler,-proxy&#125; $NODE:/usr/local/bin/; scp /usr/local/bin/etcd* $NODE:/usr/local/bin/; done</span><br><span class="line">​</span><br><span class="line">​</span><br><span class="line"># 拷贝work组件</span><br><span class="line">for NODE in $Work; do echo $NODE; scp /usr/local/bin/kube&#123;let,-proxy&#125; $NODE:/usr/local/bin/ ; done</span><br><span class="line"></span><br><span class="line">​</span><br><span class="line"># 所有节点执行</span><br><span class="line">mkdir -p /opt/cni/bin</span><br></pre></td></tr></table></figure>

<h2 id="2-3创建证书相关文件"><a href="#2-3创建证书相关文件" class="headerlink" title="2.3创建证书相关文件"></a><strong>2.3创建证书相关文件</strong></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 请查看Github仓库 或者进行获取已经打好的包</span><br><span class="line">https://github.com/cby-chen/Kubernetes/</span><br><span class="line">https://github.com/cby-chen/Kubernetes/tags</span><br><span class="line">https://github.com/cby-chen/Kubernetes/releases/download/v1.29.2/kubernetes-v1.29.2.tar</span><br></pre></td></tr></table></figure>

<h1 id="3-相关证书生成"><a href="#3-相关证书生成" class="headerlink" title="3.相关证书生成"></a>3.相关证书生成</h1><h2 id="3-2-生成k8s相关证书"><a href="#3-2-生成k8s相关证书" class="headerlink" title="3.2.生成k8s相关证书"></a><strong>3.2.生成k8s相关证书</strong></h2><p>特别说明除外，以下操作在所有master节点操作</p>
<h3 id="3-2-1-所有k8s节点创建证书存放目录"><a href="#3-2-1-所有k8s节点创建证书存放目录" class="headerlink" title="3.2.1 所有k8s节点创建证书存放目录"></a><strong>3.2.1 所有k8s节点创建证书存放目录</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/kubernetes/pki</span><br></pre></td></tr></table></figure>

<h3 id="3-2-2-master01节点生成k8s证书"><a href="#3-2-2-master01节点生成k8s证书" class="headerlink" title="3.2.2 master01节点生成k8s证书"></a><strong>3.2.2 master01节点生成k8s证书</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"># 写入生成证书所需的配置文件</span><br><span class="line">cat &gt; ca-csr.json   &lt;&lt; EOF </span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;kubernetes&quot;,</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;Kubernetes&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;Kubernetes-manual&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;ca&quot;: &#123;</span><br><span class="line">    &quot;expiry&quot;: &quot;876000h&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare /etc/kubernetes/pki/ca</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cat &gt; apiserver-csr.json &lt;&lt; EOF </span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;kube-apiserver&quot;,</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;Kubernetes&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;Kubernetes-manual&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 生成一个根证书 ，多写了一些IP作为预留IP，为将来添加node做准备</span><br><span class="line"># 10.96.0.1是service网段的第一个地址，需要计算，192.168.1.36为高可用vip地址</span><br><span class="line"># 若没有IPv6 可删除可保留 </span><br><span class="line"></span><br><span class="line">cfssl gencert   \</span><br><span class="line">-ca=/etc/kubernetes/pki/ca.pem   \</span><br><span class="line">-ca-key=/etc/kubernetes/pki/ca-key.pem   \</span><br><span class="line">-config=ca-config.json   \</span><br><span class="line">-hostname=10.96.0.1,192.168.1.36,127.0.0.1,kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.default.svc.cluster.local,x.oiox.cn,k.oiox.cn,l.oiox.cn,o.oiox.cn,192.168.1.31,192.168.1.32,192.168.1.33,192.168.1.34,192.168.1.35,192.168.1.36,192.168.0.37,192.168.0.38,192.168.0.39,192.168.1.70,fc00:43f4:1eea:1::10,fc00:43f4:1eea:1::20,fc00:43f4:1eea:1::30,fc00:43f4:1eea:1::40,fc00:43f4:1eea:1::50,fc00:43f4:1eea:1::60,fc00:43f4:1eea:1::70,fc00:43f4:1eea:1::80,fc00:43f4:1eea:1::90,fc00:43f4:1eea:1::100,::1   \</span><br><span class="line">-profile=kubernetes   apiserver-csr.json | cfssljson -bare /etc/kubernetes/pki/apiserver</span><br></pre></td></tr></table></figure>

<h3 id="3-2-3-生成apiserver聚合证书"><a href="#3-2-3-生成apiserver聚合证书" class="headerlink" title="3.2.3 生成apiserver聚合证书"></a><strong>3.2.3 生成apiserver聚合证书</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; front-proxy-ca-csr.json  &lt;&lt; EOF </span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;kubernetes&quot;,</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">     &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">     &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;ca&quot;: &#123;</span><br><span class="line">    &quot;expiry&quot;: &quot;876000h&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cfssl gencert   -initca front-proxy-ca-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-ca </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cat &gt; front-proxy-client-csr.json  &lt;&lt; EOF </span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;front-proxy-client&quot;,</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">     &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">     &quot;size&quot;: 2048</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cfssl gencert  \</span><br><span class="line">-ca=/etc/kubernetes/pki/front-proxy-ca.pem   \</span><br><span class="line">-ca-key=/etc/kubernetes/pki/front-proxy-ca-key.pem   \</span><br><span class="line">-config=ca-config.json   \</span><br><span class="line">-profile=kubernetes   front-proxy-client-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-client</span><br><span class="line"></span><br><span class="line"># 这个命令使用cfssl工具生成一个用于Kubernetes的front-proxy-client证书。</span><br><span class="line"># </span><br><span class="line"># 主要参数解释如下：</span><br><span class="line"># - `-ca=/etc/kubernetes/pki/front-proxy-ca.pem`: 指定用于签署证书的根证书文件路径。</span><br><span class="line"># - `-ca-key=/etc/kubernetes/pki/front-proxy-ca-key.pem`: 指定用于签署证书的根证书的私钥文件路径。</span><br><span class="line"># - `-config=ca-config.json`: 指定用于配置证书签署的配置文件路径。该配置文件描述了证书生成的一些规则，如加密算法和有效期等。</span><br><span class="line"># - `-profile=kubernetes`: 指定生成证书时使用的配置文件中定义的profile，其中包含了一些默认的参数。</span><br><span class="line"># - `front-proxy-client-csr.json`: 指定用于生成证书的CSR文件路径，该文件包含了证书请求的相关信息。</span><br><span class="line"># - `| cfssljson -bare /etc/kubernetes/pki/front-proxy-client`: 通过管道将生成的证书输出到cfssljson工具进行解析，并通过`-bare`参数将证书和私钥分别保存到指定路径。</span><br><span class="line"># </span><br><span class="line"># 这个命令的作用是根据提供的CSR文件和配置信息，使用指定的根证书和私钥生成一个前端代理客户端的证书，并将证书和私钥分别保存到`/etc/kubernetes/pki/front-proxy-client.pem`和`/etc/kubernetes/pki/front-proxy-client-key.pem`文件中。</span><br></pre></td></tr></table></figure>

<h3 id="3-2-4-生成controller-manage的证书"><a href="#3-2-4-生成controller-manage的证书" class="headerlink" title="3.2.4 生成controller-manage的证书"></a><strong>3.2.4 生成controller-manage的证书</strong></h3><p>在《5.高可用配置》选择使用那种高可用方案 若使用 haproxy、keepalived 那么为 <code>--server=https://192.168.1.36:9443</code> 若使用 nginx方案，那么为 <code>--server=https://127.0.0.1:8443</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; manager-csr.json &lt;&lt; EOF </span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;system:kube-controller-manager&quot;,</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;system:kube-controller-manager&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;Kubernetes-manual&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cfssl gencert \</span><br><span class="line">   -ca=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">   -ca-key=/etc/kubernetes/pki/ca-key.pem \</span><br><span class="line">   -config=ca-config.json \</span><br><span class="line">   -profile=kubernetes \</span><br><span class="line">   manager-csr.json | cfssljson -bare /etc/kubernetes/pki/controller-manager</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 设置一个集群项</span><br><span class="line"># 在《5.高可用配置》选择使用那种高可用方案</span><br><span class="line"># 若使用 haproxy、keepalived 那么为 `--server=https://192.168.1.36:9443`</span><br><span class="line"># 若使用 nginx方案，那么为 `--server=https://127.0.0.1:8443`</span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">     --certificate-authority=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">     --embed-certs=true \</span><br><span class="line">     --server=https://127.0.0.1:8443 \</span><br><span class="line">     --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 设置一个环境项，一个上下文</span><br><span class="line">kubectl config set-context system:kube-controller-manager@kubernetes \</span><br><span class="line">    --cluster=kubernetes \</span><br><span class="line">    --user=system:kube-controller-manager \</span><br><span class="line">    --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  # 设置一个用户项</span><br><span class="line">  kubectl config set-credentials system:kube-controller-manager \</span><br><span class="line">       --client-certificate=/etc/kubernetes/pki/controller-manager.pem \</span><br><span class="line">       --client-key=/etc/kubernetes/pki/controller-manager-key.pem \</span><br><span class="line">       --embed-certs=true \</span><br><span class="line">       --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 设置默认环境</span><br><span class="line">kubectl config use-context system:kube-controller-manager@kubernetes \</span><br><span class="line">     --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig</span><br><span class="line"># 这个命令是用来指定kubectl使用指定的上下文环境来执行操作。上下文环境是kubectl用来确定要连接到哪个Kubernetes集群以及使用哪个身份验证信息的配置。</span><br><span class="line"># </span><br><span class="line"># 在这个命令中，`kubectl config use-context`是用来设置当前上下文环境的命令。 `system:kube-controller-manager@kubernetes`是指定的上下文名称，它告诉kubectl要使用的Kubernetes集群和身份验证信息。 </span><br><span class="line"># `--kubeconfig=/etc/kubernetes/controller-manager.kubeconfig`是用来指定使用的kubeconfig文件的路径。kubeconfig文件是存储集群连接和身份验证信息的配置文件。</span><br><span class="line"># 通过执行这个命令，kubectl将使用指定的上下文来执行后续的操作，包括部署和管理Kubernetes资源。</span><br></pre></td></tr></table></figure>

<h3 id="3-2-5-生成kube-scheduler的证书"><a href="#3-2-5-生成kube-scheduler的证书" class="headerlink" title="3.2.5 生成kube-scheduler的证书"></a><strong>3.2.5 生成kube-scheduler的证书</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; scheduler-csr.json &lt;&lt; EOF </span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;system:kube-scheduler&quot;,</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;system:kube-scheduler&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;Kubernetes-manual&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cfssl gencert \</span><br><span class="line">   -ca=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">   -ca-key=/etc/kubernetes/pki/ca-key.pem \</span><br><span class="line">   -config=ca-config.json \</span><br><span class="line">   -profile=kubernetes \</span><br><span class="line">   scheduler-csr.json | cfssljson -bare /etc/kubernetes/pki/scheduler</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">     --certificate-authority=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">     --embed-certs=true \</span><br><span class="line">     --server=https://127.0.0.1:8443 \</span><br><span class="line">     --kubeconfig=/etc/kubernetes/scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl config set-credentials system:kube-scheduler \</span><br><span class="line">     --client-certificate=/etc/kubernetes/pki/scheduler.pem \</span><br><span class="line">     --client-key=/etc/kubernetes/pki/scheduler-key.pem \</span><br><span class="line">     --embed-certs=true \</span><br><span class="line">     --kubeconfig=/etc/kubernetes/scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl config set-context system:kube-scheduler@kubernetes \</span><br><span class="line">     --cluster=kubernetes \</span><br><span class="line">     --user=system:kube-scheduler \</span><br><span class="line">     --kubeconfig=/etc/kubernetes/scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl config use-context system:kube-scheduler@kubernetes \</span><br><span class="line">     --kubeconfig=/etc/kubernetes/scheduler.kubeconfig</span><br></pre></td></tr></table></figure>

<h3 id="3-2-6-生成admin的证书配置"><a href="#3-2-6-生成admin的证书配置" class="headerlink" title="3.2.6 生成admin的证书配置"></a><strong>3.2.6 生成admin的证书配置</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; admin-csr.json &lt;&lt; EOF </span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;admin&quot;,</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;system:masters&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;Kubernetes-manual&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cfssl gencert \</span><br><span class="line">   -ca=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">   -ca-key=/etc/kubernetes/pki/ca-key.pem \</span><br><span class="line">   -config=ca-config.json \</span><br><span class="line">   -profile=kubernetes \</span><br><span class="line">   admin-csr.json | cfssljson -bare /etc/kubernetes/pki/admin</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl config set-cluster kubernetes     \</span><br><span class="line">  --certificate-authority=/etc/kubernetes/pki/ca.pem     \</span><br><span class="line">  --embed-certs=true     \</span><br><span class="line">  --server=https://127.0.0.1:8443     \</span><br><span class="line">  --kubeconfig=/etc/kubernetes/admin.kubeconfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl config set-credentials kubernetes-admin  \</span><br><span class="line">  --client-certificate=/etc/kubernetes/pki/admin.pem     \</span><br><span class="line">  --client-key=/etc/kubernetes/pki/admin-key.pem     \</span><br><span class="line">  --embed-certs=true     \</span><br><span class="line">  --kubeconfig=/etc/kubernetes/admin.kubeconfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl config set-context kubernetes-admin@kubernetes    \</span><br><span class="line">  --cluster=kubernetes     \</span><br><span class="line">  --user=kubernetes-admin     \</span><br><span class="line">  --kubeconfig=/etc/kubernetes/admin.kubeconfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl config use-context kubernetes-admin@kubernetes  --kubeconfig=/etc/kubernetes/admin.kubeconfig</span><br></pre></td></tr></table></figure>

<h3 id="3-2-7-创建kube-proxy证书"><a href="#3-2-7-创建kube-proxy证书" class="headerlink" title="3.2.7 创建kube-proxy证书"></a><strong>3.2.7 创建kube-proxy证书</strong></h3><p>在《5.高可用配置》选择使用那种高可用方案 若使用 haproxy、keepalived 那么为 <code>--server=https://192.168.1.36:9443</code> 若使用 nginx方案，那么为 <code>--server=https://127.0.0.1:8443</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube-proxy-csr.json  &lt;&lt; EOF </span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;system:kube-proxy&quot;,</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;system:kube-proxy&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;Kubernetes-manual&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cfssl gencert \</span><br><span class="line">   -ca=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">   -ca-key=/etc/kubernetes/pki/ca-key.pem \</span><br><span class="line">   -config=ca-config.json \</span><br><span class="line">   -profile=kubernetes \</span><br><span class="line">   kube-proxy-csr.json | cfssljson -bare /etc/kubernetes/pki/kube-proxy</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   </span><br><span class="line"># 在《5.高可用配置》选择使用那种高可用方案</span><br><span class="line"># 若使用 haproxy、keepalived 那么为 `--server=https://192.168.1.36:9443`</span><br><span class="line"># 若使用 nginx方案，那么为 `--server=https://127.0.0.1:8443`</span><br><span class="line"></span><br><span class="line">kubectl config set-cluster kubernetes     \</span><br><span class="line">  --certificate-authority=/etc/kubernetes/pki/ca.pem     \</span><br><span class="line">  --embed-certs=true     \</span><br><span class="line">  --server=https://127.0.0.1:8443     \</span><br><span class="line">  --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl config set-credentials kube-proxy  \</span><br><span class="line">  --client-certificate=/etc/kubernetes/pki/kube-proxy.pem     \</span><br><span class="line">  --client-key=/etc/kubernetes/pki/kube-proxy-key.pem     \</span><br><span class="line">  --embed-certs=true     \</span><br><span class="line">  --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl config set-context kube-proxy@kubernetes    \</span><br><span class="line">  --cluster=kubernetes     \</span><br><span class="line">  --user=kube-proxy     \</span><br><span class="line">  --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl config use-context kube-proxy@kubernetes  --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig</span><br></pre></td></tr></table></figure>

<h3 id="3-2-8-创建ServiceAccount-Key-——secret"><a href="#3-2-8-创建ServiceAccount-Key-——secret" class="headerlink" title="3.2.8 创建ServiceAccount Key ——secret"></a><strong>3.2.8 创建ServiceAccount Key ——secret</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out /etc/kubernetes/pki/sa.key 2048</span><br><span class="line">openssl rsa -in /etc/kubernetes/pki/sa.key -pubout -out /etc/kubernetes/pki/sa.pub</span><br><span class="line"></span><br><span class="line"># 这两个命令是使用OpenSSL工具生成RSA密钥对。</span><br><span class="line"># </span><br><span class="line"># 命令1：openssl genrsa -out /etc/kubernetes/pki/sa.key 2048</span><br><span class="line"># 该命令用于生成私钥文件。具体解释如下：</span><br><span class="line"># - openssl：openssl命令行工具。</span><br><span class="line"># - genrsa：生成RSA密钥对。</span><br><span class="line"># - -out /etc/kubernetes/pki/sa.key：指定输出私钥文件的路径和文件名。</span><br><span class="line"># - 2048：指定密钥长度为2048位。</span><br><span class="line"># </span><br><span class="line"># 命令2：openssl rsa -in /etc/kubernetes/pki/sa.key -pubout -out /etc/kubernetes/pki/sa.pub</span><br><span class="line"># 该命令用于从私钥中导出公钥。具体解释如下：</span><br><span class="line"># - openssl：openssl命令行工具。</span><br><span class="line"># - rsa：与私钥相关的RSA操作。</span><br><span class="line"># - -in /etc/kubernetes/pki/sa.key：指定输入私钥文件的路径和文件名。</span><br><span class="line"># - -pubout：指定输出公钥。</span><br><span class="line"># - -out /etc/kubernetes/pki/sa.pub：指定输出公钥文件的路径和文件名。</span><br><span class="line"># </span><br><span class="line"># 总结：通过以上两个命令，我们可以使用OpenSSL工具生成一个RSA密钥对，并将私钥保存在/etc/kubernetes/pki/sa.key文件中，将公钥保存在/etc/kubernetes/pki/sa.pub文件中。</span><br></pre></td></tr></table></figure>

<h3 id="3-2-9-将证书发送到其他master节点"><a href="#3-2-9-将证书发送到其他master节点" class="headerlink" title="3.2.9 将证书发送到其他master节点"></a><strong>3.2.9 将证书发送到其他master节点</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#其他节点创建目录</span><br><span class="line"># mkdir  /etc/kubernetes/pki/ -p</span><br><span class="line"></span><br><span class="line">for NODE in k8s-master02 k8s-master03; do  for FILE in $(ls /etc/kubernetes/pki | grep -v etcd); do  scp /etc/kubernetes/pki/$&#123;FILE&#125; $NODE:/etc/kubernetes/pki/$&#123;FILE&#125;; done;  for FILE in admin.kubeconfig controller-manager.kubeconfig scheduler.kubeconfig; do  scp /etc/kubernetes/$&#123;FILE&#125; $NODE:/etc/kubernetes/$&#123;FILE&#125;; done; done</span><br></pre></td></tr></table></figure>

<h3 id="3-2-10-查看证书"><a href="#3-2-10-查看证书" class="headerlink" title="3.2.10 查看证书"></a><strong>3.2.10 查看证书</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ls /etc/kubernetes/pki/</span><br><span class="line">admin.csr          controller-manager.csr      kube-proxy.csr</span><br><span class="line">admin-key.pem      controller-manager-key.pem  kube-proxy-key.pem</span><br><span class="line">admin.pem          controller-manager.pem      kube-proxy.pem</span><br><span class="line">apiserver.csr      front-proxy-ca.csr          sa.key</span><br><span class="line">apiserver-key.pem  front-proxy-ca-key.pem      sa.pub</span><br><span class="line">apiserver.pem      front-proxy-ca.pem          scheduler.csr</span><br><span class="line">ca.csr             front-proxy-client.csr      scheduler-key.pem</span><br><span class="line">ca-key.pem         front-proxy-client-key.pem  scheduler.pem</span><br><span class="line">ca.pem             front-proxy-client.pem</span><br><span class="line"></span><br><span class="line"># 一共26个就对了</span><br><span class="line">ls /etc/kubernetes/pki/ |wc -l</span><br><span class="line">26</span><br></pre></td></tr></table></figure>

<h1 id="5-高可用配置（在Master服务器上操作）"><a href="#5-高可用配置（在Master服务器上操作）" class="headerlink" title="5.高可用配置（在Master服务器上操作）"></a>5.高可用配置（在Master服务器上操作）</h1><p><strong>注意* 5.1.1 和5.1.2 二选一即可</strong></p>
<p>选择使用那种高可用方案，同时可以俩种都选用，实现内外兼顾的效果，比如： 5.1 的 NGINX方案实现集群内的高可用 5.2 的 haproxy、keepalived 方案实现集群外访问</p>
<p>在《3.2.生成k8s相关证书》</p>
<p>若使用 nginx方案，那么为 <code>--server=https://127.0.0.1:8443</code> 若使用 haproxy、keepalived 那么为 <code>--server=https://192.168.1.36:9443</code></p>
<h3 id="kube-vip高可用方案（推荐）"><a href="#kube-vip高可用方案（推荐）" class="headerlink" title="kube-vip高可用方案（推荐）"></a>kube-vip高可用方案（推荐）</h3><p>原文地址：<a href="https://sreok.cn/archives/9d06c7be-1885-4df7-bfbf-b80ed16e4d47">k8s高可用方案-使用kube-vip作为控制平面负载入口 - (</a><a href="http://sreok.cn/">sreok.cn</a><a href="https://sreok.cn/archives/9d06c7be-1885-4df7-bfbf-b80ed16e4d47">)</a></p>
<h3 id="NGINX高可用方案"><a href="#NGINX高可用方案" class="headerlink" title="NGINX高可用方案"></a><strong>NGINX高可用方案</strong></h3><h4 id="5-1-1-进行编译"><a href="#5-1-1-进行编译" class="headerlink" title="5.1.1 进行编译"></a><strong>5.1.1 进行编译</strong></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"># 安装编译环境</span><br><span class="line">yum install gcc -y</span><br><span class="line">​</span><br><span class="line"># 下载解压nginx二进制文件</span><br><span class="line"># wget http://nginx.org/download/nginx-1.25.3.tar.gz</span><br><span class="line">tar xvf nginx-*.tar.gz</span><br><span class="line">cd nginx-*</span><br><span class="line">​</span><br><span class="line"># 进行编译</span><br><span class="line">./configure --with-stream --without-http --without-http_uwsgi_module --without-http_scgi_module --without-http_fastcgi_module</span><br><span class="line">make &amp;&amp; make install </span><br><span class="line">​</span><br><span class="line"># 拷贝编译好的nginx</span><br><span class="line">node=&#x27;k8s-master02 k8s-master03 k8s-node01 k8s-node02&#x27;</span><br><span class="line">for NODE in $node; do scp -r /usr/local/nginx/ $NODE:/usr/local/nginx/; done</span><br><span class="line">​</span><br><span class="line"># 这是一系列命令行指令，用于编译和安装软件。</span><br><span class="line"># </span><br><span class="line"># 1. `./configure` 是用于配置软件的命令。在这个例子中，配置的软件是一个Web服务器，指定了一些选项来启用流模块，并禁用了HTTP、uwsgi、scgi和fastcgi模块。</span><br><span class="line"># 2. `--with-stream` 指定启用流模块。流模块通常用于代理TCP和UDP流量。</span><br><span class="line"># 3. `--without-http` 指定禁用HTTP模块。这意味着编译的软件将没有HTTP服务器功能。</span><br><span class="line"># 4. `--without-http_uwsgi_module` 指定禁用uwsgi模块。uwsgi是一种Web服务器和应用服务器之间的通信协议。</span><br><span class="line"># 5. `--without-http_scgi_module` 指定禁用scgi模块。scgi是一种用于将Web服务器请求传递到应用服务器的协议。</span><br><span class="line"># 6. `--without-http_fastcgi_module` 指定禁用fastcgi模块。fastcgi是一种用于在Web服务器和应用服务器之间交换数据的协议。</span><br><span class="line"># 7. `make` 是用于编译软件的命令。该命令将根据之前的配置生成可执行文件。</span><br><span class="line"># 8. `make install` 用于安装软件。该命令将生成的可执行文件和其他必要文件复制到系统的适当位置，以便可以使用该软件。</span><br><span class="line"># </span><br><span class="line"># 总之，这个命令序列用于编译一个配置了特定选项的Web服务器，并将其安装到系统中。</span><br></pre></td></tr></table></figure>

<h3 id="5-1-2-写入启动配置"><a href="#5-1-2-写入启动配置" class="headerlink" title="5.1.2 写入启动配置"></a><strong>5.1.2 写入启动配置</strong></h3><p>在所有主机上执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"># 写入nginx配置文件</span><br><span class="line">cat &gt; /usr/local/nginx/conf/kube-nginx.conf &lt;&lt;EOF</span><br><span class="line">worker_processes 1;</span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line">stream &#123;</span><br><span class="line">    upstream backend &#123;</span><br><span class="line">        least_conn;</span><br><span class="line">        hash $remote_addr consistent;</span><br><span class="line">        server 192.168.1.31:6443        max_fails=3 fail_timeout=30s;</span><br><span class="line">        server 192.168.1.32:6443        max_fails=3 fail_timeout=30s;</span><br><span class="line">        server 192.168.1.33:6443        max_fails=3 fail_timeout=30s;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 127.0.0.1:8443;</span><br><span class="line">        proxy_connect_timeout 1s;</span><br><span class="line">        proxy_pass backend;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"># 这段配置是一个nginx的stream模块的配置，用于代理TCP和UDP流量。</span><br><span class="line"># </span><br><span class="line"># 首先，`worker_processes 1;`表示启动一个worker进程用于处理流量。</span><br><span class="line"># 接下来，`events &#123; worker_connections 1024; &#125;`表示每个worker进程可以同时处理最多1024个连接。</span><br><span class="line"># 在stream块里面，定义了一个名为`backend`的upstream，用于负载均衡和故障转移。</span><br><span class="line"># `least_conn`表示使用最少连接算法进行负载均衡。</span><br><span class="line"># `hash $remote_addr consistent`表示用客户端的IP地址进行哈希分配请求，保持相同IP的请求始终访问同一台服务器。</span><br><span class="line"># `server`指令用于定义后端的服务器，每个服务器都有一个IP地址和端口号，以及一些可选的参数。</span><br><span class="line"># `max_fails=3`表示当一个服务器连续失败3次时将其标记为不可用。</span><br><span class="line"># `fail_timeout=30s`表示如果一个服务器被标记为不可用，nginx将在30秒后重新尝试。</span><br><span class="line"># 在server块内部，定义了一个监听地址为127.0.0.1:8443的服务器。</span><br><span class="line"># `proxy_connect_timeout 1s`表示与后端服务器建立连接的超时时间为1秒。</span><br><span class="line"># `proxy_pass backend`表示将流量代理到名为backend的上游服务器组。</span><br><span class="line"># </span><br><span class="line"># 总结起来，这段配置将流量代理到一个包含3个后端服务器的上游服务器组中，使用最少连接算法进行负载均衡，并根据客户端的IP地址进行哈希分配请求。如果一个服务器连续失败3次，则将其标记为不可用，并在30秒后重新尝试。</span><br><span class="line">​</span><br><span class="line">​</span><br><span class="line"># 写入启动配置文件</span><br><span class="line">cat &gt; /etc/systemd/system/kube-nginx.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=kube-apiserver nginx proxy</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line">​</span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">ExecStartPre=/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/kube-nginx.conf -p /usr/local/nginx -t</span><br><span class="line">ExecStart=/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/kube-nginx.conf -p /usr/local/nginx</span><br><span class="line">ExecReload=/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/kube-nginx.conf -p /usr/local/nginx -s reload</span><br><span class="line">PrivateTmp=true</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=5</span><br><span class="line">StartLimitInterval=0</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"> </span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"># 这是一个用于kube-apiserver的NGINX代理的systemd单位文件。</span><br><span class="line"># </span><br><span class="line"># [Unit]部分包含了单位的描述和依赖关系。它指定了在network.target和network-online.target之后启动，并且需要network-online.target。</span><br><span class="line"># </span><br><span class="line"># [Service]部分定义了如何运行该服务。Type指定了服务进程的类型（forking表示主进程会派生一个子进程）。ExecStartPre指定了在服务启动之前需要运行的命令，用于检查NGINX配置文件的语法是否正确。ExecStart指定了启动服务所需的命令。ExecReload指定了在重新加载配置文件时运行的命令。PrivateTmp设置为true表示将为服务创建一个私有的临时文件系统。Restart和RestartSec用于设置服务的自动重启机制。StartLimitInterval设置为0表示无需等待，可以立即重启服务。LimitNOFILE指定了服务的文件描述符的限制。</span><br><span class="line"># </span><br><span class="line"># [Install]部分指定了在哪些target下该单位应该被启用。</span><br><span class="line"># </span><br><span class="line"># 综上所述，此单位文件用于启动和管理kube-apiserver的NGINX代理服务。它通过NGINX来反向代理和负载均衡kube-apiserver的请求。该服务会在系统启动时自动启动，并具有自动重启的机制。</span><br><span class="line">​</span><br><span class="line">​</span><br><span class="line"># 设置开机自启</span><br><span class="line">​</span><br><span class="line">systemctl daemon-reload</span><br><span class="line"># 用于重新加载systemd管理的单位文件。当你新增或修改了某个单位文件（如.service文件、.socket文件等），需要运行该命令来刷新systemd对该文件的配置。</span><br><span class="line">systemctl enable --now kube-nginx.service</span><br><span class="line"># 启用并立即启动kube-nginx.service单元。kube-nginx.service是kube-nginx守护进程的systemd服务单元。</span><br><span class="line">systemctl restart kube-nginx.service</span><br><span class="line"># 重启kube-nginx.service单元，即重新启动kube-nginx守护进程。</span><br><span class="line">systemctl status kube-nginx.service</span><br><span class="line"># kube-nginx.service单元的当前状态，包括运行状态、是否启用等信息。</span><br></pre></td></tr></table></figure>

<h2 id="5-2-keepalived和haproxy-高可用方案"><a href="#5-2-keepalived和haproxy-高可用方案" class="headerlink" title="5.2 keepalived和haproxy 高可用方案"></a><strong>5.2 keepalived和haproxy 高可用方案</strong></h2><h3 id="5-2-1安装keepalived和haproxy服务"><a href="#5-2-1安装keepalived和haproxy服务" class="headerlink" title="5.2.1安装keepalived和haproxy服务"></a><strong>5.2.1安装keepalived和haproxy服务</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl disable --now firewalld</span><br><span class="line">setenforce 0</span><br><span class="line">sed -i &#x27;s#SELINUX=enforcing#SELINUX=disabled#g&#x27; /etc/selinux/config</span><br><span class="line">yum -y install keepalived haproxy</span><br></pre></td></tr></table></figure>

<h3 id="5-2-2修改haproxy配置文件（配置文件一样）"><a href="#5-2-2修改haproxy配置文件（配置文件一样）" class="headerlink" title="5.2.2修改haproxy配置文件（配置文件一样）"></a><strong>5.2.2修改haproxy配置文件（配置文件一样）</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"># cp /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.bak</span><br><span class="line">​</span><br><span class="line">cat &gt;/etc/haproxy/haproxy.cfg&lt;&lt;&quot;EOF&quot;</span><br><span class="line">global</span><br><span class="line"> maxconn 2000</span><br><span class="line"> ulimit-n 16384</span><br><span class="line"> log 127.0.0.1 local0 err</span><br><span class="line"> stats timeout 30s</span><br><span class="line">​</span><br><span class="line">defaults</span><br><span class="line"> log global</span><br><span class="line"> mode http</span><br><span class="line"> option httplog</span><br><span class="line"> timeout connect 5000</span><br><span class="line"> timeout client 50000</span><br><span class="line"> timeout server 50000</span><br><span class="line"> timeout http-request 15s</span><br><span class="line"> timeout http-keep-alive 15s</span><br><span class="line">​</span><br><span class="line">​</span><br><span class="line">frontend monitor-in</span><br><span class="line"> bind *:33305</span><br><span class="line"> mode http</span><br><span class="line"> option httplog</span><br><span class="line"> monitor-uri /monitor</span><br><span class="line">​</span><br><span class="line">frontend k8s-master</span><br><span class="line"> bind 0.0.0.0:9443</span><br><span class="line"> bind 127.0.0.1:9443</span><br><span class="line"> mode tcp</span><br><span class="line"> option tcplog</span><br><span class="line"> tcp-request inspect-delay 5s</span><br><span class="line"> default_backend k8s-master</span><br><span class="line">​</span><br><span class="line">​</span><br><span class="line">backend k8s-master</span><br><span class="line"> mode tcp</span><br><span class="line"> option tcplog</span><br><span class="line"> option tcp-check</span><br><span class="line"> balance roundrobin</span><br><span class="line"> default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100</span><br><span class="line"> server  k8s-master01  192.168.1.31:6443 check</span><br><span class="line"> server  k8s-master02  192.168.1.32:6443 check</span><br><span class="line"> server  k8s-master03  192.168.1.33:6443 check</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">这段配置代码是指定了一个HAProxy负载均衡器的配置。下面对各部分进行详细解释：</span><br><span class="line">1. global:</span><br><span class="line">   - maxconn 2000: 设置每个进程的最大连接数为2000。</span><br><span class="line">   - ulimit-n 16384: 设置每个进程的最大文件描述符数为16384。</span><br><span class="line">   - log 127.0.0.1 local0 err: 指定日志的输出地址为本地主机的127.0.0.1，并且只记录错误级别的日志。</span><br><span class="line">   - stats timeout 30s: 设置查看负载均衡器统计信息的超时时间为30秒。</span><br><span class="line">​</span><br><span class="line">2. defaults:</span><br><span class="line">   - log global: 使默认日志与global部分相同。</span><br><span class="line">   - mode http: 设定负载均衡器的工作模式为HTTP模式。</span><br><span class="line">   - option httplog: 使负载均衡器记录HTTP协议的日志。</span><br><span class="line">   - timeout connect 5000: 设置与后端服务器建立连接的超时时间为5秒。</span><br><span class="line">   - timeout client 50000: 设置与客户端的连接超时时间为50秒。</span><br><span class="line">   - timeout server 50000: 设置与后端服务器连接的超时时间为50秒。</span><br><span class="line">   - timeout http-request 15s: 设置处理HTTP请求的超时时间为15秒。</span><br><span class="line">   - timeout http-keep-alive 15s: 设置保持HTTP连接的超时时间为15秒。</span><br><span class="line">​</span><br><span class="line">3. frontend monitor-in:</span><br><span class="line">   - bind *:33305: 监听所有IP地址的33305端口。</span><br><span class="line">   - mode http: 设定frontend的工作模式为HTTP模式。</span><br><span class="line">   - option httplog: 记录HTTP协议的日志。</span><br><span class="line">   - monitor-uri /monitor: 设置监控URI为/monitor。</span><br><span class="line">​</span><br><span class="line">4. frontend k8s-master:</span><br><span class="line">   - bind 0.0.0.0:9443: 监听所有IP地址的9443端口。</span><br><span class="line">   - bind 127.0.0.1:9443: 监听本地主机的9443端口。</span><br><span class="line">   - mode tcp: 设定frontend的工作模式为TCP模式。</span><br><span class="line">   - option tcplog: 记录TCP协议的日志。</span><br><span class="line">   - tcp-request inspect-delay 5s: 设置在接收到请求后延迟5秒进行检查。</span><br><span class="line">   - default_backend k8s-master: 设置默认的后端服务器组为k8s-master。</span><br><span class="line">​</span><br><span class="line">5. backend k8s-master:</span><br><span class="line">   - mode tcp: 设定backend的工作模式为TCP模式。</span><br><span class="line">   - option tcplog: 记录TCP协议的日志。</span><br><span class="line">   - option tcp-check: 启用TCP检查功能。</span><br><span class="line">   - balance roundrobin: 使用轮询算法进行负载均衡。</span><br><span class="line">   - default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100: 设置默认的服务器参数。</span><br><span class="line">   - server k8s-master01 192.168.1.31:6443 check: 增加一个名为k8s-master01的服务器，IP地址为192.168.1.31，端口号为6443，并对其进行健康检查。</span><br><span class="line">   - server k8s-master02 192.168.1.32:6443 check: 增加一个名为k8s-master02的服务器，IP地址为192.168.1.32，端口号为6443，并对其进行健康检查。</span><br><span class="line">   - server k8s-master03 192.168.1.33:6443 check: 增加一个名为k8s-master03的服务器，IP地址为192.168.1.33，端口号为6443，并对其进行健康检查。</span><br><span class="line">​</span><br><span class="line">以上就是这段配置代码的详细解释。它主要定义了全局配置、默认配置、前端监听和后端服务器组的相关参数和设置。通过这些配置，可以实现负载均衡和监控功能。</span><br></pre></td></tr></table></figure>

<h3 id="5-2-3Master01配置keepalived-master节点"><a href="#5-2-3Master01配置keepalived-master节点" class="headerlink" title="5.2.3Master01配置keepalived master节点"></a><strong>5.2.3Master01配置keepalived master节点</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">#cp /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak</span><br><span class="line">​</span><br><span class="line">cat &gt; /etc/keepalived/keepalived.conf &lt;&lt; EOF</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line">​</span><br><span class="line">global_defs &#123;</span><br><span class="line">    router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_apiserver &#123;</span><br><span class="line">    script &quot;/etc/keepalived/check_apiserver.sh&quot;</span><br><span class="line">    interval 5 </span><br><span class="line">    weight -5</span><br><span class="line">    fall 2</span><br><span class="line">    rise 1</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    # 注意网卡名</span><br><span class="line">    interface eth0 </span><br><span class="line">    mcast_src_ip 192.168.1.31</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    nopreempt</span><br><span class="line">    advert_int 2</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass K8SHA_KA_AUTH</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.1.36</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">      chk_apiserver </span><br><span class="line">&#125; &#125;</span><br><span class="line">​</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="5-2-4Master02配置keepalived-backup节点"><a href="#5-2-4Master02配置keepalived-backup节点" class="headerlink" title="5.2.4Master02配置keepalived backup节点"></a><strong>5.2.4Master02配置keepalived backup节点</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"># cp /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak</span><br><span class="line">​</span><br><span class="line">cat &gt; /etc/keepalived/keepalived.conf &lt;&lt; EOF</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line">​</span><br><span class="line">global_defs &#123;</span><br><span class="line">    router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_apiserver &#123;</span><br><span class="line">    script &quot;/etc/keepalived/check_apiserver.sh&quot;</span><br><span class="line">    interval 5 </span><br><span class="line">    weight -5</span><br><span class="line">    fall 2</span><br><span class="line">    rise 1</span><br><span class="line">​</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    # 注意网卡名</span><br><span class="line">    interface eth0</span><br><span class="line">    mcast_src_ip 192.168.1.32</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 80</span><br><span class="line">    nopreempt</span><br><span class="line">    advert_int 2</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass K8SHA_KA_AUTH</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.1.36</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">      chk_apiserver </span><br><span class="line">&#125; &#125;</span><br><span class="line">​</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="5-2-5Master03配置keepalived-backup节点"><a href="#5-2-5Master03配置keepalived-backup节点" class="headerlink" title="5.2.5Master03配置keepalived backup节点"></a><strong>5.2.5Master03配置keepalived backup节点</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"># cp /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak</span><br><span class="line"></span><br><span class="line">cat &gt; /etc/keepalived/keepalived.conf &lt;&lt; EOF</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">    router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_apiserver &#123;</span><br><span class="line">    script &quot;/etc/keepalived/check_apiserver.sh&quot;</span><br><span class="line">    interval 5 </span><br><span class="line">    weight -5</span><br><span class="line">    fall 2</span><br><span class="line">    rise 1</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    # 注意网卡名</span><br><span class="line">    interface eth0</span><br><span class="line">    mcast_src_ip 192.168.1.33</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 50</span><br><span class="line">    nopreempt</span><br><span class="line">    advert_int 2</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass K8SHA_KA_AUTH</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.1.36</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">      chk_apiserver </span><br><span class="line">&#125; &#125;</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">这是一个用于配置keepalived的配置文件。下面是对每个部分的详细解释：</span><br><span class="line"></span><br><span class="line">- `global_defs`部分定义了全局参数。</span><br><span class="line">- `router_id`参数指定了当前路由器的标识，这里设置为&quot;LVS_DEVEL&quot;。</span><br><span class="line"></span><br><span class="line">- `vrrp_script`部分定义了一个VRRP脚本。`chk_apiserver`是脚本的名称，</span><br><span class="line">    - `script`参数指定了脚本的路径。该脚本每5秒执行一次，返回值为0表示服务正常，返回值为1表示服务异常。</span><br><span class="line">    - `weight`参数指定了根据脚本返回的值来调整优先级，这里设置为-5。</span><br><span class="line">    - `fall`参数指定了失败阈值，当连续2次脚本返回值为1时认为服务异常。</span><br><span class="line">    - `rise`参数指定了恢复阈值，当连续1次脚本返回值为0时认为服务恢复正常。</span><br><span class="line"></span><br><span class="line">- `vrrp_instance`部分定义了一个VRRP实例。`VI_1`是实例的名称。</span><br><span class="line">    - `state`参数指定了当前实例的状态，这里设置为MASTER表示当前实例是主节点。</span><br><span class="line">    - `interface`参数指定了要监听的网卡，这里设置为eth0。</span><br><span class="line">    - `mcast_src_ip`参数指定了VRRP报文的源IP地址，这里设置为192.168.1.31。</span><br><span class="line">    - `virtual_router_id`参数指定了虚拟路由器的ID，这里设置为51。</span><br><span class="line">    - `priority`参数指定了实例的优先级，优先级越高（数值越大）越有可能被选为主节点。</span><br><span class="line">    - `nopreempt`参数指定了当主节点失效后不要抢占身份，即不要自动切换为主节点。</span><br><span class="line">    - `advert_int`参数指定了发送广播的间隔时间，这里设置为2秒。</span><br><span class="line">    - `authentication`部分指定了认证参数</span><br><span class="line">    	- `auth_type`参数指定了认证类型，这里设置为PASS表示使用密码认证，</span><br><span class="line">    	- `auth_pass`参数指定了认证密码，这里设置为K8SHA_KA_AUTH。</span><br><span class="line">    - `virtual_ipaddress`部分指定了虚拟IP地址，这里设置为192.168.1.36。</span><br><span class="line">    - `track_script`部分指定了要跟踪的脚本，这里跟踪了chk_apiserver脚本。</span><br></pre></td></tr></table></figure>

<h3 id="5-2-6健康检查脚本配置（lb主机）"><a href="#5-2-6健康检查脚本配置（lb主机）" class="headerlink" title="5.2.6健康检查脚本配置（lb主机）"></a><strong>5.2.6健康检查脚本配置（lb主机）</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;  /etc/keepalived/check_apiserver.sh &lt;&lt; EOF</span><br><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">err=0</span><br><span class="line">for k in \$(seq 1 3)</span><br><span class="line">do</span><br><span class="line">    check_code=\$(pgrep haproxy)</span><br><span class="line">    if [[ \$check_code == &quot;&quot; ]]; then</span><br><span class="line">        err=\$(expr \$err + 1)</span><br><span class="line">        sleep 1</span><br><span class="line">        continue</span><br><span class="line">    else</span><br><span class="line">        err=0</span><br><span class="line">        break</span><br><span class="line">    fi</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">if [[ \$err != &quot;0&quot; ]]; then</span><br><span class="line">    echo &quot;systemctl stop keepalived&quot;</span><br><span class="line">    /usr/bin/systemctl stop keepalived</span><br><span class="line">    exit 1</span><br><span class="line">else</span><br><span class="line">    exit 0</span><br><span class="line">fi</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># 给脚本授权</span><br><span class="line"></span><br><span class="line">chmod +x /etc/keepalived/check_apiserver.sh</span><br><span class="line"></span><br><span class="line"># 这段脚本是一个简单的bash脚本，主要用来检查是否有名为haproxy的进程正在运行。</span><br><span class="line"># </span><br><span class="line"># 脚本的主要逻辑如下：</span><br><span class="line"># 1. 首先设置一个变量err为0，用来记录错误次数。</span><br><span class="line"># 2. 使用一个循环，在循环内部执行以下操作：</span><br><span class="line">#    a. 使用pgrep命令检查是否有名为haproxy的进程在运行。如果不存在该进程，将err加1，并暂停1秒钟，然后继续下一次循环。</span><br><span class="line">#    b. 如果存在haproxy进程，将err重置为0，并跳出循环。</span><br><span class="line"># 3. 检查err的值，如果不为0，表示检查失败，输出一条错误信息并执行“systemctl stop keepalived”命令停止keepalived进程，并退出脚本返回1。</span><br><span class="line"># 4. 如果err的值为0，表示检查成功，退出脚本返回0。</span><br><span class="line"># </span><br><span class="line"># 该脚本的主要作用是检查是否存在运行中的haproxy进程，如果无法检测到haproxy进程，将停止keepalived进程并返回错误状态。如果haproxy进程存在，则返回成功状态。这个脚本可能是作为一个健康检查脚本的一部分，在确保haproxy服务可用的情况下，才继续运行其他操作。</span><br></pre></td></tr></table></figure>

<h3 id="5-2-7启动服务"><a href="#5-2-7启动服务" class="headerlink" title="5.2.7启动服务"></a><strong>5.2.7启动服务</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line"># 用于重新加载systemd管理的单位文件。当你新增或修改了某个单位文件（如.service文件、.socket文件等），需要运行该命令来刷新systemd对该文件的配置。</span><br><span class="line">systemctl enable --now haproxy.service</span><br><span class="line"># 启用并立即启动haproxy.service单元。haproxy.service是haproxy守护进程的systemd服务单元。</span><br><span class="line">systemctl enable --now keepalived.service</span><br><span class="line"># 启用并立即启动keepalived.service单元。keepalived.service是keepalived守护进程的systemd服务单元。</span><br><span class="line">systemctl status haproxy.service</span><br><span class="line"># haproxy.service单元的当前状态，包括运行状态、是否启用等信息。</span><br><span class="line">systemctl status keepalived.service</span><br><span class="line"># keepalived.service单元的当前状态，包括运行状态、是否启用等信息。</span><br></pre></td></tr></table></figure>

<h3 id="5-2-8测试高可用"><a href="#5-2-8测试高可用" class="headerlink" title="5.2.8测试高可用"></a><strong>5.2.8测试高可用</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 能ping同</span><br><span class="line">[root@k8s-node02 ~]# ping 192.168.1.36</span><br><span class="line"></span><br><span class="line"># 能telnet访问</span><br><span class="line">[root@k8s-node02 ~]# telnet 192.168.1.36 9443</span><br><span class="line"></span><br><span class="line"># 关闭主节点，看vip是否漂移到备节点</span><br></pre></td></tr></table></figure>

<h1 id="6-k8s组件配置"><a href="#6-k8s组件配置" class="headerlink" title="6.k8s组件配置"></a>6.k8s组件配置</h1><p>所有k8s节点创建以下目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/kubernetes/manifests/ /etc/systemd/system/kubelet.service.d /var/lib/kubelet /var/log/kubernetes</span><br></pre></td></tr></table></figure>

<h2 id="6-1-创建apiserver（所有master节点）"><a href="#6-1-创建apiserver（所有master节点）" class="headerlink" title="6.1.创建apiserver（所有master节点）"></a><strong>6.1.创建apiserver（所有master节点）</strong></h2><h3 id="6-1-1master01节点配置"><a href="#6-1-1master01节点配置" class="headerlink" title="6.1.1master01节点配置"></a><strong>6.1.1master01节点配置</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kube-apiserver.service &lt;&lt; EOF</span><br><span class="line">​</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line">​</span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kube-apiserver \\</span><br><span class="line">      --v=2  \\</span><br><span class="line">      --allow-privileged=true  \\</span><br><span class="line">      --bind-address=0.0.0.0  \\</span><br><span class="line">      --secure-port=6443  \\</span><br><span class="line">      --advertise-address=192.168.1.31 \\</span><br><span class="line">      --service-cluster-ip-range=10.96.0.0/12,fd00:1111::/112  \\</span><br><span class="line">      --service-node-port-range=30000-32767  \\</span><br><span class="line">      --etcd-servers=https://192.168.1.31:2379,https://192.168.1.32:2379,https://192.168.1.33:2379 \\</span><br><span class="line">      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  \\</span><br><span class="line">      --etcd-certfile=/etc/etcd/ssl/etcd.pem  \\</span><br><span class="line">      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  \\</span><br><span class="line">      --client-ca-file=/etc/kubernetes/pki/ca.pem  \\</span><br><span class="line">      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  \\</span><br><span class="line">      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  \\</span><br><span class="line">      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  \\</span><br><span class="line">      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  \\</span><br><span class="line">      --service-account-key-file=/etc/kubernetes/pki/sa.pub  \\</span><br><span class="line">      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key  \\</span><br><span class="line">      --service-account-issuer=https://kubernetes.default.svc.cluster.local \\</span><br><span class="line">      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  \\</span><br><span class="line">      --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  \</span><br><span class="line">      --authorization-mode=Node,RBAC  \\</span><br><span class="line">      --enable-bootstrap-token-auth=true  \\</span><br><span class="line">      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  \\</span><br><span class="line">      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  \\</span><br><span class="line">      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  \\</span><br><span class="line">      --requestheader-allowed-names=aggregator  \\</span><br><span class="line">      --requestheader-group-headers=X-Remote-Group  \\</span><br><span class="line">      --requestheader-extra-headers-prefix=X-Remote-Extra-  \\</span><br><span class="line">      --requestheader-username-headers=X-Remote-User \\</span><br><span class="line">      --enable-aggregator-routing=true</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=10s</span><br><span class="line">LimitNOFILE=65535</span><br><span class="line">​</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">​</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="6-1-2master02节点配置"><a href="#6-1-2master02节点配置" class="headerlink" title="6.1.2master02节点配置"></a><strong>6.1.2master02节点配置</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kube-apiserver.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line">​</span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kube-apiserver \\</span><br><span class="line">      --v=2  \\</span><br><span class="line">      --allow-privileged=true  \\</span><br><span class="line">      --bind-address=0.0.0.0  \\</span><br><span class="line">      --secure-port=6443  \\</span><br><span class="line">      --advertise-address=192.168.1.32 \\</span><br><span class="line">      --service-cluster-ip-range=10.96.0.0/12,fd00:1111::/112  \\</span><br><span class="line">      --service-node-port-range=30000-32767  \\</span><br><span class="line">      --etcd-servers=https://192.168.1.31:2379,https://192.168.1.32:2379,https://192.168.1.33:2379 \\</span><br><span class="line">      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  \\</span><br><span class="line">      --etcd-certfile=/etc/etcd/ssl/etcd.pem  \\</span><br><span class="line">      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  \\</span><br><span class="line">      --client-ca-file=/etc/kubernetes/pki/ca.pem  \\</span><br><span class="line">      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  \\</span><br><span class="line">      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  \\</span><br><span class="line">      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  \\</span><br><span class="line">      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  \\</span><br><span class="line">      --service-account-key-file=/etc/kubernetes/pki/sa.pub  \\</span><br><span class="line">      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key  \\</span><br><span class="line">      --service-account-issuer=https://kubernetes.default.svc.cluster.local \\</span><br><span class="line">      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  \\</span><br><span class="line">      --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  \\</span><br><span class="line">      --authorization-mode=Node,RBAC  \\</span><br><span class="line">      --enable-bootstrap-token-auth=true  \\</span><br><span class="line">      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  \\</span><br><span class="line">      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  \\</span><br><span class="line">      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  \\</span><br><span class="line">      --requestheader-allowed-names=aggregator  \\</span><br><span class="line">      --requestheader-group-headers=X-Remote-Group  \\</span><br><span class="line">      --requestheader-extra-headers-prefix=X-Remote-Extra-  \\</span><br><span class="line">      --requestheader-username-headers=X-Remote-User \\</span><br><span class="line">      --enable-aggregator-routing=true</span><br><span class="line">​</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=10s</span><br><span class="line">LimitNOFILE=65535</span><br><span class="line">​</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">​</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="6-1-3master03节点配置"><a href="#6-1-3master03节点配置" class="headerlink" title="6.1.3master03节点配置"></a><strong>6.1.3master03节点配置</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kube-apiserver.service  &lt;&lt; EOF</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kube-apiserver \\</span><br><span class="line">      --v=2  \\</span><br><span class="line">      --allow-privileged=true  \\</span><br><span class="line">      --bind-address=0.0.0.0  \\</span><br><span class="line">      --secure-port=6443  \\</span><br><span class="line">      --advertise-address=192.168.1.33 \\</span><br><span class="line">      --service-cluster-ip-range=10.96.0.0/12,fd00:1111::/112  \\</span><br><span class="line">      --service-node-port-range=30000-32767  \\</span><br><span class="line">      --etcd-servers=https://192.168.1.31:2379,https://192.168.1.32:2379,https://192.168.1.33:2379 \\</span><br><span class="line">      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  \\</span><br><span class="line">      --etcd-certfile=/etc/etcd/ssl/etcd.pem  \\</span><br><span class="line">      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  \\</span><br><span class="line">      --client-ca-file=/etc/kubernetes/pki/ca.pem  \\</span><br><span class="line">      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  \\</span><br><span class="line">      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  \\</span><br><span class="line">      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  \\</span><br><span class="line">      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  \\</span><br><span class="line">      --service-account-key-file=/etc/kubernetes/pki/sa.pub  \\</span><br><span class="line">      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key  \\</span><br><span class="line">      --service-account-issuer=https://kubernetes.default.svc.cluster.local \\</span><br><span class="line">      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  \\</span><br><span class="line">      --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  \\</span><br><span class="line">      --authorization-mode=Node,RBAC  \\</span><br><span class="line">      --enable-bootstrap-token-auth=true  \\</span><br><span class="line">      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  \\</span><br><span class="line">      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  \\</span><br><span class="line">      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  \\</span><br><span class="line">      --requestheader-allowed-names=aggregator  \\</span><br><span class="line">      --requestheader-group-headers=X-Remote-Group  \\</span><br><span class="line">      --requestheader-extra-headers-prefix=X-Remote-Extra-  \\</span><br><span class="line">      --requestheader-username-headers=X-Remote-User \\</span><br><span class="line">      --enable-aggregator-routing=true</span><br><span class="line"></span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=10s</span><br><span class="line">LimitNOFILE=65535</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">该配置文件是用于定义Kubernetes API Server的systemd服务的配置。systemd是一个用于启动和管理Linux系统服务的守护进程。</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">- Description: 服务的描述信息，用于显示在日志和系统管理工具中。</span><br><span class="line">- Documentation: 提供关于服务的文档链接。</span><br><span class="line">- After: 规定服务依赖于哪些其他服务或单元。在这个例子中，API Server服务在网络目标启动之后启动。</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">- ExecStart: 定义服务的命令行参数和命令。这里指定了API Server的启动命令，包括各种参数选项。</span><br><span class="line">- Restart: 指定当服务退出时应该如何重新启动。在这个例子中，服务在失败时将被重新启动。</span><br><span class="line">- RestartSec: 指定两次重新启动之间的等待时间。</span><br><span class="line">- LimitNOFILE: 指定进程可以打开的文件描述符的最大数量。</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">- WantedBy: 指定服务应该安装到哪个系统目标。在这个例子中，服务将被安装到multi-user.target目标，以便在多用户模式下启动。</span><br><span class="line"></span><br><span class="line">上述配置文件中定义的kube-apiserver服务将以指定的参数运行，这些参数包括：</span><br><span class="line"></span><br><span class="line">- `--v=2` 指定日志级别为2，打印详细的API Server日志。</span><br><span class="line">- `--allow-privileged=true` 允许特权容器运行。</span><br><span class="line">- `--bind-address=0.0.0.0` 绑定API Server监听的IP地址。</span><br><span class="line">- `--secure-port=6443` 指定API Server监听的安全端口。</span><br><span class="line">- `--advertise-address=192.168.1.31` 广告API Server的地址。</span><br><span class="line">- `--service-cluster-ip-range=10.96.0.0/12,fd00:1111::/112` 指定服务CIDR范围。</span><br><span class="line">- `--service-node-port-range=30000-32767` 指定NodePort的范围。</span><br><span class="line">- `--etcd-servers=https://192.168.1.31:2379,https://192.168.1.32:2379,https://192.168.1.33:2379` 指定etcd服务器的地址。</span><br><span class="line">- `--etcd-cafile` 指定etcd服务器的CA证书。</span><br><span class="line">- `--etcd-certfile` 指定etcd服务器的证书。</span><br><span class="line">- `--etcd-keyfile` 指定etcd服务器的私钥。</span><br><span class="line">- `--client-ca-file` 指定客户端CA证书。</span><br><span class="line">- `--tls-cert-file` 指定服务的证书。</span><br><span class="line">- `--tls-private-key-file` 指定服务的私钥。</span><br><span class="line">- `--kubelet-client-certificate` 和 `--kubelet-client-key` 指定与kubelet通信的客户端证书和私钥。</span><br><span class="line">- `--service-account-key-file` 指定服务账户公钥文件。</span><br><span class="line">- `--service-account-signing-key-file` 指定服务账户签名密钥文件。</span><br><span class="line">- `--service-account-issuer` 指定服务账户的发布者。</span><br><span class="line">- `--kubelet-preferred-address-types` 指定kubelet通信时的首选地址类型。</span><br><span class="line">- `--enable-admission-plugins` 启用一系列准入插件。</span><br><span class="line">- `--authorization-mode` 指定授权模式。</span><br><span class="line">- `--enable-bootstrap-token-auth` 启用引导令牌认证。</span><br><span class="line">- `--requestheader-client-ca-file` 指定请求头中的客户端CA证书。</span><br><span class="line">- `--proxy-client-cert-file` 和 `--proxy-client-key-file` 指定代理客户端的证书和私钥。</span><br><span class="line">- `--requestheader-allowed-names` 指定请求头中允许的名字。</span><br><span class="line">- `--requestheader-group-headers` 指定请求头中的组头。</span><br><span class="line">- `--requestheader-extra-headers-prefix` 指定请求头中的额外头前缀。</span><br><span class="line">- `--requestheader-username-headers` 指定请求头中的用户名头。</span><br><span class="line">- `--enable-aggregator-routing` 启用聚合路由。</span><br><span class="line"></span><br><span class="line">整个配置文件为Kubernetes API Server提供了必要的参数，以便正确地启动和运行。</span><br></pre></td></tr></table></figure>

<h3 id="6-1-4启动apiserver（所有master节点）"><a href="#6-1-4启动apiserver（所有master节点）" class="headerlink" title="6.1.4启动apiserver（所有master节点）"></a><strong>6.1.4启动apiserver（所有master节点）</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line"># 用于重新加载systemd管理的单位文件。当你新增或修改了某个单位文件（如.service文件、.socket文件等），需要运行该命令来刷新systemd对该文件的配置。</span><br><span class="line"></span><br><span class="line">systemctl enable --now kube-apiserver.service</span><br><span class="line"># 启用并立即启动kube-apiserver.service单元。kube-apiserver.service是kube-apiserver守护进程的systemd服务单元。</span><br><span class="line"></span><br><span class="line">systemctl restart kube-apiserver.service</span><br><span class="line"># 重启kube-apiserver.service单元，即重新启动etcd守护进程。</span><br><span class="line"></span><br><span class="line">systemctl status kube-apiserver.service</span><br><span class="line"># kube-apiserver.service单元的当前状态，包括运行状态、是否启用等信息。</span><br></pre></td></tr></table></figure>

<h2 id="6-2-配置kube-controller-manager-service"><a href="#6-2-配置kube-controller-manager-service" class="headerlink" title="6.2.配置kube-controller-manager service"></a><strong>6.2.配置kube-controller-manager service</strong></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"># 所有master节点配置，且配置相同</span><br><span class="line"># 172.16.0.0/12为pod网段，按需求设置你自己的网段</span><br><span class="line"></span><br><span class="line">cat &gt; /usr/lib/systemd/system/kube-controller-manager.service &lt;&lt; EOF</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kube-controller-manager \\</span><br><span class="line">      --v=2 \\</span><br><span class="line">      --bind-address=0.0.0.0 \\</span><br><span class="line">      --root-ca-file=/etc/kubernetes/pki/ca.pem \\</span><br><span class="line">      --cluster-signing-cert-file=/etc/kubernetes/pki/ca.pem \\</span><br><span class="line">      --cluster-signing-key-file=/etc/kubernetes/pki/ca-key.pem \\</span><br><span class="line">      --service-account-private-key-file=/etc/kubernetes/pki/sa.key \\</span><br><span class="line">      --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig \\</span><br><span class="line">      --leader-elect=true \\</span><br><span class="line">      --use-service-account-credentials=true \\</span><br><span class="line">      --node-monitor-grace-period=40s \\</span><br><span class="line">      --node-monitor-period=5s \\</span><br><span class="line">      --controllers=*,bootstrapsigner,tokencleaner \\</span><br><span class="line">      --allocate-node-cidrs=true \\</span><br><span class="line">      --service-cluster-ip-range=10.96.0.0/12,fd00:1111::/112 \\</span><br><span class="line">      --cluster-cidr=172.16.0.0/12,fc00:2222::/112 \\</span><br><span class="line">      --node-cidr-mask-size-ipv4=24 \\</span><br><span class="line">      --node-cidr-mask-size-ipv6=120 \\</span><br><span class="line">      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem</span><br><span class="line"></span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=10s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">这是一个用于启动 Kubernetes 控制器管理器的 systemd 服务单元文件。下面是对每个部分的详细解释：</span><br><span class="line"></span><br><span class="line">[Unit]：单元的基本信息部分，用于描述和标识这个服务单元。</span><br><span class="line">Description：服务单元的描述信息，说明了该服务单元的作用，这里是 Kubernetes 控制器管理器。</span><br><span class="line">Documentation：可选项，提供了关于该服务单元的文档链接。</span><br><span class="line">After：定义了该服务单元在哪些其他单元之后启动，这里是 network.target，即在网络服务启动之后启动。</span><br><span class="line"></span><br><span class="line">[Service]：定义了服务的运行参数和行为。</span><br><span class="line">ExecStart：指定服务启动时执行的命令，这里是 /usr/local/bin/kube-controller-manager，并通过后续的行继续传递了一系列的参数设置。</span><br><span class="line">Restart：定义了服务在退出后的重新启动策略，这里设置为 always，表示总是重新启动服务。</span><br><span class="line">RestartSec：定义了重新启动服务的时间间隔，这里设置为 10 秒。</span><br><span class="line"></span><br><span class="line">[Install]：定义了如何安装和启用服务单元。</span><br><span class="line">WantedBy：指定了服务单元所属的 target，这里是 multi-user.target，表示启动多用户模式下的服务。</span><br><span class="line">在 ExecStart 中传递的参数说明如下：</span><br><span class="line"></span><br><span class="line">--v=2：设置日志的详细级别为 2。</span><br><span class="line">--bind-address=0.0.0.0：绑定的 IP 地址，用于监听 Kubernetes 控制平面的请求，这里设置为 0.0.0.0，表示监听所有网络接口上的请求。</span><br><span class="line">--root-ca-file：根证书文件的路径，用于验证其他组件的证书。</span><br><span class="line">--cluster-signing-cert-file：用于签名集群证书的证书文件路径。</span><br><span class="line">--cluster-signing-key-file：用于签名集群证书的私钥文件路径。</span><br><span class="line">--service-account-private-key-file：用于签名服务账户令牌的私钥文件路径。</span><br><span class="line">--kubeconfig：kubeconfig 文件的路径，包含了与 Kubernetes API 服务器通信所需的配置信息。</span><br><span class="line">--leader-elect=true：启用 Leader 选举机制，确保只有一个控制器管理器作为 leader 在运行。</span><br><span class="line">--use-service-account-credentials=true：使用服务账户的凭据进行认证和授权。</span><br><span class="line">--node-monitor-grace-period=40s：节点监控的优雅退出时间，节点长时间不响应时会触发节点驱逐。</span><br><span class="line">--node-monitor-period=5s：节点监控的检测周期，用于检测节点是否正常运行。</span><br><span class="line">--controllers：指定要运行的控制器类型，在这里使用了通配符 *，表示运行所有的控制器，同时还包括了 bootstrapsigner 和 tokencleaner 控制器。</span><br><span class="line">--allocate-node-cidrs=true：为节点分配 CIDR 子网，用于分配 Pod 网络地址。</span><br><span class="line">--service-cluster-ip-range：定义 Service 的 IP 范围，这里设置为 10.96.0.0/12 和 fd00::/108。</span><br><span class="line">--cluster-cidr：定义集群的 CIDR 范围，这里设置为 172.16.0.0/12 和 fc00::/48。</span><br><span class="line">--node-cidr-mask-size-ipv4：分配给每个节点的 IPv4 子网掩码大小，默认是 24。</span><br><span class="line">--node-cidr-mask-size-ipv6：分配给每个节点的 IPv6 子网掩码大小，默认是 120。</span><br><span class="line">--requestheader-client-ca-file：设置请求头中客户端 CA 的证书文件路径，用于认证请求头中的 CA 证书。</span><br><span class="line"></span><br><span class="line">这个服务单元文件描述了 Kubernetes 控制器管理器的启动参数和行为，并且定义了服务的依赖关系和重新启动策略。通过 systemd 启动该服务单元，即可启动 Kubernetes 控制器管理器组件。</span><br></pre></td></tr></table></figure>

<h3 id="6-2-1启动kube-controller-manager，并查看状态"><a href="#6-2-1启动kube-controller-manager，并查看状态" class="headerlink" title="6.2.1启动kube-controller-manager，并查看状态"></a><strong>6.2.1启动kube-controller-manager，并查看状态</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line"># 用于重新加载systemd管理的单位文件。当你新增或修改了某个单位文件（如.service文件、.socket文件等），需要运行该命令来刷新systemd对该文件的配置。</span><br><span class="line"></span><br><span class="line">systemctl enable --now kube-controller-manager.service</span><br><span class="line"># 启用并立即启动kube-controller-manager.service单元。kube-controller-manager.service是kube-controller-manager守护进程的systemd服务单元。</span><br><span class="line"></span><br><span class="line">systemctl restart kube-controller-manager.service</span><br><span class="line"># 重启kube-controller-manager.service单元，即重新启动etcd守护进程。</span><br><span class="line"></span><br><span class="line">systemctl status kube-controller-manager.service</span><br><span class="line"># kube-controller-manager.service单元的当前状态，包括运行状态、是否启用等信息。</span><br></pre></td></tr></table></figure>

<h2 id="6-3-配置kube-scheduler-service"><a href="#6-3-配置kube-scheduler-service" class="headerlink" title="6.3.配置kube-scheduler service"></a><strong>6.3.配置kube-scheduler service</strong></h2><h3 id="6-3-1所有master节点配置，且配置相同"><a href="#6-3-1所有master节点配置，且配置相同" class="headerlink" title="6.3.1所有master节点配置，且配置相同"></a><strong>6.3.1所有master节点配置，且配置相同</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kube-scheduler.service &lt;&lt; EOF</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kube-scheduler \\</span><br><span class="line">      --v=2 \\</span><br><span class="line">      --bind-address=0.0.0.0 \\</span><br><span class="line">      --leader-elect=true \\</span><br><span class="line">      --kubeconfig=/etc/kubernetes/scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=10s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">这是一个用于启动 Kubernetes 调度器的 systemd 服务单元文件。下面是对每个部分的详细解释：</span><br><span class="line"></span><br><span class="line">[Unit]：单元的基本信息部分，用于描述和标识这个服务单元。</span><br><span class="line">Description：服务单元的描述信息，说明了该服务单元的作用，这里是 Kubernetes 调度器。</span><br><span class="line">Documentation：可选项，提供了关于该服务单元的文档链接。</span><br><span class="line">After：定义了该服务单元在哪些其他单元之后启动，这里是 network.target，即在网络服务启动之后启动。</span><br><span class="line"></span><br><span class="line">[Service]：定义了服务的运行参数和行为。</span><br><span class="line">ExecStart：指定服务启动时执行的命令，这里是 /usr/local/bin/kube-scheduler，并通过后续的行继续传递了一系列的参数设置。</span><br><span class="line">Restart：定义了服务在退出后的重新启动策略，这里设置为 always，表示总是重新启动服务。</span><br><span class="line">RestartSec：定义了重新启动服务的时间间隔，这里设置为 10 秒。</span><br><span class="line"></span><br><span class="line">[Install]：定义了如何安装和启用服务单元。</span><br><span class="line">WantedBy：指定了服务单元所属的 target，这里是 multi-user.target，表示启动多用户模式下的服务。</span><br><span class="line"></span><br><span class="line">在 ExecStart 中传递的参数说明如下：</span><br><span class="line"></span><br><span class="line">--v=2：设置日志的详细级别为 2。</span><br><span class="line">--bind-address=0.0.0.0：绑定的 IP 地址，用于监听 Kubernetes 控制平面的请求，这里设置为 0.0.0.0，表示监听所有网络接口上的请求。</span><br><span class="line">--leader-elect=true：启用 Leader 选举机制，确保只有一个调度器作为 leader 在运行。</span><br><span class="line">--kubeconfig=/etc/kubernetes/scheduler.kubeconfig：kubeconfig 文件的路径，包含了与 Kubernetes API 服务器通信所需的配置信息。</span><br><span class="line"></span><br><span class="line">这个服务单元文件描述了 Kubernetes 调度器的启动参数和行为，并且定义了服务的依赖关系和重新启动策略。通过 systemd 启动该服务单元，即可启动 Kubernetes 调度器组件。</span><br></pre></td></tr></table></figure>

<h3 id="6-3-2启动并查看服务状态"><a href="#6-3-2启动并查看服务状态" class="headerlink" title="6.3.2启动并查看服务状态"></a><strong>6.3.2启动并查看服务状态</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line"># 用于重新加载systemd管理的单位文件。当你新增或修改了某个单位文件（如.service文件、.socket文件等），需要运行该命令来刷新systemd对该文件的配置。</span><br><span class="line"></span><br><span class="line">systemctl enable --now kube-scheduler.service</span><br><span class="line"># 启用并立即启动kube-scheduler.service单元。kube-scheduler.service是kube-scheduler守护进程的systemd服务单元。</span><br><span class="line"></span><br><span class="line">systemctl restart kube-scheduler.service</span><br><span class="line"># 重启kube-scheduler.service单元，即重新启动etcd守护进程。</span><br><span class="line"></span><br><span class="line">systemctl status kube-scheduler.service</span><br><span class="line"># kube-scheduler.service单元的当前状态，包括运行状态、是否启用等信息。</span><br></pre></td></tr></table></figure>

<h1 id="7-TLS-Bootstrapping配置"><a href="#7-TLS-Bootstrapping配置" class="headerlink" title="7.TLS Bootstrapping配置"></a>7.TLS Bootstrapping配置</h1><h2 id="7-1在master01上配置"><a href="#7-1在master01上配置" class="headerlink" title="7.1在master01上配置"></a><strong>7.1在master01上配置</strong></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"># 在《5.高可用配置》选择使用那种高可用方案</span><br><span class="line"># 若使用 haproxy、keepalived 那么为 `--server=https://192.168.1.36:8443`</span><br><span class="line"># 若使用 nginx方案，那么为 `--server=https://127.0.0.1:8443`</span><br><span class="line"></span><br><span class="line">cd bootstrap</span><br><span class="line"></span><br><span class="line">kubectl config set-cluster kubernetes     \</span><br><span class="line">--certificate-authority=/etc/kubernetes/pki/ca.pem     \</span><br><span class="line">--embed-certs=true     --server=https://127.0.0.1:8443     \</span><br><span class="line">--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig</span><br><span class="line"># 这是一个使用 kubectl 命令设置 Kubernetes 集群配置的命令示例。下面是对每个选项的详细解释：</span><br><span class="line"># </span><br><span class="line"># config set-cluster kubernetes：指定要设置的集群名称为 &quot;kubernetes&quot;，表示要修改名为 &quot;kubernetes&quot; 的集群配置。</span><br><span class="line"># --certificate-authority=/etc/kubernetes/pki/ca.pem：指定证书颁发机构（CA）的证书文件路径，用于验证服务器证书的有效性。</span><br><span class="line"># --embed-certs=true：将证书文件嵌入到生成的 kubeconfig 文件中。这样可以避免在 kubeconfig 文件中引用外部证书文件。</span><br><span class="line"># --server=https://127.0.0.1:8443：指定 Kubernetes API 服务器的地址和端口，这里使用的是 https 协议和本地地址（127.0.0.1），端口号为 8443。你可以根据实际环境修改该参数。</span><br><span class="line"># --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig：指定 kubeconfig 文件的路径和名称，这里是 /etc/kubernetes/bootstrap-kubelet.kubeconfig。</span><br><span class="line"># 通过执行此命令，你可以设置名为 &quot;kubernetes&quot; 的集群配置，并提供 CA 证书、API 服务器地址和端口，并将这些配置信息嵌入到 bootstrap-kubelet.kubeconfig 文件中。这个 kubeconfig 文件可以用于认证和授权 kubelet 组件与 Kubernetes API 服务器之间的通信。请确保路径和文件名与实际环境中的配置相匹配。</span><br><span class="line"></span><br><span class="line">kubectl config set-credentials tls-bootstrap-token-user     \</span><br><span class="line">--token=c8ad9c.2e4d610cf3e7426e \</span><br><span class="line">--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig</span><br><span class="line"># 这是一个使用 kubectl 命令设置凭证信息的命令示例。下面是对每个选项的详细解释：</span><br><span class="line"># </span><br><span class="line"># config set-credentials tls-bootstrap-token-user：指定要设置的凭证名称为 &quot;tls-bootstrap-token-user&quot;，表示要修改名为 &quot;tls-bootstrap-token-user&quot; 的用户凭证配置。</span><br><span class="line"># --token=c8ad9c.2e4d610cf3e7426e：指定用户的身份验证令牌（token）。在这个示例中，令牌是 c8ad9c.2e4d610cf3e7426e。你可以根据实际情况修改该令牌。</span><br><span class="line"># --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig：指定 kubeconfig 文件的路径和名称，这里是 /etc/kubernetes/bootstrap-kubelet.kubeconfig。</span><br><span class="line"># 通过执行此命令，你可以设置名为 &quot;tls-bootstrap-token-user&quot; 的用户凭证，并将令牌信息加入到 bootstrap-kubelet.kubeconfig 文件中。这个 kubeconfig 文件可以用于认证和授权 kubelet 组件与 Kubernetes API 服务器之间的通信。请确保路径和文件名与实际环境中的配置相匹配。</span><br><span class="line"></span><br><span class="line">kubectl config set-context tls-bootstrap-token-user@kubernetes     \</span><br><span class="line">--cluster=kubernetes     \</span><br><span class="line">--user=tls-bootstrap-token-user     \</span><br><span class="line">--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig</span><br><span class="line"># 这是一个使用 kubectl 命令设置上下文信息的命令示例。下面是对每个选项的详细解释：</span><br><span class="line"># </span><br><span class="line"># config set-context tls-bootstrap-token-user@kubernetes：指定要设置的上下文名称为 &quot;tls-bootstrap-token-user@kubernetes&quot;，表示要修改名为 &quot;tls-bootstrap-token-user@kubernetes&quot; 的上下文配置。</span><br><span class="line"># --cluster=kubernetes：指定上下文关联的集群名称为 &quot;kubernetes&quot;，表示使用名为 &quot;kubernetes&quot; 的集群配置。</span><br><span class="line"># --user=tls-bootstrap-token-user：指定上下文关联的用户凭证名称为 &quot;tls-bootstrap-token-user&quot;，表示使用名为 &quot;tls-bootstrap-token-user&quot; 的用户凭证配置。</span><br><span class="line"># --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig：指定 kubeconfig 文件的路径和名称，这里是 /etc/kubernetes/bootstrap-kubelet.kubeconfig。</span><br><span class="line"># 通过执行此命令，你可以设置名为 &quot;tls-bootstrap-token-user@kubernetes&quot; 的上下文，并将其关联到名为 &quot;kubernetes&quot; 的集群配置和名为 &quot;tls-bootstrap-token-user&quot; 的用户凭证配置。这样，bootstrap-kubelet.kubeconfig 文件就包含了完整的上下文信息，可以用于指定与 Kubernetes 集群建立连接时要使用的集群和凭证。请确保路径和文件名与实际环境中的配置相匹配。</span><br><span class="line"></span><br><span class="line">kubectl config use-context tls-bootstrap-token-user@kubernetes     \</span><br><span class="line">--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig</span><br><span class="line"># 这是一个使用 kubectl 命令设置当前上下文的命令示例。下面是对每个选项的详细解释：</span><br><span class="line"># </span><br><span class="line"># config use-context tls-bootstrap-token-user@kubernetes：指定要使用的上下文名称为 &quot;tls-bootstrap-token-user@kubernetes&quot;，表示要将当前上下文切换为名为 &quot;tls-bootstrap-token-user@kubernetes&quot; 的上下文。</span><br><span class="line"># --kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig：指定 kubeconfig 文件的路径和名称，这里是 /etc/kubernetes/bootstrap-kubelet.kubeconfig。</span><br><span class="line"># 通过执行此命令，你可以将当前上下文设置为名为 &quot;tls-bootstrap-token-user@kubernetes&quot; 的上下文。这样，当你执行其他 kubectl 命令时，它们将使用该上下文与 Kubernetes 集群进行交互。请确保路径和文件名与实际环境中的配置相匹配。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># token的位置在bootstrap.secret.yaml，如果修改的话到这个文件修改</span><br><span class="line">mkdir -p /root/.kube ; cp /etc/kubernetes/admin.kubeconfig /root/.kube/config</span><br></pre></td></tr></table></figure>

<h2 id="7-2查看集群状态，没问题的话继续后续操作"><a href="#7-2查看集群状态，没问题的话继续后续操作" class="headerlink" title="7.2查看集群状态，没问题的话继续后续操作"></a><strong>7.2查看集群状态，没问题的话继续后续操作</strong></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 1.28 版本只能查看到一个etcd 属于正常现象</span><br><span class="line"># export ETCDCTL_API=3</span><br><span class="line"># etcdctl --endpoints=&quot;192.168.1.33:2379,192.168.1.32:2379,192.168.1.31:2379&quot; --cacert=/etc/kubernetes/pki/etcd/etcd-ca.pem --cert=/etc/kubernetes/pki/etcd/etcd.pem --key=/etc/kubernetes/pki/etcd/etcd-key.pem  endpoint status --write-out=table</span><br><span class="line"></span><br><span class="line">kubectl get cs</span><br><span class="line">Warning: v1 ComponentStatus is deprecated in v1.19+</span><br><span class="line">NAME                 STATUS    MESSAGE   ERROR</span><br><span class="line">scheduler            Healthy   ok        </span><br><span class="line">controller-manager   Healthy   ok        </span><br><span class="line">etcd-0               Healthy   ok </span><br><span class="line"></span><br><span class="line"># 切记执行，别忘记！！！</span><br><span class="line">kubectl create -f bootstrap.secret.yaml</span><br></pre></td></tr></table></figure>

<h1 id="8-node节点配置"><a href="#8-node节点配置" class="headerlink" title="8.node节点配置"></a>8.node节点配置</h1><h2 id="8-1-在master01上将证书复制到node节点"><a href="#8-1-在master01上将证书复制到node节点" class="headerlink" title="8.1.在master01上将证书复制到node节点"></a><strong>8.1.在master01上将证书复制到node节点</strong></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/kubernetes/</span><br><span class="line"> </span><br><span class="line">for NODE in k8s-master02 k8s-master03 k8s-node01 k8s-node02; do ssh $NODE mkdir -p /etc/kubernetes/pki; for FILE in pki/ca.pem pki/ca-key.pem pki/front-proxy-ca.pem bootstrap-kubelet.kubeconfig kube-proxy.kubeconfig; do scp /etc/kubernetes/$FILE $NODE:/etc/kubernetes/$&#123;FILE&#125;; done; done</span><br></pre></td></tr></table></figure>

<h2 id="8-2-kubelet配置"><a href="#8-2-kubelet配置" class="headerlink" title="8.2.kubelet配置"></a><strong>8.2.kubelet配置</strong></h2><p><strong>注意 ： 8.2.1 和 8.2.2 需要和 上方 2.1 和 2.2 对应起来</strong></p>
<h3 id="8-2-1当使用docker作为Runtime"><a href="#8-2-1当使用docker作为Runtime" class="headerlink" title="8.2.1当使用docker作为Runtime"></a><strong>8.2.1当使用docker作为Runtime</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kubelet.service &lt;&lt; EOF</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network-online.target firewalld.service cri-docker.service docker.socket containerd.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line">Requires=docker.socket containerd.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kubelet \\</span><br><span class="line">    --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig  \\</span><br><span class="line">    --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \\</span><br><span class="line">    --config=/etc/kubernetes/kubelet-conf.yml \\</span><br><span class="line">    --container-runtime-endpoint=unix:///run/cri-dockerd.sock  \\</span><br><span class="line">    --node-labels=node.kubernetes.io/node= </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># 这是一个表示 Kubernetes Kubelet 服务的 systemd 单位文件示例。下面是对每个节（[Unit]、[Service]、[Install]）的详细解释：</span><br><span class="line"># </span><br><span class="line"># [Unit]</span><br><span class="line"># </span><br><span class="line"># Description=Kubernetes Kubelet：指定了此单位文件对应的服务描述信息为 &quot;Kubernetes Kubelet&quot;。</span><br><span class="line"># Documentation=...：指定了对该服务的文档链接。</span><br><span class="line"># - After: 说明该服务在哪些其他服务之后启动，这里是在网络在线、firewalld服务和containerd服务后启动。</span><br><span class="line"># - Wants: 说明该服务想要的其他服务，这里是网络在线服务。</span><br><span class="line"># - Requires: 说明该服务需要的其他服务，这里是docker.socket和containerd.service。</span><br><span class="line"># [Service]</span><br><span class="line"># </span><br><span class="line"># ExecStart=/usr/local/bin/kubelet ...：指定了启动 Kubelet 服务的命令和参数。这里使用的是 /usr/local/bin/kubelet 命令，并传递了一系列参数来配置 Kubelet 的运行。这些参数包括：</span><br><span class="line"># --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig：指定了用于引导 kubelet 的 kubeconfig 文件的路径和名称。</span><br><span class="line"># --kubeconfig=/etc/kubernetes/kubelet.kubeconfig：指定了 kubelet 的 kubeconfig 文件的路径和名称。</span><br><span class="line"># --config=/etc/kubernetes/kubelet-conf.yml：指定了 kubelet 的配置文件的路径和名称。</span><br><span class="line"># --container-runtime-endpoint=unix:///run/cri-dockerd.sock：指定了容器运行时接口的端点地址，这里使用的是 Docker 运行时（cri-dockerd）的 UNIX 套接字。</span><br><span class="line"># --node-labels=node.kubernetes.io/node=：指定了节点的标签。这里的示例只给节点添加了一个简单的标签 node.kubernetes.io/node=。</span><br><span class="line"># [Install]</span><br><span class="line"># </span><br><span class="line"># WantedBy=multi-user.target：指定了在 multi-user.target 被启动时，该服务应该被启用。</span><br><span class="line"># 通过这个单位文件，你可以配置 Kubelet 服务的启动参数，指定相关的配置文件和凭证文件，以及定义节点的标签。请确认路径和文件名与你的实际环境中的配置相匹配。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># IPv6示例</span><br><span class="line"># 若不使用IPv6那么忽略此项即可</span><br><span class="line"># 下方 --node-ip 更换为每个节点的IP即可</span><br><span class="line">cat &gt; /usr/lib/systemd/system/kubelet.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network-online.target firewalld.service cri-docker.service docker.socket containerd.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line">Requires=docker.socket containerd.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kubelet \\</span><br><span class="line">    --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig  \\</span><br><span class="line">    --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \\</span><br><span class="line">    --config=/etc/kubernetes/kubelet-conf.yml \\</span><br><span class="line">    --container-runtime-endpoint=unix:///run/cri-dockerd.sock  \\</span><br><span class="line">    --node-labels=node.kubernetes.io/node=   \\</span><br><span class="line">    --node-ip=192.168.1.31,2408:822a:245:8c01::fab</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="8-2-2当使用Containerd作为Runtime-（推荐）"><a href="#8-2-2当使用Containerd作为Runtime-（推荐）" class="headerlink" title="8.2.2当使用Containerd作为Runtime （推荐）"></a><strong>8.2.2当使用Containerd作为Runtime （推荐）</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /var/lib/kubelet /var/log/kubernetes /etc/systemd/system/kubelet.service.d /etc/kubernetes/manifests/</span><br><span class="line">​</span><br><span class="line"># 所有k8s节点配置kubelet service</span><br><span class="line">cat &gt; /usr/lib/systemd/system/kubelet.service &lt;&lt; EOF</span><br><span class="line">​</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network-online.target firewalld.service containerd.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line">Requires=containerd.service</span><br><span class="line">​</span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kubelet \\</span><br><span class="line">    --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig  \\</span><br><span class="line">    --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \\</span><br><span class="line">    --config=/etc/kubernetes/kubelet-conf.yml \\</span><br><span class="line">    --container-runtime-endpoint=unix:///run/containerd/containerd.sock  \\</span><br><span class="line">    --node-labels=node.kubernetes.io/node=</span><br><span class="line">​</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line">​</span><br><span class="line"># 这是一个表示 Kubernetes Kubelet 服务的 systemd 单位文件示例。与之前相比，添加了 After 和 Requires 字段来指定依赖关系。</span><br><span class="line"># </span><br><span class="line"># [Unit]</span><br><span class="line"># </span><br><span class="line"># Description=Kubernetes Kubelet：指定了此单位文件对应的服务描述信息为 &quot;Kubernetes Kubelet&quot;。</span><br><span class="line"># Documentation=...：指定了对该服务的文档链接。</span><br><span class="line"># - After: 说明该服务在哪些其他服务之后启动，这里是在网络在线、firewalld服务和containerd服务后启动。</span><br><span class="line"># - Wants: 说明该服务想要的其他服务，这里是网络在线服务。</span><br><span class="line"># - Requires: 说明该服务需要的其他服务，这里是docker.socket和containerd.service。</span><br><span class="line"># [Service]</span><br><span class="line"># </span><br><span class="line"># ExecStart=/usr/local/bin/kubelet ...：指定了启动 Kubelet 服务的命令和参数，与之前的示例相同。</span><br><span class="line"># --container-runtime-endpoint=unix:///run/containerd/containerd.sock：修改了容器运行时接口的端点地址，将其更改为使用 containerd 运行时（通过 UNIX 套接字）。</span><br><span class="line"># [Install]</span><br><span class="line"># </span><br><span class="line"># WantedBy=multi-user.target：指定了在 multi-user.target 被启动时，该服务应该被启用。</span><br><span class="line"># 通过这个单位文件，你可以配置 Kubelet 服务的启动参数，并指定了它依赖的 containerd 服务。确保路径和文件名与你实际环境中的配置相匹配。</span><br><span class="line">​</span><br><span class="line">​</span><br><span class="line">​</span><br><span class="line"># IPv6示例</span><br><span class="line"># 若不使用IPv6那么忽略此项即可</span><br><span class="line"># 下方 --node-ip 更换为每个节点的IP即可</span><br><span class="line">cat &gt; /usr/lib/systemd/system/kubelet.service &lt;&lt; EOF</span><br><span class="line">​</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network-online.target firewalld.service containerd.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line">Requires=containerd.service</span><br><span class="line">​</span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kubelet \\</span><br><span class="line">    --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig  \\</span><br><span class="line">    --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \\</span><br><span class="line">    --config=/etc/kubernetes/kubelet-conf.yml \\</span><br><span class="line">    --container-runtime-endpoint=unix:///run/containerd/containerd.sock  \\</span><br><span class="line">    --node-labels=node.kubernetes.io/node=  \\</span><br><span class="line">    --node-ip=192.168.1.31,2408:822a:245:8c01::fab</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="8-2-3所有k8s节点创建kubelet的配置文件"><a href="#8-2-3所有k8s节点创建kubelet的配置文件" class="headerlink" title="8.2.3所有k8s节点创建kubelet的配置文件"></a><strong>8.2.3所有k8s节点创建kubelet的配置文件</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/kubernetes/kubelet-conf.yml &lt;&lt;EOF</span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">address: 0.0.0.0</span><br><span class="line">port: 10250</span><br><span class="line">readOnlyPort: 10255</span><br><span class="line">authentication:</span><br><span class="line">  anonymous:</span><br><span class="line">    enabled: false</span><br><span class="line">  webhook:</span><br><span class="line">    cacheTTL: 2m0s</span><br><span class="line">    enabled: true</span><br><span class="line">  x509:</span><br><span class="line">    clientCAFile: /etc/kubernetes/pki/ca.pem</span><br><span class="line">authorization:</span><br><span class="line">  mode: Webhook</span><br><span class="line">  webhook:</span><br><span class="line">    cacheAuthorizedTTL: 5m0s</span><br><span class="line">    cacheUnauthorizedTTL: 30s</span><br><span class="line">cgroupDriver: systemd</span><br><span class="line">cgroupsPerQOS: true</span><br><span class="line">clusterDNS:</span><br><span class="line">- 10.96.0.10</span><br><span class="line">clusterDomain: cluster.local</span><br><span class="line">containerLogMaxFiles: 5</span><br><span class="line">containerLogMaxSize: 10Mi</span><br><span class="line">contentType: application/vnd.kubernetes.protobuf</span><br><span class="line">cpuCFSQuota: true</span><br><span class="line">cpuManagerPolicy: none</span><br><span class="line">cpuManagerReconcilePeriod: 10s</span><br><span class="line">enableControllerAttachDetach: true</span><br><span class="line">enableDebuggingHandlers: true</span><br><span class="line">enforceNodeAllocatable:</span><br><span class="line">- pods</span><br><span class="line">eventBurst: 10</span><br><span class="line">eventRecordQPS: 5</span><br><span class="line">evictionHard:</span><br><span class="line">  imagefs.available: 15%</span><br><span class="line">  memory.available: 100Mi</span><br><span class="line">  nodefs.available: 10%</span><br><span class="line">  nodefs.inodesFree: 5%</span><br><span class="line">evictionPressureTransitionPeriod: 5m0s</span><br><span class="line">failSwapOn: true</span><br><span class="line">fileCheckFrequency: 20s</span><br><span class="line">hairpinMode: promiscuous-bridge</span><br><span class="line">healthzBindAddress: 127.0.0.1</span><br><span class="line">healthzPort: 10248</span><br><span class="line">httpCheckFrequency: 20s</span><br><span class="line">imageGCHighThresholdPercent: 85</span><br><span class="line">imageGCLowThresholdPercent: 80</span><br><span class="line">imageMinimumGCAge: 2m0s</span><br><span class="line">iptablesDropBit: 15</span><br><span class="line">iptablesMasqueradeBit: 14</span><br><span class="line">kubeAPIBurst: 10</span><br><span class="line">kubeAPIQPS: 5</span><br><span class="line">makeIPTablesUtilChains: true</span><br><span class="line">maxOpenFiles: 1000000</span><br><span class="line">maxPods: 110</span><br><span class="line">nodeStatusUpdateFrequency: 10s</span><br><span class="line">oomScoreAdj: -999</span><br><span class="line">podPidsLimit: -1</span><br><span class="line">registryBurst: 10</span><br><span class="line">registryPullQPS: 5</span><br><span class="line">resolvConf: /etc/resolv.conf</span><br><span class="line">rotateCertificates: true</span><br><span class="line">runtimeRequestTimeout: 2m0s</span><br><span class="line">serializeImagePulls: true</span><br><span class="line">staticPodPath: /etc/kubernetes/manifests</span><br><span class="line">streamingConnectionIdleTimeout: 4h0m0s</span><br><span class="line">syncFrequency: 1m0s</span><br><span class="line">volumeStatsAggPeriod: 1m0s</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># 这是一个Kubelet的配置文件，用于配置Kubelet的各项参数。</span><br><span class="line"># </span><br><span class="line"># - apiVersion: kubelet.config.k8s.io/v1beta1：指定了配置文件的API版本为kubelet.config.k8s.io/v1beta1。</span><br><span class="line"># - kind: KubeletConfiguration：指定了配置类别为KubeletConfiguration。</span><br><span class="line"># - address: 0.0.0.0：指定了Kubelet监听的地址为0.0.0.0。</span><br><span class="line"># - port: 10250：指定了Kubelet监听的端口为10250。</span><br><span class="line"># - readOnlyPort: 10255：指定了只读端口为10255，用于提供只读的状态信息。</span><br><span class="line"># - authentication：指定了认证相关的配置信息。</span><br><span class="line">#   - anonymous.enabled: false：禁用了匿名认证。</span><br><span class="line">#   - webhook.enabled: true：启用了Webhook认证。</span><br><span class="line">#   - x509.clientCAFile: /etc/kubernetes/pki/ca.pem：指定了X509证书的客户端CA文件路径。</span><br><span class="line"># - authorization：指定了授权相关的配置信息。</span><br><span class="line">#   - mode: Webhook：指定了授权模式为Webhook。</span><br><span class="line">#   - webhook.cacheAuthorizedTTL: 5m0s：指定了授权缓存时间段为5分钟。</span><br><span class="line">#   - webhook.cacheUnauthorizedTTL: 30s：指定了未授权缓存时间段为30秒。</span><br><span class="line"># - cgroupDriver: systemd：指定了Cgroup驱动为systemd。</span><br><span class="line"># - cgroupsPerQOS: true：启用了每个QoS类别一个Cgroup的设置。</span><br><span class="line"># - clusterDNS: 指定了集群的DNS服务器地址列表。</span><br><span class="line">#   - 10.96.0.10：指定了DNS服务器地址为10.96.0.10。</span><br><span class="line"># - clusterDomain: cluster.local：指定了集群的域名后缀为cluster.local。</span><br><span class="line"># - containerLogMaxFiles: 5：指定了容器日志文件保留的最大数量为5个。</span><br><span class="line"># - containerLogMaxSize: 10Mi：指定了容器日志文件的最大大小为10Mi。</span><br><span class="line"># - contentType: application/vnd.kubernetes.protobuf：指定了内容类型为protobuf。</span><br><span class="line"># - cpuCFSQuota: true：启用了CPU CFS Quota。</span><br><span class="line"># - cpuManagerPolicy: none：禁用了CPU Manager。</span><br><span class="line"># - cpuManagerReconcilePeriod: 10s：指定了CPU管理器的调整周期为10秒。</span><br><span class="line"># - enableControllerAttachDetach: true：启用了控制器的挂载和拆卸。</span><br><span class="line"># - enableDebuggingHandlers: true：启用了调试处理程序。</span><br><span class="line"># - enforceNodeAllocatable: 指定了强制节点可分配资源的列表。</span><br><span class="line">#   - pods：强制节点可分配pods资源。</span><br><span class="line"># - eventBurst: 10：指定了事件突发的最大数量为10。</span><br><span class="line"># - eventRecordQPS: 5：指定了事件记录的最大请求量为5。</span><br><span class="line"># - evictionHard: 指定了驱逐硬性限制参数的配置信息。</span><br><span class="line">#   - imagefs.available: 15%：指定了镜像文件系统可用空间的限制为15%。</span><br><span class="line">#   - memory.available: 100Mi：指定了可用内存的限制为100Mi。</span><br><span class="line">#   - nodefs.available: 10%：指定了节点文件系统可用空间的限制为10%。</span><br><span class="line">#   - nodefs.inodesFree: 5%：指定了节点文件系统可用inode的限制为5%。</span><br><span class="line"># - evictionPressureTransitionPeriod: 5m0s：指定了驱逐压力转换的时间段为5分钟。</span><br><span class="line"># - failSwapOn: true：指定了在发生OOM时禁用交换分区。</span><br><span class="line"># - fileCheckFrequency: 20s：指定了文件检查频率为20秒。</span><br><span class="line"># - hairpinMode: promiscuous-bridge：设置了Hairpin Mode为&quot;promiscuous-bridge&quot;。</span><br><span class="line"># - healthzBindAddress: 127.0.0.1：指定了健康检查的绑定地址为127.0.0.1。</span><br><span class="line"># - healthzPort: 10248：指定了健康检查的端口为10248。</span><br><span class="line"># - httpCheckFrequency: 20s：指定了HTTP检查的频率为20秒。</span><br><span class="line"># - imageGCHighThresholdPercent: 85：指定了镜像垃圾回收的上阈值为85%。</span><br><span class="line"># - imageGCLowThresholdPercent: 80：指定了镜像垃圾回收的下阈值为80%。</span><br><span class="line"># - imageMinimumGCAge: 2m0s：指定了镜像垃圾回收的最小时间为2分钟。</span><br><span class="line"># - iptablesDropBit: 15：指定了iptables的Drop Bit为15。</span><br><span class="line"># - iptablesMasqueradeBit: 14：指定了iptables的Masquerade Bit为14。</span><br><span class="line"># - kubeAPIBurst: 10：指定了KubeAPI的突发请求数量为10个。</span><br><span class="line"># - kubeAPIQPS: 5：指定了KubeAPI的每秒请求频率为5个。</span><br><span class="line"># - makeIPTablesUtilChains: true：指定了是否使用iptables工具链。</span><br><span class="line"># - maxOpenFiles: 1000000：指定了最大打开文件数为1000000。</span><br><span class="line"># - maxPods: 110：指定了最大的Pod数量为110。</span><br><span class="line"># - nodeStatusUpdateFrequency: 10s：指定了节点状态更新的频率为10秒。</span><br><span class="line"># - oomScoreAdj: -999：指定了OOM Score Adjustment为-999。</span><br><span class="line"># - podPidsLimit: -1：指定了Pod的PID限制为-1，表示无限制。</span><br><span class="line"># - registryBurst: 10：指定了Registry的突发请求数量为10个。</span><br><span class="line"># - registryPullQPS: 5：指定了Registry的每秒拉取请求数量为5个。</span><br><span class="line"># - resolvConf: /etc/resolv.conf：指定了resolv.conf的文件路径。</span><br><span class="line"># - rotateCertificates: true：指定了是否轮转证书。</span><br><span class="line"># - runtimeRequestTimeout: 2m0s：指定了运行时请求的超时时间为2分钟。</span><br><span class="line"># - serializeImagePulls: true：指定了是否序列化镜像拉取。</span><br><span class="line"># - staticPodPath: /etc/kubernetes/manifests：指定了静态Pod的路径。</span><br><span class="line"># - streamingConnectionIdleTimeout: 4h0m0s：指定了流式连接的空闲超时时间为4小时。</span><br><span class="line"># - syncFrequency: 1m0s：指定了同步频率为1分钟。</span><br><span class="line"># - volumeStatsAggPeriod: 1m0s：指定了卷统计聚合周期为1分钟。</span><br></pre></td></tr></table></figure>

<h3 id="8-2-4启动kubelet"><a href="#8-2-4启动kubelet" class="headerlink" title="8.2.4启动kubelet"></a><strong>8.2.4启动kubelet</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line"># 用于重新加载systemd管理的单位文件。当你新增或修改了某个单位文件（如.service文件、.socket文件等），需要运行该命令来刷新systemd对该文件的配置。</span><br><span class="line"></span><br><span class="line">systemctl enable --now kubelet.service</span><br><span class="line"># 启用并立即启动kubelet.service单元。kubelet.service是kubelet守护进程的systemd服务单元。</span><br><span class="line"></span><br><span class="line">systemctl restart kubelet.service</span><br><span class="line"># 重启kubelet.service单元，即重新启动kubelet守护进程。</span><br><span class="line"></span><br><span class="line">systemctl status kubelet.service</span><br><span class="line"># kubelet.service单元的当前状态，包括运行状态、是否启用等信息。</span><br></pre></td></tr></table></figure>

<h3 id="8-2-5查看集群"><a href="#8-2-5查看集群" class="headerlink" title="8.2.5查看集群"></a><strong>8.2.5查看集群</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# kubectl  get node</span><br><span class="line">NAME           STATUS   ROLES    AGE   VERSION</span><br><span class="line">k8s-master01   Ready    &lt;none&gt;   16s   v1.29.2</span><br><span class="line">k8s-master02   Ready    &lt;none&gt;   13s   v1.29.2</span><br><span class="line">k8s-master03   Ready    &lt;none&gt;   12s   v1.29.2</span><br><span class="line">k8s-node01     Ready    &lt;none&gt;   10s   v1.29.2</span><br><span class="line">k8s-node02     Ready    &lt;none&gt;   9s    v1.29.2</span><br><span class="line">[root@k8s-master01 ~]#</span><br></pre></td></tr></table></figure>

<h3 id="8-2-6查看容器运行时"><a href="#8-2-6查看容器运行时" class="headerlink" title="8.2.6查看容器运行时"></a><strong>8.2.6查看容器运行时</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# kubectl describe node | grep Runtime</span><br><span class="line">  Container Runtime Version:  containerd://1.7.13</span><br><span class="line">  Container Runtime Version:  containerd://1.7.13</span><br><span class="line">  Container Runtime Version:  containerd://1.7.13</span><br><span class="line">  Container Runtime Version:  containerd://1.7.13</span><br><span class="line">  Container Runtime Version:  containerd://1.7.13</span><br><span class="line">[root@k8s-master01 ~]# kubectl describe node | grep Runtime</span><br><span class="line">  Container Runtime Version:  docker://25.0.3</span><br><span class="line">  Container Runtime Version:  docker://25.0.3</span><br><span class="line">  Container Runtime Version:  docker://25.0.3</span><br><span class="line">  Container Runtime Version:  docker://25.0.3</span><br><span class="line">  Container Runtime Version:  docker://25.0.3</span><br></pre></td></tr></table></figure>

<h2 id="8-3-kube-proxy配置"><a href="#8-3-kube-proxy配置" class="headerlink" title="8.3.kube-proxy配置"></a><strong>8.3.kube-proxy配置</strong></h2><h3 id="8-3-1将kubeconfig发送至其他节点"><a href="#8-3-1将kubeconfig发送至其他节点" class="headerlink" title="8.3.1将kubeconfig发送至其他节点"></a><strong>8.3.1将kubeconfig发送至其他节点</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># master-1执行</span><br><span class="line">for NODE in k8s-master02 k8s-master03 k8s-node01 k8s-node02; do scp /etc/kubernetes/kube-proxy.kubeconfig $NODE:/etc/kubernetes/kube-proxy.kubeconfig; done</span><br></pre></td></tr></table></figure>

<h3 id="8-3-2所有k8s节点添加kube-proxy的service文件"><a href="#8-3-2所有k8s节点添加kube-proxy的service文件" class="headerlink" title="8.3.2所有k8s节点添加kube-proxy的service文件"></a><strong>8.3.2所有k8s节点添加kube-proxy的service文件</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;  /usr/lib/systemd/system/kube-proxy.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kube Proxy</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kube-proxy \\</span><br><span class="line">  --config=/etc/kubernetes/kube-proxy.yaml \\</span><br><span class="line">  --cluster-cidr=172.16.0.0/12,fc00:2222::/112 \\</span><br><span class="line">  --v=2</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=10s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># 这是一个 systemd 服务单元文件的示例，用于配置 Kubernetes Kube Proxy 服务。下面是对其中一些字段的详细解释：</span><br><span class="line"># </span><br><span class="line"># [Unit]</span><br><span class="line"># </span><br><span class="line"># Description: 描述了该服务单元的用途，这里是 Kubernetes Kube Proxy。</span><br><span class="line"># Documentation: 指定了该服务单元的文档地址，即 https://github.com/kubernetes/kubernetes。</span><br><span class="line"># After: 指定该服务单元应在 network.target（网络目标）之后启动。</span><br><span class="line"># [Service]</span><br><span class="line"># </span><br><span class="line"># ExecStart: 指定了启动 Kube Proxy 服务的命令。通过 /usr/local/bin/kube-proxy 命令启动，并指定了配置文件的路径为 /etc/kubernetes/kube-proxy.yaml，同时指定了日志级别为 2。</span><br><span class="line"># Restart: 配置了服务在失败或退出后自动重启。</span><br><span class="line"># RestartSec: 配置了重启间隔，这里是每次重启之间的等待时间为 10 秒。</span><br><span class="line"># [Install]</span><br><span class="line"># </span><br><span class="line"># WantedBy: 指定了该服务单元的安装目标为 multi-user.target（多用户目标），表示该服务将在多用户模式下启动。</span><br><span class="line"># 通过配置这些字段，你可以启动和管理 Kubernetes Kube Proxy 服务。请注意，你需要根据实际情况修改 ExecStart 中的路径和文件名，确保与你的环境一致。另外，可以根据需求修改其他字段的值，以满足你的特定要求。</span><br></pre></td></tr></table></figure>

<h3 id="8-3-3所有k8s节点添加kube-proxy的配置"><a href="#8-3-3所有k8s节点添加kube-proxy的配置" class="headerlink" title="8.3.3所有k8s节点添加kube-proxy的配置"></a><strong>8.3.3所有k8s节点添加kube-proxy的配置</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/kubernetes/kube-proxy.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">bindAddress: 0.0.0.0</span><br><span class="line">clientConnection:</span><br><span class="line">  acceptContentTypes: &quot;&quot;</span><br><span class="line">  burst: 10</span><br><span class="line">  contentType: application/vnd.kubernetes.protobuf</span><br><span class="line">  kubeconfig: /etc/kubernetes/kube-proxy.kubeconfig</span><br><span class="line">  qps: 5</span><br><span class="line">clusterCIDR: 172.16.0.0/12,fc00:2222::/112</span><br><span class="line">configSyncPeriod: 15m0s</span><br><span class="line">conntrack:</span><br><span class="line">  max: null</span><br><span class="line">  maxPerCore: 32768</span><br><span class="line">  min: 131072</span><br><span class="line">  tcpCloseWaitTimeout: 1h0m0s</span><br><span class="line">  tcpEstablishedTimeout: 24h0m0s</span><br><span class="line">enableProfiling: false</span><br><span class="line">healthzBindAddress: 0.0.0.0:10256</span><br><span class="line">hostnameOverride: &quot;&quot;</span><br><span class="line">iptables:</span><br><span class="line">  masqueradeAll: false</span><br><span class="line">  masqueradeBit: 14</span><br><span class="line">  minSyncPeriod: 0s</span><br><span class="line">  syncPeriod: 30s</span><br><span class="line">ipvs:</span><br><span class="line">  masqueradeAll: true</span><br><span class="line">  minSyncPeriod: 5s</span><br><span class="line">  scheduler: &quot;rr&quot;</span><br><span class="line">  syncPeriod: 30s</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">metricsBindAddress: 127.0.0.1:10249</span><br><span class="line">mode: &quot;ipvs&quot;</span><br><span class="line">nodePortAddresses: null</span><br><span class="line">oomScoreAdj: -999</span><br><span class="line">portRange: &quot;&quot;</span><br><span class="line">udpIdleTimeout: 250ms</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># 这是一个Kubernetes的kube-proxy组件配置文件示例。以下是每个配置项的详细解释：</span><br><span class="line"># </span><br><span class="line"># 1. apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">#    - 指定该配置文件的API版本。</span><br><span class="line"># </span><br><span class="line"># 2. bindAddress: 0.0.0.0</span><br><span class="line">#    - 指定kube-proxy使用的监听地址。0.0.0.0表示监听所有网络接口。</span><br><span class="line"># </span><br><span class="line"># 3. clientConnection:</span><br><span class="line">#    - 客户端连接配置项。</span><br><span class="line"># </span><br><span class="line">#    a. acceptContentTypes: &quot;&quot;</span><br><span class="line">#       - 指定接受的内容类型。</span><br><span class="line"># </span><br><span class="line">#    b. burst: 10</span><br><span class="line">#       - 客户端请求超出qps设置时的最大突发请求数。</span><br><span class="line"># </span><br><span class="line">#    c. contentType: application/vnd.kubernetes.protobuf</span><br><span class="line">#       - 指定客户端请求的内容类型。</span><br><span class="line"># </span><br><span class="line">#    d. kubeconfig: /etc/kubernetes/kube-proxy.kubeconfig</span><br><span class="line">#       - kube-proxy使用的kubeconfig文件路径。</span><br><span class="line"># </span><br><span class="line">#    e. qps: 5</span><br><span class="line">#       - 每秒向API服务器发送的请求数量。</span><br><span class="line"># </span><br><span class="line"># 4. clusterCIDR: 172.16.0.0/12,fc00:2222::/112</span><br><span class="line">#    - 指定集群使用的CIDR范围，用于自动分配Pod IP。</span><br><span class="line"># </span><br><span class="line"># 5. configSyncPeriod: 15m0s</span><br><span class="line">#    - 指定kube-proxy配置同步到节点的频率。</span><br><span class="line"># </span><br><span class="line"># 6. conntrack:</span><br><span class="line">#    - 连接跟踪设置。</span><br><span class="line"># </span><br><span class="line">#    a. max: null</span><br><span class="line">#       - 指定连接跟踪的最大值。</span><br><span class="line"># </span><br><span class="line">#    b. maxPerCore: 32768</span><br><span class="line">#       - 指定每个核心的最大连接跟踪数。</span><br><span class="line"># </span><br><span class="line">#    c. min: 131072</span><br><span class="line">#       - 指定最小的连接跟踪数。</span><br><span class="line"># </span><br><span class="line">#    d. tcpCloseWaitTimeout: 1h0m0s</span><br><span class="line">#       - 指定处于CLOSE_WAIT状态的TCP连接的超时时间。</span><br><span class="line"># </span><br><span class="line">#    e. tcpEstablishedTimeout: 24h0m0s</span><br><span class="line">#       - 指定已建立的TCP连接的超时时间。</span><br><span class="line"># </span><br><span class="line"># 7. enableProfiling: false</span><br><span class="line">#    - 是否启用性能分析。</span><br><span class="line"># </span><br><span class="line"># 8. healthzBindAddress: 0.0.0.0:10256</span><br><span class="line">#    - 指定健康检查监听地址和端口。</span><br><span class="line"># </span><br><span class="line"># 9. hostnameOverride: &quot;&quot;</span><br><span class="line">#    - 指定覆盖默认主机名的值。</span><br><span class="line"># </span><br><span class="line"># 10. iptables:</span><br><span class="line">#     - iptables设置。</span><br><span class="line"># </span><br><span class="line">#     a. masqueradeAll: false</span><br><span class="line">#        - 是否对所有流量使用IP伪装。</span><br><span class="line"># </span><br><span class="line">#     b. masqueradeBit: 14</span><br><span class="line">#        - 指定伪装的Bit标记。</span><br><span class="line"># </span><br><span class="line">#     c. minSyncPeriod: 0s</span><br><span class="line">#        - 指定同步iptables规则的最小间隔。</span><br><span class="line"># </span><br><span class="line">#     d. syncPeriod: 30s</span><br><span class="line">#        - 指定同步iptables规则的时间间隔。</span><br><span class="line"># </span><br><span class="line"># 11. ipvs:</span><br><span class="line">#     - ipvs设置。</span><br><span class="line"># </span><br><span class="line">#     a. masqueradeAll: true</span><br><span class="line">#        - 是否对所有流量使用IP伪装。</span><br><span class="line"># </span><br><span class="line">#     b. minSyncPeriod: 5s</span><br><span class="line">#        - 指定同步ipvs规则的最小间隔。</span><br><span class="line"># </span><br><span class="line">#     c. scheduler: &quot;rr&quot;</span><br><span class="line">#        - 指定ipvs默认使用的调度算法。</span><br><span class="line"># </span><br><span class="line">#     d. syncPeriod: 30s</span><br><span class="line">#        - 指定同步ipvs规则的时间间隔。</span><br><span class="line"># </span><br><span class="line"># 12. kind: KubeProxyConfiguration</span><br><span class="line">#     - 指定该配置文件的类型。</span><br><span class="line"># </span><br><span class="line"># 13. metricsBindAddress: 127.0.0.1:10249</span><br><span class="line">#     - 指定指标绑定的地址和端口。</span><br><span class="line"># </span><br><span class="line"># 14. mode: &quot;ipvs&quot;</span><br><span class="line">#     - 指定kube-proxy的模式。这里指定为ipvs，使用IPVS代理模式。</span><br><span class="line"># </span><br><span class="line"># 15. nodePortAddresses: null</span><br><span class="line">#     - 指定可用于NodePort的网络地址。</span><br><span class="line"># </span><br><span class="line"># 16. oomScoreAdj: -999</span><br><span class="line">#     - 指定kube-proxy的OOM优先级。</span><br><span class="line"># </span><br><span class="line"># 17. portRange: &quot;&quot;</span><br><span class="line">#     - 指定可用于服务端口范围。</span><br><span class="line"># </span><br><span class="line"># 18. udpIdleTimeout: 250ms</span><br><span class="line">#     - 指定UDP连接的空闲超时时间。</span><br></pre></td></tr></table></figure>

<h3 id="8-3-4启动kube-proxy"><a href="#8-3-4启动kube-proxy" class="headerlink" title="8.3.4启动kube-proxy"></a><strong>8.3.4启动kube-proxy</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> systemctl daemon-reload</span><br><span class="line"># 用于重新加载systemd管理的单位文件。当你新增或修改了某个单位文件（如.service文件、.socket文件等），需要运行该命令来刷新systemd对该文件的配置。</span><br><span class="line"></span><br><span class="line">systemctl enable --now kube-proxy.service</span><br><span class="line"># 启用并立即启动kube-proxy.service单元。kube-proxy.service是kube-proxy守护进程的systemd服务单元。</span><br><span class="line"></span><br><span class="line">systemctl restart kube-proxy.service</span><br><span class="line"># 重启kube-proxy.service单元，即重新启动kube-proxy守护进程。</span><br><span class="line"></span><br><span class="line">systemctl status kube-proxy.service</span><br><span class="line"># kube-proxy.service单元的当前状态，包括运行状态、是否启用等信息。</span><br></pre></td></tr></table></figure>

<h1 id="9-安装网络插件"><a href="#9-安装网络插件" class="headerlink" title="9.安装网络插件"></a>9.安装网络插件</h1><p><strong>注意 9.1 和 9.2 二选其一即可，建议在此处创建好快照后在进行操作，后续出问题可以回滚</strong></p>
<p><strong>centos7 要升级libseccomp 不然 无法安装网络插件</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># https://github.com/opencontainers/runc/releases</span><br><span class="line"># 升级runc</span><br><span class="line"># wget https://mirrors.chenby.cn/https://github.com/opencontainers/runc/releases/download/v1.1.12/runc.amd64</span><br><span class="line"></span><br><span class="line">install -m 755 runc.amd64 /usr/local/sbin/runc</span><br><span class="line">cp -p /usr/local/sbin/runc  /usr/local/bin/runc</span><br><span class="line">cp -p /usr/local/sbin/runc  /usr/bin/runc</span><br><span class="line"></span><br><span class="line">#下载高于2.4以上的包</span><br><span class="line">yum -y install http://rpmfind.net/linux/centos/8-stream/BaseOS/x86_64/os/Packages/libseccomp-2.5.1-1.el8.x86_64.rpm</span><br><span class="line"># 清华源</span><br><span class="line">yum -y install https://mirrors.tuna.tsinghua.edu.cn/centos/8-stream/BaseOS/x86_64/os/Packages/libseccomp-2.5.1-1.el8.x86_64.rpm</span><br><span class="line"></span><br><span class="line">#查看当前版本</span><br><span class="line">[root@k8s-master-1 ~]# rpm -qa | grep libseccomp</span><br><span class="line">libseccomp-2.5.1-1.el8.x86_64</span><br></pre></td></tr></table></figure>

<h2 id="9-1安装Calico"><a href="#9-1安装Calico" class="headerlink" title="9.1安装Calico"></a><strong>9.1安装Calico</strong></h2><h3 id="9-1-1更改calico网段"><a href="#9-1-1更改calico网段" class="headerlink" title="9.1.1更改calico网段"></a><strong>9.1.1更改calico网段</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">wget https://mirrors.chenby.cn/https://github.com/projectcalico/calico/blob/master/manifests/calico-typha.yaml</span><br><span class="line"></span><br><span class="line">cp calico-typha.yaml calico.yaml</span><br><span class="line">cp calico-typha.yaml calico-ipv6.yaml</span><br><span class="line"></span><br><span class="line">vim calico.yaml</span><br><span class="line"># calico-config ConfigMap处</span><br><span class="line">    &quot;ipam&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;calico-ipam&quot;,</span><br><span class="line">    &#125;,</span><br><span class="line">    - name: IP</span><br><span class="line">      value: &quot;autodetect&quot;</span><br><span class="line"></span><br><span class="line">    - name: CALICO_IPV4POOL_CIDR</span><br><span class="line">      value: &quot;172.16.0.0/12&quot;</span><br><span class="line"></span><br><span class="line"># vim calico-ipv6.yaml</span><br><span class="line"># calico-config ConfigMap处</span><br><span class="line">    &quot;ipam&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;calico-ipam&quot;,</span><br><span class="line">        &quot;assign_ipv4&quot;: &quot;true&quot;,</span><br><span class="line">        &quot;assign_ipv6&quot;: &quot;true&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    - name: IP</span><br><span class="line">      value: &quot;autodetect&quot;</span><br><span class="line"></span><br><span class="line">    - name: IP6</span><br><span class="line">      value: &quot;autodetect&quot;</span><br><span class="line"></span><br><span class="line">    - name: CALICO_IPV4POOL_CIDR</span><br><span class="line">      value: &quot;172.16.0.0/12&quot;</span><br><span class="line"></span><br><span class="line">    - name: CALICO_IPV6POOL_CIDR</span><br><span class="line">      value: &quot;fc00:2222::/112&quot;</span><br><span class="line"></span><br><span class="line">    - name: FELIX_IPV6SUPPORT</span><br><span class="line">      value: &quot;true&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 若docker镜像拉不下来，可以使用国内的仓库</span><br><span class="line">sed -i &quot;s#docker.io/calico/#m.daocloud.io/docker.io/calico/#g&quot; calico.yaml </span><br><span class="line">sed -i &quot;s#docker.io/calico/#m.daocloud.io/docker.io/calico/#g&quot; calico-ipv6.yaml</span><br><span class="line"></span><br><span class="line">sed -i &quot;s#m.daocloud.io/docker.io/calico/#docker.io/calico/#g&quot; calico.yaml </span><br><span class="line">sed -i &quot;s#m.daocloud.io/docker.io/calico/#docker.io/calico/#g&quot; calico-ipv6.yaml</span><br><span class="line"></span><br><span class="line"># 本地没有公网 IPv6 使用 calico.yaml</span><br><span class="line">kubectl apply -f calico.yaml</span><br><span class="line"></span><br><span class="line"># 本地有公网 IPv6 使用 calico-ipv6.yaml </span><br><span class="line"># kubectl apply -f calico-ipv6.yaml </span><br></pre></td></tr></table></figure>

<h3 id="9-1-2查看容器状态"><a href="#9-1-2查看容器状态" class="headerlink" title="9.1.2查看容器状态"></a><strong>9.1.2查看容器状态</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># calico 初始化会很慢 需要耐心等待一下，大约十分钟左右</span><br><span class="line">[root@k8s-master01 ~]# kubectl  get pod -A</span><br><span class="line">NAMESPACE     NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-system   calico-kube-controllers-6747f75cdc-fbvvc   1/1     Running   0          61s</span><br><span class="line">kube-system   calico-node-fs7hl                          1/1     Running   0          61s</span><br><span class="line">kube-system   calico-node-jqz58                          1/1     Running   0          61s</span><br><span class="line">kube-system   calico-node-khjlg                          1/1     Running   0          61s</span><br><span class="line">kube-system   calico-node-wmf8q                          1/1     Running   0          61s</span><br><span class="line">kube-system   calico-node-xc6gn                          1/1     Running   0          61s</span><br><span class="line">kube-system   calico-typha-6cdc4b4fbc-57snb              1/1     Running   0          61s</span><br></pre></td></tr></table></figure>

<h2 id="9-2-安装cilium"><a href="#9-2-安装cilium" class="headerlink" title="9.2 安装cilium"></a><strong>9.2 安装cilium</strong></h2><h3 id="9-2-1-安装helm"><a href="#9-2-1-安装helm" class="headerlink" title="9.2.1 安装helm"></a><strong>9.2.1 安装helm</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># [root@k8s-master01 ~]# curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3</span><br><span class="line"># [root@k8s-master01 ~]# chmod 700 get_helm.sh</span><br><span class="line"># [root@k8s-master01 ~]# ./get_helm.sh</span><br><span class="line"></span><br><span class="line"># wget https://mirrors.huaweicloud.com/helm/v3.13.2/helm-v3.13.2-linux-amd64.tar.gz</span><br><span class="line">tar xvf helm-*-linux-amd64.tar.gz</span><br><span class="line">cp linux-amd64/helm /usr/local/bin/</span><br></pre></td></tr></table></figure>

<h3 id="9-2-2-安装cilium"><a href="#9-2-2-安装cilium" class="headerlink" title="9.2.2 安装cilium"></a><strong>9.2.2 安装cilium</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># 添加源</span><br><span class="line">helm repo add cilium https://helm.cilium.io</span><br><span class="line"></span><br><span class="line"># 修改为国内源</span><br><span class="line">helm pull cilium/cilium</span><br><span class="line">tar xvf cilium-*.tgz</span><br><span class="line">cd cilium/</span><br><span class="line">sed -i &quot;s#quay.io/#m.daocloud.io/quay.io/#g&quot; values.yaml</span><br><span class="line"></span><br><span class="line"># 默认参数安装</span><br><span class="line">helm install  cilium ./cilium/ -n kube-system</span><br><span class="line"></span><br><span class="line"># 启用ipv6</span><br><span class="line"># helm install cilium cilium/cilium --namespace kube-system --set ipv6.enabled=true</span><br><span class="line"></span><br><span class="line"># 启用路由信息和监控插件</span><br><span class="line"># helm install cilium cilium/cilium --namespace kube-system --set hubble.relay.enabled=true --set hubble.ui.enabled=true --set prometheus.enabled=true --set operator.prometheus.enabled=true --set hubble.enabled=true --set hubble.metrics.enabled=&quot;&#123;dns,drop,tcp,flow,port-distribution,icmp,http&#125;&quot; </span><br></pre></td></tr></table></figure>

<h3 id="9-2-3-查看"><a href="#9-2-3-查看" class="headerlink" title="9.2.3 查看"></a><strong>9.2.3 查看</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# kubectl  get pod -A | grep cil</span><br><span class="line">kube-system   cilium-gmr6c                       1/1     Running       0             5m3s</span><br><span class="line">kube-system   cilium-kzgdj                       1/1     Running       0             5m3s</span><br><span class="line">kube-system   cilium-operator-69b677f97c-6pw4k   1/1     Running       0             5m3s</span><br><span class="line">kube-system   cilium-operator-69b677f97c-xzzdk   1/1     Running       0             5m3s</span><br><span class="line">kube-system   cilium-q2rnr                       1/1     Running       0             5m3s</span><br><span class="line">kube-system   cilium-smx5v                       1/1     Running       0             5m3s</span><br><span class="line">kube-system   cilium-tdjq4                       1/1     Running       0             5m3s</span><br><span class="line">[root@k8s-master01 ~]#</span><br></pre></td></tr></table></figure>

<h3 id="9-2-4-下载专属监控面板"><a href="#9-2-4-下载专属监控面板" class="headerlink" title="9.2.4 下载专属监控面板"></a><strong>9.2.4 下载专属监控面板</strong></h3><p>安装时候没有创建 监控可以忽略</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 yaml]# wget https://mirrors.chenby.cn/https://raw.githubusercontent.com/cilium/cilium/1.12.1/examples/kubernetes/addons/prometheus/monitoring-example.yaml</span><br><span class="line"></span><br><span class="line">[root@k8s-master01 yaml]# sed -i &quot;s#docker.io/#m.daocloud.io/docker.io/#g&quot; monitoring-example.yaml</span><br><span class="line"></span><br><span class="line">[root@k8s-master01 yaml]# kubectl  apply -f monitoring-example.yaml</span><br><span class="line">namespace/cilium-monitoring created</span><br><span class="line">serviceaccount/prometheus-k8s created</span><br><span class="line">configmap/grafana-config created</span><br><span class="line">configmap/grafana-cilium-dashboard created</span><br><span class="line">configmap/grafana-cilium-operator-dashboard created</span><br><span class="line">configmap/grafana-hubble-dashboard created</span><br><span class="line">configmap/prometheus created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/prometheus created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/prometheus created</span><br><span class="line">service/grafana created</span><br><span class="line">service/prometheus created</span><br><span class="line">deployment.apps/grafana created</span><br><span class="line">deployment.apps/prometheus created</span><br><span class="line">[root@k8s-master01 yaml]#</span><br></pre></td></tr></table></figure>

<h3 id="9-2-5-下载部署测试用例"><a href="#9-2-5-下载部署测试用例" class="headerlink" title="9.2.5 下载部署测试用例"></a><strong>9.2.5 下载部署测试用例</strong></h3><p>说明 测试用例 需要在 安装CoreDNS 之后即可完成</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget https://mirrors.chenby.cn/https://raw.githubusercontent.com/cilium/cilium/master/examples/kubernetes/connectivity-check/connectivity-check.yaml</span><br><span class="line"></span><br><span class="line">sed -i &quot;s#google.com#baidu.cn#g&quot; connectivity-check.yaml</span><br><span class="line">sed -i &quot;s#quay.io/#m.daocloud.io/quay.io/#g&quot; connectivity-check.yaml</span><br><span class="line"></span><br><span class="line">kubectl  apply -f connectivity-check.yaml</span><br></pre></td></tr></table></figure>

<h3 id="9-2-6-查看pod"><a href="#9-2-6-查看pod" class="headerlink" title="9.2.6 查看pod"></a><strong>9.2.6 查看pod</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 yaml]# kubectl  get pod -A</span><br><span class="line">NAMESPACE           NAME                                                     READY   STATUS    RESTARTS      AGE</span><br><span class="line">cilium-monitoring   grafana-59957b9549-6zzqh                                 1/1     Running   0             10m</span><br><span class="line">cilium-monitoring   prometheus-7c8c9684bb-4v9cl                              1/1     Running   0             10m</span><br><span class="line">default             chenby-75b5d7fbfb-7zjsr                                  1/1     Running   0             27h</span><br><span class="line">default             chenby-75b5d7fbfb-hbvr8                                  1/1     Running   0             27h</span><br><span class="line">default             chenby-75b5d7fbfb-ppbzg                                  1/1     Running   0             27h</span><br><span class="line">default             echo-a-6799dff547-pnx6w                                  1/1     Running   0             10m</span><br><span class="line">default             echo-b-fc47b659c-4bdg9                                   1/1     Running   0             10m</span><br><span class="line">default             echo-b-host-67fcfd59b7-28r9s                             1/1     Running   0             10m</span><br><span class="line">default             host-to-b-multi-node-clusterip-69c57975d6-z4j2z          1/1     Running   0             10m</span><br><span class="line">default             host-to-b-multi-node-headless-865899f7bb-frrmc           1/1     Running   0             10m</span><br><span class="line">default             pod-to-a-allowed-cnp-5f9d7d4b9d-hcd8x                    1/1     Running   0             10m</span><br><span class="line">default             pod-to-a-denied-cnp-65cc5ff97b-2rzb8                     1/1     Running   0             10m</span><br><span class="line">default             pod-to-a-dfc64f564-p7xcn                                 1/1     Running   0             10m</span><br><span class="line">default             pod-to-b-intra-node-nodeport-677868746b-trk2l            1/1     Running   0             10m</span><br><span class="line">default             pod-to-b-multi-node-clusterip-76bbbc677b-knfq2           1/1     Running   0             10m</span><br><span class="line">default             pod-to-b-multi-node-headless-698c6579fd-mmvd7            1/1     Running   0             10m</span><br><span class="line">default             pod-to-b-multi-node-nodeport-5dc4b8cfd6-8dxmz            1/1     Running   0             10m</span><br><span class="line">default             pod-to-external-1111-8459965778-pjt9b                    1/1     Running   0             10m</span><br><span class="line">default             pod-to-external-fqdn-allow-google-cnp-64df9fb89b-l9l4q   1/1     Running   0             10m</span><br><span class="line">kube-system         cilium-7rfj6                                             1/1     Running   0             56s</span><br><span class="line">kube-system         cilium-d4cch                                             1/1     Running   0             56s</span><br><span class="line">kube-system         cilium-h5x8r                                             1/1     Running   0             56s</span><br><span class="line">kube-system         cilium-operator-5dbddb6dbf-flpl5                         1/1     Running   0             56s</span><br><span class="line">kube-system         cilium-operator-5dbddb6dbf-gcznc                         1/1     Running   0             56s</span><br><span class="line">kube-system         cilium-t2xlz                                             1/1     Running   0             56s</span><br><span class="line">kube-system         cilium-z65z7                                             1/1     Running   0             56s</span><br><span class="line">kube-system         coredns-665475b9f8-jkqn8                                 1/1     Running   1 (36h ago)   36h</span><br><span class="line">kube-system         hubble-relay-59d8575-9pl9z                               1/1     Running   0             56s</span><br><span class="line">kube-system         hubble-ui-64d4995d57-nsv9j                               2/2     Running   0             56s</span><br><span class="line">kube-system         metrics-server-776f58c94b-c6zgs                          1/1     Running   1 (36h ago)   37h</span><br><span class="line">[root@k8s-master01 yaml]#</span><br></pre></td></tr></table></figure>

<h3 id="9-2-7-修改为NodePort"><a href="#9-2-7-修改为NodePort" class="headerlink" title="9.2.7 修改为NodePort"></a><strong>9.2.7 修改为NodePort</strong></h3><p>安装时候没有创建 监控可以忽略</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 yaml]# kubectl  edit svc  -n kube-system hubble-ui</span><br><span class="line">service/hubble-ui edited</span><br><span class="line">[root@k8s-master01 yaml]#</span><br><span class="line">[root@k8s-master01 yaml]# kubectl  edit svc  -n cilium-monitoring grafana</span><br><span class="line">service/grafana edited</span><br><span class="line">[root@k8s-master01 yaml]#</span><br><span class="line">[root@k8s-master01 yaml]# kubectl  edit svc  -n cilium-monitoring prometheus</span><br><span class="line">service/prometheus edited</span><br><span class="line">[root@k8s-master01 yaml]#</span><br><span class="line"></span><br><span class="line">type: NodePort</span><br></pre></td></tr></table></figure>

<h3 id="9-2-8-查看端口"><a href="#9-2-8-查看端口" class="headerlink" title="9.2.8 查看端口"></a><strong>9.2.8 查看端口</strong></h3><p>安装时候没有创建 监控可以忽略</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 yaml]# kubectl get svc -A | grep monit</span><br><span class="line">cilium-monitoring   grafana                NodePort    10.100.250.17    &lt;none&gt;        3000:30707/TCP           15m</span><br><span class="line">cilium-monitoring   prometheus             NodePort    10.100.131.243   &lt;none&gt;        9090:31155/TCP           15m</span><br><span class="line">[root@k8s-master01 yaml]#</span><br><span class="line">[root@k8s-master01 yaml]# kubectl get svc -A | grep hubble</span><br><span class="line">kube-system         hubble-metrics         ClusterIP   None             &lt;none&gt;        9965/TCP                 5m12s</span><br><span class="line">kube-system         hubble-peer            ClusterIP   10.100.150.29    &lt;none&gt;        443/TCP                  5m12s</span><br><span class="line">kube-system         hubble-relay           ClusterIP   10.109.251.34    &lt;none&gt;        80/TCP                   5m12s</span><br><span class="line">kube-system         hubble-ui              NodePort    10.102.253.59    &lt;none&gt;        80:31219/TCP             5m12s</span><br><span class="line">[root@k8s-master01 yaml]#</span><br></pre></td></tr></table></figure>

<h3 id="9-2-9-访问"><a href="#9-2-9-访问" class="headerlink" title="9.2.9 访问"></a><strong>9.2.9 访问</strong></h3><p>安装时候没有创建 监控可以忽略</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.1.31:30707</span><br><span class="line">http://192.168.1.31:31155</span><br><span class="line">http://192.168.1.31:31219</span><br></pre></td></tr></table></figure>

<h1 id="10-安装CoreDNS"><a href="#10-安装CoreDNS" class="headerlink" title="10.安装CoreDNS"></a>10.安装CoreDNS</h1><h2 id="10-1以下步骤只在master01操作"><a href="#10-1以下步骤只在master01操作" class="headerlink" title="10.1以下步骤只在master01操作"></a><strong>10.1以下步骤只在master01操作</strong></h2><h3 id="10-1-1修改文件"><a href="#10-1-1修改文件" class="headerlink" title="10.1.1修改文件"></a><strong>10.1.1修改文件</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"># 下载tgz包</span><br><span class="line">helm repo add coredns https://coredns.github.io/helm</span><br><span class="line">helm pull coredns/coredns</span><br><span class="line">tar xvf coredns-*.tgz</span><br><span class="line">cd coredns/</span><br><span class="line"></span><br><span class="line"># 修改IP地址</span><br><span class="line">vim values.yaml</span><br><span class="line">cat values.yaml | grep clusterIP:</span><br><span class="line">clusterIP: &quot;10.96.0.10&quot;</span><br><span class="line"></span><br><span class="line"># 示例</span><br><span class="line">---</span><br><span class="line">service:</span><br><span class="line"># clusterIP: &quot;&quot;</span><br><span class="line"># clusterIPs: []</span><br><span class="line"># loadBalancerIP: &quot;&quot;</span><br><span class="line"># externalIPs: []</span><br><span class="line"># externalTrafficPolicy: &quot;&quot;</span><br><span class="line"># ipFamilyPolicy: &quot;&quot;</span><br><span class="line">  # The name of the Service</span><br><span class="line">  # If not set, a name is generated using the fullname template</span><br><span class="line">  clusterIP: &quot;10.96.0.10&quot;</span><br><span class="line">  name: &quot;&quot;</span><br><span class="line">  annotations: &#123;&#125;</span><br><span class="line">---</span><br><span class="line"></span><br><span class="line"># 修改为国内源 docker源可选</span><br><span class="line">sed -i &quot;s#coredns/#m.daocloud.io/docker.io/coredns/#g&quot; values.yaml</span><br><span class="line">sed -i &quot;s#registry.k8s.io/#m.daocloud.io/registry.k8s.io/#g&quot; values.yaml</span><br><span class="line"></span><br><span class="line"># 默认参数安装</span><br><span class="line">helm install  coredns ./coredns/ -n kube-system</span><br></pre></td></tr></table></figure>

<h1 id="11-安装Metrics-Server"><a href="#11-安装Metrics-Server" class="headerlink" title="11.安装Metrics Server"></a>11.安装Metrics Server</h1><h2 id="11-1以下步骤只在master01操作"><a href="#11-1以下步骤只在master01操作" class="headerlink" title="11.1以下步骤只在master01操作"></a><strong>11.1以下步骤只在master01操作</strong></h2><h3 id="11-1-1安装Metrics-server"><a href="#11-1-1安装Metrics-server" class="headerlink" title="11.1.1安装Metrics-server"></a><strong>11.1.1安装Metrics-server</strong></h3><p>在新版的Kubernetes中系统资源的采集均使用Metrics-server，可以通过Metrics采集节点和Pod的内存、磁盘、CPU和网络的使用率</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"># 下载 </span><br><span class="line">wget https://mirrors.chenby.cn/https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml</span><br><span class="line"></span><br><span class="line"># 修改配置</span><br><span class="line">vim components.yaml</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"># 1</span><br><span class="line">			- args:</span><br><span class="line">        - --cert-dir=/tmp</span><br><span class="line">        - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname</span><br><span class="line">        - --kubelet-use-node-status-port</span><br><span class="line">        - --metric-resolution=15s</span><br><span class="line">        - --kubelet-insecure-tls</span><br><span class="line">        - --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem</span><br><span class="line">        - --requestheader-username-headers=X-Remote-User</span><br><span class="line">        - --requestheader-group-headers=X-Remote-Group</span><br><span class="line">        - --requestheader-extra-headers-prefix=X-Remote-Extra-</span><br><span class="line"></span><br><span class="line"># 2</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /tmp</span><br><span class="line">          name: tmp-dir</span><br><span class="line">        - name: ca-ssl</span><br><span class="line">          mountPath: /etc/kubernetes/pki</span><br><span class="line"></span><br><span class="line"># 3</span><br><span class="line">      volumes:</span><br><span class="line">      - emptyDir: &#123;&#125;</span><br><span class="line">        name: tmp-dir</span><br><span class="line">      - name: ca-ssl</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /etc/kubernetes/pki</span><br><span class="line">---</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 修改为国内源 docker源可选</span><br><span class="line">sed -i &quot;s#registry.k8s.io/#m.daocloud.io/registry.k8s.io/#g&quot; *.yaml</span><br><span class="line"></span><br><span class="line"># 执行部署</span><br><span class="line">kubectl apply -f components.yaml</span><br></pre></td></tr></table></figure>

<h3 id="11-1-2稍等片刻查看状态"><a href="#11-1-2稍等片刻查看状态" class="headerlink" title="11.1.2稍等片刻查看状态"></a><strong>11.1.2稍等片刻查看状态</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl  top node</span><br><span class="line">NAME           CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%   </span><br><span class="line">k8s-master01   268m         6%     2318Mi          60%       </span><br><span class="line">k8s-master02   147m         3%     1802Mi          47%       </span><br><span class="line">k8s-master03   147m         3%     1820Mi          47%       </span><br><span class="line">k8s-node01     62m          1%     1152Mi          30%       </span><br><span class="line">k8s-node02     63m          1%     1114Mi          29%  </span><br></pre></td></tr></table></figure>

<h1 id="12-集群验证"><a href="#12-集群验证" class="headerlink" title="12.集群验证"></a>12.集群验证</h1><h2 id="12-1部署pod资源"><a href="#12-1部署pod资源" class="headerlink" title="12.1部署pod资源"></a><strong>12.1部署pod资源</strong></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cat&lt;&lt;EOF | kubectl apply -f -</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: busybox</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: busybox</span><br><span class="line">    image: docker.io/library/busybox:1.28</span><br><span class="line">    command:</span><br><span class="line">      - sleep</span><br><span class="line">      - &quot;3600&quot;</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">  restartPolicy: Always</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"># 查看</span><br><span class="line">kubectl  get pod</span><br><span class="line">NAME      READY   STATUS    RESTARTS   AGE</span><br><span class="line">busybox   1/1     Running   0          17s</span><br></pre></td></tr></table></figure>

<h2 id="12-2用pod解析默认命名空间中的kubernetes"><a href="#12-2用pod解析默认命名空间中的kubernetes" class="headerlink" title="12.2用pod解析默认命名空间中的kubernetes"></a><strong>12.2用pod解析默认命名空间中的kubernetes</strong></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 查看name</span><br><span class="line">kubectl get svc</span><br><span class="line">NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   17h</span><br><span class="line"></span><br><span class="line"># 进行解析</span><br><span class="line">kubectl exec  busybox -n default -- nslookup kubernetes</span><br><span class="line">3Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      kubernetes</span><br><span class="line">Address 1: 10.96.0.1 kubernetes.default.svc.cluster.local</span><br></pre></td></tr></table></figure>

<h2 id="12-3测试跨命名空间是否可以解析"><a href="#12-3测试跨命名空间是否可以解析" class="headerlink" title="12.3测试跨命名空间是否可以解析"></a><strong>12.3测试跨命名空间是否可以解析</strong></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 查看有那些name</span><br><span class="line">kubectl  get svc -A</span><br><span class="line">NAMESPACE     NAME              TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">default       kubernetes        ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP         76m</span><br><span class="line">kube-system   calico-typha      ClusterIP   10.105.100.82   &lt;none&gt;        5473/TCP        35m</span><br><span class="line">kube-system   coredns-coredns   ClusterIP   10.96.0.10      &lt;none&gt;        53/UDP,53/TCP   8m14s</span><br><span class="line">kube-system   metrics-server    ClusterIP   10.105.60.31    &lt;none&gt;        443/TCP         109s</span><br><span class="line"></span><br><span class="line"># 进行解析</span><br><span class="line">kubectl exec  busybox -n default -- nslookup coredns-coredns.kube-system</span><br><span class="line">Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 coredns-coredns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      coredns-coredns.kube-system</span><br><span class="line">Address 1: 10.96.0.10 coredns-coredns.kube-system.svc.cluster.local</span><br><span class="line">[root@k8s-master01 metrics-server]# </span><br></pre></td></tr></table></figure>

<h2 id="12-4每个节点都必须要能访问Kubernetes的kubernetes-svc-443和kube-dns的service-53"><a href="#12-4每个节点都必须要能访问Kubernetes的kubernetes-svc-443和kube-dns的service-53" class="headerlink" title="12.4每个节点都必须要能访问Kubernetes的kubernetes svc 443和kube-dns的service 53"></a><strong>12.4每个节点都必须要能访问Kubernetes的kubernetes svc 443和kube-dns的service 53</strong></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">telnet 10.96.0.1 443</span><br><span class="line">Trying 10.96.0.1...</span><br><span class="line">Connected to 10.96.0.1.</span><br><span class="line">Escape character is &#x27;^]&#x27;.</span><br><span class="line"></span><br><span class="line"> telnet 10.96.0.10 53</span><br><span class="line">Trying 10.96.0.10...</span><br><span class="line">Connected to 10.96.0.10.</span><br><span class="line">Escape character is &#x27;^]&#x27;.</span><br><span class="line"></span><br><span class="line">curl 10.96.0.10:53</span><br><span class="line">curl: (52) Empty reply from server</span><br></pre></td></tr></table></figure>

<h2 id="12-5Pod和Pod之前要能通"><a href="#12-5Pod和Pod之前要能通" class="headerlink" title="12.5Pod和Pod之前要能通"></a><strong>12.5Pod和Pod之前要能通</strong></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">kubectl get po -owide</span><br><span class="line">NAME      READY   STATUS    RESTARTS   AGE   IP              NODE         NOMINATED NODE   READINESS GATES</span><br><span class="line">busybox   1/1     Running   0          17m   172.27.14.193   k8s-node02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">kubectl get po -n kube-system -owide</span><br><span class="line">NAME                                       READY   STATUS    RESTARTS   AGE     IP               NODE           NOMINATED NODE   READINESS GATES</span><br><span class="line">calico-kube-controllers-76754ff848-pw4xg   1/1     Running   0          38m     172.25.244.193   k8s-master01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">calico-node-97m55                          1/1     Running   0          38m     192.168.1.34     k8s-node01     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">calico-node-hlz7j                          1/1     Running   0          38m     192.168.1.32     k8s-master02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">calico-node-jtlck                          1/1     Running   0          38m     192.168.1.33     k8s-master03   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">calico-node-lxfkf                          1/1     Running   0          38m     192.168.1.35     k8s-node02     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">calico-node-t667x                          1/1     Running   0          38m     192.168.1.31     k8s-master01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">calico-typha-59d75c5dd4-gbhfp              1/1     Running   0          38m     192.168.1.35     k8s-node02     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">coredns-coredns-c5c6d4d9b-bd829            1/1     Running   0          10m     172.25.92.65     k8s-master02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">metrics-server-7c8b55c754-w7q8v            1/1     Running   0          3m56s   172.17.125.3     k8s-node01     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line"># 进入busybox ping其他节点上的pod</span><br><span class="line"></span><br><span class="line">kubectl exec -ti busybox -- sh</span><br><span class="line">/ # ping 192.168.1.34</span><br><span class="line">PING 192.168.1.34 (192.168.1.34): 56 data bytes</span><br><span class="line">64 bytes from 192.168.1.34: seq=0 ttl=63 time=0.358 ms</span><br><span class="line">64 bytes from 192.168.1.34: seq=1 ttl=63 time=0.668 ms</span><br><span class="line">64 bytes from 192.168.1.34: seq=2 ttl=63 time=0.637 ms</span><br><span class="line">64 bytes from 192.168.1.34: seq=3 ttl=63 time=0.624 ms</span><br><span class="line">64 bytes from 192.168.1.34: seq=4 ttl=63 time=0.907 ms</span><br><span class="line"></span><br><span class="line"># 可以连通证明这个pod是可以跨命名空间和跨主机通信的</span><br></pre></td></tr></table></figure>

<h2 id="12-6创建三个副本，可以看到3个副本分布在不同的节点上（用完可以删了）"><a href="#12-6创建三个副本，可以看到3个副本分布在不同的节点上（用完可以删了）" class="headerlink" title="12.6创建三个副本，可以看到3个副本分布在不同的节点上（用完可以删了）"></a><strong>12.6创建三个副本，可以看到3个副本分布在不同的节点上（用完可以删了）</strong></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">cat&lt;&lt;EOF | kubectl apply -f -</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-deployment</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">kubectl  get pod </span><br><span class="line">NAME                               READY   STATUS    RESTARTS   AGE</span><br><span class="line">busybox                            1/1     Running   0          6m25s</span><br><span class="line">nginx-deployment-9456bbbf9-4bmvk   1/1     Running   0          8s</span><br><span class="line">nginx-deployment-9456bbbf9-9rcdk   1/1     Running   0          8s</span><br><span class="line">nginx-deployment-9456bbbf9-dqv8s   1/1     Running   0          8s</span><br><span class="line"></span><br><span class="line"># 删除nginx</span><br><span class="line">[root@k8s-master01 ~]# kubectl delete deployments nginx-deployment </span><br></pre></td></tr></table></figure>

<h1 id="13-安装dashboard"><a href="#13-安装dashboard" class="headerlink" title="13.安装dashboard"></a>13.安装dashboard</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">helm repo add kubernetes-dashboard https://kubernetes.github.io/dashboard/</span><br><span class="line">helm install kubernetes-dashboard kubernetes-dashboard/kubernetes-dashboard --namespace kube-system</span><br></pre></td></tr></table></figure>

<h2 id="13-1更改dashboard的svc为NodePort，如果已是请忽略"><a href="#13-1更改dashboard的svc为NodePort，如果已是请忽略" class="headerlink" title="13.1更改dashboard的svc为NodePort，如果已是请忽略"></a><strong>13.1更改dashboard的svc为NodePort，如果已是请忽略</strong></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit svc kubernetes-dashboard -n kube-system</span><br><span class="line">  type: NodePort</span><br></pre></td></tr></table></figure>

<h2 id="13-2查看端口号"><a href="#13-2查看端口号" class="headerlink" title="13.2查看端口号"></a><strong>13.2查看端口号</strong></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc kubernetes-dashboard -n kube-system</span><br><span class="line">NAME                   TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">kubernetes-dashboard   NodePort   10.108.120.110   &lt;none&gt;        443:30034/TCP   34s</span><br></pre></td></tr></table></figure>

<h2 id="13-3创建token"><a href="#13-3创建token" class="headerlink" title="13.3创建token"></a><strong>13.3创建token</strong></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; dashboard-user.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kube-system</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">kubectl  apply -f dashboard-user.yaml</span><br><span class="line"></span><br><span class="line"># 创建token</span><br><span class="line">kubectl -n kube-system create token admin-user</span><br><span class="line"></span><br><span class="line">eyJhbGciOiJSUzI1NiIsImtpZCI6Im5vZExpNi1tTERLb09ONVM2cEE0SWNCUnA4eTZieE81RnVGb1IwSk5QVFEifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjLmNsdXN0ZXIubG9jYWwiXSwiZXhwIjoxNzA4MjQ4NjM4LCJpYXQiOjE3MDgyNDUwMzgsImlzcyI6Imh0dHBzOi8va3ViZXJuZXRlcy5kZWZhdWx0LnN2Yy5jbHVzdGVyLmxvY2FsIiwia3ViZXJuZXRlcy5pbyI6eyJuYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsInNlcnZpY2VhY2NvdW50Ijp7Im5hbWUiOiJhZG1pbi11c2VyIiwidWlkIjoiMTQ1YTdmZTktMTQ0YS00NDZmLWI1M2QtNDk4OGM3YjIyZjgyIn19LCJuYmYiOjE3MDgyNDUwMzgsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTphZG1pbi11c2VyIn0.H2Oxxrb5BVLH1iDOA-Uo1I7aiAUZX1wK-xBiV9NJXQ32EDyQvss95yQbCNHtPMhQZ8jFE3NRhyjkgZMZmX7kR9J-89QXLqKhE8Qnihd1mq5HOEVQ8tjZ6ix8ymxs5QkfSvd_OUzILKBtfYAMb4Fer67Dyf14oBHWVKU9LQkCdtFaLxerK--N7gLWeGXzavqzOlEPZR5UZWUPwP5dJmAQtvSToPVMaKiA49LjaGJid0F5Pxnutr80oZRsLfKr0MpoEG6jrow1QeJ2PgVksDTcqMTpye-M6jmIbuxabsRSskTT_zEDT0J86BiLYIHnh79D-P7IUUq6GOp8DgG-wXhICQ</span><br></pre></td></tr></table></figure>

<h2 id="13-3登录dashboard"><a href="#13-3登录dashboard" class="headerlink" title="13.3登录dashboard"></a><strong>13.3登录dashboard</strong></h2><p><a target="_blank" rel="noopener" href="https://192.168.1.31:30034/"><em>https://192.168.1.31:30034/</em></a></p>
<h1 id="14-ingress安装"><a href="#14-ingress安装" class="headerlink" title="14.ingress安装"></a>14.ingress安装</h1><h2 id="14-1执行部署"><a href="#14-1执行部署" class="headerlink" title="14.1执行部署"></a><strong>14.1执行部署</strong></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line">wget https://mirrors.chenby.cn/https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/cloud/deploy.yaml</span><br><span class="line">​</span><br><span class="line"># 修改为国内源 docker源可选</span><br><span class="line">sed -i &quot;s#registry.k8s.io/#m.daocloud.io/registry.k8s.io/#g&quot; *.yaml</span><br><span class="line">​</span><br><span class="line">cat &gt; backend.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: default-http-backend</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: default-http-backend</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app.kubernetes.io/name: default-http-backend</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app.kubernetes.io/name: default-http-backend</span><br><span class="line">    spec:</span><br><span class="line">      terminationGracePeriodSeconds: 60</span><br><span class="line">      containers:</span><br><span class="line">      - name: default-http-backend</span><br><span class="line">        image: registry.cn-hangzhou.aliyuncs.com/chenby/defaultbackend-amd64:1.5 </span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /healthz</span><br><span class="line">            port: 8080</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 30</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 10m</span><br><span class="line">            memory: 20Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 10m</span><br><span class="line">            memory: 20Mi</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: default-http-backend</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: default-http-backend</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    targetPort: 8080</span><br><span class="line">  selector:</span><br><span class="line">    app.kubernetes.io/name: default-http-backend</span><br><span class="line">EOF</span><br><span class="line">​</span><br><span class="line">kubectl  apply -f deploy.yaml </span><br><span class="line">kubectl  apply -f backend.yaml </span><br><span class="line">​</span><br><span class="line">​</span><br><span class="line">cat &gt; ingress-demo-app.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: hello-server</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: hello-server</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: hello-server</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: hello-server</span><br><span class="line">        image: registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images/hello-server</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9000</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx-demo</span><br><span class="line">  name: nginx-demo</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx-demo</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-demo</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: nginx</span><br><span class="line">        name: nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx-demo</span><br><span class="line">  name: nginx-demo</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx-demo</span><br><span class="line">  ports:</span><br><span class="line">  - port: 8000</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: hello-server</span><br><span class="line">  name: hello-server</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: hello-server</span><br><span class="line">  ports:</span><br><span class="line">  - port: 8000</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 9000</span><br><span class="line">---</span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress  </span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-host-bar</span><br><span class="line">spec:</span><br><span class="line">  ingressClassName: nginx</span><br><span class="line">  rules:</span><br><span class="line">  - host: &quot;hello.chenby.cn&quot;</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - pathType: Prefix</span><br><span class="line">        path: &quot;/&quot;</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: hello-server</span><br><span class="line">            port:</span><br><span class="line">              number: 8000</span><br><span class="line">  - host: &quot;demo.chenby.cn&quot;</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - pathType: Prefix</span><br><span class="line">        path: &quot;/nginx&quot;  </span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: nginx-demo</span><br><span class="line">            port:</span><br><span class="line">              number: 8000</span><br><span class="line">EOF</span><br><span class="line">​</span><br><span class="line"># 等创建完成后在执行：</span><br><span class="line">kubectl  apply -f ingress-demo-app.yaml </span><br><span class="line">​</span><br><span class="line">kubectl  get ingress</span><br><span class="line">NAME               CLASS   HOSTS                            ADDRESS     PORTS   AGE</span><br><span class="line">ingress-host-bar   nginx   hello.chenby.cn,demo.chenby.cn   192.168.1.32   80      7s</span><br><span class="line">​</span><br></pre></td></tr></table></figure>

<h2 id="14-2过滤查看ingress端口"><a href="#14-2过滤查看ingress端口" class="headerlink" title="14.2过滤查看ingress端口"></a><strong>14.2过滤查看ingress端口</strong></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 修改为nodeport</span><br><span class="line">kubectl edit svc -n ingress-nginx   ingress-nginx-controller</span><br><span class="line">type: NodePort</span><br><span class="line"></span><br><span class="line">[root@hello ~/yaml]# kubectl  get svc -A | grep ingress</span><br><span class="line">ingress-nginx          ingress-nginx-controller             NodePort    10.104.231.36    &lt;none&gt;        80:32636/TCP,443:30579/TCP   104s</span><br><span class="line">ingress-nginx          ingress-nginx-controller-admission   ClusterIP   10.101.85.88     &lt;none&gt;        443/TCP                      105s</span><br><span class="line">[root@hello ~/yaml]#</span><br></pre></td></tr></table></figure>

<h1 id="15-IPv6测试"><a href="#15-IPv6测试" class="headerlink" title="15.IPv6测试"></a>15.IPv6测试</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">#部署应用</span><br><span class="line">​</span><br><span class="line">cat&lt;&lt;EOF | kubectl apply -f -</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: chenby</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: chenby</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: chenby</span><br><span class="line">    spec:</span><br><span class="line">      hostNetwork: true</span><br><span class="line">      containers:</span><br><span class="line">      - name: chenby</span><br><span class="line">        image: docker.io/library/nginx</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            memory: &quot;128Mi&quot;</span><br><span class="line">            cpu: &quot;500m&quot;</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: chenby</span><br><span class="line">spec:</span><br><span class="line">  ipFamilyPolicy: PreferDualStack</span><br><span class="line">  ipFamilies:</span><br><span class="line">  - IPv6</span><br><span class="line">  - IPv4</span><br><span class="line">  type: NodePort</span><br><span class="line">  selector:</span><br><span class="line">    app: chenby</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    targetPort: 80</span><br><span class="line">EOF</span><br><span class="line">​</span><br><span class="line">​</span><br><span class="line">#查看端口</span><br><span class="line">[root@k8s-master01 ~]# kubectl  get svc</span><br><span class="line">NAME           TYPE        CLUSTER-IP            EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">chenby         NodePort    fd00:1111::bc86       &lt;none&gt;        80:31540/TCP   5s</span><br><span class="line">[root@k8s-master01 ~]# </span><br><span class="line">​</span><br><span class="line">[root@localhost yaml]# curl -I http://192.168.1.31:31540</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.21.6</span><br><span class="line">Date: Thu, 05 May 2022 10:20:59 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 615</span><br><span class="line">Last-Modified: Tue, 25 Jan 2022 15:03:52 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: &quot;61f01158-267&quot;</span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line">​</span><br><span class="line">[root@localhost yaml]# </span><br><span class="line">​</span><br><span class="line">[root@localhost yaml]# curl -I http://[2409:8a10:9e18:9020::10]:31540</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.21.6</span><br><span class="line">Date: Thu, 05 May 2022 10:20:54 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 615</span><br><span class="line">Last-Modified: Tue, 25 Jan 2022 15:03:52 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: &quot;61f01158-267&quot;</span><br><span class="line">Accept-Ranges: bytes</span><br></pre></td></tr></table></figure>

<h1 id="16-安装命令行自动补全功能"><a href="#16-安装命令行自动补全功能" class="headerlink" title="16.安装命令行自动补全功能"></a>16.安装命令行自动补全功能</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum install bash-completion -y</span><br><span class="line">source /usr/share/bash-completion/bash_completion</span><br><span class="line">source &lt;(kubectl completion bash)</span><br><span class="line">echo &quot;source &lt;(kubectl completion bash)&quot; &gt;&gt; ~/.bashrc</span><br></pre></td></tr></table></figure>

<h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"># 镜像加速器可以使用DaoCloud仓库，替换规则如下</span><br><span class="line">cr.l5d.io/  ===&gt; m.daocloud.io/cr.l5d.io/</span><br><span class="line">docker.elastic.co/  ===&gt; m.daocloud.io/docker.elastic.co/</span><br><span class="line">docker.io/  ===&gt; m.daocloud.io/docker.io/</span><br><span class="line">gcr.io/  ===&gt; m.daocloud.io/gcr.io/</span><br><span class="line">ghcr.io/  ===&gt; m.daocloud.io/ghcr.io/</span><br><span class="line">k8s.gcr.io/  ===&gt; m.daocloud.io/k8s.gcr.io/</span><br><span class="line">mcr.microsoft.com/  ===&gt; m.daocloud.io/mcr.microsoft.com/</span><br><span class="line">nvcr.io/  ===&gt; m.daocloud.io/nvcr.io/</span><br><span class="line">quay.io/  ===&gt; m.daocloud.io/quay.io/</span><br><span class="line">registry.jujucharms.com/  ===&gt; m.daocloud.io/registry.jujucharms.com/</span><br><span class="line">registry.k8s.io/  ===&gt; m.daocloud.io/registry.k8s.io/</span><br><span class="line">registry.opensource.zalan.do/  ===&gt; m.daocloud.io/registry.opensource.zalan.do/</span><br><span class="line">rocks.canonical.com/  ===&gt; m.daocloud.io/rocks.canonical.com/</span><br><span class="line">​</span><br><span class="line">​</span><br><span class="line">​</span><br><span class="line">​</span><br><span class="line"># 镜像版本要自行查看，因为镜像版本是随时更新的，文档无法做到实时更新</span><br><span class="line">​</span><br><span class="line"># docker pull 镜像</span><br><span class="line">​</span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/chenby/cni:master </span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/chenby/node:master</span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/chenby/kube-controllers:master</span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/chenby/typha:master</span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/chenby/coredns:v1.10.0</span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/chenby/pause:3.6</span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/chenby/metrics-server:v0.5.2</span><br><span class="line">docker pull kubernetesui/dashboard:v2.7.0</span><br><span class="line">docker pull kubernetesui/metrics-scraper:v1.0.8</span><br><span class="line">docker pull quay.io/cilium/cilium:v1.12.6</span><br><span class="line">docker pull quay.io/cilium/certgen:v0.1.8</span><br><span class="line">docker pull quay.io/cilium/hubble-relay:v1.12.6</span><br><span class="line">docker pull quay.io/cilium/hubble-ui-backend:v0.9.2</span><br><span class="line">docker pull quay.io/cilium/hubble-ui:v0.9.2</span><br><span class="line">docker pull quay.io/cilium/cilium-etcd-operator:v2.0.7</span><br><span class="line">docker pull quay.io/cilium/operator:v1.12.6</span><br><span class="line">docker pull quay.io/cilium/clustermesh-apiserver:v1.12.6</span><br><span class="line">docker pull quay.io/coreos/etcd:v3.5.4</span><br><span class="line">docker pull quay.io/cilium/startup-script:d69851597ea019af980891a4628fb36b7880ec26</span><br><span class="line">​</span><br><span class="line"># docker 保存镜像</span><br><span class="line">docker save registry.cn-hangzhou.aliyuncs.com/chenby/cni:master -o cni.tar </span><br><span class="line">docker save registry.cn-hangzhou.aliyuncs.com/chenby/node:master -o node.tar </span><br><span class="line">docker save registry.cn-hangzhou.aliyuncs.com/chenby/typha:master -o typha.tar </span><br><span class="line">docker save registry.cn-hangzhou.aliyuncs.com/chenby/kube-controllers:master -o kube-controllers.tar </span><br><span class="line">docker save registry.cn-hangzhou.aliyuncs.com/chenby/coredns:v1.10.0 -o coredns.tar </span><br><span class="line">docker save registry.cn-hangzhou.aliyuncs.com/chenby/pause:3.6 -o pause.tar </span><br><span class="line">docker save registry.cn-hangzhou.aliyuncs.com/chenby/metrics-server:v0.5.2 -o metrics-server.tar </span><br><span class="line">docker save kubernetesui/dashboard:v2.7.0 -o dashboard.tar </span><br><span class="line">docker save kubernetesui/metrics-scraper:v1.0.8 -o metrics-scraper.tar </span><br><span class="line">docker save quay.io/cilium/cilium:v1.12.6 -o cilium.tar </span><br><span class="line">docker save quay.io/cilium/certgen:v0.1.8 -o certgen.tar </span><br><span class="line">docker save quay.io/cilium/hubble-relay:v1.12.6 -o hubble-relay.tar </span><br><span class="line">docker save quay.io/cilium/hubble-ui-backend:v0.9.2 -o hubble-ui-backend.tar </span><br><span class="line">docker save quay.io/cilium/hubble-ui:v0.9.2 -o hubble-ui.tar </span><br><span class="line">docker save quay.io/cilium/cilium-etcd-operator:v2.0.7 -o cilium-etcd-operator.tar </span><br><span class="line">docker save quay.io/cilium/operator:v1.12.6 -o operator.tar </span><br><span class="line">docker save quay.io/cilium/clustermesh-apiserver:v1.12.6 -o clustermesh-apiserver.tar </span><br><span class="line">docker save quay.io/coreos/etcd:v3.5.4 -o etcd.tar </span><br><span class="line">docker save quay.io/cilium/startup-script:d69851597ea019af980891a4628fb36b7880ec26 -o startup-script.tar </span><br><span class="line">​</span><br><span class="line"># 传输到各个节点</span><br><span class="line">for NODE in k8s-master01 k8s-master02 k8s-master03 k8s-node01 k8s-node02; do scp -r images/  $NODE:/root/ ; done</span><br><span class="line">​</span><br><span class="line"># 创建命名空间</span><br><span class="line">ctr ns create k8s.io</span><br><span class="line">​</span><br><span class="line"># 导入镜像</span><br><span class="line">ctr --namespace k8s.io image import images/cni.tar</span><br><span class="line">ctr --namespace k8s.io image import images/node.tar</span><br><span class="line">ctr --namespace k8s.io image import images/typha.tar</span><br><span class="line">ctr --namespace k8s.io image import images/kube-controllers.tar </span><br><span class="line">ctr --namespace k8s.io image import images/coredns.tar </span><br><span class="line">ctr --namespace k8s.io image import images/pause.tar </span><br><span class="line">ctr --namespace k8s.io image import images/metrics-server.tar </span><br><span class="line">ctr --namespace k8s.io image import images/dashboard.tar </span><br><span class="line">ctr --namespace k8s.io image import images/metrics-scraper.tar </span><br><span class="line">ctr --namespace k8s.io image import images/dashboard.tar </span><br><span class="line">ctr --namespace k8s.io image import images/metrics-scraper.tar </span><br><span class="line">ctr --namespace k8s.io image import images/cilium.tar </span><br><span class="line">ctr --namespace k8s.io image import images/certgen.tar </span><br><span class="line">ctr --namespace k8s.io image import images/hubble-relay.tar </span><br><span class="line">ctr --namespace k8s.io image import images/hubble-ui-backend.tar </span><br><span class="line">ctr --namespace k8s.io image import images/hubble-ui.tar </span><br><span class="line">ctr --namespace k8s.io image import images/cilium-etcd-operator.tar </span><br><span class="line">ctr --namespace k8s.io image import images/operator.tar </span><br><span class="line">ctr --namespace k8s.io image import images/clustermesh-apiserver.tar </span><br><span class="line">ctr --namespace k8s.io image import images/etcd.tar </span><br><span class="line">ctr --namespace k8s.io image import images/startup-script.tar </span><br><span class="line">​</span><br><span class="line"># pull tar包 解压后</span><br><span class="line">helm pull cilium/cilium</span><br><span class="line">​</span><br><span class="line"># 查看镜像版本</span><br><span class="line">root@hello:~/cilium# cat values.yaml| grep tag: -C1</span><br><span class="line">  repository: &quot;quay.io/cilium/cilium&quot;</span><br><span class="line">  tag: &quot;v1.12.6&quot;</span><br><span class="line">  pullPolicy: &quot;IfNotPresent&quot;</span><br><span class="line">--</span><br><span class="line">    repository: &quot;quay.io/cilium/certgen&quot;</span><br><span class="line">    tag: &quot;v0.1.8@sha256:4a456552a5f192992a6edcec2febb1c54870d665173a33dc7d876129b199ddbd&quot;</span><br><span class="line">    pullPolicy: &quot;IfNotPresent&quot;</span><br><span class="line">--</span><br><span class="line">      repository: &quot;quay.io/cilium/hubble-relay&quot;</span><br><span class="line">      tag: &quot;v1.12.6&quot;</span><br><span class="line">       # hubble-relay-digest</span><br><span class="line">--</span><br><span class="line">        repository: &quot;quay.io/cilium/hubble-ui-backend&quot;</span><br><span class="line">        tag: &quot;v0.9.2@sha256:a3ac4d5b87889c9f7cc6323e86d3126b0d382933bd64f44382a92778b0cde5d7&quot;</span><br><span class="line">        pullPolicy: &quot;IfNotPresent&quot;</span><br><span class="line">--</span><br><span class="line">        repository: &quot;quay.io/cilium/hubble-ui&quot;</span><br><span class="line">        tag: &quot;v0.9.2@sha256:d3596efc94a41c6b772b9afe6fe47c17417658956e04c3e2a28d293f2670663e&quot;</span><br><span class="line">        pullPolicy: &quot;IfNotPresent&quot;</span><br><span class="line">--</span><br><span class="line">    repository: &quot;quay.io/cilium/cilium-etcd-operator&quot;</span><br><span class="line">    tag: &quot;v2.0.7@sha256:04b8327f7f992693c2cb483b999041ed8f92efc8e14f2a5f3ab95574a65ea2dc&quot;</span><br><span class="line">    pullPolicy: &quot;IfNotPresent&quot;</span><br><span class="line">--</span><br><span class="line">    repository: &quot;quay.io/cilium/operator&quot;</span><br><span class="line">    tag: &quot;v1.12.6&quot;</span><br><span class="line">    # operator-generic-digest</span><br><span class="line">--</span><br><span class="line">    repository: &quot;quay.io/cilium/startup-script&quot;</span><br><span class="line">    tag: &quot;d69851597ea019af980891a4628fb36b7880ec26&quot;</span><br><span class="line">    pullPolicy: &quot;IfNotPresent&quot;</span><br><span class="line">--</span><br><span class="line">    repository: &quot;quay.io/cilium/cilium&quot;</span><br><span class="line">    tag: &quot;v1.12.6&quot;</span><br><span class="line">    # cilium-digest</span><br><span class="line">--</span><br><span class="line">      repository: &quot;quay.io/cilium/clustermesh-apiserver&quot;</span><br><span class="line">      tag: &quot;v1.12.6&quot;</span><br><span class="line">      # clustermesh-apiserver-digest</span><br><span class="line">--</span><br><span class="line">        repository: &quot;quay.io/coreos/etcd&quot;</span><br><span class="line">        tag: &quot;v3.5.4@sha256:795d8660c48c439a7c3764c2330ed9222ab5db5bb524d8d0607cac76f7ba82a3&quot;</span><br><span class="line">        pullPolicy: &quot;IfNotPresent&quot;</span><br><span class="line">​</span><br></pre></td></tr></table></figure>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2024-03-16</span><i class="fa fa-tag"></i><a class="tag" href="/categories/云原生/" title="云原生">云原生 </a><a class="tag" href="/tags/CNI/" title="CNI">CNI </a><a class="tag" href="/tags/Kubernetes/" title="Kubernetes">Kubernetes </a><a class="tag" href="/tags/calico/" title="calico">calico </a><span class="leancloud_visitors"></span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://sreok.cn/2024/03/16/【云原生】二进制安装Kubernetes v1.29.2/,Elijah,【云原生】二进制安装Kubernetes v1.29.2,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2024/03/17/%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91kubernetes%E9%9B%86%E7%BE%A4%E5%8D%87%E7%BA%A7ipv4ipv6%E5%8F%8C%E6%A0%88/" title="【云原生】kubernetes集群升级ipv4ipv6双栈">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2024/03/16/%E3%80%90%E8%BD%AC%E8%BD%BD%E3%80%91%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2%20Kubernetes%20v1.29.2%20ipv4ipv6%E5%8F%8C%E6%A0%88/" title="【转载】二进制部署 Kubernetes v1.29.2 ipv4/ipv6双栈">下一篇</a></li></ul></div><script src="/js/visitors.js"></script><a id="comments"></a><div id="vcomments" style="margin:0 30px;"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/gh/xcss/valine@latest/dist/Valine.min.js"></script><script>var valine = new Valine({
  el:'#vcomments',
  notify:true || false, 
  verify:false|| false, 
  app_id:'fI99ZhgQcLYvkEn59ArxksxC-gzGzoHsz',
  app_key:'t54nFvuZ0mPdSIYuMFD5eL39',
  placeholder:'念念不忘，必有回响...',
  path: window.location.pathname,
  serverURLs: '',
  visitor:true,
  recordIP:true,
  avatar:'hide'
})</script></div></div></div></div><script src="/js/search.js"></script><div class="hidden" id="search-popup"><div id="search-panel"><input type="text" id="local-search-input" name="q" results="0" placeholder="搜索..."><div id="local-search-results"></div></div></div><script>// 点击按钮显示弹窗
document.getElementById('search-button')?.addEventListener('click', function(event) {
    document.getElementById('search-popup').classList.remove('hidden');
    document.getElementById('local-search-input').focus();
    event.stopPropagation();
});

// 点击弹窗外关闭
document.addEventListener('click', function() {
    document.getElementById('search-popup').classList.add('hidden');
});

// 阻止弹窗内冒泡
document.getElementById('search-popup').addEventListener('click', function(event) {
    event.stopPropagation();
});

// 初始化搜索功能
document.addEventListener('DOMContentLoaded', function() {
    const path = "/search.json";
    if (typeof searchFunc === 'function') {
    searchFunc(path, 'local-search-input', 'local-search-results');
    } else {
    console.error('searchFunc is not defined');
    }
});</script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script src="/js/baidu-tongji.js"></script></body></html>