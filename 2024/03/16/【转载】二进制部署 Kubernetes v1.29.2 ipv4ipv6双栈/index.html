<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Elijah"><title>【转载】二进制部署 Kubernetes v1.29.2 ipv4/ipv6双栈 · Elijah</title><meta name="description" content="二进制部署 Kubernetes v1.29.2 ipv4&amp;#x2F;ipv6双栈介绍kubernetes（k8s）二进制高可用安装部署，支持IPv4+IPv6双栈。
我使用IPV6的目的是在公网进行访问，所以我配置了IPV6静态地址。
若您没有IPV6环境，或者不想使用IPv6，不对主机进行配置I"><meta name="keywords" content="Elijah博客,Elijah Blog,博客,Elijah,Linux,Kubernetes,Docker,DevOps"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/links.css"><link rel="stylesheet" href="/css/search.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 7.3.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo.png" style="width:127px;"><h3 title=""><a href="/">Elijah</a></h3><div class="description"><p>Do one thing at a time, and do well</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/sreok"><i class="fa fa-github"></i></a></li><li><a href="mailto:admin@vsoul.cn"><i class="fa fa-envelope"></i></a></li><li><a href="/rss.xml"><i class="fa fa-rss"></i></a></li></ul><div class="footer"><div class="p"> <span>© 2020 - 2025 Elijah All Rights Reserved.</span></div><div class="by_farbox"><span>Technical support provided by </span><a href="https://github.com/sreok" target="_blank">Elijah  </a><span> & </span><a href="https://hexo.io/zh-cn/" target="_blank">Hexo </a></div><div class="beian"><img src="/images/gongan.png" style="height:10px;margin-right: 10px;position: relative;top: 1px;"><a href="https://beian.miit.gov.cn/" target="_blank">冀ICP备2022029112号</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/archives">归档</a></li><li><a href="/tags">标签</a></li><li><a href="/about">关于</a></li><li><a href="/links">友链</a></li><li><a href="/guestbook">留言</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="search_btn"><li><a id="search-button"><i class="fa fa-search"></i></a></li></div><div class="avatar"><img src="/images/favicon.png"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>【转载】二进制部署 Kubernetes v1.29.2 ipv4/ipv6双栈</a></h3></div><div class="post-content"><h1 id="二进制部署-Kubernetes-v1-29-2-ipv4-ipv6双栈"><a href="#二进制部署-Kubernetes-v1-29-2-ipv4-ipv6双栈" class="headerlink" title="二进制部署 Kubernetes v1.29.2 ipv4&#x2F;ipv6双栈"></a>二进制部署 Kubernetes v1.29.2 ipv4&#x2F;ipv6双栈</h1><h1 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h1><p>kubernetes（k8s）二进制高可用安装部署，支持IPv4+IPv6双栈。</p>
<p>我使用IPV6的目的是在公网进行访问，所以我配置了IPV6静态地址。</p>
<p>若您没有IPV6环境，或者不想使用IPv6，不对主机进行配置IPv6地址即可。</p>
<p>不配置IPV6，不影响后续，不过集群依旧是支持IPv6的。为后期留有扩展可能性。</p>
<p>若不要IPv6 ，不给网卡配置IPv6即可，不要对IPv6相关配置删除或操作，否则会出问题。</p>
<h1 id="1-环境"><a href="#1-环境" class="headerlink" title="1.环境"></a>1.环境</h1><table>
<thead>
<tr>
<th>主机名称</th>
<th>IP地址</th>
<th>说明</th>
<th>软件</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td>192.168.1.60</td>
<td>外网节点</td>
<td>下载各种所需安装包</td>
</tr>
<tr>
<td>Master01</td>
<td>192.168.1.31</td>
<td>master节点</td>
<td>kube-apiserver、kube-controller-manager、kube-scheduler、etcd、<br />kubelet、kube-proxy、nfs-client、haproxy、keepalived、nginx</td>
</tr>
<tr>
<td>Master02</td>
<td>192.168.1.32</td>
<td>master节点</td>
<td>kube-apiserver、kube-controller-manager、kube-scheduler、etcd、<br />kubelet、kube-proxy、nfs-client、haproxy、keepalived、nginx</td>
</tr>
<tr>
<td>Master03</td>
<td>192.168.1.33</td>
<td>master节点</td>
<td>kube-apiserver、kube-controller-manager、kube-scheduler、etcd、<br />kubelet、kube-proxy、nfs-client、haproxy、keepalived、nginx</td>
</tr>
<tr>
<td>Node01</td>
<td>192.168.1.34</td>
<td>node节点</td>
<td>kubelet、kube-proxy、nfs-client、nginx</td>
</tr>
<tr>
<td>Node02</td>
<td>192.168.1.35</td>
<td>node节点</td>
<td>kubelet、kube-proxy、nfs-client、nginx</td>
</tr>
<tr>
<td></td>
<td>192.168.1.36</td>
<td>VIP</td>
<td></td>
</tr>
</tbody></table>
<p>网段<br>物理主机：192.168.1.0&#x2F;24<br>service：10.96.0.0&#x2F;12<br>pod：172.16.0.0&#x2F;12</p>
<p>安装包已经整理好：<a target="_blank" rel="noopener" href="https://mirrors.chenby.cn/https://github.com/cby-chen/Kubernetes/releases/download/v1.29.2/kubernetes-v1.29.2.tar">https://mirrors.chenby.cn/https://github.com/cby-chen/Kubernetes/releases/download/v1.29.2/kubernetes-v1.29.2.tar</a></p>
<h2 id="1-1-k8s基础系统环境配置"><a href="#1-1-k8s基础系统环境配置" class="headerlink" title="1.1.k8s基础系统环境配置"></a>1.1.k8s基础系统环境配置</h2><h3 id="1-2-配置IP"><a href="#1-2-配置IP" class="headerlink" title="1.2.配置IP"></a>1.2.配置IP</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">注意！</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">若虚拟机是进行克隆的那么网卡的UUID会重复</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">若UUID重复需要重新生成新的UUID</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">UUID重复无法获取到IPV6地址</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 查看当前的网卡列表和 UUID：</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">nmcli con show</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除要更改 UUID 的网络连接：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">nmcli con delete uuid &lt;原 UUID&gt;</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重新生成 UUID：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">nmcli con add <span class="built_in">type</span> ethernet ifname &lt;接口名称&gt; con-name &lt;新名称&gt;</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重新启用网络连接：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">nmcli con up &lt;新名称&gt;</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">更改网卡的UUID</span></span><br><span class="line">ssh root@192.168.1.31 &quot;nmcli con delete uuid 708a1497-2192-43a5-9f03-2ab936fb3c44;nmcli con add type ethernet ifname eth0 con-name eth0;nmcli con up eth0&quot;</span><br><span class="line">ssh root@192.168.1.32 &quot;nmcli con delete uuid 708a1497-2192-43a5-9f03-2ab936fb3c44;nmcli con add type ethernet ifname eth0 con-name eth0;nmcli con up eth0&quot;</span><br><span class="line">ssh root@192.168.1.33 &quot;nmcli con delete uuid 708a1497-2192-43a5-9f03-2ab936fb3c44;nmcli con add type ethernet ifname eth0 con-name eth0;nmcli con up eth0&quot;</span><br><span class="line">ssh root@192.168.1.34 &quot;nmcli con delete uuid 708a1497-2192-43a5-9f03-2ab936fb3c44;nmcli con add type ethernet ifname eth0 con-name eth0;nmcli con up eth0&quot;</span><br><span class="line">ssh root@192.168.1.35 &quot;nmcli con delete uuid 708a1497-2192-43a5-9f03-2ab936fb3c44;nmcli con add type ethernet ifname eth0 con-name eth0;nmcli con up eth0&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">参数解释</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># ssh ssh root@192.168.1.31</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用SSH登录到IP为192.168.1.31的主机，使用root用户身份。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># nmcli con delete uuid 708a1497-2192-43a5-9f03-2ab936fb3c44</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除 UUID 为 708a1497-2192-43a5-9f03-2ab936fb3c44 的网络连接，这是 NetworkManager 中一种特定网络配置的唯一标识符。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># nmcli con add type ethernet ifname eth0 con-name eth0</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加一种以太网连接类型，并指定接口名为 eth0，连接名称也为 eth0。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># nmcli con up eth0</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">开启 eth0 这个网络连接。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 简单来说，这个命令的作用是删除一个特定的网络连接配置，并添加一个名为 eth0 的以太网连接，然后启用这个新的连接。</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改静态的IPv4地址</span></span><br><span class="line">ssh root@192.168.1.104 &quot;nmcli con mod eth0 ipv4.addresses 192.168.1.31/24; nmcli con mod eth0 ipv4.gateway  192.168.1.1; nmcli con mod eth0 ipv4.method manual; nmcli con mod eth0 ipv4.dns &quot;8.8.8.8&quot;; nmcli con up eth0&quot;</span><br><span class="line">ssh root@192.168.1.106 &quot;nmcli con mod eth0 ipv4.addresses 192.168.1.32/24; nmcli con mod eth0 ipv4.gateway  192.168.1.1; nmcli con mod eth0 ipv4.method manual; nmcli con mod eth0 ipv4.dns &quot;8.8.8.8&quot;; nmcli con up eth0&quot;</span><br><span class="line">ssh root@192.168.1.107 &quot;nmcli con mod eth0 ipv4.addresses 192.168.1.33/24; nmcli con mod eth0 ipv4.gateway  192.168.1.1; nmcli con mod eth0 ipv4.method manual; nmcli con mod eth0 ipv4.dns &quot;8.8.8.8&quot;; nmcli con up eth0&quot;</span><br><span class="line">ssh root@192.168.1.109 &quot;nmcli con mod eth0 ipv4.addresses 192.168.1.34/24; nmcli con mod eth0 ipv4.gateway  192.168.1.1; nmcli con mod eth0 ipv4.method manual; nmcli con mod eth0 ipv4.dns &quot;8.8.8.8&quot;; nmcli con up eth0&quot;</span><br><span class="line">ssh root@192.168.1.110 &quot;nmcli con mod eth0 ipv4.addresses 192.168.1.35/24; nmcli con mod eth0 ipv4.gateway  192.168.1.1; nmcli con mod eth0 ipv4.method manual; nmcli con mod eth0 ipv4.dns &quot;8.8.8.8&quot;; nmcli con up eth0&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">参数解释</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># ssh root@192.168.1.154</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用SSH登录到IP为192.168.1.154的主机，使用root用户身份。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># &quot;nmcli con mod eth0 ipv4.addresses 192.168.1.31/24&quot;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改eth0网络连接的IPv4地址为192.168.1.31，子网掩码为 24。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># &quot;nmcli con mod eth0 ipv4.gateway 192.168.1.1&quot;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改eth0网络连接的IPv4网关为192.168.1.1。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># &quot;nmcli con mod eth0 ipv4.method manual&quot;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将eth0网络连接的IPv4配置方法设置为手动。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># &quot;nmcli con mod eth0 ipv4.dns &quot;8.8.8.8&quot;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将eth0网络连接的IPv4 DNS服务器设置为 8.8.8.8。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># &quot;nmcli con up eth0&quot;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动eth0网络连接。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 总体来说，这条命令是通过SSH远程登录到指定的主机，并使用网络管理命令 (nmcli) 修改eth0网络连接的配置，包括IP地址、网关、配置方法和DNS服务器，并启动该网络连接。</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">没有IPv6选择不配置即可</span></span><br><span class="line">ssh root@192.168.1.31 &quot;nmcli con mod eth0 ipv6.addresses fc00:43f4:1eea:1::10; nmcli con mod eth0 ipv6.gateway fc00:43f4:1eea:1::1; nmcli con mod eth0 ipv6.method manual; nmcli con mod eth0 ipv6.dns &quot;2400:3200::1&quot;; nmcli con up eth0&quot;</span><br><span class="line">ssh root@192.168.1.32 &quot;nmcli con mod eth0 ipv6.addresses fc00:43f4:1eea:1::20; nmcli con mod eth0 ipv6.gateway fc00:43f4:1eea:1::1; nmcli con mod eth0 ipv6.method manual; nmcli con mod eth0 ipv6.dns &quot;2400:3200::1&quot;; nmcli con up eth0&quot;</span><br><span class="line">ssh root@192.168.1.33 &quot;nmcli con mod eth0 ipv6.addresses fc00:43f4:1eea:1::30; nmcli con mod eth0 ipv6.gateway fc00:43f4:1eea:1::1; nmcli con mod eth0 ipv6.method manual; nmcli con mod eth0 ipv6.dns &quot;2400:3200::1&quot;; nmcli con up eth0&quot;</span><br><span class="line">ssh root@192.168.1.34 &quot;nmcli con mod eth0 ipv6.addresses fc00:43f4:1eea:1::40; nmcli con mod eth0 ipv6.gateway fc00:43f4:1eea:1::1; nmcli con mod eth0 ipv6.method manual; nmcli con mod eth0 ipv6.dns &quot;2400:3200::1&quot;; nmcli con up eth0&quot;</span><br><span class="line">ssh root@192.168.1.35 &quot;nmcli con mod eth0 ipv6.addresses fc00:43f4:1eea:1::50; nmcli con mod eth0 ipv6.gateway fc00:43f4:1eea:1::1; nmcli con mod eth0 ipv6.method manual; nmcli con mod eth0 ipv6.dns &quot;2400:3200::1&quot;; nmcli con up eth0&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">参数解释</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># ssh root@192.168.1.31</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过SSH连接到IP地址为192.168.1.31的远程主机，使用root用户进行登录。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># &quot;nmcli con mod eth0 ipv6.addresses fc00:43f4:1eea:1::10&quot;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用nmcli命令修改eth0接口的IPv6地址为fc00:43f4:1eea:1::10。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># &quot;nmcli con mod eth0 ipv6.gateway fc00:43f4:1eea:1::1&quot;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用nmcli命令修改eth0接口的IPv6网关为fc00:43f4:1eea:1::1。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># &quot;nmcli con mod eth0 ipv6.method manual&quot;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用nmcli命令将eth0接口的IPv6配置方法修改为手动配置。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># &quot;nmcli con mod eth0 ipv6.dns &quot;2400:3200::1&quot;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用nmcli命令设置eth0接口的IPv6 DNS服务器为2400:3200::1。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># &quot;nmcli con up eth0&quot;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">使用nmcli命令启动eth0接口。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 这个命令的目的是在远程主机上配置eth0接口的IPv6地址、网关、配置方法和DNS服务器，并启动eth0接口。</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看网卡配置</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">nmcli device show eth0</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">nmcli con show eth0</span></span><br><span class="line">[root@localhost ~]# cat /etc/sysconfig/network-scripts/ifcfg-eth0 </span><br><span class="line">TYPE=Ethernet</span><br><span class="line">PROXY_METHOD=none</span><br><span class="line">BROWSER_ONLY=no</span><br><span class="line">BOOTPROTO=none</span><br><span class="line">DEFROUTE=yes</span><br><span class="line">IPV4_FAILURE_FATAL=no</span><br><span class="line">IPV6INIT=yes</span><br><span class="line">IPV6_AUTOCONF=yes</span><br><span class="line">IPV6_DEFROUTE=yes</span><br><span class="line">IPV6_FAILURE_FATAL=no</span><br><span class="line">IPV6_ADDR_GEN_MODE=stable-privacy</span><br><span class="line">NAME=eth0</span><br><span class="line">UUID=2aaddf95-3f36-4a48-8626-b55ebf7f53e7</span><br><span class="line">DEVICE=eth0</span><br><span class="line">ONBOOT=yes</span><br><span class="line">IPADDR=192.168.1.31</span><br><span class="line">PREFIX=24</span><br><span class="line">GATEWAY=192.168.1.1</span><br><span class="line">DNS1=8.8.8.8</span><br><span class="line">[root@localhost ~]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">参数解释</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># TYPE=Ethernet</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定连接类型为以太网。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># PROXY_METHOD=none</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定不使用代理方法。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># BROWSER_ONLY=no</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定不仅仅在浏览器中使用代理。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># BOOTPROTO=none</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定自动分配地址的方式为无（即手动配置IP地址）。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># DEFROUTE=yes</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定默认路由开启。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># IPV4_FAILURE_FATAL=no</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定IPv4连接失败时不宣告严重错误。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># IPV6INIT=yes</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定启用IPv6。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># IPV6_AUTOCONF=no</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定不自动配置IPv6地址。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># IPV6_DEFROUTE=yes</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定默认IPv6路由开启。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># IPV6_FAILURE_FATAL=no</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定IPv6连接失败时不宣告严重错误。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># IPV6_ADDR_GEN_MODE=stable-privacy</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定IPv6地址生成模式为稳定隐私模式。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># NAME=eth0</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定设备名称为eth0。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># UUID=424fd260-c480-4899-97e6-6fc9722031e8</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定设备的唯一标识符。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># DEVICE=eth0</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定设备名称为eth0。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># ONBOOT=yes</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定开机自动启用这个连接。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># IPADDR=192.168.1.31</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定IPv4地址为192.168.1.31。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># PREFIX=24</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定IPv4地址的子网掩码为24。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># GATEWAY=192.168.8.1</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定IPv4的网关地址为192.168.8.1。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># DNS1=8.8.8.8</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定首选DNS服务器为8.8.8.8。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># IPV6ADDR=fc00:43f4:1eea:1::10/128</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定IPv6地址为fc00:43f4:1eea:1::10，子网掩码为128。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># IPV6_DEFAULTGW=fc00:43f4:1eea:1::1</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定IPv6的默认网关地址为fc00:43f4:1eea:1::1。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># DNS2=2400:3200::1</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定备用DNS服务器为2400:3200::1。</span></span><br></pre></td></tr></table></figure>

<h3 id="1-3-设置主机名"><a href="#1-3-设置主机名" class="headerlink" title="1.3.设置主机名"></a>1.3.设置主机名</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname k8s-master01</span><br><span class="line">hostnamectl set-hostname k8s-master02</span><br><span class="line">hostnamectl set-hostname k8s-master03</span><br><span class="line">hostnamectl set-hostname k8s-node01</span><br><span class="line">hostnamectl set-hostname k8s-node02</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">参数解释</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 参数: set-hostname</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解释: 这是hostnamectl命令的一个参数，用于设置系统的主机名。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 参数: k8s-master01</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解释: 这是要设置的主机名，将系统的主机名设置为<span class="string">&quot;k8s-master01&quot;</span>。</span></span><br></pre></td></tr></table></figure>


<h3 id="1-4-配置yum源"><a href="#1-4-配置yum源" class="headerlink" title="1.4.配置yum源"></a>1.4.配置yum源</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">其他系统的源地址</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https://mirrors.tuna.tsinghua.edu.cn/help/</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">对于 Ubuntu</span></span><br><span class="line">sed -i &#x27;s/cn.archive.ubuntu.com/mirrors.ustc.edu.cn/g&#x27; /etc/apt/sources.list</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">对于 CentOS 7</span></span><br><span class="line">sudo sed -e &#x27;s|^mirrorlist=|#mirrorlist=|g&#x27; \</span><br><span class="line">         -e &#x27;s|^#baseurl=http://mirror.centos.org/centos|baseurl=https://mirrors.tuna.tsinghua.edu.cn/centos|g&#x27; \</span><br><span class="line">         -i.bak \</span><br><span class="line">         /etc/yum.repos.d/CentOS-*.repo</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">对于 CentOS 8</span></span><br><span class="line">sudo sed -e &#x27;s|^mirrorlist=|#mirrorlist=|g&#x27; \</span><br><span class="line">         -e &#x27;s|^#baseurl=http://mirror.centos.org/$contentdir|baseurl=https://mirrors.tuna.tsinghua.edu.cn/centos|g&#x27; \</span><br><span class="line">         -i.bak \</span><br><span class="line">         /etc/yum.repos.d/CentOS-*.repo</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">对于私有仓库</span></span><br><span class="line">sed -e &#x27;s|^mirrorlist=|#mirrorlist=|g&#x27; -e &#x27;s|^#baseurl=http://mirror.centos.org/\$contentdir|baseurl=http://192.168.1.123/centos|g&#x27; -i.bak  /etc/yum.repos.d/CentOS-*.repo</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">参数解释</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 以上命令是用于更改系统软件源的配置，以便从国内镜像站点下载软件包和更新。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 对于 Ubuntu 系统，将 /etc/apt/sources.list 文件中的软件源地址 cn.archive.ubuntu.com 替换为 mirrors.ustc.edu.cn。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 对于 CentOS 7 系统，将 /etc/yum.repos.d/CentOS-*.repo 文件中的 mirrorlist 注释掉，并将 baseurl 的值替换为 https://mirrors.tuna.tsinghua.edu.cn/centos。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 对于 CentOS 8 系统，同样将 /etc/yum.repos.d/CentOS-*.repo 文件中的 mirrorlist 注释掉，并将 baseurl 的值替换为 https://mirrors.tuna.tsinghua.edu.cn/centos。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 对于私有仓库，将 /etc/yum.repos.d/CentOS-*.repo 文件中的 mirrorlist 注释掉，并将 baseurl 的值替换为私有仓库地址 http://192.168.1.123/centos。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 这些命令通过使用 sed 工具和正则表达式，对相应的配置文件进行批量的替换操作，从而更改系统软件源配置。</span></span></span><br></pre></td></tr></table></figure>

<h3 id="1-5-安装一些必备工具"><a href="#1-5-安装一些必备工具" class="headerlink" title="1.5.安装一些必备工具"></a>1.5.安装一些必备工具</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">对于 Ubuntu</span></span><br><span class="line">apt update &amp;&amp; apt upgrade -y &amp;&amp; apt install -y wget psmisc vim net-tools nfs-kernel-server telnet lvm2 git tar curl</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">对于 CentOS 7</span></span><br><span class="line">yum update -y &amp;&amp; yum -y install  wget psmisc vim net-tools nfs-utils telnet yum-utils device-mapper-persistent-data lvm2 git tar curl</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">对于 CentOS 8</span></span><br><span class="line">yum update -y &amp;&amp; yum -y install wget psmisc vim net-tools nfs-utils telnet yum-utils device-mapper-persistent-data lvm2 git network-scripts tar curl</span><br></pre></td></tr></table></figure>

<h4 id="1-5-1-下载离线所需文件-可选"><a href="#1-5-1-下载离线所需文件-可选" class="headerlink" title="1.5.1 下载离线所需文件(可选)"></a>1.5.1 下载离线所需文件(可选)</h4><p> 在互联网服务器上安装一个一模一样的系统进行下载所需包</p>
<h5 id="CentOS7"><a href="#CentOS7" class="headerlink" title="CentOS7"></a>CentOS7</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载必要工具</span></span><br><span class="line">yum -y install createrepo yum-utils wget epel*</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载全量依赖包</span></span><br><span class="line">repotrack createrepo wget psmisc vim net-tools nfs-utils telnet yum-utils device-mapper-persistent-data lvm2 git tar curl gcc keepalived haproxy bash-completion chrony sshpass ipvsadm ipset sysstat conntrack libseccomp</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除libseccomp</span></span><br><span class="line">rm -rf libseccomp-*.rpm</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载libseccomp</span></span><br><span class="line">wget http://rpmfind.net/linux/centos/8-stream/BaseOS/x86_64/os/Packages/libseccomp-2.5.1-1.el8.x86_64.rpm</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建yum源信息</span></span><br><span class="line">createrepo -u -d /data/centos7/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拷贝包到内网机器上</span></span><br><span class="line">scp -r /data/centos7/ root@192.168.1.31:</span><br><span class="line">scp -r /data/centos7/ root@192.168.1.32:</span><br><span class="line">scp -r /data/centos7/ root@192.168.1.33:</span><br><span class="line">scp -r /data/centos7/ root@192.168.1.34:</span><br><span class="line">scp -r /data/centos7/ root@192.168.1.35:</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在内网机器上创建repo配置文件</span></span><br><span class="line">rm -rf /etc/yum.repos.d/*</span><br><span class="line">cat &gt; /etc/yum.repos.d/123.repo  &lt;&lt; EOF </span><br><span class="line">[cby]</span><br><span class="line">name=CentOS-$releasever - Media</span><br><span class="line">baseurl=file:///root/centos7/</span><br><span class="line">gpgcheck=0</span><br><span class="line">enabled=1</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装下载好的包</span></span><br><span class="line">yum clean all</span><br><span class="line">yum makecache</span><br><span class="line">yum install /root/centos7/* --skip-broken -y</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">### 备注 #####</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装完成后，可能还会出现yum无法使用那么再次执行</span></span><br><span class="line">rm -rf /etc/yum.repos.d/*</span><br><span class="line">cat &gt; /etc/yum.repos.d/123.repo  &lt;&lt; EOF </span><br><span class="line">[cby]</span><br><span class="line">name=CentOS-$releasever - Media</span><br><span class="line">baseurl=file:///root/centos7/</span><br><span class="line">gpgcheck=0</span><br><span class="line">enabled=1</span><br><span class="line">EOF</span><br><span class="line">yum clean all</span><br><span class="line">yum makecache</span><br><span class="line">yum install /root/centos7/* --skip-broken -y</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">### 备注 #####</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装 chrony 和 libseccomp</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">yum install /root/centos7/libseccomp-2.5.1*.rpm -y</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">yum install /root/centos7/chrony-*.rpm -y</span></span><br></pre></td></tr></table></figure>
<h5 id="CentOS8"><a href="#CentOS8" class="headerlink" title="CentOS8"></a>CentOS8</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载必要工具</span></span><br><span class="line">yum -y install createrepo yum-utils wget epel*</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载全量依赖包</span></span><br><span class="line">repotrack wget psmisc vim net-tools nfs-utils telnet yum-utils device-mapper-persistent-data lvm2 git network-scripts tar curl gcc keepalived haproxy bash-completion chrony sshpass ipvsadm ipset sysstat conntrack libseccomp</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建yum源信息</span></span><br><span class="line">createrepo -u -d /data/centos8/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拷贝包到内网机器上</span></span><br><span class="line">scp -r centos8/ root@192.168.1.31:</span><br><span class="line">scp -r centos8/ root@192.168.1.32:</span><br><span class="line">scp -r centos8/ root@192.168.1.33:</span><br><span class="line">scp -r centos8/ root@192.168.1.34:</span><br><span class="line">scp -r centos8/ root@192.168.1.35:</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在内网机器上创建repo配置文件</span></span><br><span class="line">rm -rf /etc/yum.repos.d/*</span><br><span class="line">cat &gt; /etc/yum.repos.d/123.repo  &lt;&lt; EOF </span><br><span class="line">[cby]</span><br><span class="line">name=CentOS-$releasever - Media</span><br><span class="line">baseurl=file:///root/centos8/</span><br><span class="line">gpgcheck=0</span><br><span class="line">enabled=1</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装下载好的包</span></span><br><span class="line">yum clean all</span><br><span class="line">yum makecache</span><br><span class="line">yum install /root/centos8/* --skip-broken -y</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="comment">### 备注 #####</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装完成后，可能还会出现yum无法使用那么再次执行</span></span><br><span class="line">rm -rf /etc/yum.repos.d/*</span><br><span class="line">cat &gt; /etc/yum.repos.d/123.repo  &lt;&lt; EOF </span><br><span class="line">[cby]</span><br><span class="line">name=CentOS-$releasever - Media</span><br><span class="line">baseurl=file:///root/centos8/</span><br><span class="line">gpgcheck=0</span><br><span class="line">enabled=1</span><br><span class="line">EOF</span><br><span class="line">yum clean all</span><br><span class="line">yum makecache</span><br><span class="line">yum install /root/centos8/* --skip-broken -y</span><br></pre></td></tr></table></figure>

<h5 id="Ubuntu-下载包和依赖"><a href="#Ubuntu-下载包和依赖" class="headerlink" title="Ubuntu 下载包和依赖"></a>Ubuntu 下载包和依赖</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">logfile=123.log</span><br><span class="line">ret=&quot;&quot;</span><br><span class="line">function getDepends()</span><br><span class="line">&#123;</span><br><span class="line">   echo &quot;fileName is&quot; $1&gt;&gt;$logfile</span><br><span class="line"><span class="meta prompt_">   # </span><span class="language-bash">use <span class="built_in">tr</span> to del &lt; &gt;</span></span><br><span class="line">   ret=`apt-cache depends $1|grep Depends |cut -d: -f2 |tr -d &quot;&lt;&gt;&quot;`</span><br><span class="line">   echo $ret|tee  -a $logfile</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">需要获取其所依赖包的包</span></span><br><span class="line">libs=&quot;wget psmisc vim net-tools nfs-kernel-server telnet lvm2 git tar curl gcc keepalived haproxy bash-completion chrony sshpass ipvsadm ipset sysstat conntrack libseccomp&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">download libs dependen. deep <span class="keyword">in</span> 3</span></span><br><span class="line">i=0</span><br><span class="line">while [ $i -lt 3 ] ;</span><br><span class="line">do</span><br><span class="line">    let i++</span><br><span class="line">    echo $i</span><br><span class="line">    # download libs</span><br><span class="line">    newlist=&quot; &quot;</span><br><span class="line">    for j in $libs</span><br><span class="line">    do</span><br><span class="line">        added=&quot;$(getDepends $j)&quot;</span><br><span class="line">        newlist=&quot;$newlist $added&quot;</span><br><span class="line">        apt install $added --reinstall -d -y</span><br><span class="line">    done</span><br><span class="line"></span><br><span class="line">    libs=$newlist</span><br><span class="line">done</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建源信息</span></span><br><span class="line">apt install dpkg-dev</span><br><span class="line">sudo cp /var/cache/apt/archives/*.deb /data/ubuntu/ -r</span><br><span class="line">dpkg-scanpackages . /dev/null |gzip &gt; /data/ubuntu/Packages.gz -r</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拷贝包到内网机器上</span></span><br><span class="line">scp -r ubuntu/ root@192.168.1.31:</span><br><span class="line">scp -r ubuntu/ root@192.168.1.32:</span><br><span class="line">scp -r ubuntu/ root@192.168.1.33:</span><br><span class="line">scp -r ubuntu/ root@192.168.1.34:</span><br><span class="line">scp -r ubuntu/ root@192.168.1.35:</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在内网机器上配置apt源</span></span><br><span class="line">vim /etc/apt/sources.list</span><br><span class="line">cat /etc/apt/sources.list</span><br><span class="line">deb file:////root/ ubuntu/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装deb包</span></span><br><span class="line">apt install ./*.deb</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="1-6-选择性下载需要工具"><a href="#1-6-选择性下载需要工具" class="headerlink" title="1.6.选择性下载需要工具"></a>1.6.选择性下载需要工具</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看版本地址：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># https://github.com/containernetworking/plugins/releases/</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https://github.com/containerd/containerd/releases/</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https://github.com/kubernetes-sigs/cri-tools/releases/</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https://github.com/Mirantis/cri-dockerd/releases/</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https://github.com/etcd-io/etcd/releases/</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https://github.com/cloudflare/cfssl/releases/</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https://github.com/kubernetes/kubernetes/tree/master/CHANGELOG</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https://download.docker.com/linux/static/stable/x86_64/</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https://github.com/opencontainers/runc/releases/</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https://mirrors.tuna.tsinghua.edu.cn/elrepo/kernel/el7/x86_64/RPMS/</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https://github.com/helm/helm/tags</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">http://nginx.org/download/</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Version numbers</span></span><br><span class="line">cni_plugins_version=&#x27;v1.4.0&#x27;</span><br><span class="line">cri_containerd_cni_version=&#x27;1.7.13&#x27;</span><br><span class="line">crictl_version=&#x27;v1.29.0&#x27;</span><br><span class="line">cri_dockerd_version=&#x27;0.3.10&#x27;</span><br><span class="line">etcd_version=&#x27;v3.5.12&#x27;</span><br><span class="line">cfssl_version=&#x27;1.6.4&#x27;</span><br><span class="line">kubernetes_server_version=&#x27;1.29.2&#x27;</span><br><span class="line">docker_version=&#x27;25.0.3&#x27;</span><br><span class="line">runc_version=&#x27;1.1.12&#x27;</span><br><span class="line">kernel_version=&#x27;5.4.268&#x27;</span><br><span class="line">helm_version=&#x27;3.14.1&#x27;</span><br><span class="line">nginx_version=&#x27;1.25.4&#x27;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">URLs</span> </span><br><span class="line">base_url=&#x27;https://mirrors.chenby.cn/https://github.com&#x27;</span><br><span class="line">kernel_url=&quot;http://mirrors.tuna.tsinghua.edu.cn/elrepo/kernel/el7/x86_64/RPMS/kernel-lt-$&#123;kernel_version&#125;-1.el7.elrepo.x86_64.rpm&quot;</span><br><span class="line">runc_url=&quot;$&#123;base_url&#125;/opencontainers/runc/releases/download/v$&#123;runc_version&#125;/runc.amd64&quot;</span><br><span class="line">docker_url=&quot;https://mirrors.ustc.edu.cn/docker-ce/linux/static/stable/x86_64/docker-$&#123;docker_version&#125;.tgz&quot;</span><br><span class="line">cni_plugins_url=&quot;$&#123;base_url&#125;/containernetworking/plugins/releases/download/$&#123;cni_plugins_version&#125;/cni-plugins-linux-amd64-$&#123;cni_plugins_version&#125;.tgz&quot;</span><br><span class="line">cri_containerd_cni_url=&quot;$&#123;base_url&#125;/containerd/containerd/releases/download/v$&#123;cri_containerd_cni_version&#125;/cri-containerd-cni-$&#123;cri_containerd_cni_version&#125;-linux-amd64.tar.gz&quot;</span><br><span class="line">crictl_url=&quot;$&#123;base_url&#125;/kubernetes-sigs/cri-tools/releases/download/$&#123;crictl_version&#125;/crictl-$&#123;crictl_version&#125;-linux-amd64.tar.gz&quot;</span><br><span class="line">cri_dockerd_url=&quot;$&#123;base_url&#125;/Mirantis/cri-dockerd/releases/download/v$&#123;cri_dockerd_version&#125;/cri-dockerd-$&#123;cri_dockerd_version&#125;.amd64.tgz&quot;</span><br><span class="line">etcd_url=&quot;$&#123;base_url&#125;/etcd-io/etcd/releases/download/$&#123;etcd_version&#125;/etcd-$&#123;etcd_version&#125;-linux-amd64.tar.gz&quot;</span><br><span class="line">cfssl_url=&quot;$&#123;base_url&#125;/cloudflare/cfssl/releases/download/v$&#123;cfssl_version&#125;/cfssl_$&#123;cfssl_version&#125;_linux_amd64&quot;</span><br><span class="line">cfssljson_url=&quot;$&#123;base_url&#125;/cloudflare/cfssl/releases/download/v$&#123;cfssl_version&#125;/cfssljson_$&#123;cfssl_version&#125;_linux_amd64&quot;</span><br><span class="line">helm_url=&quot;https://mirrors.huaweicloud.com/helm/v$&#123;helm_version&#125;/helm-v$&#123;helm_version&#125;-linux-amd64.tar.gz&quot;</span><br><span class="line">kubernetes_server_url=&quot;https://storage.googleapis.com/kubernetes-release/release/v$&#123;kubernetes_server_version&#125;/kubernetes-server-linux-amd64.tar.gz&quot;</span><br><span class="line">nginx_url=&quot;http://nginx.org/download/nginx-$&#123;nginx_version&#125;.tar.gz&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Download packages</span></span><br><span class="line">packages=(</span><br><span class="line"><span class="meta prompt_">  $</span><span class="language-bash">kernel_url</span></span><br><span class="line"><span class="meta prompt_">  $</span><span class="language-bash">runc_url</span></span><br><span class="line"><span class="meta prompt_">  $</span><span class="language-bash">docker_url</span></span><br><span class="line"><span class="meta prompt_">  $</span><span class="language-bash">cni_plugins_url</span></span><br><span class="line"><span class="meta prompt_">  $</span><span class="language-bash">cri_containerd_cni_url</span></span><br><span class="line"><span class="meta prompt_">  $</span><span class="language-bash">crictl_url</span></span><br><span class="line"><span class="meta prompt_">  $</span><span class="language-bash">cri_dockerd_url</span></span><br><span class="line"><span class="meta prompt_">  $</span><span class="language-bash">etcd_url</span></span><br><span class="line"><span class="meta prompt_">  $</span><span class="language-bash">cfssl_url</span></span><br><span class="line"><span class="meta prompt_">  $</span><span class="language-bash">cfssljson_url</span></span><br><span class="line"><span class="meta prompt_">  $</span><span class="language-bash">helm_url</span></span><br><span class="line"><span class="meta prompt_">  $</span><span class="language-bash">kubernetes_server_url</span></span><br><span class="line"><span class="meta prompt_">  $</span><span class="language-bash">nginx_url</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">for package_url in &quot;$&#123;packages[@]&#125;&quot;; do</span><br><span class="line">  filename=$(basename &quot;$package_url&quot;)</span><br><span class="line">  if curl --parallel --parallel-immediate -k -L -C - -o &quot;$filename&quot; &quot;$package_url&quot;; then</span><br><span class="line">    echo &quot;Downloaded $filename&quot;</span><br><span class="line">  else</span><br><span class="line">    echo &quot;Failed to download $filename&quot;</span><br><span class="line">    exit 1</span><br><span class="line">  fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<h3 id="1-7-关闭防火墙"><a href="#1-7-关闭防火墙" class="headerlink" title="1.7.关闭防火墙"></a>1.7.关闭防火墙</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Ubuntu忽略，CentOS执行</span></span><br><span class="line">systemctl disable --now firewalld</span><br></pre></td></tr></table></figure>

<h3 id="1-8-关闭SELinux"><a href="#1-8-关闭SELinux" class="headerlink" title="1.8.关闭SELinux"></a>1.8.关闭SELinux</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Ubuntu忽略，CentOS执行</span></span><br><span class="line">setenforce 0</span><br><span class="line">sed -i &#x27;s#SELINUX=enforcing#SELINUX=disabled#g&#x27; /etc/selinux/config</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">参数解释</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># setenforce 0</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">此命令用于设置 SELinux 的执行模式。0 表示关闭 SELinux。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># sed -i &#x27;s#SELINUX=enforcing#SELINUX=disabled#g&#x27; /etc/selinux/config</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">该命令使用 sed 工具来编辑 /etc/selinux/config 文件。其中 <span class="string">&#x27;-i&#x27;</span> 参数表示直接修改原文件，而不是输出到终端或另一个文件。<span class="string">&#x27;s#SELINUX=enforcing#SELINUX=disabled#g&#x27;</span> 是 sed 的替换命令，它将文件中所有的 <span class="string">&quot;SELINUX=enforcing&quot;</span> 替换为 <span class="string">&quot;SELINUX=disabled&quot;</span>。这里的 <span class="string">&#x27;#&#x27;</span> 是分隔符，用于替代传统的 <span class="string">&#x27;/&#x27;</span> 分隔符，以避免与路径中的 <span class="string">&#x27;/&#x27;</span> 冲突。</span></span><br></pre></td></tr></table></figure>

<h3 id="1-9-关闭交换分区"><a href="#1-9-关闭交换分区" class="headerlink" title="1.9.关闭交换分区"></a>1.9.关闭交换分区</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sed -ri &#x27;s/.*swap.*/#&amp;/&#x27; /etc/fstab</span><br><span class="line">swapoff -a &amp;&amp; sysctl -w vm.swappiness=0</span><br><span class="line"></span><br><span class="line">cat /etc/fstab</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">/dev/mapper/centos-swap swap                    swap    defaults        0 0</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">参数解释：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># -ri: 这个参数用于在原文件中替换匹配的模式。-r表示扩展正则表达式，-i允许直接修改文件。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">&#x27;s/.*swap.*/#&amp;/&#x27;</span>: 这是一个sed命令，用于在文件/etc/fstab中找到包含swap的行，并在行首添加#来注释掉该行。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">/etc/fstab: 这是一个文件路径，即/etc/fstab文件，用于存储文件系统表。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">swapoff -a: 这个命令用于关闭所有启用的交换分区。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">sysctl -w vm.swappiness=0: 这个命令用于修改vm.swappiness参数的值为0，表示系统在物理内存充足时更倾向于使用物理内存而非交换分区。</span></span><br></pre></td></tr></table></figure>

<h3 id="1-10-网络配置（俩种方式二选一）"><a href="#1-10-网络配置（俩种方式二选一）" class="headerlink" title="1.10.网络配置（俩种方式二选一）"></a>1.10.网络配置（俩种方式二选一）</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Ubuntu忽略，CentOS执行</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">方式一</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">systemctl <span class="built_in">disable</span> --now NetworkManager</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">systemctl start network &amp;&amp; systemctl <span class="built_in">enable</span> network</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">方式二</span></span><br><span class="line">cat &gt; /etc/NetworkManager/conf.d/calico.conf &lt;&lt; EOF </span><br><span class="line">[keyfile]</span><br><span class="line">unmanaged-devices=interface-name:cali*;interface-name:tunl*</span><br><span class="line">EOF</span><br><span class="line">systemctl restart NetworkManager</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">参数解释</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 这个参数用于指定不由 NetworkManager 管理的设备。它由以下两个部分组成</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># interface-name:cali*</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">表示以 <span class="string">&quot;cali&quot;</span> 开头的接口名称被排除在 NetworkManager 管理之外。例如，<span class="string">&quot;cali0&quot;</span>, <span class="string">&quot;cali1&quot;</span> 等接口不受 NetworkManager 管理。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># interface-name:tunl*</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">表示以 <span class="string">&quot;tunl&quot;</span> 开头的接口名称被排除在 NetworkManager 管理之外。例如，<span class="string">&quot;tunl0&quot;</span>, <span class="string">&quot;tunl1&quot;</span> 等接口不受 NetworkManager 管理。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 通过使用这个参数，可以将特定的接口排除在 NetworkManager 的管理范围之外，以便其他工具或进程可以独立地管理和配置这些接口。</span></span></span><br></pre></td></tr></table></figure>

<h3 id="1-11-进行时间同步"><a href="#1-11-进行时间同步" class="headerlink" title="1.11.进行时间同步"></a>1.11.进行时间同步</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">服务端</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">apt install chrony -y</span></span><br><span class="line">yum install chrony -y</span><br><span class="line">cat &gt; /etc/chrony.conf &lt;&lt; EOF </span><br><span class="line">pool ntp.aliyun.com iburst</span><br><span class="line">driftfile /var/lib/chrony/drift</span><br><span class="line">makestep 1.0 3</span><br><span class="line">rtcsync</span><br><span class="line">allow 192.168.1.0/24</span><br><span class="line">local stratum 10</span><br><span class="line">keyfile /etc/chrony.keys</span><br><span class="line">leapsectz right/UTC</span><br><span class="line">logdir /var/log/chrony</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl restart chronyd ; systemctl enable chronyd</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">客户端</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">apt install chrony -y</span></span><br><span class="line">yum install chrony -y</span><br><span class="line">cat &gt; /etc/chrony.conf &lt;&lt; EOF </span><br><span class="line">pool 192.168.1.31 iburst</span><br><span class="line">driftfile /var/lib/chrony/drift</span><br><span class="line">makestep 1.0 3</span><br><span class="line">rtcsync</span><br><span class="line">keyfile /etc/chrony.keys</span><br><span class="line">leapsectz right/UTC</span><br><span class="line">logdir /var/log/chrony</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl restart chronyd ; systemctl enable chronyd</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">使用客户端进行验证</span></span><br><span class="line">chronyc sources -v</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">参数解释</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># pool ntp.aliyun.com iburst</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定使用ntp.aliyun.com作为时间服务器池，iburst选项表示在初始同步时会发送多个请求以加快同步速度。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># driftfile /var/lib/chrony/drift</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定用于保存时钟漂移信息的文件路径。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># makestep 1.0 3</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置当系统时间与服务器时间偏差大于1秒时，会以1秒的步长进行调整。如果偏差超过3秒，则立即进行时间调整。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># rtcsync</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启用硬件时钟同步功能，可以提高时钟的准确性。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># allow 192.168.0.0/24</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">允许192.168.0.0/24网段范围内的主机与chrony进行时间同步。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># local stratum 10</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将本地时钟设为stratum 10，stratum值表示时钟的准确度，值越小表示准确度越高。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># keyfile /etc/chrony.keys</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定使用的密钥文件路径，用于对时间同步进行身份验证。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># leapsectz right/UTC</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定时区为UTC。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># logdir /var/log/chrony</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定日志文件存放目录。</span></span><br></pre></td></tr></table></figure>

<h3 id="1-12-配置ulimit"><a href="#1-12-配置ulimit" class="headerlink" title="1.12.配置ulimit"></a>1.12.配置ulimit</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">ulimit -SHn 65535</span><br><span class="line">cat &gt;&gt; /etc/security/limits.conf &lt;&lt;EOF</span><br><span class="line">* soft nofile 655360</span><br><span class="line">* hard nofile 131072</span><br><span class="line">* soft nproc 655350</span><br><span class="line">* hard nproc 655350</span><br><span class="line">* seft memlock unlimited</span><br><span class="line">* hard memlock unlimitedd</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">参数解释</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># soft nofile 655360</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">soft表示软限制，nofile表示一个进程可打开的最大文件数，默认值为1024。这里的软限制设置为655360，即一个进程可打开的最大文件数为655360。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># hard nofile 131072</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">hard表示硬限制，即系统设置的最大值。nofile表示一个进程可打开的最大文件数，默认值为4096。这里的硬限制设置为131072，即系统设置的最大文件数为131072。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># soft nproc 655350</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">soft表示软限制，<span class="built_in">nproc</span>表示一个用户可创建的最大进程数，默认值为30720。这里的软限制设置为655350，即一个用户可创建的最大进程数为655350。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># hard nproc 655350</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">hard表示硬限制，即系统设置的最大值。<span class="built_in">nproc</span>表示一个用户可创建的最大进程数，默认值为4096。这里的硬限制设置为655350，即系统设置的最大进程数为655350。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># seft memlock unlimited</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">seft表示软限制，memlock表示一个进程可锁定在RAM中的最大内存，默认值为64 KB。这里的软限制设置为unlimited，即一个进程可锁定的最大内存为无限制。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># hard memlock unlimited</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">hard表示硬限制，即系统设置的最大值。memlock表示一个进程可锁定在RAM中的最大内存，默认值为64 KB。这里的硬限制设置为unlimited，即系统设置的最大内存锁定为无限制。</span></span><br></pre></td></tr></table></figure>

<h3 id="1-13-配置免密登录"><a href="#1-13-配置免密登录" class="headerlink" title="1.13.配置免密登录"></a>1.13.配置免密登录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">apt install -y sshpass</span></span><br><span class="line">yum install -y sshpass</span><br><span class="line">ssh-keygen -f /root/.ssh/id_rsa -P &#x27;&#x27;</span><br><span class="line">export IP=&quot;192.168.1.31 192.168.1.32 192.168.1.33 192.168.1.34 192.168.1.35&quot;</span><br><span class="line">export SSHPASS=123123</span><br><span class="line">for HOST in $IP;do</span><br><span class="line">     sshpass -e ssh-copy-id -o StrictHostKeyChecking=no $HOST</span><br><span class="line">done</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这段脚本的作用是在一台机器上安装sshpass工具，并通过sshpass自动将本机的SSH公钥复制到多个远程主机上，以实现无需手动输入密码的SSH登录。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 具体解释如下：</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 1. `apt install -y sshpass` 或 `yum install -y sshpass`：通过包管理器（apt或yum）安装sshpass工具，使得后续可以使用sshpass命令。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 2. `ssh-keygen -f /root/.ssh/id_rsa -P &#x27;&#x27;`：生成SSH密钥对。该命令会在/root/.ssh目录下生成私钥文件id_rsa和公钥文件id_rsa.pub，同时不设置密码（即-P参数后面为空），方便后续通过ssh-copy-id命令自动复制公钥。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 3. `export IP=&quot;192.168.1.31 192.168.1.32 192.168.1.33 192.168.1.34 192.168.1.35&quot;`：设置一个包含多个远程主机IP地址的环境变量IP，用空格分隔开，表示要将SSH公钥复制到这些远程主机上。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 4. `export SSHPASS=123123`：设置环境变量SSHPASS，将sshpass所需的SSH密码（在这里是&quot;123123&quot;）赋值给它，这样sshpass命令可以自动使用这个密码进行登录。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 5. `for HOST in $IP;do`：遍历环境变量IP中的每个IP地址，并将当前IP地址赋值给变量HOST。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 6. `sshpass -e ssh-copy-id -o StrictHostKeyChecking=no $HOST`：使用sshpass工具复制本机的SSH公钥到远程主机。其中，-e选项表示使用环境变量中的密码（即SSHPASS）进行登录，-o StrictHostKeyChecking=no选项表示连接时不检查远程主机的公钥，以避免交互式确认。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 通过这段脚本，可以方便地将本机的SSH公钥复制到多个远程主机上，实现无需手动输入密码的SSH登录。</span></span></span><br></pre></td></tr></table></figure>

<h3 id="1-14-添加启用源"><a href="#1-14-添加启用源" class="headerlink" title="1.14.添加启用源"></a>1.14.添加启用源</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Ubuntu忽略，CentOS执行</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">为 RHEL-8或 CentOS-8配置源</span></span><br><span class="line">yum install https://www.elrepo.org/elrepo-release-8.el8.elrepo.noarch.rpm -y </span><br><span class="line">sed -i &quot;s@mirrorlist@#mirrorlist@g&quot; /etc/yum.repos.d/elrepo.repo </span><br><span class="line">sed -i &quot;s@elrepo.org/linux@mirrors.tuna.tsinghua.edu.cn/elrepo@g&quot; /etc/yum.repos.d/elrepo.repo </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">为 RHEL-7 SL-7 或 CentOS-7 安装 ELRepo</span> </span><br><span class="line">yum install https://www.elrepo.org/elrepo-release-7.el7.elrepo.noarch.rpm -y </span><br><span class="line">sed -i &quot;s@mirrorlist@#mirrorlist@g&quot; /etc/yum.repos.d/elrepo.repo </span><br><span class="line">sed -i &quot;s@elrepo.org/linux@mirrors.tuna.tsinghua.edu.cn/elrepo@g&quot; /etc/yum.repos.d/elrepo.repo </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看可用安装包</span></span><br><span class="line">yum  --disablerepo=&quot;*&quot;  --enablerepo=&quot;elrepo-kernel&quot;  list  available</span><br></pre></td></tr></table></figure>

<h3 id="1-15-升级内核至4-18版本以上"><a href="#1-15-升级内核至4-18版本以上" class="headerlink" title="1.15.升级内核至4.18版本以上"></a>1.15.升级内核至4.18版本以上</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Ubuntu忽略，CentOS执行</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装最新的内核</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">我这里选择的是稳定版kernel-ml   如需更新长期维护版本kernel-lt</span>  </span><br><span class="line">yum -y --enablerepo=elrepo-kernel  install  kernel-ml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看已安装那些内核</span></span><br><span class="line">rpm -qa | grep kernel</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看默认内核</span></span><br><span class="line">grubby --default-kernel</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">若不是最新的使用命令设置</span></span><br><span class="line">grubby --set-default $(ls /boot/vmlinuz-* | grep elrepo)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启生效</span></span><br><span class="line">reboot</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">v8 整合命令为：</span></span><br><span class="line">yum install https://www.elrepo.org/elrepo-release-8.el8.elrepo.noarch.rpm -y ; sed -i &quot;s@mirrorlist@#mirrorlist@g&quot; /etc/yum.repos.d/elrepo.repo ; sed -i &quot;s@elrepo.org/linux@mirrors.tuna.tsinghua.edu.cn/elrepo@g&quot; /etc/yum.repos.d/elrepo.repo ; yum  --disablerepo=&quot;*&quot;  --enablerepo=&quot;elrepo-kernel&quot;  list  available -y ; yum  --enablerepo=elrepo-kernel  install kernel-lt -y ; grubby --default-kernel ; reboot </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">v7 整合命令为：</span></span><br><span class="line">yum install https://www.elrepo.org/elrepo-release-7.el7.elrepo.noarch.rpm -y ; sed -i &quot;s@mirrorlist@#mirrorlist@g&quot; /etc/yum.repos.d/elrepo.repo ; sed -i &quot;s@elrepo.org/linux@mirrors.tuna.tsinghua.edu.cn/elrepo@g&quot; /etc/yum.repos.d/elrepo.repo ; yum  --disablerepo=&quot;*&quot;  --enablerepo=&quot;elrepo-kernel&quot;  list  available -y ; yum  --enablerepo=elrepo-kernel  install  kernel-lt -y ; grubby --set-default $(ls /boot/vmlinuz-* | grep elrepo) ; grubby --default-kernel ; reboot </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">离线版本</span> </span><br><span class="line">yum install -y /root/cby/kernel-lt-*-1.el7.elrepo.x86_64.rpm ; grubby --set-default $(ls /boot/vmlinuz-* | grep elrepo) ; grubby --default-kernel ; reboot </span><br></pre></td></tr></table></figure>

<h3 id="1-16-安装ipvsadm"><a href="#1-16-安装ipvsadm" class="headerlink" title="1.16.安装ipvsadm"></a>1.16.安装ipvsadm</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">对于CentOS7离线安装</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">yum install /root/centos7/ipset-*.el7.x86_64.rpm /root/centos7/lm_sensors-libs-*.el7.x86_64.rpm  /root/centos7/ipset-libs-*.el7.x86_64.rpm /root/centos7/sysstat-*.el7_9.x86_64.rpm  /root/centos7/ipvsadm-*.el7.x86_64.rpm  -y</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">对于 Ubuntu</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">apt install ipvsadm ipset sysstat conntrack -y</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">对于 CentOS</span></span><br><span class="line">yum install ipvsadm ipset sysstat conntrack libseccomp -y</span><br><span class="line">cat &gt;&gt; /etc/modules-load.d/ipvs.conf &lt;&lt;EOF </span><br><span class="line">ip_vs</span><br><span class="line">ip_vs_rr</span><br><span class="line">ip_vs_wrr</span><br><span class="line">ip_vs_sh</span><br><span class="line">nf_conntrack</span><br><span class="line">ip_tables</span><br><span class="line">ip_set</span><br><span class="line">xt_set</span><br><span class="line">ipt_set</span><br><span class="line">ipt_rpfilter</span><br><span class="line">ipt_REJECT</span><br><span class="line">ipip</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl restart systemd-modules-load.service</span><br><span class="line"></span><br><span class="line">lsmod | grep -e ip_vs -e nf_conntrack</span><br><span class="line">ip_vs_sh               16384  0</span><br><span class="line">ip_vs_wrr              16384  0</span><br><span class="line">ip_vs_rr               16384  0</span><br><span class="line">ip_vs                 180224  6 ip_vs_rr,ip_vs_sh,ip_vs_wrr</span><br><span class="line">nf_conntrack          176128  1 ip_vs</span><br><span class="line">nf_defrag_ipv6         24576  2 nf_conntrack,ip_vs</span><br><span class="line">nf_defrag_ipv4         16384  1 nf_conntrack</span><br><span class="line">libcrc32c              16384  3 nf_conntrack,xfs,ip_vs</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">参数解释</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># ip_vs</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">IPVS 是 Linux 内核中的一个模块，用于实现负载均衡和高可用性。它通过在前端代理服务器上分发传入请求到后端实际服务器上，提供了高性能和可扩展的网络服务。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># ip_vs_rr</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">IPVS 的一种调度算法之一，使用轮询方式分发请求到后端服务器，每个请求按顺序依次分发。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># ip_vs_wrr</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">IPVS 的一种调度算法之一，使用加权轮询方式分发请求到后端服务器，每个请求按照指定的权重比例分发。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># ip_vs_sh</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">IPVS 的一种调度算法之一，使用哈希方式根据源 IP 地址和目标 IP 地址来分发请求。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># nf_conntrack</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这是一个内核模块，用于跟踪和管理网络连接，包括 TCP、UDP 和 ICMP 等协议。它是实现防火墙状态跟踪的基础。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># ip_tables</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这是一个内核模块，提供了对 Linux 系统 IP 数据包过滤和网络地址转换（NAT）功能的支持。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># ip_set</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这是一个内核模块，扩展了 iptables 的功能，支持更高效的 IP 地址集合操作。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># xt_set</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这是一个内核模块，扩展了 iptables 的功能，支持更高效的数据包匹配和操作。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># ipt_set</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这是一个用户空间工具，用于配置和管理 xt_set 内核模块。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># ipt_rpfilter</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这是一个内核模块，用于实现反向路径过滤，用于防止 IP 欺骗和 DDoS 攻击。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># ipt_REJECT</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这是一个 iptables 目标，用于拒绝 IP 数据包，并向发送方发送响应，指示数据包被拒绝。</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># ipip</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这是一个内核模块，用于实现 IP 封装在 IP（IP-over-IP）的隧道功能。它可以在不同网络之间创建虚拟隧道来传输 IP 数据包。</span></span><br></pre></td></tr></table></figure>

<h3 id="1-17-修改内核参数"><a href="#1-17-修改内核参数" class="headerlink" title="1.17.修改内核参数"></a>1.17.修改内核参数</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/sysctl.d/k8s.conf</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">fs.may_detach_mounts = 1</span><br><span class="line">vm.overcommit_memory=1</span><br><span class="line">vm.panic_on_oom=0</span><br><span class="line">fs.inotify.max_user_watches=89100</span><br><span class="line">fs.file-max=52706963</span><br><span class="line">fs.nr_open=52706963</span><br><span class="line">net.netfilter.nf_conntrack_max=2310720</span><br><span class="line"></span><br><span class="line">net.ipv4.tcp_keepalive_time = 600</span><br><span class="line">net.ipv4.tcp_keepalive_probes = 3</span><br><span class="line">net.ipv4.tcp_keepalive_intvl =15</span><br><span class="line">net.ipv4.tcp_max_tw_buckets = 36000</span><br><span class="line">net.ipv4.tcp_tw_reuse = 1</span><br><span class="line">net.ipv4.tcp_max_orphans = 327680</span><br><span class="line">net.ipv4.tcp_orphan_retries = 3</span><br><span class="line">net.ipv4.tcp_syncookies = 1</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 16384</span><br><span class="line">net.ipv4.ip_conntrack_max = 65536</span><br><span class="line">net.ipv4.tcp_max_syn_backlog = 16384</span><br><span class="line">net.ipv4.tcp_timestamps = 0</span><br><span class="line">net.core.somaxconn = 16384</span><br><span class="line"></span><br><span class="line">net.ipv6.conf.all.disable_ipv6 = 0</span><br><span class="line">net.ipv6.conf.default.disable_ipv6 = 0</span><br><span class="line">net.ipv6.conf.lo.disable_ipv6 = 0</span><br><span class="line">net.ipv6.conf.all.forwarding = 1</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">sysctl --system</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这些是Linux系统的一些参数设置，用于配置和优化网络、文件系统和虚拟内存等方面的功能。以下是每个参数的详细解释：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 1. net.ipv4.ip_forward = 1</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   - 这个参数启用了IPv4的IP转发功能，允许服务器作为网络路由器转发数据包。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 2. net.bridge.bridge-nf-call-iptables = 1</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   - 当使用网络桥接技术时，将数据包传递到iptables进行处理。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> </span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">3. fs.may_detach_mounts = 1</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   - 允许在挂载文件系统时，允许被其他进程使用。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> </span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">4. vm.overcommit_memory=1</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   - 该设置允许原始的内存过量分配策略，当系统的内存已经被完全使用时，系统仍然会分配额外的内存。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 5. vm.panic_on_oom=0</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   - 当系统内存不足（OOM）时，禁用系统崩溃和重启。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 6. fs.inotify.max_user_watches=89100</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   - 设置系统允许一个用户的inotify实例可以监控的文件数目的上限。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 7. fs.file-max=52706963</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   - 设置系统同时打开的文件数的上限。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 8. fs.nr_open=52706963</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   - 设置系统同时打开的文件描述符数的上限。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 9. net.netfilter.nf_conntrack_max=2310720</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   - 设置系统可以创建的网络连接跟踪表项的最大数量。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 10. net.ipv4.tcp_keepalive_time = 600</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    - 设置TCP套接字的空闲超时时间（秒），超过该时间没有活动数据时，内核会发送心跳包。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 11. net.ipv4.tcp_keepalive_probes = 3</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    - 设置未收到响应的TCP心跳探测次数。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 12. net.ipv4.tcp_keepalive_intvl = 15</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    - 设置TCP心跳探测的时间间隔（秒）。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 13. net.ipv4.tcp_max_tw_buckets = 36000</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    - 设置系统可以使用的TIME_WAIT套接字的最大数量。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 14. net.ipv4.tcp_tw_reuse = 1</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    - 启用TIME_WAIT套接字的重新利用，允许新的套接字使用旧的TIME_WAIT套接字。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 15. net.ipv4.tcp_max_orphans = 327680</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    - 设置系统可以同时存在的TCP套接字垃圾回收包裹数的最大数量。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 16. net.ipv4.tcp_orphan_retries = 3</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    - 设置系统对于孤立的TCP套接字的重试次数。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 17. net.ipv4.tcp_syncookies = 1</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    - 启用TCP SYN cookies保护，用于防止SYN洪泛攻击。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 18. net.ipv4.tcp_max_syn_backlog = 16384</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    - 设置新的TCP连接的半连接数（半连接队列）的最大长度。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 19. net.ipv4.ip_conntrack_max = 65536</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    - 设置系统可以创建的网络连接跟踪表项的最大数量。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 20. net.ipv4.tcp_timestamps = 0</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    - 关闭TCP时间戳功能，用于提供更好的安全性。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 21. net.core.somaxconn = 16384</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    - 设置系统核心层的连接队列的最大值。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 22. net.ipv6.conf.all.disable_ipv6 = 0</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    - 启用IPv6协议。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 23. net.ipv6.conf.default.disable_ipv6 = 0</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    - 启用IPv6协议。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 24. net.ipv6.conf.lo.disable_ipv6 = 0</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    - 启用IPv6协议。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 25. net.ipv6.conf.all.forwarding = 1</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    - 允许IPv6数据包转发。</span></span><br></pre></td></tr></table></figure>

<h3 id="1-18-所有节点配置hosts本地解析"><a href="#1-18-所有节点配置hosts本地解析" class="headerlink" title="1.18.所有节点配置hosts本地解析"></a>1.18.所有节点配置hosts本地解析</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/hosts &lt;&lt;EOF</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line"></span><br><span class="line">192.168.1.31 k8s-master01</span><br><span class="line">192.168.1.32 k8s-master02</span><br><span class="line">192.168.1.33 k8s-master03</span><br><span class="line">192.168.1.34 k8s-node01</span><br><span class="line">192.168.1.35 k8s-node02</span><br><span class="line">192.168.1.36 lb-vip</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h1 id="2-k8s基本组件安装"><a href="#2-k8s基本组件安装" class="headerlink" title="2.k8s基本组件安装"></a>2.k8s基本组件安装</h1><p><strong>注意 ：  2.1 和 2.2 二选其一即可</strong></p>
<h2 id="2-1-安装Containerd作为Runtime-（推荐）"><a href="#2-1-安装Containerd作为Runtime-（推荐）" class="headerlink" title="2.1.安装Containerd作为Runtime （推荐）"></a>2.1.安装Containerd作为Runtime （推荐）</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https://github.com/containernetworking/plugins/releases/</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">wget https://mirrors.chenby.cn/https://github.com/containernetworking/plugins/releases/download/v1.4.0/cni-plugins-linux-amd64-v1.4.0.tgz</span></span><br><span class="line"></span><br><span class="line">cd cby/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建cni插件所需目录</span></span><br><span class="line">mkdir -p /etc/cni/net.d /opt/cni/bin </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">解压cni二进制包</span></span><br><span class="line">tar xf cni-plugins-linux-amd64-v*.tgz -C /opt/cni/bin/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https://github.com/containerd/containerd/releases/</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">wget https://mirrors.chenby.cn/https://github.com/containerd/containerd/releases/download/v1.7.13/cri-containerd-cni-1.7.13-linux-amd64.tar.gz</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">解压</span></span><br><span class="line">tar -xzf cri-containerd-cni-*-linux-amd64.tar.gz -C /</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建服务启动文件</span></span><br><span class="line">cat &gt; /etc/systemd/system/containerd.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=containerd container runtime</span><br><span class="line">Documentation=https://containerd.io</span><br><span class="line">After=network.target local-fs.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStartPre=-/sbin/modprobe overlay</span><br><span class="line">ExecStart=/usr/local/bin/containerd</span><br><span class="line">Type=notify</span><br><span class="line">Delegate=yes</span><br><span class="line">KillMode=process</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=5</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">TasksMax=infinity</span><br><span class="line">OOMScoreAdjust=-999</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">参数解释：</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 这是一个用于启动containerd容器运行时的systemd unit文件。下面是对该文件不同部分的详细解释：</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># [Unit]</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Description=containerd container runtime</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">描述该unit的作用是作为containerd容器运行时。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Documentation=https://containerd.io</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指向容器运行时的文档的URL。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># After=network.target local-fs.target</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">定义了在哪些依赖项之后该unit应该被启动。在网络和本地文件系统加载完成后启动，确保了容器运行时在这些依赖项可用时才会启动。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># [Service]</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ExecStartPre=-/sbin/modprobe overlay</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在启动containerd之前执行的命令。这里的命令是尝试加载内核的overlay模块，如果失败则忽略错误继续执行下面的命令。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># ExecStart=/usr/local/bin/containerd</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">实际执行的命令，用于启动containerd容器运行时。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Type=notify</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定服务的通知类型。这里使用notify类型，表示当服务就绪时会通过通知的方式告知systemd。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Delegate=yes</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">允许systemd对此服务进行重启和停止操作。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># KillMode=process</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在终止容器运行时时使用的<span class="built_in">kill</span>模式。这里使用process模式，表示通过终止进程来停止容器运行时。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Restart=always</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">定义了当容器运行时终止后的重启策略。这里设置为always，表示无论何时终止容器运行时，都会自动重新启动。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># RestartSec=5</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在容器运行时终止后重新启动之前等待的秒数。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># LimitNPROC=infinity</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定容器运行时可以使用的最大进程数量。这里设置为无限制。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># LimitCORE=infinity</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定容器运行时可以使用的最大CPU核心数量。这里设置为无限制。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># LimitNOFILE=infinity</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定容器运行时可以打开的最大文件数。这里设置为无限制。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># TasksMax=infinity</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定容器运行时可以创建的最大任务数。这里设置为无限制。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># OOMScoreAdjust=-999</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定容器运行时的OOM（Out-Of-Memory）分数调整值。负数值表示容器运行时的优先级较高。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># [Install]</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">WantedBy=multi-user.target</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">定义了服务的安装位置。这里指定为multi-user.target，表示将服务安装为多用户模式下的启动项。</span></span><br></pre></td></tr></table></figure>

<h3 id="2-1-1配置Containerd所需的模块"><a href="#2-1-1配置Containerd所需的模块" class="headerlink" title="2.1.1配置Containerd所需的模块"></a>2.1.1配置Containerd所需的模块</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF | sudo tee /etc/modules-load.d/containerd.conf</span><br><span class="line">overlay</span><br><span class="line">br_netfilter</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">参数解释：</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># containerd是一个容器运行时，用于管理和运行容器。它支持多种不同的参数配置来自定义容器运行时的行为和功能。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 1. overlay：overlay是容器d默认使用的存储驱动，它提供了一种轻量级的、可堆叠的、逐层增量的文件系统。它通过在现有文件系统上叠加文件系统层来创建容器的文件系统视图。每个容器可以有自己的一组文件系统层，这些层可以共享基础镜像中的文件，并在容器内部进行修改。使用overlay可以有效地使用磁盘空间，并使容器更加轻量级。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 2. br_netfilter：br_netfilter是Linux内核提供的一个网络过滤器模块，用于在容器网络中进行网络过滤和NAT转发。当容器和主机之间的网络通信需要进行DNAT或者SNAT时，br_netfilter模块可以将IP地址进行转换。它还可以提供基于iptables规则的网络过滤功能，用于限制容器之间或容器与外部网络之间的通信。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 这些参数可以在containerd的配置文件或者命令行中指定。例如，可以通过设置--storage-driver参数来选择使用overlay作为存储驱动，通过设置--iptables参数来启用或禁用br_netfilter模块。具体的使用方法和配置细节可以参考containerd的官方文档。</span></span></span><br></pre></td></tr></table></figure>

<h3 id="2-1-2加载模块"><a href="#2-1-2加载模块" class="headerlink" title="2.1.2加载模块"></a>2.1.2加载模块</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart systemd-modules-load.service</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">参数解释：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `systemctl`: 是Linux系统管理服务的命令行工具，可以管理systemd init系统。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `restart`: 是systemctl命令的一个选项，用于重新启动服务。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `systemd-modules-load.service`: 是一个系统服务，用于加载内核模块。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 将上述参数结合在一起来解释`systemctl restart systemd-modules-load.service`的含义：</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这个命令用于重新启动系统服务`systemd-modules-load.service`，它是负责加载内核模块的服务。在重新启动该服务后，系统会重新加载所有的内核模块。</span></span><br></pre></td></tr></table></figure>

<h3 id="2-1-3配置Containerd所需的内核"><a href="#2-1-3配置Containerd所需的内核" class="headerlink" title="2.1.3配置Containerd所需的内核"></a>2.1.3配置Containerd所需的内核</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF | sudo tee /etc/sysctl.d/99-kubernetes-cri.conf</span><br><span class="line">net.bridge.bridge-nf-call-iptables  = 1</span><br><span class="line">net.ipv4.ip_forward                 = 1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">加载内核</span></span><br><span class="line">sysctl --system</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">参数解释：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 这些参数是Linux操作系统中用于网络和网络桥接设置的参数。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># - net.bridge.bridge-nf-call-iptables：这个参数控制网络桥接设备是否调用iptables规则处理网络数据包。当该参数设置为1时，网络数据包将被传递到iptables进行处理；当该参数设置为0时，网络数据包将绕过iptables直接传递。默认情况下，这个参数的值是1，即启用iptables规则处理网络数据包。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># - net.ipv4.ip_forward：这个参数用于控制是否启用IP转发功能。IP转发使得操作系统可以将接收到的数据包从一个网络接口转发到另一个网络接口。当该参数设置为1时，启用IP转发功能；当该参数设置为0时，禁用IP转发功能。在网络环境中，通常需要启用IP转发功能来实现不同网络之间的通信。默认情况下，这个参数的值是0，即禁用IP转发功能。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># - net.bridge.bridge-nf-call-ip6tables：这个参数与net.bridge.bridge-nf-call-iptables类似，但是它用于IPv6数据包的处理。当该参数设置为1时，IPv6数据包将被传递到ip6tables进行处理；当该参数设置为0时，IPv6数据包将绕过ip6tables直接传递。默认情况下，这个参数的值是1，即启用ip6tables规则处理IPv6数据包。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 这些参数的值可以通过修改操作系统的配置文件（通常是&#x27;/etc/sysctl.conf&#x27;）来进行设置。修改完成后，需要使用&#x27;sysctl -p&#x27;命令重载配置文件使参数生效。</span></span></span><br></pre></td></tr></table></figure>

<h3 id="2-1-4创建Containerd的配置文件"><a href="#2-1-4创建Containerd的配置文件" class="headerlink" title="2.1.4创建Containerd的配置文件"></a>2.1.4创建Containerd的配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">参数解释：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 这段代码是用于修改并配置containerd的参数。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 1. 首先使用命令`mkdir -p /etc/containerd`创建/etc/containerd目录，如果该目录已存在，则不进行任何操作。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2. 使用命令`containerd config default | <span class="built_in">tee</span> /etc/containerd/config.toml`创建默认配置文件，并将输出同时传递给/etc/containerd/config.toml文件。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">3. 使用sed命令修改/etc/containerd/config.toml文件，将SystemdCgroup参数的值从<span class="literal">false</span>改为<span class="literal">true</span>。-i参数表示直接在原文件中进行编辑。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">4. 使用<span class="built_in">cat</span>命令结合grep命令查看/etc/containerd/config.toml文件中SystemdCgroup参数的值是否已修改为<span class="literal">true</span>。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">5. 使用sed命令修改/etc/containerd/config.toml文件，将registry.k8s.io的地址替换为m.daocloud.io/registry.k8s.io。-i参数表示直接在原文件中进行编辑。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">6. 使用<span class="built_in">cat</span>命令结合grep命令查看/etc/containerd/config.toml文件中sandbox_image参数的值是否已修改为m.daocloud.io/registry.k8s.io。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">7. 使用sed命令修改/etc/containerd/config.toml文件，将config_path参数的值从<span class="string">&quot;&quot;</span>改为<span class="string">&quot;/etc/containerd/certs.d&quot;</span>。-i参数表示直接在原文件中进行编辑。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">8. 使用<span class="built_in">cat</span>命令结合grep命令查看/etc/containerd/config.toml文件中certs.d参数的值是否已修改为/etc/containerd/certs.d。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">9. 使用<span class="built_in">mkdir</span>命令创建/etc/containerd/certs.d/docker.io目录，如果目录已存在，则不进行任何操作。-p参数表示创建目录时，如果父级目录不存在，则自动创建父级目录。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 最后，使用cat重定向操作符将内容写入/etc/containerd/certs.d/docker.io/hosts.toml文件。该文件会配置加速器，其中server参数设置为&quot;https://docker.io&quot;，host参数设置为&quot;https://hub-mirror.c.163.com&quot;，并添加capabilities参数。</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建默认配置文件</span></span><br><span class="line">mkdir -p /etc/containerd</span><br><span class="line">containerd config default | tee /etc/containerd/config.toml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改Containerd的配置文件</span></span><br><span class="line">sed -i &quot;s#SystemdCgroup\ \=\ false#SystemdCgroup\ \=\ true#g&quot; /etc/containerd/config.toml</span><br><span class="line">cat /etc/containerd/config.toml | grep SystemdCgroup</span><br><span class="line">sed -i &quot;s#registry.k8s.io#m.daocloud.io/registry.k8s.io#g&quot; /etc/containerd/config.toml</span><br><span class="line">cat /etc/containerd/config.toml | grep sandbox_image</span><br><span class="line">sed -i &quot;s#config_path\ \=\ \&quot;\&quot;#config_path\ \=\ \&quot;/etc/containerd/certs.d\&quot;#g&quot; /etc/containerd/config.toml</span><br><span class="line">cat /etc/containerd/config.toml | grep certs.d</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置加速器</span></span><br><span class="line">mkdir /etc/containerd/certs.d/docker.io -pv</span><br><span class="line">cat &gt; /etc/containerd/certs.d/docker.io/hosts.toml &lt;&lt; EOF</span><br><span class="line">server = &quot;https://docker.io&quot;</span><br><span class="line">[host.&quot;https://docker.mirrors.ustc.edu.cn&quot;]</span><br><span class="line">  capabilities = [&quot;pull&quot;, &quot;resolve&quot;]</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">注意！</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">SystemdCgroup参数是containerd中的一个配置参数，用于设置containerd在运行过程中使用的Cgroup（控制组）路径。Containerd使用SystemdCgroup参数来指定应该使用哪个Cgroup来跟踪和管理容器的资源使用。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Cgroup是Linux内核提供的一种资源隔离和管理机制，可以用于限制、分配和监控进程组的资源使用。使用Cgroup，可以将容器的资源限制和隔离，以防止容器之间的资源争用和不公平的竞争。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 通过设置SystemdCgroup参数，可以确保containerd能够找到正确的Cgroup路径，并正确地限制和隔离容器的资源使用，确保容器可以按照预期的方式运行。如果未正确设置SystemdCgroup参数，可能会导致容器无法正确地使用资源，或者无法保证资源的公平分配和隔离。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 总而言之，SystemdCgroup参数的作用是为了确保containerd能够正确地管理容器的资源使用，以实现资源的限制、隔离和公平分配。</span></span></span><br></pre></td></tr></table></figure>

<h3 id="2-1-5启动并设置为开机启动"><a href="#2-1-5启动并设置为开机启动" class="headerlink" title="2.1.5启动并设置为开机启动"></a>2.1.5启动并设置为开机启动</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">用于重新加载systemd管理的单位文件。当你新增或修改了某个单位文件（如.service文件、.socket文件等），需要运行该命令来刷新systemd对该文件的配置。</span></span><br><span class="line"></span><br><span class="line">systemctl enable --now containerd.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启用并立即启动docker.service单元。docker.service是Docker守护进程的systemd服务单元。</span></span><br><span class="line"></span><br><span class="line">systemctl stop containerd.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">停止运行中的docker.service单元，即停止Docker守护进程。</span></span><br><span class="line"></span><br><span class="line">systemctl start containerd.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动docker.service单元，即启动Docker守护进程。</span></span><br><span class="line"></span><br><span class="line">systemctl restart containerd.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启docker.service单元，即重新启动Docker守护进程。</span></span><br><span class="line"></span><br><span class="line">systemctl status containerd.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">显示docker.service单元的当前状态，包括运行状态、是否启用等信息。</span></span><br></pre></td></tr></table></figure>

<h3 id="2-1-6配置crictl客户端连接的运行时位置"><a href="#2-1-6配置crictl客户端连接的运行时位置" class="headerlink" title="2.1.6配置crictl客户端连接的运行时位置"></a>2.1.6配置crictl客户端连接的运行时位置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https://github.com/kubernetes-sigs/cri-tools/releases/</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">wget https://mirrors.chenby.cn/https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.29.0/crictl-v1.29.0-linux-amd64.tar.gz</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">解压</span></span><br><span class="line">tar xf crictl-v*-linux-amd64.tar.gz -C /usr/bin/</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">生成配置文件</span></span><br><span class="line">cat &gt; /etc/crictl.yaml &lt;&lt;EOF</span><br><span class="line">runtime-endpoint: unix:///run/containerd/containerd.sock</span><br><span class="line">image-endpoint: unix:///run/containerd/containerd.sock</span><br><span class="line">timeout: 10</span><br><span class="line">debug: false</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">测试</span></span><br><span class="line">systemctl restart  containerd</span><br><span class="line">crictl info</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">注意！</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下面是参数`crictl`的详细解释</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># `crictl`是一个用于与容器运行时通信的命令行工具。它是容器运行时接口（CRI）工具的一个实现，可以对容器运行时进行管理和操作。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 1. `runtime-endpoint: unix:///run/containerd/containerd.sock`</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定容器运行时的终端套接字地址。在这个例子中，指定的地址是`unix:///run/containerd/containerd.sock`，这是一个Unix域套接字地址。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 2. `image-endpoint: unix:///run/containerd/containerd.sock`</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定容器镜像服务的终端套接字地址。在这个例子中，指定的地址是`unix:///run/containerd/containerd.sock`，这是一个Unix域套接字地址。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 3. `timeout: 10`</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置与容器运行时通信的超时时间，单位是秒。在这个例子中，超时时间被设置为10秒。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 4. `debug: false`</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">指定是否开启调式模式。在这个例子中，调式模式被设置为关闭，即`<span class="literal">false</span>`。如果设置为`<span class="literal">true</span>`，则会输出更详细的调试信息。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 这些参数可以根据需要进行修改，以便与容器运行时进行有效的通信和管理。</span></span></span><br></pre></td></tr></table></figure>

<h2 id="2-2-安装docker作为Runtime"><a href="#2-2-安装docker作为Runtime" class="headerlink" title="2.2 安装docker作为Runtime"></a>2.2 安装docker作为Runtime</h2><h3 id="2-2-1-解压docker程序"><a href="#2-2-1-解压docker程序" class="headerlink" title="2.2.1 解压docker程序"></a>2.2.1 解压docker程序</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">二进制包下载地址：https://download.docker.com/linux/static/stable/x86_64/</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">wget https://mirrors.ustc.edu.cn/docker-ce/linux/static/stable/x86_64/docker-25.0.3.tgz</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">解压</span></span><br><span class="line">tar xf docker-*.tgz </span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">拷贝二进制文件</span></span><br><span class="line">cp docker/* /usr/bin/</span><br></pre></td></tr></table></figure>

<h3 id="2-2-2-创建containerd的service文件"><a href="#2-2-2-创建containerd的service文件" class="headerlink" title="2.2.2 创建containerd的service文件"></a>2.2.2 创建containerd的service文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建containerd的service文件,并且启动</span></span><br><span class="line">cat &gt;/etc/systemd/system/containerd.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=containerd container runtime</span><br><span class="line">Documentation=https://containerd.io</span><br><span class="line">After=network.target local-fs.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStartPre=-/sbin/modprobe overlay</span><br><span class="line">ExecStart=/usr/bin/containerd</span><br><span class="line">Type=notify</span><br><span class="line">Delegate=yes</span><br><span class="line">KillMode=process</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=5</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">LimitNOFILE=1048576</span><br><span class="line">TasksMax=infinity</span><br><span class="line">OOMScoreAdjust=-999</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">参数解释：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># [Unit]</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- Description=containerd container runtime：指定服务的描述信息。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- Documentation=https://containerd.io：指定服务的文档链接。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- After=network.target local-fs.target：指定服务的启动顺序，在网络和本地文件系统启动之后再启动该服务。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># [Service]</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- ExecStartPre=-/sbin/modprobe overlay：在启动服务之前执行的命令，使用`-`表示忽略错误。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- ExecStart=/usr/bin/containerd：指定服务的启动命令。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- Type=notify：指定服务的类型，`notify`表示服务会在启动完成后向systemd发送通知。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- Delegate=<span class="built_in">yes</span>：允许服务代理其他服务的应答，例如收到关机命令后终止其他服务。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- KillMode=process：指定服务终止时的行为，`process`表示终止服务进程。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- Restart=always：指定服务终止后是否自动重启，`always`表示总是自动重启。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- RestartSec=5：指定服务重启的时间间隔，单位为秒。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- LimitNPROC=infinity：限制服务的最大进程数，`infinity`表示没有限制。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- LimitCORE=infinity：限制服务的最大核心数，`infinity`表示没有限制。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- LimitNOFILE=1048576：限制服务的最大文件数，指定为1048576。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- TasksMax=infinity：限制服务的最大任务数，`infinity`表示没有限制。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- OOMScoreAdjust=-999：指定服务的OOM（Out of Memory）得分，负数表示降低被终止的概率。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># [Install]</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- WantedBy=multi-user.target：指定服务的安装方式，`multi-user.target`表示该服务在多用户模式下安装。</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置开机自启</span></span><br><span class="line">systemctl enable --now containerd.service</span><br></pre></td></tr></table></figure>

<h3 id="2-2-3-准备docker的service文件"><a href="#2-2-3-准备docker的service文件" class="headerlink" title="2.2.3 准备docker的service文件"></a>2.2.3 准备docker的service文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">准备docker的service文件</span></span><br><span class="line">cat &gt; /etc/systemd/system/docker.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Docker Application Container Engine</span><br><span class="line">Documentation=https://docs.docker.com</span><br><span class="line">After=network-online.target firewalld.service cri-docker.service docker.socket containerd.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line">Requires=docker.socket containerd.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock</span><br><span class="line">ExecReload=/bin/kill -s HUP $MAINPID</span><br><span class="line">TimeoutSec=0</span><br><span class="line">RestartSec=2</span><br><span class="line">Restart=always</span><br><span class="line">StartLimitBurst=3</span><br><span class="line">StartLimitInterval=60s</span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">TasksMax=infinity</span><br><span class="line">Delegate=yes</span><br><span class="line">KillMode=process</span><br><span class="line">OOMScoreAdjust=-500</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">参数解释：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># [Unit]</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- Description: 描述服务的作用，这里是Docker Application Container Engine，即Docker应用容器引擎。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- Documentation: 提供关于此服务的文档链接，这里是Docker官方文档链接。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- After: 说明该服务在哪些其他服务之后启动，这里是在网络在线、firewalld服务和containerd服务后启动。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- Wants: 说明该服务想要的其他服务，这里是网络在线服务。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- Requires: 说明该服务需要的其他服务，这里是docker.socket和containerd.service。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># [Service]</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- Type: 服务类型，这里是notify，表示服务在启动完成时发送通知。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- ExecStart: 命令，启动该服务时会执行的命令，这里是/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock，即启动dockerd并指定一些参数，其中-H指定dockerd的监听地址为fd://，--containerd指定containerd的sock文件位置。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- ExecReload: 重载命令，当接收到HUP信号时执行的命令，这里是/bin/kill -s HUP <span class="variable">$MAINPID</span>，即发送HUP信号给主进程ID。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- TimeoutSec: 服务超时时间，这里是0，表示没有超时限制。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- RestartSec: 重启间隔时间，这里是2秒，表示重启失败后等待2秒再重启。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- Restart: 重启策略，这里是always，表示总是重启。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- StartLimitBurst: 启动限制次数，这里是3，表示在启动失败后最多重试3次。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- StartLimitInterval: 启动限制时间间隔，这里是60秒，表示两次启动之间最少间隔60秒。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- LimitNOFILE: 文件描述符限制，这里是infinity，表示没有限制。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- LimitNPROC: 进程数限制，这里是infinity，表示没有限制。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- LimitCORE: 核心转储限制，这里是infinity，表示没有限制。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- TasksMax: 最大任务数，这里是infinity，表示没有限制。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- Delegate: 修改权限，这里是<span class="built_in">yes</span>，表示启用权限修改。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- KillMode: 杀死模式，这里是process，表示杀死整个进程组。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- OOMScoreAdjust: 用于调整进程在系统内存紧张时的优先级调整，这里是-500，表示将OOM分数降低500。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># [Install]</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- WantedBy: 安装目标，这里是multi-user.target，表示在多用户模式下安装。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">     在WantedBy参数中，我们可以使用以下参数：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">     1. multi-user.target：指定该服务应该在多用户模式下启动。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">     2. graphical.target：指定该服务应该在图形化界面模式下启动。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">     3. default.target：指定该服务应该在系统的默认目标（runlevel）下启动。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">     4. rescue.target：指定该服务应该在系统救援模式下启动。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">     5. poweroff.target：指定该服务应该在关机时启动。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">     6. reboot.target：指定该服务应该在重启时启动。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">     7. halt.target：指定该服务应该在停止时启动。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">     8. shutdown.target：指定该服务应该在系统关闭时启动。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">     这些参数可以根据需要选择一个或多个，以告知系统在何时启动该服务。</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2-2-4-准备docker的socket文件"><a href="#2-2-4-准备docker的socket文件" class="headerlink" title="2.2.4 准备docker的socket文件"></a>2.2.4 准备docker的socket文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">准备docker的socket文件</span></span><br><span class="line">cat &gt; /etc/systemd/system/docker.socket &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Docker Socket for the API</span><br><span class="line"></span><br><span class="line">[Socket]</span><br><span class="line">ListenStream=/var/run/docker.sock</span><br><span class="line">SocketMode=0660</span><br><span class="line">SocketUser=root</span><br><span class="line">SocketGroup=docker</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=sockets.target</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这是一个用于Docker API的socket配置文件，包含了以下参数：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># [Unit]</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- Description：描述了该socket的作用，即为Docker API的socket。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># [Socket]</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- ListenStream：指定了socket的监听地址，该socket会监听在/var/run/docker.sock上，即Docker守护程序使用的默认sock文件。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- SocketMode：指定了socket文件的权限模式，此处为0660，即用户和用户组有读写权限，其他用户无权限。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- SocketUser：指定了socket文件的所有者，此处为root用户。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- SocketGroup：指定了socket文件的所属用户组，此处为docker用户组。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># [Install]</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- WantedBy：指定了该socket被启用时的目标，此处为sockets.target，表示当sockets.target启动时启用该socket。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 该配置文件的作用是为Docker提供API访问的通道，它监听在/var/run/docker.sock上，具有root用户权限，但只接受docker用户组的成员的连接，并且其他用户无法访问。这样，只有docker用户组的成员可以通过该socket与Docker守护进程进行通信。</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2-2-5-配置加速器"><a href="#2-2-5-配置加速器" class="headerlink" title="2.2.5 配置加速器"></a>2.2.5 配置加速器</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置加速器</span></span><br><span class="line">mkdir /etc/docker/ -pv</span><br><span class="line">cat &gt;/etc/docker/daemon.json &lt;&lt;EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span><br><span class="line">  &quot;registry-mirrors&quot;: [</span><br><span class="line">    &quot;https://docker.mirrors.ustc.edu.cn&quot;</span><br><span class="line">  ],</span><br><span class="line">  &quot;max-concurrent-downloads&quot;: 10,</span><br><span class="line">  &quot;log-driver&quot;: &quot;json-file&quot;,</span><br><span class="line">  &quot;log-level&quot;: &quot;warn&quot;,</span><br><span class="line">  &quot;log-opts&quot;: &#123;</span><br><span class="line">    &quot;max-size&quot;: &quot;10m&quot;,</span><br><span class="line">    &quot;max-file&quot;: &quot;3&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">  &quot;data-root&quot;: &quot;/var/lib/docker&quot;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">该参数文件中包含以下参数：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 1. exec-opts: 用于设置Docker守护进程的选项，native.cgroupdriver=systemd表示使用systemd作为Cgroup驱动程序。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2. registry-mirrors: 用于指定Docker镜像的镜像注册服务器。在这里有三个镜像注册服务器：https://docker.m.daocloud.io、https://docker.mirrors.ustc.edu.cn和http://hub-mirror.c.163.com。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">3. max-concurrent-downloads: 用于设置同时下载镜像的最大数量，默认值为3，这里设置为10。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">4. log-driver: 用于设置Docker守护进程的日志驱动程序，这里设置为json-file。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">5. log-level: 用于设置日志的级别，这里设置为warn。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">6. log-opts: 用于设置日志驱动程序的选项，这里有两个选项：max-size和max-file。max-size表示每个日志文件的最大大小，这里设置为10m，max-file表示保存的最大日志文件数量，这里设置为3。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">7. data-root: 用于设置Docker守护进程的数据存储根目录，默认为/var/lib/docker，这里设置为/var/lib/docker。</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2-2-6-启动docker"><a href="#2-2-6-启动docker" class="headerlink" title="2.2.6 启动docker"></a>2.2.6 启动docker</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">groupadd docker</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">创建docker组</span></span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">用于重新加载systemd管理的单位文件。当你新增或修改了某个单位文件（如.service文件、.socket文件等），需要运行该命令来刷新systemd对该文件的配置。</span></span><br><span class="line"></span><br><span class="line">systemctl enable --now docker.socket</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启用并立即启动docker.socket单元。docker.socket是一个systemd的socket单元，用于接收来自网络的Docker API请求。</span></span><br><span class="line"></span><br><span class="line">systemctl enable --now docker.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启用并立即启动docker.service单元。docker.service是Docker守护进程的systemd服务单元。</span></span><br><span class="line"></span><br><span class="line">systemctl stop docker.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">停止运行中的docker.service单元，即停止Docker守护进程。</span></span><br><span class="line"></span><br><span class="line">systemctl start docker.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动docker.service单元，即启动Docker守护进程。</span></span><br><span class="line"></span><br><span class="line">systemctl restart docker.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启docker.service单元，即重新启动Docker守护进程。</span></span><br><span class="line"></span><br><span class="line">systemctl status docker.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">显示docker.service单元的当前状态，包括运行状态、是否启用等信息。</span></span><br><span class="line"></span><br><span class="line">docker info</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">验证</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-7-解压cri-docker"><a href="#2-2-7-解压cri-docker" class="headerlink" title="2.2.7 解压cri-docker"></a>2.2.7 解压cri-docker</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">由于1.24以及更高版本不支持docker所以安装cri-docker</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载cri-docker</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https://github.com/Mirantis/cri-dockerd/releases/</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">wget  https://mirrors.chenby.cn/https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.10/cri-dockerd-0.3.10.amd64.tgz</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解压cri-docker</span></span><br><span class="line">tar xvf cri-dockerd-*.amd64.tgz </span><br><span class="line">cp -r cri-dockerd/  /usr/bin/</span><br><span class="line">chmod +x /usr/bin/cri-dockerd/cri-dockerd</span><br></pre></td></tr></table></figure>

<h3 id="2-2-8-写入启动cri-docker配置文件"><a href="#2-2-8-写入启动cri-docker配置文件" class="headerlink" title="2.2.8 写入启动cri-docker配置文件"></a>2.2.8 写入启动cri-docker配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">写入启动配置文件</span></span><br><span class="line">cat &gt;  /usr/lib/systemd/system/cri-docker.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=CRI Interface for Docker Application Container Engine</span><br><span class="line">Documentation=https://docs.mirantis.com</span><br><span class="line">After=network-online.target firewalld.service docker.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line">Requires=cri-docker.socket</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">ExecStart=/usr/bin/cri-dockerd/cri-dockerd --network-plugin=cni --pod-infra-container-image=registry.aliyuncs.com/google_containers/pause:3.7</span><br><span class="line">ExecReload=/bin/kill -s HUP $MAINPID</span><br><span class="line">TimeoutSec=0</span><br><span class="line">RestartSec=2</span><br><span class="line">Restart=always</span><br><span class="line">StartLimitBurst=3</span><br><span class="line">StartLimitInterval=60s</span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">TasksMax=infinity</span><br><span class="line">Delegate=yes</span><br><span class="line">KillMode=process</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">[Unit]</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- Description：该参数用于描述该单元的功能，这里描述的是CRI与Docker应用容器引擎的接口。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- Documentation：该参数指定了相关文档的网址，供用户参考。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- After：该参数指定了此单元应该在哪些其他单元之后启动，确保在网络在线、防火墙和Docker服务启动之后再启动此单元。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- Wants：该参数指定了此单元希望也启动的所有单元，此处是希望在网络在线之后启动。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- Requires：该参数指定了此单元需要依赖的单元，此处是cri-docker.socket单元。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># [Service]</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- Type：该参数指定了服务的类型，这里是notify，表示当服务启动完成时向系统发送通知。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- ExecStart：该参数指定了将要运行的命令和参数，此处是执行/usr/bin/cri-dockerd/cri-dockerd命令，并指定了网络插件为cni和Pod基础设施容器的镜像为registry.aliyuncs.com/google_containers/pause:3.7。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- ExecReload：该参数指定在服务重载时运行的命令，此处是发送HUP信号给主进程。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- TimeoutSec：该参数指定了服务启动的超时时间，此处为0，表示无限制。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- RestartSec：该参数指定了自动重启服务的时间间隔，此处为2秒。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- Restart：该参数指定了在服务发生错误时自动重启，此处是始终重启。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- StartLimitBurst：该参数指定了在给定时间间隔内允许的启动失败次数，此处为3次。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- StartLimitInterval：该参数指定启动失败的时间间隔，此处为60秒。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- LimitNOFILE：该参数指定了允许打开文件的最大数量，此处为无限制。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- LimitNPROC：该参数指定了允许同时运行的最大进程数，此处为无限制。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- LimitCORE：该参数指定了允许生成的core文件的最大大小，此处为无限制。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- TasksMax：该参数指定了此服务的最大任务数，此处为无限制。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- Delegate：该参数指定了是否将控制权委托给指定服务，此处为是。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- KillMode：该参数指定了在终止服务时如何处理进程，此处是通过终止进程来终止服务。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># [Install]</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- WantedBy：该参数指定了希望这个单元启动的多用户目标。在这里，这个单元希望在multi-user.target启动。</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-9-写入cri-docker的socket配置文件"><a href="#2-2-9-写入cri-docker的socket配置文件" class="headerlink" title="2.2.9 写入cri-docker的socket配置文件"></a>2.2.9 写入cri-docker的socket配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">写入socket配置文件</span></span><br><span class="line">cat &gt; /usr/lib/systemd/system/cri-docker.socket &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=CRI Docker Socket for the API</span><br><span class="line">PartOf=cri-docker.service</span><br><span class="line"></span><br><span class="line">[Socket]</span><br><span class="line">ListenStream=%t/cri-dockerd.sock</span><br><span class="line">SocketMode=0660</span><br><span class="line">SocketUser=root</span><br><span class="line">SocketGroup=docker</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=sockets.target</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">该配置文件是用于systemd的单元配置文件(unit file)，用于定义一个socket单元。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># [Unit]</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- Description：表示该单元的描述信息。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- PartOf：表示该单元是cri-docker.service的一部分。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># [Socket]</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- ListenStream：指定了该socket要监听的地址和端口，这里使用了%t占位符，表示根据单元的类型来决定路径。%t/cri-dockerd.sock表示将监听Unix域套接字cri-dockerd.sock。Unix域套接字用于在同一台主机上的进程之间通信。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- SocketMode：指定了socket文件的权限模式，此处为0660，即用户和用户组有读写权限，其他用户无权限。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- SocketUser：指定了socket文件的所有者，此处为root用户。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- SocketGroup：指定了socket文件的所属用户组，此处为docker用户组。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># [Install]</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- WantedBy：部分定义了该单元的安装配置信息。WantedBy=sockets.target表示当sockets.target单元启动时，自动启动该socket单元。sockets.target是一个系统服务，用于管理所有的socket单元。</span></span><br></pre></td></tr></table></figure>

<h3 id="2-2-10-启动cri-docker"><a href="#2-2-10-启动cri-docker" class="headerlink" title="2.2.10 启动cri-docker"></a>2.2.10 启动cri-docker</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">用于重新加载systemd管理的单位文件。当你新增或修改了某个单位文件（如.service文件、.socket文件等），需要运行该命令来刷新systemd对该文件的配置。</span></span><br><span class="line"></span><br><span class="line">systemctl enable --now cri-docker.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启用并立即启动cri-docker.service单元。cri-docker.service是cri-docker守护进程的systemd服务单元。</span></span><br><span class="line"></span><br><span class="line">systemctl restart cri-docker.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启cri-docker.service单元，即重新启动cri-docker守护进程。</span></span><br><span class="line"></span><br><span class="line">systemctl status docker.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">显示docker.service单元的当前状态，包括运行状态、是否启用等信息。</span></span><br></pre></td></tr></table></figure>



<h2 id="2-3-k8s与etcd下载及安装（仅在master01操作）"><a href="#2-3-k8s与etcd下载及安装（仅在master01操作）" class="headerlink" title="2.3.k8s与etcd下载及安装（仅在master01操作）"></a>2.3.k8s与etcd下载及安装（仅在master01操作）</h2><h3 id="2-3-1解压k8s安装包"><a href="#2-3-1解压k8s安装包" class="headerlink" title="2.3.1解压k8s安装包"></a>2.3.1解压k8s安装包</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载安装包</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">wget https://mirrors.chenby.cn/https://github.com/etcd-io/etcd/releases/download/v3.5.12/etcd-v3.5.12-linux-amd64.tar.gz</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">wget https://dl.k8s.io/v1.29.2/kubernetes-server-linux-amd64.tar.gz</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解压k8s安装文件</span></span><br><span class="line">cd cby</span><br><span class="line">tar -xf kubernetes-server-linux-amd64.tar.gz  --strip-components=3 -C /usr/local/bin kubernetes/server/bin/kube&#123;let,ctl,-apiserver,-controller-manager,-scheduler,-proxy&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这是一个tar命令，用于解压指定的kubernetes-server-linux-amd64.tar.gz文件，并将其中的特定文件提取到/usr/local/bin目录下。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 命令的解释如下：</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- tar：用于处理tar压缩文件的命令。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- -xf：表示解压操作。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- kubernetes-server-linux-amd64.tar.gz：要解压的文件名。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- --strip-components=3：表示解压时忽略压缩文件中的前3级目录结构，提取文件时直接放到目标目录中。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- -C /usr/local/bin：指定提取文件的目标目录为/usr/local/bin。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- kubernetes/server/bin/kube&#123;<span class="built_in">let</span>,ctl,-apiserver,-controller-manager,-scheduler,-proxy&#125;：要解压和提取的文件名模式，用花括号括起来表示模式中的多个可能的文件名。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 总的来说，这个命令的作用是将kubernetes-server-linux-amd64.tar.gz文件中的kubelet、kubectl、kube-apiserver、kube-controller-manager、kube-scheduler和kube-proxy六个文件提取到/usr/local/bin目录下，同时忽略文件路径中的前三级目录结构。</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解压etcd安装文件</span></span><br><span class="line">tar -xf etcd*.tar.gz &amp;&amp; mv etcd-*/etcd /usr/local/bin/ &amp;&amp; mv etcd-*/etcdctl /usr/local/bin/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这是一个将文件解压并移动到特定目录的命令。这是一个用于 Linux 系统中的命令。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># - tar -xf etcd*.tar.gz：这个命令将解压以 etcd 开头并以.tar.gz 结尾的文件。`-xf` 是使用 `tar` 命令的选项，它表示解压文件并展开其中的内容。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- <span class="built_in">mv</span> etcd-*/etcd /usr/local/bin/：这个命令将 etcd 文件移动到 /usr/local/bin 目录。`<span class="built_in">mv</span>` 是移动命令，它将 etcd-*/etcd 路径下的 etcd 文件移动到了 /usr/local/bin 目录。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- <span class="built_in">mv</span> etcd-*/etcdctl /usr/local/bin/：这个命令将 etcdctl 文件移动到 /usr/local/bin 目录，和上一条命令类似。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 总结起来，以上命令将从名为 etcd*.tar.gz 的压缩文件中解压出 etcd 和 etcdctl 文件，并将它们移动到 /usr/local/bin 目录中。</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看/usr/local/bin下内容</span></span><br><span class="line">ls /usr/local/bin/</span><br><span class="line">containerd               crictl       etcdctl                  kube-proxy</span><br><span class="line">containerd-shim          critest      kube-apiserver           kube-scheduler</span><br><span class="line">containerd-shim-runc-v1  ctd-decoder  kube-controller-manager</span><br><span class="line">containerd-shim-runc-v2  ctr          kubectl</span><br><span class="line">containerd-stress        etcd         kubelet</span><br></pre></td></tr></table></figure>

<h3 id="2-3-2查看版本"><a href="#2-3-2查看版本" class="headerlink" title="2.3.2查看版本"></a>2.3.2查看版本</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]#  kubelet --version</span><br><span class="line">Kubernetes v1.29.2</span><br><span class="line">[root@k8s-master01 ~]# etcdctl version</span><br><span class="line">etcdctl version: 3.5.12</span><br><span class="line">API version: 3.5</span><br><span class="line">[root@k8s-master01 ~]# </span><br></pre></td></tr></table></figure>

<h3 id="2-3-3将组件发送至其他k8s节点"><a href="#2-3-3将组件发送至其他k8s节点" class="headerlink" title="2.3.3将组件发送至其他k8s节点"></a>2.3.3将组件发送至其他k8s节点</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Master=&#x27;k8s-master02 k8s-master03&#x27;</span><br><span class="line">Work=&#x27;k8s-node01 k8s-node02&#x27;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拷贝master组件</span></span><br><span class="line">for NODE in $Master; do echo $NODE; scp /usr/local/bin/kube&#123;let,ctl,-apiserver,-controller-manager,-scheduler,-proxy&#125; $NODE:/usr/local/bin/; scp /usr/local/bin/etcd* $NODE:/usr/local/bin/; done</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">该命令是一个<span class="keyword">for</span>循环，对于在<span class="variable">$Master</span>变量中的每个节点，执行以下操作：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 1. 打印出节点的名称。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2. 使用scp命令将/usr/local/bin/kubelet、kubectl、kube-apiserver、kube-controller-manager、kube-scheduler和kube-proxy文件复制到节点的/usr/local/bin/目录下。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">3. 使用scp命令将/usr/local/bin/etcd*文件复制到节点的/usr/local/bin/目录下。</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拷贝work组件</span></span><br><span class="line">for NODE in $Work; do echo $NODE; scp /usr/local/bin/kube&#123;let,-proxy&#125; $NODE:/usr/local/bin/ ; done</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">该命令是一个<span class="keyword">for</span>循环，对于在<span class="variable">$Master</span>变量中的每个节点，执行以下操作：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 1. 打印出节点的名称。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2. 使用scp命令将/usr/local/bin/kubelet和kube-proxy文件复制到节点的/usr/local/bin/目录下。</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">所有节点执行</span></span><br><span class="line">mkdir -p /opt/cni/bin</span><br></pre></td></tr></table></figure>

<h2 id="2-3创建证书相关文件"><a href="#2-3创建证书相关文件" class="headerlink" title="2.3创建证书相关文件"></a>2.3创建证书相关文件</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">请查看Github仓库 或者进行获取已经打好的包</span></span><br><span class="line">https://github.com/cby-chen/Kubernetes/</span><br><span class="line">https://github.com/cby-chen/Kubernetes/tags</span><br><span class="line">https://github.com/cby-chen/Kubernetes/releases/download/v1.29.2/kubernetes-v1.29.2.tar</span><br></pre></td></tr></table></figure>

<h1 id="3-相关证书生成"><a href="#3-相关证书生成" class="headerlink" title="3.相关证书生成"></a>3.相关证书生成</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">master01节点下载证书生成工具</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">wget <span class="string">&quot;https://mirrors.chenby.cn/https://github.com/cloudflare/cfssl/releases/download/v1.6.4/cfssl_1.6.4_linux_amd64&quot;</span> -O /usr/local/bin/cfssl</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">wget <span class="string">&quot;https://mirrors.chenby.cn/https://github.com/cloudflare/cfssl/releases/download/v1.6.4/cfssljson_1.6.4_linux_amd64&quot;</span> -O /usr/local/bin/cfssljson</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">软件包内有</span></span><br><span class="line">cp cfssl_*_linux_amd64 /usr/local/bin/cfssl</span><br><span class="line">cp cfssljson_*_linux_amd64 /usr/local/bin/cfssljson</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加执行权限</span></span><br><span class="line">chmod +x /usr/local/bin/cfssl /usr/local/bin/cfssljson</span><br></pre></td></tr></table></figure>

<h2 id="3-1-生成etcd证书"><a href="#3-1-生成etcd证书" class="headerlink" title="3.1.生成etcd证书"></a>3.1.生成etcd证书</h2><p>特别说明除外，以下操作在所有master节点操作</p>
<h3 id="3-1-1所有master节点创建证书存放目录"><a href="#3-1-1所有master节点创建证书存放目录" class="headerlink" title="3.1.1所有master节点创建证书存放目录"></a>3.1.1所有master节点创建证书存放目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir /etc/etcd/ssl -p</span><br></pre></td></tr></table></figure>

<h3 id="3-1-2master01节点生成etcd证书"><a href="#3-1-2master01节点生成etcd证书" class="headerlink" title="3.1.2master01节点生成etcd证书"></a>3.1.2master01节点生成etcd证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">写入生成证书所需的配置文件</span></span><br><span class="line">cat &gt; ca-config.json &lt;&lt; EOF </span><br><span class="line">&#123;</span><br><span class="line">  &quot;signing&quot;: &#123;</span><br><span class="line">    &quot;default&quot;: &#123;</span><br><span class="line">      &quot;expiry&quot;: &quot;876000h&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;profiles&quot;: &#123;</span><br><span class="line">      &quot;kubernetes&quot;: &#123;</span><br><span class="line">        &quot;usages&quot;: [</span><br><span class="line">            &quot;signing&quot;,</span><br><span class="line">            &quot;key encipherment&quot;,</span><br><span class="line">            &quot;server auth&quot;,</span><br><span class="line">            &quot;client auth&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;expiry&quot;: &quot;876000h&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这段配置文件是用于配置加密和认证签名的一些参数。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 在这里，有两个部分：`signing`和`profiles`。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># `signing`包含了默认签名配置和配置文件。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">默认签名配置`default`指定了证书的过期时间为`876000h`。`876000h`表示证书有效期为100年。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># `profiles`部分定义了不同的证书配置文件。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在这里，只有一个配置文件`kubernetes`。它包含了以下`usages`和过期时间`expiry`：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 1. `signing`：用于对其他证书进行签名</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2. `key encipherment`：用于加密和解密传输数据</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">3. `server auth`：用于服务器身份验证</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">4. `client auth`：用于客户端身份验证</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 对于`kubernetes`配置文件，证书的过期时间也是`876000h`，即100年。</span></span></span><br><span class="line"></span><br><span class="line">cat &gt; etcd-ca-csr.json  &lt;&lt; EOF </span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;etcd&quot;,</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;etcd&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;Etcd Security&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;ca&quot;: &#123;</span><br><span class="line">    &quot;expiry&quot;: &quot;876000h&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这是一个用于生成证书签名请求（Certificate Signing Request，CSR）的JSON配置文件。JSON配置文件指定了生成证书签名请求所需的数据。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># - &quot;CN&quot;: &quot;etcd&quot; 指定了希望生成的证书的CN字段（Common Name），即证书的主题，通常是该证书标识的实体的名称。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- <span class="string">&quot;key&quot;</span>: &#123;&#125; 指定了生成证书所使用的密钥的配置信息。<span class="string">&quot;algo&quot;</span>: <span class="string">&quot;rsa&quot;</span> 指定了密钥的算法为RSA，<span class="string">&quot;size&quot;</span>: 2048 指定了密钥的长度为2048位。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- <span class="string">&quot;names&quot;</span>: [] 包含了生成证书时所需的实体信息。在这个例子中，只包含了一个实体，其相关信息如下：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - <span class="string">&quot;C&quot;</span>: <span class="string">&quot;CN&quot;</span> 指定了实体的国家/地区代码，这里是中国。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - <span class="string">&quot;ST&quot;</span>: <span class="string">&quot;Beijing&quot;</span> 指定了实体所在的省/州。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - <span class="string">&quot;L&quot;</span>: <span class="string">&quot;Beijing&quot;</span> 指定了实体所在的城市。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - <span class="string">&quot;O&quot;</span>: <span class="string">&quot;etcd&quot;</span> 指定了实体的组织名称。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - <span class="string">&quot;OU&quot;</span>: <span class="string">&quot;Etcd Security&quot;</span> 指定了实体所属的组织单位。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- <span class="string">&quot;ca&quot;</span>: &#123;&#125; 指定了生成证书时所需的CA（Certificate Authority）配置信息。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - <span class="string">&quot;expiry&quot;</span>: <span class="string">&quot;876000h&quot;</span> 指定了证书的有效期，这里是876000小时。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 生成证书签名请求时，可以使用这个JSON配置文件作为输入，根据配置文件中的信息生成相应的CSR文件。然后，可以将CSR文件发送给CA进行签名，以获得有效的证书。</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成etcd证书和etcd证书的key（如果你觉得以后可能会扩容，可以在ip那多写几个预留出来）</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">若没有IPv6 可删除可保留</span> </span><br><span class="line"></span><br><span class="line">cfssl gencert -initca etcd-ca-csr.json | cfssljson -bare /etc/etcd/ssl/etcd-ca</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">具体的解释如下：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># cfssl是一个用于生成TLS/SSL证书的工具，它支持PKI、JSON格式配置文件以及与许多其他集成工具的配合使用。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># gencert参数表示生成证书的操作。-initca参数表示初始化一个CA（证书颁发机构）。CA是用于签发其他证书的根证书。etcd-ca-csr.json是一个JSON格式的配置文件，其中包含了CA的详细信息，如私钥、公钥、有效期等。这个文件提供了生成CA证书所需的信息。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># | 符号表示将上一个命令的输出作为下一个命令的输入。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># cfssljson是cfssl工具的一个子命令，用于格式化cfssl生成的JSON数据。 -bare参数表示直接输出裸证书，即只生成证书文件，不包含其他格式的文件。/etc/etcd/ssl/etcd-ca是指定生成的证书文件的路径和名称。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 所以，这条命令的含义是使用cfssl工具根据配置文件ca-csr.json生成一个CA证书，并将证书文件保存在/etc/etcd/ssl/etcd-ca路径下。</span></span></span><br><span class="line"></span><br><span class="line">cat &gt; etcd-csr.json &lt;&lt; EOF </span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;etcd&quot;,</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;etcd&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;Etcd Security&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这段代码是一个JSON格式的配置文件，用于生成一个证书签名请求（Certificate Signing Request，CSR）。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 首先，&quot;CN&quot;字段指定了该证书的通用名称（Common Name），这里设为&quot;etcd&quot;。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 接下来，&quot;key&quot;字段指定了密钥的算法（&quot;algo&quot;字段）和长度（&quot;size&quot;字段），此处使用的是RSA算法，密钥长度为2048位。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 最后，&quot;names&quot;字段是一个数组，其中包含了一个名字对象，用于指定证书中的一些其他信息。这个名字对象包含了以下字段：</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- <span class="string">&quot;C&quot;</span>字段指定了国家代码（Country），这里设置为<span class="string">&quot;CN&quot;</span>。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- <span class="string">&quot;ST&quot;</span>字段指定了省份（State）或地区，这里设置为<span class="string">&quot;Beijing&quot;</span>。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- <span class="string">&quot;L&quot;</span>字段指定了城市（Locality），这里设置为<span class="string">&quot;Beijing&quot;</span>。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- <span class="string">&quot;O&quot;</span>字段指定了组织（Organization），这里设置为<span class="string">&quot;etcd&quot;</span>。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- <span class="string">&quot;OU&quot;</span>字段指定了组织单元（Organizational Unit），这里设置为<span class="string">&quot;Etcd Security&quot;</span>。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 这些字段将作为证书的一部分，用于标识和验证证书的使用范围和颁发者等信息。</span></span></span><br><span class="line"></span><br><span class="line">cfssl gencert \</span><br><span class="line">   -ca=/etc/etcd/ssl/etcd-ca.pem \</span><br><span class="line">   -ca-key=/etc/etcd/ssl/etcd-ca-key.pem \</span><br><span class="line">   -config=ca-config.json \</span><br><span class="line">   -hostname=127.0.0.1,k8s-master01,k8s-master02,k8s-master03,192.168.1.31,192.168.1.32,192.168.1.33,fc00:43f4:1eea:1::10,fc00:43f4:1eea:1::20,fc00:43f4:1eea:1::30,::1 \</span><br><span class="line">   -profile=kubernetes \</span><br><span class="line">   etcd-csr.json | cfssljson -bare /etc/etcd/ssl/etcd</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这是一条使用cfssl生成etcd证书的命令，下面是各个参数的解释：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># -ca=/etc/etcd/ssl/etcd-ca.pem：指定用于签名etcd证书的CA文件的路径。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-ca-key=/etc/etcd/ssl/etcd-ca-key.pem：指定用于签名etcd证书的CA私钥文件的路径。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-config=ca-config.json：指定CA配置文件的路径，该文件定义了证书的有效期、加密算法等设置。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-hostname=xxxx：指定要为etcd生成证书的主机名和IP地址列表。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">-profile=kubernetes：指定使用的证书配置文件，该文件定义了证书的用途和扩展属性。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">etcd-csr.json：指定etcd证书请求的JSON文件的路径，该文件包含了证书请求的详细信息。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">| cfssljson -bare /etc/etcd/ssl/etcd：通过管道将cfssl命令的输出传递给cfssljson命令，并使用-bare参数指定输出文件的前缀路径，这里将生成etcd证书的.pem和-key.pem文件。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 这条命令的作用是使用指定的CA证书和私钥，根据证书请求的JSON文件和配置文件生成etcd的证书文件。</span></span></span><br></pre></td></tr></table></figure>

<h3 id="3-1-3将证书复制到其他节点"><a href="#3-1-3将证书复制到其他节点" class="headerlink" title="3.1.3将证书复制到其他节点"></a>3.1.3将证书复制到其他节点</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Master=&#x27;k8s-master02 k8s-master03&#x27;</span><br><span class="line">for NODE in $Master; do ssh $NODE &quot;mkdir -p /etc/etcd/ssl&quot;; for FILE in etcd-ca-key.pem  etcd-ca.pem  etcd-key.pem  etcd.pem; do scp /etc/etcd/ssl/$&#123;FILE&#125; $NODE:/etc/etcd/ssl/$&#123;FILE&#125;; done; done</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这个命令是一个简单的<span class="keyword">for</span>循环，在一个由`<span class="variable">$Master</span>`存储的主机列表中迭代执行。对于每个主机，它使用`ssh`命令登录到主机，并在远程主机上创建一个名为`/etc/etcd/ssl`的目录（如果不存在）。接下来，它使用`scp`将本地主机上`/etc/etcd/ssl`目录中的四个文件（`etcd-ca-key.pem`，`etcd-ca.pem`，`etcd-key.pem`和`etcd.pem`）复制到远程主机的`/etc/etcd/ssl`目录中。最终的结果是，远程主机上的`/etc/etcd/ssl`目录中包含与本地主机上相同的四个文件的副本。</span></span><br></pre></td></tr></table></figure>

<h2 id="3-2-生成k8s相关证书"><a href="#3-2-生成k8s相关证书" class="headerlink" title="3.2.生成k8s相关证书"></a>3.2.生成k8s相关证书</h2><p>特别说明除外，以下操作在所有master节点操作</p>
<h3 id="3-2-1-所有k8s节点创建证书存放目录"><a href="#3-2-1-所有k8s节点创建证书存放目录" class="headerlink" title="3.2.1 所有k8s节点创建证书存放目录"></a>3.2.1 所有k8s节点创建证书存放目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/kubernetes/pki</span><br></pre></td></tr></table></figure>

<h3 id="3-2-2-master01节点生成k8s证书"><a href="#3-2-2-master01节点生成k8s证书" class="headerlink" title="3.2.2 master01节点生成k8s证书"></a>3.2.2 master01节点生成k8s证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">写入生成证书所需的配置文件</span></span><br><span class="line">cat &gt; ca-csr.json   &lt;&lt; EOF </span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;kubernetes&quot;,</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;Kubernetes&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;Kubernetes-manual&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  &quot;ca&quot;: &#123;</span><br><span class="line">    &quot;expiry&quot;: &quot;876000h&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这是一个用于生成 Kubernetes 相关证书的配置文件。该配置文件中包含以下信息：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># - CN：CommonName，即用于标识证书的通用名称。在此配置中，CN 设置为 &quot;kubernetes&quot;，表示该证书是用于 Kubernetes。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- key：用于生成证书的算法和大小。在此配置中，使用的算法是 RSA，大小是 2048 位。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- names：用于证书中的名称字段的详细信息。在此配置中，有以下字段信息：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - C：Country，即国家。在此配置中，设置为 <span class="string">&quot;CN&quot;</span>。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - ST：State，即省/州。在此配置中，设置为 <span class="string">&quot;Beijing&quot;</span>。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - L：Locality，即城市。在此配置中，设置为 <span class="string">&quot;Beijing&quot;</span>。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - O：Organization，即组织。在此配置中，设置为 <span class="string">&quot;Kubernetes&quot;</span>。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - OU：Organization Unit，即组织单位。在此配置中，设置为 <span class="string">&quot;Kubernetes-manual&quot;</span>。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- ca：用于证书签名的证书颁发机构（CA）的配置信息。在此配置中，设置了证书的有效期为 876000 小时。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 这个配置文件可以用于生成 Kubernetes 相关的证书，以确保集群中的通信安全性。</span></span></span><br><span class="line"></span><br><span class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare /etc/kubernetes/pki/ca</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">具体的解释如下：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># cfssl是一个用于生成TLS/SSL证书的工具，它支持PKI、JSON格式配置文件以及与许多其他集成工具的配合使用。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># gencert参数表示生成证书的操作。-initca参数表示初始化一个CA（证书颁发机构）。CA是用于签发其他证书的根证书。ca-csr.json是一个JSON格式的配置文件，其中包含了CA的详细信息，如私钥、公钥、有效期等。这个文件提供了生成CA证书所需的信息。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># | 符号表示将上一个命令的输出作为下一个命令的输入。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># cfssljson是cfssl工具的一个子命令，用于格式化cfssl生成的JSON数据。 -bare参数表示直接输出裸证书，即只生成证书文件，不包含其他格式的文件。/etc/kubernetes/pki/ca是指定生成的证书文件的路径和名称。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 所以，这条命令的含义是使用cfssl工具根据配置文件ca-csr.json生成一个CA证书，并将证书文件保存在/etc/kubernetes/pki/ca路径下。</span></span></span><br><span class="line"></span><br><span class="line">cat &gt; apiserver-csr.json &lt;&lt; EOF </span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;kube-apiserver&quot;,</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;Kubernetes&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;Kubernetes-manual&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这是一个用于生成 Kubernetes 相关证书的配置文件。该配置文件中包含以下信息：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># - `CN` 字段指定了证书的通用名称 (Common Name)，这里设置为 &quot;kube-apiserver&quot;，表示该证书用于 Kubernetes API Server。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `key` 字段指定了生成证书时所选用的加密算法和密钥长度。这里选用了 RSA 算法，密钥长度为 2048 位。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `names` 字段包含了一组有关证书持有者信息的项。这里使用了以下信息：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - `C` 表示国家代码 (Country)，这里设置为 <span class="string">&quot;CN&quot;</span> 表示中国。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - `ST` 表示州或省份 (State)，这里设置为 <span class="string">&quot;Beijing&quot;</span> 表示北京市。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - `L` 表示城市或地区 (Location)，这里设置为 <span class="string">&quot;Beijing&quot;</span> 表示北京市。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - `O` 表示组织名称 (Organization)，这里设置为 <span class="string">&quot;Kubernetes&quot;</span> 表示 Kubernetes。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - `OU` 表示组织单位 (Organizational Unit)，这里设置为 <span class="string">&quot;Kubernetes-manual&quot;</span> 表示手动管理的 Kubernetes 集群。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 这个配置文件可以用于生成 Kubernetes 相关的证书，以确保集群中的通信安全性。</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成一个根证书 ，多写了一些IP作为预留IP，为将来添加node做准备</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">10.96.0.1是service网段的第一个地址，需要计算，192.168.1.36为高可用vip地址</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">若没有IPv6 可删除可保留</span> </span><br><span class="line"></span><br><span class="line">cfssl gencert   \</span><br><span class="line">-ca=/etc/kubernetes/pki/ca.pem   \</span><br><span class="line">-ca-key=/etc/kubernetes/pki/ca-key.pem   \</span><br><span class="line">-config=ca-config.json   \</span><br><span class="line">-hostname=10.96.0.1,192.168.1.36,127.0.0.1,kubernetes,kubernetes.default,kubernetes.default.svc,kubernetes.default.svc.cluster,kubernetes.default.svc.cluster.local,x.oiox.cn,k.oiox.cn,l.oiox.cn,o.oiox.cn,192.168.1.31,192.168.1.32,192.168.1.33,192.168.1.34,192.168.1.35,192.168.1.36,192.168.0.37,192.168.0.38,192.168.0.39,192.168.1.70,fc00:43f4:1eea:1::10,fc00:43f4:1eea:1::20,fc00:43f4:1eea:1::30,fc00:43f4:1eea:1::40,fc00:43f4:1eea:1::50,fc00:43f4:1eea:1::60,fc00:43f4:1eea:1::70,fc00:43f4:1eea:1::80,fc00:43f4:1eea:1::90,fc00:43f4:1eea:1::100,::1   \</span><br><span class="line">-profile=kubernetes   apiserver-csr.json | cfssljson -bare /etc/kubernetes/pki/apiserver</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这个命令是使用cfssl工具生成Kubernetes API Server的证书。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 命令的参数解释如下：</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `-ca=/etc/kubernetes/pki/ca.pem`：指定证书的颁发机构（CA）文件路径。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `-ca-key=/etc/kubernetes/pki/ca-key.pem`：指定证书的颁发机构（CA）私钥文件路径。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `-config=ca-config.json`：指定证书生成的配置文件路径，配置文件中包含了证书的有效期、加密算法等信息。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `-hostname=10.96.0.1,192.168.1.36,127.0.0.1,fc00:43f4:1eea:1::10`：指定证书的主机名或IP地址列表。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `-profile=kubernetes`：指定证书生成的配置文件中的配置文件名。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `apiserver-csr.json`：API Server的证书签名请求配置文件路径。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `| cfssljson -bare /etc/kubernetes/pki/apiserver`：通过管道将生成的证书输出到cfssljson工具，将其转换为PEM编码格式，并保存到 `/etc/kubernetes/pki/apiserver.pem` 和 `/etc/kubernetes/pki/apiserver-key.pem` 文件中。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 最终，这个命令将会生成API Server的证书和私钥，并保存到指定的文件中。</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="3-2-3-生成apiserver聚合证书"><a href="#3-2-3-生成apiserver聚合证书" class="headerlink" title="3.2.3 生成apiserver聚合证书"></a>3.2.3 生成apiserver聚合证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; front-proxy-ca-csr.json  &lt;&lt; EOF </span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;kubernetes&quot;,</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">     &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">     &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;ca&quot;: &#123;</span><br><span class="line">    &quot;expiry&quot;: &quot;876000h&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这个JSON文件表示了生成一个名为<span class="string">&quot;kubernetes&quot;</span>的证书的配置信息。这个证书是用来进行Kubernetes集群的身份验证和安全通信。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 配置信息包括以下几个部分：</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 1. &quot;CN&quot;: &quot;kubernetes&quot;：这表示了证书的通用名称（Common Name），也就是证书所代表的实体的名称。在这里，证书的通用名称被设置为&quot;kubernetes&quot;，表示这个证书是用来代表Kubernetes集群。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 2. &quot;key&quot;：这是用来生成证书的密钥相关的配置。在这里，配置使用了RSA算法，并且设置了密钥的大小为2048位。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 3. &quot;ca&quot;：这个字段指定了证书的颁发机构（Certificate Authority）相关的配置。在这里，配置指定了证书的有效期为876000小时，即100年。这意味着该证书在100年内将被视为有效，过期后需要重新生成。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 总之，这个JSON文件中的配置信息描述了如何生成一个用于Kubernetes集群的证书，包括证书的通用名称、密钥算法和大小以及证书的有效期。</span></span></span><br><span class="line"></span><br><span class="line">cfssl gencert   -initca front-proxy-ca-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-ca </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">具体的解释如下：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># cfssl是一个用于生成TLS/SSL证书的工具，它支持PKI、JSON格式配置文件以及与许多其他集成工具的配合使用。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># gencert参数表示生成证书的操作。-initca参数表示初始化一个CA（证书颁发机构）。CA是用于签发其他证书的根证书。front-proxy-ca-csr.json是一个JSON格式的配置文件，其中包含了CA的详细信息，如私钥、公钥、有效期等。这个文件提供了生成CA证书所需的信息。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># | 符号表示将上一个命令的输出作为下一个命令的输入。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># cfssljson是cfssl工具的一个子命令，用于格式化cfssl生成的JSON数据。 -bare参数表示直接输出裸证书，即只生成证书文件，不包含其他格式的文件。/etc/kubernetes/pki/front-proxy-ca是指定生成的证书文件的路径和名称。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 所以，这条命令的含义是使用cfssl工具根据配置文件ca-csr.json生成一个CA证书，并将证书文件保存在/etc/kubernetes/pki/front-proxy-ca路径下。</span></span></span><br><span class="line"></span><br><span class="line">cat &gt; front-proxy-client-csr.json  &lt;&lt; EOF </span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;front-proxy-client&quot;,</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">     &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">     &quot;size&quot;: 2048</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这是一个JSON格式的配置文件，用于描述一个名为<span class="string">&quot;front-proxy-client&quot;</span>的配置。配置包括两个字段：CN和key。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># - CN（Common Name）字段表示证书的通用名称，这里为&quot;front-proxy-client&quot;。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- key字段描述了密钥的算法和大小。<span class="string">&quot;algo&quot;</span>表示使用RSA算法，<span class="string">&quot;size&quot;</span>表示密钥大小为2048位。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 该配置文件用于生成一个SSL证书，用于在前端代理客户端进行认证和数据传输的加密。这个证书中的通用名称是&quot;front-proxy-client&quot;，使用RSA算法生成，密钥大小为2048位。</span></span></span><br><span class="line"></span><br><span class="line">cfssl gencert  \</span><br><span class="line">-ca=/etc/kubernetes/pki/front-proxy-ca.pem   \</span><br><span class="line">-ca-key=/etc/kubernetes/pki/front-proxy-ca-key.pem   \</span><br><span class="line">-config=ca-config.json   \</span><br><span class="line">-profile=kubernetes   front-proxy-client-csr.json | cfssljson -bare /etc/kubernetes/pki/front-proxy-client</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这个命令使用cfssl工具生成一个用于Kubernetes的front-proxy-client证书。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 主要参数解释如下：</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `-ca=/etc/kubernetes/pki/front-proxy-ca.pem`: 指定用于签署证书的根证书文件路径。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `-ca-key=/etc/kubernetes/pki/front-proxy-ca-key.pem`: 指定用于签署证书的根证书的私钥文件路径。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `-config=ca-config.json`: 指定用于配置证书签署的配置文件路径。该配置文件描述了证书生成的一些规则，如加密算法和有效期等。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `-profile=kubernetes`: 指定生成证书时使用的配置文件中定义的profile，其中包含了一些默认的参数。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `front-proxy-client-csr.json`: 指定用于生成证书的CSR文件路径，该文件包含了证书请求的相关信息。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `| cfssljson -bare /etc/kubernetes/pki/front-proxy-client`: 通过管道将生成的证书输出到cfssljson工具进行解析，并通过`-bare`参数将证书和私钥分别保存到指定路径。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 这个命令的作用是根据提供的CSR文件和配置信息，使用指定的根证书和私钥生成一个前端代理客户端的证书，并将证书和私钥分别保存到`/etc/kubernetes/pki/front-proxy-client.pem`和`/etc/kubernetes/pki/front-proxy-client-key.pem`文件中。</span></span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-4-生成controller-manage的证书"><a href="#3-2-4-生成controller-manage的证书" class="headerlink" title="3.2.4 生成controller-manage的证书"></a>3.2.4 生成controller-manage的证书</h3><p>在《5.高可用配置》选择使用那种高可用方案<br>若使用 haproxy、keepalived 那么为 <code>--server=https://192.168.1.36:9443</code><br>若使用 nginx方案，那么为 <code>--server=https://127.0.0.1:8443</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; manager-csr.json &lt;&lt; EOF </span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;system:kube-controller-manager&quot;,</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;system:kube-controller-manager&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;Kubernetes-manual&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这是一个用于生成密钥对（公钥和私钥）的JSON配置文件。下面是针对该文件中每个字段的详细解释：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># - &quot;CN&quot;: 值为&quot;system:kube-controller-manager&quot;，代表通用名称（Common Name），是此密钥对的主题（subject）。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- <span class="string">&quot;key&quot;</span>: 这个字段用来定义密钥算法和大小。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - <span class="string">&quot;algo&quot;</span>: 值为<span class="string">&quot;rsa&quot;</span>，表示使用RSA算法。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - <span class="string">&quot;size&quot;</span>: 值为2048，表示生成的密钥大小为2048位。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- <span class="string">&quot;names&quot;</span>: 这个字段用来定义密钥对的各个名称字段。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - <span class="string">&quot;C&quot;</span>: 值为<span class="string">&quot;CN&quot;</span>，表示国家（Country）名称是<span class="string">&quot;CN&quot;</span>（中国）。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - <span class="string">&quot;ST&quot;</span>: 值为<span class="string">&quot;Beijing&quot;</span>，表示省/州（State/Province）名称是<span class="string">&quot;Beijing&quot;</span>（北京）。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - <span class="string">&quot;L&quot;</span>: 值为<span class="string">&quot;Beijing&quot;</span>，表示城市（Locality）名称是<span class="string">&quot;Beijing&quot;</span>（北京）。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - <span class="string">&quot;O&quot;</span>: 值为<span class="string">&quot;system:kube-controller-manager&quot;</span>，表示组织（Organization）名称是<span class="string">&quot;system:kube-controller-manager&quot;</span>。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - <span class="string">&quot;OU&quot;</span>: 值为<span class="string">&quot;Kubernetes-manual&quot;</span>，表示组织单位（Organizational Unit）名称是<span class="string">&quot;Kubernetes-manual&quot;</span>。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 这个JSON配置文件基本上是告诉生成密钥对的工具，生成一个带有特定名称和属性的密钥对。</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cfssl gencert \</span><br><span class="line">   -ca=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">   -ca-key=/etc/kubernetes/pki/ca-key.pem \</span><br><span class="line">   -config=ca-config.json \</span><br><span class="line">   -profile=kubernetes \</span><br><span class="line">   manager-csr.json | cfssljson -bare /etc/kubernetes/pki/controller-manager</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这是一个命令行操作，使用cfssl工具生成证书。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 1. `cfssl gencert` 是cfssl工具的命令，用于生成证书。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2. `-ca` 指定根证书的路径和文件名，这里是`/etc/kubernetes/pki/ca.pem`。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">3. `-ca-key` 指定根证书的私钥的路径和文件名，这里是`/etc/kubernetes/pki/ca-key.pem`。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">4. `-config` 指定配置文件的路径和文件名，这里是`ca-config.json`。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">5. `-profile` 指定证书使用的配置文件中的配置模板，这里是`kubernetes`。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">6. `manager-csr.json` 是证书签发请求的配置文件，用于生成证书签发请求。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">7. `|` 管道操作符，将前一条命令的输出作为后一条命令的输入。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">8. `cfssljson -bare` 是 cfssl 工具的命令，作用是将证书签发请求的输出转换为PKCS＃1、PKCS＃8和x509 PEM文件。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">9. `/etc/kubernetes/pki/controller-manager` 是转换后的 PEM 文件的存储位置和文件名。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 这个命令的作用是根据根证书和私钥、配置文件以及证书签发请求的配置文件，生成经过签发的控制器管理器证书和私钥，并将转换后的 PEM 文件保存到指定的位置。</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置一个集群项</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在《5.高可用配置》选择使用那种高可用方案</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">若使用 haproxy、keepalived 那么为 `--server=https://192.168.1.36:9443`</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">若使用 nginx方案，那么为 `--server=https://127.0.0.1:8443`</span></span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">     --certificate-authority=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">     --embed-certs=true \</span><br><span class="line">     --server=https://127.0.0.1:8443 \</span><br><span class="line">     --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl config set-cluster命令用于配置集群信息。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--certificate-authority选项指定了集群的证书颁发机构（CA）的路径，这个CA会验证kube-apiserver提供的证书是否合法。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--embed-certs选项用于将证书嵌入到生成的kubeconfig文件中，这样就不需要在kubeconfig文件中单独指定证书文件路径。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--server选项指定了kube-apiserver的地址，这里使用的是127.0.0.1:8443，表示使用本地主机上的kube-apiserver，默认端口为8443。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--kubeconfig选项指定了生成的kubeconfig文件的路径和名称，这里指定为/etc/kubernetes/controller-manager.kubeconfig。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">综上所述，kubectl config set-cluster命令的作用是在kubeconfig文件中设置集群信息，包括证书颁发机构、证书、kube-apiserver地址等。</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置一个环境项，一个上下文</span></span><br><span class="line">kubectl config set-context system:kube-controller-manager@kubernetes \</span><br><span class="line">    --cluster=kubernetes \</span><br><span class="line">    --user=system:kube-controller-manager \</span><br><span class="line">    --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这个命令用于配置 Kubernetes 控制器管理器的上下文信息。下面是各个参数的详细解释：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">1. `kubectl config set-context system:kube-controller-manager@kubernetes`: 设置上下文的名称为 `system:kube-controller-manager@kubernetes`，这是一个标识符，用于唯一标识该上下文。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2. `--cluster=kubernetes`: 指定集群的名称为 `kubernetes`，这是一个现有集群的标识符，表示要管理的 Kubernetes 集群。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">3. `--user=system:kube-controller-manager`: 指定使用的用户身份为 `system:kube-controller-manager`。这是一个特殊的用户身份，具有控制 Kubernetes 控制器管理器的权限。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">4. `--kubeconfig=/etc/kubernetes/controller-manager.kubeconfig`: 指定 kubeconfig 文件的路径为 `/etc/kubernetes/controller-manager.kubeconfig`。kubeconfig 文件是一个用于管理 Kubernetes 配置的文件，包含了集群、用户和上下文的相关信息。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过运行这个命令，可以将这些配置信息保存到 `/etc/kubernetes/controller-manager.kubeconfig` 文件中，以便在后续的操作中使用。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">设置一个用户项</span></span><br><span class="line">  kubectl config set-credentials system:kube-controller-manager \</span><br><span class="line">       --client-certificate=/etc/kubernetes/pki/controller-manager.pem \</span><br><span class="line">       --client-key=/etc/kubernetes/pki/controller-manager-key.pem \</span><br><span class="line">       --embed-certs=true \</span><br><span class="line">       --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">上述命令是用于设置 Kubernetes 的 controller-manager 组件的客户端凭据。下面是每个参数的详细解释：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># - `kubectl config`: 是使用 kubectl 命令行工具的配置子命令。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `set-credentials`: 是定义一个新的用户凭据配置的子命令。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `system:kube-controller-manager`: 是设置用户凭据的名称，`system:` 是 Kubernetes API Server 内置的身份验证器使用的用户标识符前缀，它表示是一个系统用户，在本例中是 kube-controller-manager 组件使用的身份。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `--client-certificate=/etc/kubernetes/pki/controller-manager.pem`: 指定 controller-manager.pem 客户端证书的路径。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `--client-key=/etc/kubernetes/pki/controller-manager-key.pem`: 指定 controller-manager-key.pem 客户端私钥的路径。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `--embed-certs=<span class="literal">true</span>`: 表示将证书和私钥直接嵌入到生成的 kubeconfig 文件中，而不是通过引用外部文件。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `--kubeconfig=/etc/kubernetes/controller-manager.kubeconfig`: 指定生成的 kubeconfig 文件的路径和文件名，即 controller-manager.kubeconfig。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 通过运行上述命令，将根据提供的证书和私钥信息，为 kube-controller-manager 创建一个 kubeconfig 文件，以便后续使用该文件进行身份验证和访问 Kubernetes API。</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置默认环境</span></span><br><span class="line">kubectl config use-context system:kube-controller-manager@kubernetes \</span><br><span class="line">     --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这个命令是用来指定kubectl使用指定的上下文环境来执行操作。上下文环境是kubectl用来确定要连接到哪个Kubernetes集群以及使用哪个身份验证信息的配置。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 在这个命令中，`kubectl config use-context`是用来设置当前上下文环境的命令。 `system:kube-controller-manager@kubernetes`是指定的上下文名称，它告诉kubectl要使用的Kubernetes集群和身份验证信息。</span></span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">`--kubeconfig=/etc/kubernetes/controller-manager.kubeconfig`是用来指定使用的kubeconfig文件的路径。kubeconfig文件是存储集群连接和身份验证信息的配置文件。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过执行这个命令，kubectl将使用指定的上下文来执行后续的操作，包括部署和管理Kubernetes资源。</span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-5-生成kube-scheduler的证书"><a href="#3-2-5-生成kube-scheduler的证书" class="headerlink" title="3.2.5 生成kube-scheduler的证书"></a>3.2.5 生成kube-scheduler的证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; scheduler-csr.json &lt;&lt; EOF </span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;system:kube-scheduler&quot;,</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;system:kube-scheduler&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;Kubernetes-manual&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这个命令是用来创建一个叫做scheduler-csr.json的文件，并将其中的内容赋值给该文件。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 文件内容是一个JSON格式的文本，包含了一个描述证书请求的结构。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 具体内容如下：</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># - &quot;CN&quot;: &quot;system:kube-scheduler&quot;：Common Name字段，表示该证书的名称为system:kube-scheduler。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- <span class="string">&quot;key&quot;</span>: &#123;<span class="string">&quot;algo&quot;</span>: <span class="string">&quot;rsa&quot;</span>, <span class="string">&quot;size&quot;</span>: 2048&#125;：key字段指定生成证书时使用的加密算法是RSA，并且密钥的长度为2048位。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- <span class="string">&quot;names&quot;</span>: [...]：names字段定义了证书中的另外一些标识信息。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- <span class="string">&quot;C&quot;</span>: <span class="string">&quot;CN&quot;</span>：Country字段，表示国家/地区为中国。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- <span class="string">&quot;ST&quot;</span>: <span class="string">&quot;Beijing&quot;</span>：State字段，表示省/市为北京。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- <span class="string">&quot;L&quot;</span>: <span class="string">&quot;Beijing&quot;</span>：Locality字段，表示所在城市为北京。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- <span class="string">&quot;O&quot;</span>: <span class="string">&quot;system:kube-scheduler&quot;</span>：Organization字段，表示组织为system:kube-scheduler。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- <span class="string">&quot;OU&quot;</span>: <span class="string">&quot;Kubernetes-manual&quot;</span>：Organizational Unit字段，表示组织单元为Kubernetes-manual。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 而EOF是一个占位符，用于标记开始和结束的位置。在开始的EOF之后到结束的EOF之间的内容将会被写入到scheduler-csr.json文件中。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 总体来说，这个命令用于生成一个描述kube-scheduler证书请求的JSON文件。</span></span></span><br><span class="line"></span><br><span class="line">cfssl gencert \</span><br><span class="line">   -ca=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">   -ca-key=/etc/kubernetes/pki/ca-key.pem \</span><br><span class="line">   -config=ca-config.json \</span><br><span class="line">   -profile=kubernetes \</span><br><span class="line">   scheduler-csr.json | cfssljson -bare /etc/kubernetes/pki/scheduler</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">上述命令是使用cfssl工具生成Kubernetes Scheduler的证书。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 具体解释如下：</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 1. `cfssl gencert`：使用cfssl工具生成证书。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2. `-ca=/etc/kubernetes/pki/ca.pem`：指定根证书文件的路径。在这里，是指定根证书的路径为`/etc/kubernetes/pki/ca.pem`。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">3. `-ca-key=/etc/kubernetes/pki/ca-key.pem`：指定根证书私钥文件的路径。在这里，是指定根证书私钥的路径为`/etc/kubernetes/pki/ca-key.pem`。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">4. `-config=ca-config.json`：指定证书配置文件的路径。在这里，是指定证书配置文件的路径为`ca-config.json`。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">5. `-profile=kubernetes`：指定证书的配置文件中的一个配置文件模板。在这里，是指定配置文件中的`kubernetes`配置模板。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">6. `scheduler-csr.json`：指定Scheduler的证书签名请求文件（CSR）的路径。在这里，是指定请求文件的路径为`scheduler-csr.json`。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">7. `|`（管道符号）：将前一个命令的输出作为下一个命令的输入。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">8. `cfssljson`：将cfssl工具生成的证书签名请求(CSR)进行解析。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">9. `-bare /etc/kubernetes/pki/scheduler`：指定输出路径和前缀。在这里，是将解析的证书签名请求生成以下文件：`/etc/kubernetes/pki/scheduler.pem`（包含了证书）、`/etc/kubernetes/pki/scheduler-key.pem`（包含了私钥）。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 总结来说，这个命令的目的是根据根证书、根证书私钥、证书配置文件、CSR文件等生成Kubernetes Scheduler的证书和私钥文件。</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在《5.高可用配置》选择使用那种高可用方案</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">若使用 haproxy、keepalived 那么为 `--server=https://192.168.1.36:9443`</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">若使用 nginx方案，那么为 `--server=https://127.0.0.1:8443`</span></span><br><span class="line"></span><br><span class="line">kubectl config set-cluster kubernetes \</span><br><span class="line">     --certificate-authority=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">     --embed-certs=true \</span><br><span class="line">     --server=https://127.0.0.1:8443 \</span><br><span class="line">     --kubeconfig=/etc/kubernetes/scheduler.kubeconfig</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">该命令用于配置一个名为<span class="string">&quot;kubernetes&quot;</span>的集群，并将其应用到/etc/kubernetes/scheduler.kubeconfig文件中。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 该命令的解释如下：</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `kubectl config set-cluster kubernetes`: 设置一个集群并命名为<span class="string">&quot;kubernetes&quot;</span>。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `--certificate-authority=/etc/kubernetes/pki/ca.pem`: 指定集群使用的证书授权机构的路径。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `--embed-certs=<span class="literal">true</span>`: 该标志指示将证书嵌入到生成的kubeconfig文件中。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `--server=https://127.0.0.1:8443`: 指定集群的 API server 位置。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `--kubeconfig=/etc/kubernetes/scheduler.kubeconfig`: 指定要保存 kubeconfig 文件的路径和名称。</span></span><br><span class="line"></span><br><span class="line">kubectl config set-credentials system:kube-scheduler \</span><br><span class="line">     --client-certificate=/etc/kubernetes/pki/scheduler.pem \</span><br><span class="line">     --client-key=/etc/kubernetes/pki/scheduler-key.pem \</span><br><span class="line">     --embed-certs=true \</span><br><span class="line">     --kubeconfig=/etc/kubernetes/scheduler.kubeconfig</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这段命令是用于设置 kube-scheduler 组件的身份验证凭据，并生成相应的 kubeconfig 文件。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 解释每个选项的含义如下：</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `kubectl config set-credentials system:kube-scheduler`：设置 `system:kube-scheduler` 用户的身份验证凭据。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `--client-certificate=/etc/kubernetes/pki/scheduler.pem`：指定一个客户端证书文件，用于基于证书的身份验证。在这种情况下，指定了 kube-scheduler 组件的证书文件路径。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `--client-key=/etc/kubernetes/pki/scheduler-key.pem`：指定与客户端证书相对应的客户端私钥文件。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `--embed-certs=<span class="literal">true</span>`：将客户端证书和私钥嵌入到生成的 kubeconfig 文件中。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `--kubeconfig=/etc/kubernetes/scheduler.kubeconfig`：指定生成的 kubeconfig 文件的路径和名称。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 该命令的目的是为 kube-scheduler 组件生成一个 kubeconfig 文件，以便进行身份验证和访问集群资源。kubeconfig 文件是一个包含了连接到 Kubernetes 集群所需的所有配置信息的文件，包括服务器地址、证书和秘钥等。</span></span></span><br><span class="line"></span><br><span class="line">kubectl config set-context system:kube-scheduler@kubernetes \</span><br><span class="line">     --cluster=kubernetes \</span><br><span class="line">     --user=system:kube-scheduler \</span><br><span class="line">     --kubeconfig=/etc/kubernetes/scheduler.kubeconfig</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">该命令用于设置一个名为<span class="string">&quot;system:kube-scheduler@kubernetes&quot;</span>的上下文，具体配置如下：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 1. --cluster=kubernetes: 指定集群的名称为&quot;kubernetes&quot;，这个集群是在当前的kubeconfig文件中已经定义好的。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2. --user=system:kube-scheduler: 指定用户的名称为<span class="string">&quot;system:kube-scheduler&quot;</span>，这个用户也是在当前的kubeconfig文件中已经定义好的。这个用户用于认证和授权kube-scheduler组件访问Kubernetes集群的权限。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">3. --kubeconfig=/etc/kubernetes/scheduler.kubeconfig: 指定kubeconfig文件的路径为<span class="string">&quot;/etc/kubernetes/scheduler.kubeconfig&quot;</span>，这个文件将被用来保存上下文的配置信息。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 这个命令的作用是将上述的配置信息保存到指定的kubeconfig文件中，以便后续使用该文件进行认证和授权访问Kubernetes集群。</span></span></span><br><span class="line"></span><br><span class="line">kubectl config use-context system:kube-scheduler@kubernetes \</span><br><span class="line">     --kubeconfig=/etc/kubernetes/scheduler.kubeconfig</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">上述命令是使用`kubectl`命令来配置Kubernetes集群中的调度器组件。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># `kubectl config use-context`命令用于切换`kubectl`当前使用的上下文。上下文是Kubernetes集群、用户和命名空间的组合，用于确定`kubectl`的连接目标。下面解释这个命令的不同部分：</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># - `system:kube-scheduler@kubernetes`是一个上下文名称。它指定了使用`kube-scheduler`用户和`kubernetes`命名空间的系统级别上下文。系统级别上下文用于操作Kubernetes核心组件。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># - `--kubeconfig=/etc/kubernetes/scheduler.kubeconfig`用于指定Kubernetes配置文件的路径。Kubernetes配置文件包含连接到Kubernetes集群所需的身份验证和连接信息。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 通过运行以上命令，`kubectl`将使用指定的上下文和配置文件，以便在以后的命令中能正确地与Kubernetes集群中的调度器组件进行交互。</span></span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-6-生成admin的证书配置"><a href="#3-2-6-生成admin的证书配置" class="headerlink" title="3.2.6 生成admin的证书配置"></a>3.2.6 生成admin的证书配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; admin-csr.json &lt;&lt; EOF </span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;admin&quot;,</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;system:masters&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;Kubernetes-manual&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这段代码是一个JSON格式的配置文件，用于创建和配置一个名为<span class="string">&quot;admin&quot;</span>的Kubernetes凭证。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 这个凭证包含以下字段：</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># - &quot;CN&quot;: &quot;admin&quot;: 这是凭证的通用名称，表示这是一个管理员凭证。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- <span class="string">&quot;key&quot;</span>: 这是一个包含证书密钥相关信息的对象。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - <span class="string">&quot;algo&quot;</span>: <span class="string">&quot;rsa&quot;</span>：这是使用的加密算法类型，这里是RSA加密算法。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - <span class="string">&quot;size&quot;</span>: 2048：这是密钥的大小，这里是2048位。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- <span class="string">&quot;names&quot;</span>: 这是一个包含证书名称信息的数组。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - <span class="string">&quot;C&quot;</span>: <span class="string">&quot;CN&quot;</span>：这是证书的国家/地区字段，这里是中国。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - <span class="string">&quot;ST&quot;</span>: <span class="string">&quot;Beijing&quot;</span>：这是证书的省/州字段，这里是北京。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - <span class="string">&quot;L&quot;</span>: <span class="string">&quot;Beijing&quot;</span>：这是证书的城市字段，这里是北京。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - <span class="string">&quot;O&quot;</span>: <span class="string">&quot;system:masters&quot;</span>：这是证书的组织字段，这里是system:masters，表示系统的管理员组。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - <span class="string">&quot;OU&quot;</span>: <span class="string">&quot;Kubernetes-manual&quot;</span>：这是证书的部门字段，这里是Kubernetes-manual。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 通过这个配置文件创建的凭证将具有管理员权限，并且可以用于管理Kubernetes集群。</span></span></span><br><span class="line"></span><br><span class="line">cfssl gencert \</span><br><span class="line">   -ca=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">   -ca-key=/etc/kubernetes/pki/ca-key.pem \</span><br><span class="line">   -config=ca-config.json \</span><br><span class="line">   -profile=kubernetes \</span><br><span class="line">   admin-csr.json | cfssljson -bare /etc/kubernetes/pki/admin</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">上述命令是使用cfssl工具生成Kubernetes admin的证书。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 具体解释如下：</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 1. `cfssl gencert`：使用cfssl工具生成证书。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2. `-ca=/etc/kubernetes/pki/ca.pem`：指定根证书文件的路径。在这里，是指定根证书的路径为`/etc/kubernetes/pki/ca.pem`。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">3. `-ca-key=/etc/kubernetes/pki/ca-key.pem`：指定根证书私钥文件的路径。在这里，是指定根证书私钥的路径为`/etc/kubernetes/pki/ca-key.pem`。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">4. `-config=ca-config.json`：指定证书配置文件的路径。在这里，是指定证书配置文件的路径为`ca-config.json`。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">5. `-profile=kubernetes`：指定证书的配置文件中的一个配置文件模板。在这里，是指定配置文件中的`kubernetes`配置模板。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">6. `admin-csr.json`：指定admin的证书签名请求文件（CSR）的路径。在这里，是指定请求文件的路径为`admin-csr.json`。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">7. `|`（管道符号）：将前一个命令的输出作为下一个命令的输入。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">8. `cfssljson`：将cfssl工具生成的证书签名请求(CSR)进行解析。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">9. `-bare /etc/kubernetes/pki/admin`：指定输出路径和前缀。在这里，是将解析的证书签名请求生成以下文件：`/etc/kubernetes/pki/admin.pem`（包含了证书）、`/etc/kubernetes/pki/admin-key.pem`（包含了私钥）。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 总结来说，这个命令的目的是根据根证书、根证书私钥、证书配置文件、CSR文件等生成Kubernetes Scheduler的证书和私钥文件。</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在《5.高可用配置》选择使用那种高可用方案</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">若使用 haproxy、keepalived 那么为 `--server=https://192.168.1.36:9443`</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">若使用 nginx方案，那么为 `--server=https://127.0.0.1:8443`</span></span><br><span class="line"></span><br><span class="line">kubectl config set-cluster kubernetes     \</span><br><span class="line">  --certificate-authority=/etc/kubernetes/pki/ca.pem     \</span><br><span class="line">  --embed-certs=true     \</span><br><span class="line">  --server=https://127.0.0.1:8443     \</span><br><span class="line">  --kubeconfig=/etc/kubernetes/admin.kubeconfig</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">该命令用于配置一个名为<span class="string">&quot;kubernetes&quot;</span>的集群，并将其应用到/etc/kubernetes/scheduler.kubeconfig文件中。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 该命令的解释如下：</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `kubectl config set-cluster kubernetes`: 设置一个集群并命名为<span class="string">&quot;kubernetes&quot;</span>。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `--certificate-authority=/etc/kubernetes/pki/ca.pem`: 指定集群使用的证书授权机构的路径。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `--embed-certs=<span class="literal">true</span>`: 该标志指示将证书嵌入到生成的kubeconfig文件中。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `--server=https://127.0.0.1:8443`: 指定集群的 API server 位置。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `--kubeconfig=/etc/kubernetes/admin.kubeconfig`: 指定要保存 kubeconfig 文件的路径和名称。</span></span><br><span class="line"></span><br><span class="line">kubectl config set-credentials kubernetes-admin  \</span><br><span class="line">  --client-certificate=/etc/kubernetes/pki/admin.pem     \</span><br><span class="line">  --client-key=/etc/kubernetes/pki/admin-key.pem     \</span><br><span class="line">  --embed-certs=true     \</span><br><span class="line">  --kubeconfig=/etc/kubernetes/admin.kubeconfig</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这段命令是用于设置 kubernetes-admin 组件的身份验证凭据，并生成相应的 kubeconfig 文件。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 解释每个选项的含义如下：</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `kubectl config set-credentials kubernetes-admin`：设置 `kubernetes-admin` 用户的身份验证凭据。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `--client-certificate=/etc/kubernetes/pki/admin.pem`：指定一个客户端证书文件，用于基于证书的身份验证。在这种情况下，指定了 admin 组件的证书文件路径。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `--client-key=/etc/kubernetes/pki/admin-key.pem`：指定与客户端证书相对应的客户端私钥文件。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `--embed-certs=<span class="literal">true</span>`：将客户端证书和私钥嵌入到生成的 kubeconfig 文件中。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `--kubeconfig=/etc/kubernetes/admin.kubeconfig`：指定生成的 kubeconfig 文件的路径和名称。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 该命令的目的是为 admin 组件生成一个 kubeconfig 文件，以便进行身份验证和访问集群资源。kubeconfig 文件是一个包含了连接到 Kubernetes 集群所需的所有配置信息的文件，包括服务器地址、证书和秘钥等。</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl config set-context kubernetes-admin@kubernetes    \</span><br><span class="line">  --cluster=kubernetes     \</span><br><span class="line">  --user=kubernetes-admin     \</span><br><span class="line">  --kubeconfig=/etc/kubernetes/admin.kubeconfig</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">该命令用于设置一个名为<span class="string">&quot;kubernetes-admin@kubernetes&quot;</span>的上下文，具体配置如下：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 1. --cluster=kubernetes: 指定集群的名称为&quot;kubernetes&quot;，这个集群是在当前的kubeconfig文件中已经定义好的。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2. --user=kubernetes-admin: 指定用户的名称为<span class="string">&quot;kubernetes-admin&quot;</span>，这个用户也是在当前的kubeconfig文件中已经定义好的。这个用户用于认证和授权admin组件访问Kubernetes集群的权限。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">3. --kubeconfig=/etc/kubernetes/admin.kubeconfig: 指定kubeconfig文件的路径为<span class="string">&quot;/etc/kubernetes/admin.kubeconfig&quot;</span>，这个文件将被用来保存上下文的配置信息。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 这个命令的作用是将上述的配置信息保存到指定的kubeconfig文件中，以便后续使用该文件进行认证和授权访问Kubernetes集群。</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl config use-context kubernetes-admin@kubernetes  --kubeconfig=/etc/kubernetes/admin.kubeconfig</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">上述命令是使用`kubectl`命令来配置Kubernetes集群中的调度器组件。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># `kubectl config use-context`命令用于切换`kubectl`当前使用的上下文。上下文是Kubernetes集群、用户和命名空间的组合，用于确定`kubectl`的连接目标。下面解释这个命令的不同部分：</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># - `kubernetes-admin@kubernetes`是一个上下文名称。它指定了使用`kubernetes-admin`用户和`kubernetes`命名空间的系统级别上下文。系统级别上下文用于操作Kubernetes核心组件。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># - `--kubeconfig=/etc/kubernetes/admin.kubeconfig`用于指定Kubernetes配置文件的路径。Kubernetes配置文件包含连接到Kubernetes集群所需的身份验证和连接信息。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 通过运行以上命令，`kubectl`将使用指定的上下文和配置文件，以便在以后的命令中能正确地与Kubernetes集群中的调度器组件进行交互。</span></span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-7-创建kube-proxy证书"><a href="#3-2-7-创建kube-proxy证书" class="headerlink" title="3.2.7 创建kube-proxy证书"></a>3.2.7 创建kube-proxy证书</h3><p>在《5.高可用配置》选择使用那种高可用方案<br>若使用 haproxy、keepalived 那么为 <code>--server=https://192.168.1.36:9443</code><br>若使用 nginx方案，那么为 <code>--server=https://127.0.0.1:8443</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; kube-proxy-csr.json  &lt;&lt; EOF </span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;system:kube-proxy&quot;,</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;Beijing&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;system:kube-proxy&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;Kubernetes-manual&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这段代码是一个JSON格式的配置文件，用于创建和配置一个名为<span class="string">&quot;kube-proxy-csr&quot;</span>的Kubernetes凭证。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 这个凭证包含以下字段：</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># - &quot;CN&quot;: &quot;system:kube-proxy&quot;: 这是凭证的通用名称，表示这是一个管理员凭证。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- <span class="string">&quot;key&quot;</span>: 这是一个包含证书密钥相关信息的对象。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - <span class="string">&quot;algo&quot;</span>: <span class="string">&quot;rsa&quot;</span>：这是使用的加密算法类型，这里是RSA加密算法。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - <span class="string">&quot;size&quot;</span>: 2048：这是密钥的大小，这里是2048位。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- <span class="string">&quot;names&quot;</span>: 这是一个包含证书名称信息的数组。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - <span class="string">&quot;C&quot;</span>: <span class="string">&quot;CN&quot;</span>：这是证书的国家/地区字段，这里是中国。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - <span class="string">&quot;ST&quot;</span>: <span class="string">&quot;Beijing&quot;</span>：这是证书的省/州字段，这里是北京。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - <span class="string">&quot;L&quot;</span>: <span class="string">&quot;Beijing&quot;</span>：这是证书的城市字段，这里是北京。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - <span class="string">&quot;O&quot;</span>: <span class="string">&quot;system:kube-proxy&quot;</span>：这是证书的组织字段，这里是system:kube-proxy。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - <span class="string">&quot;OU&quot;</span>: <span class="string">&quot;Kubernetes-manual&quot;</span>：这是证书的部门字段，这里是Kubernetes-manual。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 通过这个配置文件创建的凭证将具有管理员权限，并且可以用于管理Kubernetes集群。</span></span></span><br><span class="line"></span><br><span class="line">cfssl gencert \</span><br><span class="line">   -ca=/etc/kubernetes/pki/ca.pem \</span><br><span class="line">   -ca-key=/etc/kubernetes/pki/ca-key.pem \</span><br><span class="line">   -config=ca-config.json \</span><br><span class="line">   -profile=kubernetes \</span><br><span class="line">   kube-proxy-csr.json | cfssljson -bare /etc/kubernetes/pki/kube-proxy</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">上述命令是使用cfssl工具生成Kubernetes admin的证书。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 具体解释如下：</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 1. `cfssl gencert`：使用cfssl工具生成证书。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2. `-ca=/etc/kubernetes/pki/ca.pem`：指定根证书文件的路径。在这里，是指定根证书的路径为`/etc/kubernetes/pki/ca.pem`。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">3. `-ca-key=/etc/kubernetes/pki/ca-key.pem`：指定根证书私钥文件的路径。在这里，是指定根证书私钥的路径为`/etc/kubernetes/pki/ca-key.pem`。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">4. `-config=ca-config.json`：指定证书配置文件的路径。在这里，是指定证书配置文件的路径为`ca-config.json`。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">5. `-profile=kubernetes`：指定证书的配置文件中的一个配置文件模板。在这里，是指定配置文件中的`kubernetes`配置模板。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">6. `kube-proxy-csr.json`：指定admin的证书签名请求文件（CSR）的路径。在这里，是指定请求文件的路径为`kube-proxy-csr.json`。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">7. `|`（管道符号）：将前一个命令的输出作为下一个命令的输入。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">8. `cfssljson`：将cfssl工具生成的证书签名请求(CSR)进行解析。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">9. `-bare /etc/kubernetes/pki/kube-proxy`：指定输出路径和前缀。在这里，是将解析的证书签名请求生成以下文件：`/etc/kubernetes/pki/kube-proxy.pem`（包含了证书）、`/etc/kubernetes/pki/kube-proxy-key.pem`（包含了私钥）。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 总结来说，这个命令的目的是根据根证书、根证书私钥、证书配置文件、CSR文件等生成Kubernetes Scheduler的证书和私钥文件。</span></span></span><br><span class="line"></span><br><span class="line">   </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在《5.高可用配置》选择使用那种高可用方案</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">若使用 haproxy、keepalived 那么为 `--server=https://192.168.1.36:9443`</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">若使用 nginx方案，那么为 `--server=https://127.0.0.1:8443`</span></span><br><span class="line"></span><br><span class="line">kubectl config set-cluster kubernetes     \</span><br><span class="line">  --certificate-authority=/etc/kubernetes/pki/ca.pem     \</span><br><span class="line">  --embed-certs=true     \</span><br><span class="line">  --server=https://127.0.0.1:8443     \</span><br><span class="line">  --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">该命令用于配置一个名为<span class="string">&quot;kubernetes&quot;</span>的集群，并将其应用到/etc/kubernetes/kube-proxy.kubeconfig文件中。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 该命令的解释如下：</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `kubectl config set-cluster kubernetes`: 设置一个集群并命名为<span class="string">&quot;kubernetes&quot;</span>。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `--certificate-authority=/etc/kubernetes/pki/ca.pem`: 指定集群使用的证书授权机构的路径。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `--embed-certs=<span class="literal">true</span>`: 该标志指示将证书嵌入到生成的kubeconfig文件中。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `--server=https://127.0.0.1:8443`: 指定集群的 API server 位置。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `--kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig`: 指定要保存 kubeconfig 文件的路径和名称。</span></span><br><span class="line"></span><br><span class="line">kubectl config set-credentials kube-proxy  \</span><br><span class="line">  --client-certificate=/etc/kubernetes/pki/kube-proxy.pem     \</span><br><span class="line">  --client-key=/etc/kubernetes/pki/kube-proxy-key.pem     \</span><br><span class="line">  --embed-certs=true     \</span><br><span class="line">  --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这段命令是用于设置 kube-proxy 组件的身份验证凭据，并生成相应的 kubeconfig 文件。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 解释每个选项的含义如下：</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `kubectl config set-credentials kube-proxy`：设置 `kube-proxy` 用户的身份验证凭据。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `--client-certificate=/etc/kubernetes/pki/kube-proxy.pem`：指定一个客户端证书文件，用于基于证书的身份验证。在这种情况下，指定了 kube-proxy 组件的证书文件路径。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `--client-key=/etc/kubernetes/pki/kube-proxy-key.pem`：指定与客户端证书相对应的客户端私钥文件。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `--embed-certs=<span class="literal">true</span>`：将客户端证书和私钥嵌入到生成的 kubeconfig 文件中。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `--kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig`：指定生成的 kubeconfig 文件的路径和名称。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 该命令的目的是为 kube-proxy 组件生成一个 kubeconfig 文件，以便进行身份验证和访问集群资源。kubeconfig 文件是一个包含了连接到 Kubernetes 集群所需的所有配置信息的文件，包括服务器地址、证书和秘钥等。</span></span></span><br><span class="line"></span><br><span class="line">kubectl config set-context kube-proxy@kubernetes    \</span><br><span class="line">  --cluster=kubernetes     \</span><br><span class="line">  --user=kube-proxy     \</span><br><span class="line">  --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">该命令用于设置一个名为<span class="string">&quot;kube-proxy@kubernetes&quot;</span>的上下文，具体配置如下：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 1. --cluster=kubernetes: 指定集群的名称为&quot;kubernetes&quot;，这个集群是在当前的kubeconfig文件中已经定义好的。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2. --user=kube-proxy: 指定用户的名称为<span class="string">&quot;kube-proxy&quot;</span>，这个用户也是在当前的kubeconfig文件中已经定义好的。这个用户用于认证和授权kube-proxy组件访问Kubernetes集群的权限。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">3. --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig: 指定kubeconfig文件的路径为<span class="string">&quot;/etc/kubernetes/kube-proxy.kubeconfig&quot;</span>，这个文件将被用来保存上下文的配置信息。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 这个命令的作用是将上述的配置信息保存到指定的kubeconfig文件中，以便后续使用该文件进行认证和授权访问Kubernetes集群。</span></span></span><br><span class="line"></span><br><span class="line">kubectl config use-context kube-proxy@kubernetes  --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">上述命令是使用`kubectl`命令来配置Kubernetes集群中的调度器组件。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># `kubectl config use-context`命令用于切换`kubectl`当前使用的上下文。上下文是Kubernetes集群、用户和命名空间的组合，用于确定`kubectl`的连接目标。下面解释这个命令的不同部分：</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># - `kube-proxy@kubernetes`是一个上下文名称。它指定了使用`kube-proxy`用户和`kubernetes`命名空间的系统级别上下文。系统级别上下文用于操作Kubernetes核心组件。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># - `--kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig`用于指定Kubernetes配置文件的路径。Kubernetes配置文件包含连接到Kubernetes集群所需的身份验证和连接信息。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 通过运行以上命令，`kubectl`将使用指定的上下文和配置文件，以便在以后的命令中能正确地与Kubernetes集群中的调度器组件进行交互。</span></span></span><br></pre></td></tr></table></figure>



<h3 id="3-2-8-创建ServiceAccount-Key-——secret"><a href="#3-2-8-创建ServiceAccount-Key-——secret" class="headerlink" title="3.2.8 创建ServiceAccount Key ——secret"></a>3.2.8 创建ServiceAccount Key ——secret</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">openssl genrsa -out /etc/kubernetes/pki/sa.key 2048</span><br><span class="line">openssl rsa -in /etc/kubernetes/pki/sa.key -pubout -out /etc/kubernetes/pki/sa.pub</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这两个命令是使用OpenSSL工具生成RSA密钥对。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 命令1：openssl genrsa -out /etc/kubernetes/pki/sa.key 2048</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">该命令用于生成私钥文件。具体解释如下：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- openssl：openssl命令行工具。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- genrsa：生成RSA密钥对。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- -out /etc/kubernetes/pki/sa.key：指定输出私钥文件的路径和文件名。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- 2048：指定密钥长度为2048位。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 命令2：openssl rsa -in /etc/kubernetes/pki/sa.key -pubout -out /etc/kubernetes/pki/sa.pub</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">该命令用于从私钥中导出公钥。具体解释如下：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- openssl：openssl命令行工具。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- rsa：与私钥相关的RSA操作。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- -<span class="keyword">in</span> /etc/kubernetes/pki/sa.key：指定输入私钥文件的路径和文件名。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- -pubout：指定输出公钥。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- -out /etc/kubernetes/pki/sa.pub：指定输出公钥文件的路径和文件名。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 总结：通过以上两个命令，我们可以使用OpenSSL工具生成一个RSA密钥对，并将私钥保存在/etc/kubernetes/pki/sa.key文件中，将公钥保存在/etc/kubernetes/pki/sa.pub文件中。</span></span></span><br></pre></td></tr></table></figure>

<h3 id="3-2-9-将证书发送到其他master节点"><a href="#3-2-9-将证书发送到其他master节点" class="headerlink" title="3.2.9 将证书发送到其他master节点"></a>3.2.9 将证书发送到其他master节点</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">其他节点创建目录</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">mkdir</span>  /etc/kubernetes/pki/ -p</span></span><br><span class="line"></span><br><span class="line">for NODE in k8s-master02 k8s-master03; do  for FILE in $(ls /etc/kubernetes/pki | grep -v etcd); do  scp /etc/kubernetes/pki/$&#123;FILE&#125; $NODE:/etc/kubernetes/pki/$&#123;FILE&#125;; done;  for FILE in admin.kubeconfig controller-manager.kubeconfig scheduler.kubeconfig; do  scp /etc/kubernetes/$&#123;FILE&#125; $NODE:/etc/kubernetes/$&#123;FILE&#125;; done; done</span><br></pre></td></tr></table></figure>

<h3 id="3-2-10-查看证书"><a href="#3-2-10-查看证书" class="headerlink" title="3.2.10 查看证书"></a>3.2.10 查看证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">ls /etc/kubernetes/pki/</span><br><span class="line">admin.csr          controller-manager.csr      kube-proxy.csr</span><br><span class="line">admin-key.pem      controller-manager-key.pem  kube-proxy-key.pem</span><br><span class="line">admin.pem          controller-manager.pem      kube-proxy.pem</span><br><span class="line">apiserver.csr      front-proxy-ca.csr          sa.key</span><br><span class="line">apiserver-key.pem  front-proxy-ca-key.pem      sa.pub</span><br><span class="line">apiserver.pem      front-proxy-ca.pem          scheduler.csr</span><br><span class="line">ca.csr             front-proxy-client.csr      scheduler-key.pem</span><br><span class="line">ca-key.pem         front-proxy-client-key.pem  scheduler.pem</span><br><span class="line">ca.pem             front-proxy-client.pem</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">一共26个就对了</span></span><br><span class="line">ls /etc/kubernetes/pki/ |wc -l</span><br><span class="line">26</span><br></pre></td></tr></table></figure>

<h1 id="4-k8s系统组件配置"><a href="#4-k8s系统组件配置" class="headerlink" title="4.k8s系统组件配置"></a>4.k8s系统组件配置</h1><h2 id="4-1-etcd配置"><a href="#4-1-etcd配置" class="headerlink" title="4.1.etcd配置"></a>4.1.etcd配置</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">这个配置文件是用于 etcd 集群的配置，其中包含了一些重要的参数和选项：</span><br><span class="line"></span><br><span class="line">- `name`：指定了当前节点的名称，用于集群中区分不同的节点。</span><br><span class="line">- `data-dir`：指定了 etcd 数据的存储目录。</span><br><span class="line">- `wal-dir`：指定了 etcd 数据写入磁盘的目录。</span><br><span class="line">- `snapshot-count`：指定了触发快照的事务数量。</span><br><span class="line">- `heartbeat-interval`：指定了 etcd 集群中节点之间的心跳间隔。</span><br><span class="line">- `election-timeout`：指定了选举超时时间。</span><br><span class="line">- `quota-backend-bytes`：指定了存储的限额，0 表示无限制。</span><br><span class="line">- `listen-peer-urls`：指定了节点之间通信的 URL，使用 HTTPS 协议。</span><br><span class="line">- `listen-client-urls`：指定了客户端访问 etcd 集群的 URL，同时提供了本地访问的 URL。</span><br><span class="line">- `max-snapshots`：指定了快照保留的数量。</span><br><span class="line">- `max-wals`：指定了日志保留的数量。</span><br><span class="line">- `initial-advertise-peer-urls`：指定了节点之间通信的初始 URL。</span><br><span class="line">- `advertise-client-urls`：指定了客户端访问 etcd 集群的初始 URL。</span><br><span class="line">- `discovery`：定义了 etcd 集群发现相关的选项。</span><br><span class="line">- `initial-cluster`：指定了 etcd 集群的初始成员。</span><br><span class="line">- `initial-cluster-token`：指定了集群的 token。</span><br><span class="line">- `initial-cluster-state`：指定了集群的初始状态。</span><br><span class="line">- `strict-reconfig-check`：指定了严格的重新配置检查选项。</span><br><span class="line">- `enable-v2`：启用了 v2 API。</span><br><span class="line">- `enable-pprof`：启用了性能分析。</span><br><span class="line">- `proxy`：设置了代理模式。</span><br><span class="line">- `client-transport-security`：客户端的传输安全配置。</span><br><span class="line">- `peer-transport-security`：节点之间的传输安全配置。</span><br><span class="line">- `debug`：是否启用调试模式。</span><br><span class="line">- `log-package-levels`：日志的输出级别。</span><br><span class="line">- `log-outputs`：指定了日志的输出类型。</span><br><span class="line">- `force-new-cluster`：是否强制创建一个新的集群。</span><br><span class="line"></span><br><span class="line">这些参数和选项可以根据实际需求进行调整和配置。</span><br></pre></td></tr></table></figure>

<h3 id="4-1-1master01配置"><a href="#4-1-1master01配置" class="headerlink" title="4.1.1master01配置"></a>4.1.1master01配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果要用IPv6那么把IPv4地址修改为IPv6即可</span></span><br><span class="line">cat &gt; /etc/etcd/etcd.config.yml &lt;&lt; EOF </span><br><span class="line">name: &#x27;k8s-master01&#x27;</span><br><span class="line">data-dir: /var/lib/etcd</span><br><span class="line">wal-dir: /var/lib/etcd/wal</span><br><span class="line">snapshot-count: 5000</span><br><span class="line">heartbeat-interval: 100</span><br><span class="line">election-timeout: 1000</span><br><span class="line">quota-backend-bytes: 0</span><br><span class="line">listen-peer-urls: &#x27;https://192.168.1.31:2380&#x27;</span><br><span class="line">listen-client-urls: &#x27;https://192.168.1.31:2379,http://127.0.0.1:2379&#x27;</span><br><span class="line">max-snapshots: 3</span><br><span class="line">max-wals: 5</span><br><span class="line">cors:</span><br><span class="line">initial-advertise-peer-urls: &#x27;https://192.168.1.31:2380&#x27;</span><br><span class="line">advertise-client-urls: &#x27;https://192.168.1.31:2379&#x27;</span><br><span class="line">discovery:</span><br><span class="line">discovery-fallback: &#x27;proxy&#x27;</span><br><span class="line">discovery-proxy:</span><br><span class="line">discovery-srv:</span><br><span class="line">initial-cluster: &#x27;k8s-master01=https://192.168.1.31:2380,k8s-master02=https://192.168.1.32:2380,k8s-master03=https://192.168.1.33:2380&#x27;</span><br><span class="line">initial-cluster-token: &#x27;etcd-k8s-cluster&#x27;</span><br><span class="line">initial-cluster-state: &#x27;new&#x27;</span><br><span class="line">strict-reconfig-check: false</span><br><span class="line">enable-v2: true</span><br><span class="line">enable-pprof: true</span><br><span class="line">proxy: &#x27;off&#x27;</span><br><span class="line">proxy-failure-wait: 5000</span><br><span class="line">proxy-refresh-interval: 30000</span><br><span class="line">proxy-dial-timeout: 1000</span><br><span class="line">proxy-write-timeout: 5000</span><br><span class="line">proxy-read-timeout: 0</span><br><span class="line">client-transport-security:</span><br><span class="line">  cert-file: &#x27;/etc/kubernetes/pki/etcd/etcd.pem&#x27;</span><br><span class="line">  key-file: &#x27;/etc/kubernetes/pki/etcd/etcd-key.pem&#x27;</span><br><span class="line">  client-cert-auth: true</span><br><span class="line">  trusted-ca-file: &#x27;/etc/kubernetes/pki/etcd/etcd-ca.pem&#x27;</span><br><span class="line">  auto-tls: true</span><br><span class="line">peer-transport-security:</span><br><span class="line">  cert-file: &#x27;/etc/kubernetes/pki/etcd/etcd.pem&#x27;</span><br><span class="line">  key-file: &#x27;/etc/kubernetes/pki/etcd/etcd-key.pem&#x27;</span><br><span class="line">  peer-client-cert-auth: true</span><br><span class="line">  trusted-ca-file: &#x27;/etc/kubernetes/pki/etcd/etcd-ca.pem&#x27;</span><br><span class="line">  auto-tls: true</span><br><span class="line">debug: false</span><br><span class="line">log-package-levels:</span><br><span class="line">log-outputs: [default]</span><br><span class="line">force-new-cluster: false</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="4-1-2master02配置"><a href="#4-1-2master02配置" class="headerlink" title="4.1.2master02配置"></a>4.1.2master02配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果要用IPv6那么把IPv4地址修改为IPv6即可</span></span><br><span class="line">cat &gt; /etc/etcd/etcd.config.yml &lt;&lt; EOF </span><br><span class="line">name: &#x27;k8s-master02&#x27;</span><br><span class="line">data-dir: /var/lib/etcd</span><br><span class="line">wal-dir: /var/lib/etcd/wal</span><br><span class="line">snapshot-count: 5000</span><br><span class="line">heartbeat-interval: 100</span><br><span class="line">election-timeout: 1000</span><br><span class="line">quota-backend-bytes: 0</span><br><span class="line">listen-peer-urls: &#x27;https://192.168.1.32:2380&#x27;</span><br><span class="line">listen-client-urls: &#x27;https://192.168.1.32:2379,http://127.0.0.1:2379&#x27;</span><br><span class="line">max-snapshots: 3</span><br><span class="line">max-wals: 5</span><br><span class="line">cors:</span><br><span class="line">initial-advertise-peer-urls: &#x27;https://192.168.1.32:2380&#x27;</span><br><span class="line">advertise-client-urls: &#x27;https://192.168.1.32:2379&#x27;</span><br><span class="line">discovery:</span><br><span class="line">discovery-fallback: &#x27;proxy&#x27;</span><br><span class="line">discovery-proxy:</span><br><span class="line">discovery-srv:</span><br><span class="line">initial-cluster: &#x27;k8s-master01=https://192.168.1.31:2380,k8s-master02=https://192.168.1.32:2380,k8s-master03=https://192.168.1.33:2380&#x27;</span><br><span class="line">initial-cluster-token: &#x27;etcd-k8s-cluster&#x27;</span><br><span class="line">initial-cluster-state: &#x27;new&#x27;</span><br><span class="line">strict-reconfig-check: false</span><br><span class="line">enable-v2: true</span><br><span class="line">enable-pprof: true</span><br><span class="line">proxy: &#x27;off&#x27;</span><br><span class="line">proxy-failure-wait: 5000</span><br><span class="line">proxy-refresh-interval: 30000</span><br><span class="line">proxy-dial-timeout: 1000</span><br><span class="line">proxy-write-timeout: 5000</span><br><span class="line">proxy-read-timeout: 0</span><br><span class="line">client-transport-security:</span><br><span class="line">  cert-file: &#x27;/etc/kubernetes/pki/etcd/etcd.pem&#x27;</span><br><span class="line">  key-file: &#x27;/etc/kubernetes/pki/etcd/etcd-key.pem&#x27;</span><br><span class="line">  client-cert-auth: true</span><br><span class="line">  trusted-ca-file: &#x27;/etc/kubernetes/pki/etcd/etcd-ca.pem&#x27;</span><br><span class="line">  auto-tls: true</span><br><span class="line">peer-transport-security:</span><br><span class="line">  cert-file: &#x27;/etc/kubernetes/pki/etcd/etcd.pem&#x27;</span><br><span class="line">  key-file: &#x27;/etc/kubernetes/pki/etcd/etcd-key.pem&#x27;</span><br><span class="line">  peer-client-cert-auth: true</span><br><span class="line">  trusted-ca-file: &#x27;/etc/kubernetes/pki/etcd/etcd-ca.pem&#x27;</span><br><span class="line">  auto-tls: true</span><br><span class="line">debug: false</span><br><span class="line">log-package-levels:</span><br><span class="line">log-outputs: [default]</span><br><span class="line">force-new-cluster: false</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="4-1-3master03配置"><a href="#4-1-3master03配置" class="headerlink" title="4.1.3master03配置"></a>4.1.3master03配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果要用IPv6那么把IPv4地址修改为IPv6即可</span></span><br><span class="line">cat &gt; /etc/etcd/etcd.config.yml &lt;&lt; EOF </span><br><span class="line">name: &#x27;k8s-master03&#x27;</span><br><span class="line">data-dir: /var/lib/etcd</span><br><span class="line">wal-dir: /var/lib/etcd/wal</span><br><span class="line">snapshot-count: 5000</span><br><span class="line">heartbeat-interval: 100</span><br><span class="line">election-timeout: 1000</span><br><span class="line">quota-backend-bytes: 0</span><br><span class="line">listen-peer-urls: &#x27;https://192.168.1.33:2380&#x27;</span><br><span class="line">listen-client-urls: &#x27;https://192.168.1.33:2379,http://127.0.0.1:2379&#x27;</span><br><span class="line">max-snapshots: 3</span><br><span class="line">max-wals: 5</span><br><span class="line">cors:</span><br><span class="line">initial-advertise-peer-urls: &#x27;https://192.168.1.33:2380&#x27;</span><br><span class="line">advertise-client-urls: &#x27;https://192.168.1.33:2379&#x27;</span><br><span class="line">discovery:</span><br><span class="line">discovery-fallback: &#x27;proxy&#x27;</span><br><span class="line">discovery-proxy:</span><br><span class="line">discovery-srv:</span><br><span class="line">initial-cluster: &#x27;k8s-master01=https://192.168.1.31:2380,k8s-master02=https://192.168.1.32:2380,k8s-master03=https://192.168.1.33:2380&#x27;</span><br><span class="line">initial-cluster-token: &#x27;etcd-k8s-cluster&#x27;</span><br><span class="line">initial-cluster-state: &#x27;new&#x27;</span><br><span class="line">strict-reconfig-check: false</span><br><span class="line">enable-v2: true</span><br><span class="line">enable-pprof: true</span><br><span class="line">proxy: &#x27;off&#x27;</span><br><span class="line">proxy-failure-wait: 5000</span><br><span class="line">proxy-refresh-interval: 30000</span><br><span class="line">proxy-dial-timeout: 1000</span><br><span class="line">proxy-write-timeout: 5000</span><br><span class="line">proxy-read-timeout: 0</span><br><span class="line">client-transport-security:</span><br><span class="line">  cert-file: &#x27;/etc/kubernetes/pki/etcd/etcd.pem&#x27;</span><br><span class="line">  key-file: &#x27;/etc/kubernetes/pki/etcd/etcd-key.pem&#x27;</span><br><span class="line">  client-cert-auth: true</span><br><span class="line">  trusted-ca-file: &#x27;/etc/kubernetes/pki/etcd/etcd-ca.pem&#x27;</span><br><span class="line">  auto-tls: true</span><br><span class="line">peer-transport-security:</span><br><span class="line">  cert-file: &#x27;/etc/kubernetes/pki/etcd/etcd.pem&#x27;</span><br><span class="line">  key-file: &#x27;/etc/kubernetes/pki/etcd/etcd-key.pem&#x27;</span><br><span class="line">  peer-client-cert-auth: true</span><br><span class="line">  trusted-ca-file: &#x27;/etc/kubernetes/pki/etcd/etcd-ca.pem&#x27;</span><br><span class="line">  auto-tls: true</span><br><span class="line">debug: false</span><br><span class="line">log-package-levels:</span><br><span class="line">log-outputs: [default]</span><br><span class="line">force-new-cluster: false</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h2 id="4-2-创建service（所有master节点操作）"><a href="#4-2-创建service（所有master节点操作）" class="headerlink" title="4.2.创建service（所有master节点操作）"></a>4.2.创建service（所有master节点操作）</h2><h3 id="4-2-1创建etcd-service并启动"><a href="#4-2-1创建etcd-service并启动" class="headerlink" title="4.2.1创建etcd.service并启动"></a>4.2.1创建etcd.service并启动</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/etcd.service &lt;&lt; EOF</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Service</span><br><span class="line">Documentation=https://coreos.com/etcd/docs/latest/</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">ExecStart=/usr/local/bin/etcd --config-file=/etc/etcd/etcd.config.yml</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=10</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">Alias=etcd3.service</span><br><span class="line"></span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这是一个系统服务配置文件，用于启动和管理Etcd服务。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># [Unit] 部分包含了服务的一些基本信息，它定义了服务的描述和文档链接，并指定了服务应在网络连接之后启动。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># [Service] 部分定义了服务的具体配置。在这里，服务的类型被设置为notify，意味着当服务成功启动时，它将通知系统。ExecStart 指定了启动服务时要执行的命令，这里是运行 /usr/local/bin/etcd 命令并传递一个配置文件 /etc/etcd/etcd.config.yml。Restart 设置为 on-failure，意味着当服务失败时将自动重启，并且在10秒后进行重启。LimitNOFILE 指定了服务的最大文件打开数。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># [Install] 部分定义了服务的安装配置。WantedBy 指定了服务应该被启动的目标，这里是 multi-user.target，表示在系统进入多用户模式时启动。Alias 定义了一个别名，可以通过etcd3.service来引用这个服务。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 这个配置文件描述了如何启动和管理Etcd服务，并将其安装到系统中。通过这个配置文件，可以确保Etcd服务在系统启动后自动启动，并在出现问题时进行重启。</span></span></span><br></pre></td></tr></table></figure>

<h3 id="4-2-2创建etcd证书目录"><a href="#4-2-2创建etcd证书目录" class="headerlink" title="4.2.2创建etcd证书目录"></a>4.2.2创建etcd证书目录</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mkdir /etc/kubernetes/pki/etcd</span><br><span class="line">ln -s /etc/etcd/ssl/* /etc/kubernetes/pki/etcd/</span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">用于重新加载systemd管理的单位文件。当你新增或修改了某个单位文件（如.service文件、.socket文件等），需要运行该命令来刷新systemd对该文件的配置。</span></span><br><span class="line"></span><br><span class="line">systemctl enable --now etcd.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启用并立即启动etcd.service单元。etcd.service是etcd守护进程的systemd服务单元。</span></span><br><span class="line"></span><br><span class="line">systemctl restart etcd.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启etcd.service单元，即重新启动etcd守护进程。</span></span><br><span class="line"></span><br><span class="line">systemctl status etcd.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">etcd.service单元的当前状态，包括运行状态、是否启用等信息。</span></span><br></pre></td></tr></table></figure>

<h3 id="4-2-3查看etcd状态"><a href="#4-2-3查看etcd状态" class="headerlink" title="4.2.3查看etcd状态"></a>4.2.3查看etcd状态</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">如果要用IPv6那么把IPv4地址修改为IPv6即可</span></span><br><span class="line">export ETCDCTL_API=3</span><br><span class="line">etcdctl --endpoints=&quot;192.168.1.33:2379,192.168.1.32:2379,192.168.1.31:2379&quot; --cacert=/etc/kubernetes/pki/etcd/etcd-ca.pem --cert=/etc/kubernetes/pki/etcd/etcd.pem --key=/etc/kubernetes/pki/etcd/etcd-key.pem  endpoint status --write-out=table</span><br><span class="line">+-------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br><span class="line">|     ENDPOINT      |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |</span><br><span class="line">+-------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br><span class="line">| 192.168.1.33:2379 |  8065f2e59c8d68c |  3.5.12 |   20 kB |     false |      false |         4 |         14 |                 14 |        |</span><br><span class="line">| 192.168.1.32:2379 | b7b7ad6bf4db3f28 |  3.5.12 |   20 kB |      true |      false |         4 |         14 |                 14 |        |</span><br><span class="line">| 192.168.1.31:2379 | bf047bcfe3b9bf27 |  3.5.12 |   20 kB |     false |      false |         4 |         14 |                 14 |        |</span><br><span class="line">+-------------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这个命令是使用etcdctl工具，用于查看指定etcd集群的健康状态。下面是每个参数的详细解释：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># - `--endpoints`：指定要连接的etcd集群节点的地址和端口。在这个例子中，指定了3个节点的地址和端口，分别是`192.168.1.33:2379,192.168.1.32:2379,192.168.1.31:2379`。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `--cacert`：指定用于验证etcd服务器证书的CA证书的路径。在这个例子中，指定了CA证书的路径为`/etc/kubernetes/pki/etcd/etcd-ca.pem`。CA证书用于验证etcd服务器证书的有效性。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `--cert`：指定用于与etcd服务器进行通信的客户端证书的路径。在这个例子中，指定了客户端证书的路径为`/etc/kubernetes/pki/etcd/etcd.pem`。客户端证书用于在与etcd服务器建立安全通信时进行身份验证。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `--key`：指定与客户端证书配对的私钥的路径。在这个例子中，指定了私钥的路径为`/etc/kubernetes/pki/etcd/etcd-key.pem`。私钥用于对通信进行加密解密和签名验证。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `endpoint status`：子命令，用于检查etcd集群节点的健康状态。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- `--write-out`：指定输出的格式。在这个例子中，指定以表格形式输出。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 通过执行这个命令，可以获取到etcd集群节点的健康状态，并以表格形式展示。</span></span></span><br></pre></td></tr></table></figure>

<h1 id="5-高可用配置（在Master服务器上操作）"><a href="#5-高可用配置（在Master服务器上操作）" class="headerlink" title="5.高可用配置（在Master服务器上操作）"></a>5.高可用配置（在Master服务器上操作）</h1><p><em><em>注意</em> 5.1.1 和5.1.2 二选一即可</em>*</p>
<p>选择使用那种高可用方案，同时可以俩种都选用，实现内外兼顾的效果，比如：<br>5.1 的 NGINX方案实现集群内的高可用<br>5.2 的 haproxy、keepalived 方案实现集群外访问</p>
<p>在《3.2.生成k8s相关证书》</p>
<p>若使用 nginx方案，那么为 <code>--server=https://127.0.0.1:8443</code><br>若使用 haproxy、keepalived 那么为 <code>--server=https://192.168.1.36:9443</code></p>
<h2 id="5-1-NGINX高可用方案"><a href="#5-1-NGINX高可用方案" class="headerlink" title="5.1 NGINX高可用方案"></a>5.1 NGINX高可用方案</h2><h3 id="5-1-1-进行编译"><a href="#5-1-1-进行编译" class="headerlink" title="5.1.1 进行编译"></a>5.1.1 进行编译</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">安装编译环境</span></span><br><span class="line">yum install gcc -y</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载解压nginx二进制文件</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">wget http://nginx.org/download/nginx-1.25.3.tar.gz</span></span><br><span class="line">tar xvf nginx-*.tar.gz</span><br><span class="line">cd nginx-*</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进行编译</span></span><br><span class="line">./configure --with-stream --without-http --without-http_uwsgi_module --without-http_scgi_module --without-http_fastcgi_module</span><br><span class="line">make &amp;&amp; make install </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">拷贝编译好的nginx</span></span><br><span class="line">node=&#x27;k8s-master02 k8s-master03 k8s-node01 k8s-node02&#x27;</span><br><span class="line">for NODE in $node; do scp -r /usr/local/nginx/ $NODE:/usr/local/nginx/; done</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这是一系列命令行指令，用于编译和安装软件。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 1. `./configure` 是用于配置软件的命令。在这个例子中，配置的软件是一个Web服务器，指定了一些选项来启用流模块，并禁用了HTTP、uwsgi、scgi和fastcgi模块。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2. `--with-stream` 指定启用流模块。流模块通常用于代理TCP和UDP流量。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">3. `--without-http` 指定禁用HTTP模块。这意味着编译的软件将没有HTTP服务器功能。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">4. `--without-http_uwsgi_module` 指定禁用uwsgi模块。uwsgi是一种Web服务器和应用服务器之间的通信协议。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">5. `--without-http_scgi_module` 指定禁用scgi模块。scgi是一种用于将Web服务器请求传递到应用服务器的协议。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">6. `--without-http_fastcgi_module` 指定禁用fastcgi模块。fastcgi是一种用于在Web服务器和应用服务器之间交换数据的协议。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">7. `make` 是用于编译软件的命令。该命令将根据之前的配置生成可执行文件。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">8. `make install` 用于安装软件。该命令将生成的可执行文件和其他必要文件复制到系统的适当位置，以便可以使用该软件。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 总之，这个命令序列用于编译一个配置了特定选项的Web服务器，并将其安装到系统中。</span></span></span><br></pre></td></tr></table></figure>

<h3 id="5-1-2-写入启动配置"><a href="#5-1-2-写入启动配置" class="headerlink" title="5.1.2 写入启动配置"></a>5.1.2 写入启动配置</h3><p>在所有主机上执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">写入nginx配置文件</span></span><br><span class="line">cat &gt; /usr/local/nginx/conf/kube-nginx.conf &lt;&lt;EOF</span><br><span class="line">worker_processes 1;</span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line">stream &#123;</span><br><span class="line">    upstream backend &#123;</span><br><span class="line">    	least_conn;</span><br><span class="line">        hash $remote_addr consistent;</span><br><span class="line">        server 192.168.1.31:6443        max_fails=3 fail_timeout=30s;</span><br><span class="line">        server 192.168.1.32:6443        max_fails=3 fail_timeout=30s;</span><br><span class="line">        server 192.168.1.33:6443        max_fails=3 fail_timeout=30s;</span><br><span class="line">    &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen 127.0.0.1:8443;</span><br><span class="line">        proxy_connect_timeout 1s;</span><br><span class="line">        proxy_pass backend;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这段配置是一个nginx的stream模块的配置，用于代理TCP和UDP流量。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 首先，`worker_processes 1;`表示启动一个worker进程用于处理流量。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">接下来，`events &#123; worker_connections 1024; &#125;`表示每个worker进程可以同时处理最多1024个连接。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在stream块里面，定义了一个名为`backend`的upstream，用于负载均衡和故障转移。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">`least_conn`表示使用最少连接算法进行负载均衡。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">`<span class="built_in">hash</span> <span class="variable">$remote_addr</span> consistent`表示用客户端的IP地址进行哈希分配请求，保持相同IP的请求始终访问同一台服务器。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">`server`指令用于定义后端的服务器，每个服务器都有一个IP地址和端口号，以及一些可选的参数。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">`max_fails=3`表示当一个服务器连续失败3次时将其标记为不可用。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">`fail_timeout=30s`表示如果一个服务器被标记为不可用，nginx将在30秒后重新尝试。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在server块内部，定义了一个监听地址为127.0.0.1:8443的服务器。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">`proxy_connect_timeout 1s`表示与后端服务器建立连接的超时时间为1秒。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">`proxy_pass backend`表示将流量代理到名为backend的上游服务器组。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 总结起来，这段配置将流量代理到一个包含3个后端服务器的上游服务器组中，使用最少连接算法进行负载均衡，并根据客户端的IP地址进行哈希分配请求。如果一个服务器连续失败3次，则将其标记为不可用，并在30秒后重新尝试。</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">写入启动配置文件</span></span><br><span class="line">cat &gt; /etc/systemd/system/kube-nginx.service &lt;&lt;EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=kube-apiserver nginx proxy</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">ExecStartPre=/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/kube-nginx.conf -p /usr/local/nginx -t</span><br><span class="line">ExecStart=/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/kube-nginx.conf -p /usr/local/nginx</span><br><span class="line">ExecReload=/usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/kube-nginx.conf -p /usr/local/nginx -s reload</span><br><span class="line">PrivateTmp=true</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=5</span><br><span class="line">StartLimitInterval=0</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"> </span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这是一个用于kube-apiserver的NGINX代理的systemd单位文件。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># [Unit]部分包含了单位的描述和依赖关系。它指定了在network.target和network-online.target之后启动，并且需要network-online.target。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># [Service]部分定义了如何运行该服务。Type指定了服务进程的类型（forking表示主进程会派生一个子进程）。ExecStartPre指定了在服务启动之前需要运行的命令，用于检查NGINX配置文件的语法是否正确。ExecStart指定了启动服务所需的命令。ExecReload指定了在重新加载配置文件时运行的命令。PrivateTmp设置为true表示将为服务创建一个私有的临时文件系统。Restart和RestartSec用于设置服务的自动重启机制。StartLimitInterval设置为0表示无需等待，可以立即重启服务。LimitNOFILE指定了服务的文件描述符的限制。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># [Install]部分指定了在哪些target下该单位应该被启用。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 综上所述，此单位文件用于启动和管理kube-apiserver的NGINX代理服务。它通过NGINX来反向代理和负载均衡kube-apiserver的请求。该服务会在系统启动时自动启动，并具有自动重启的机制。</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置开机自启</span></span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">用于重新加载systemd管理的单位文件。当你新增或修改了某个单位文件（如.service文件、.socket文件等），需要运行该命令来刷新systemd对该文件的配置。</span></span><br><span class="line">systemctl enable --now kube-nginx.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启用并立即启动kube-nginx.service单元。kube-nginx.service是kube-nginx守护进程的systemd服务单元。</span></span><br><span class="line">systemctl restart kube-nginx.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启kube-nginx.service单元，即重新启动kube-nginx守护进程。</span></span><br><span class="line">systemctl status kube-nginx.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kube-nginx.service单元的当前状态，包括运行状态、是否启用等信息。</span></span><br></pre></td></tr></table></figure>

<h2 id="5-2-keepalived和haproxy-高可用方案"><a href="#5-2-keepalived和haproxy-高可用方案" class="headerlink" title="5.2 keepalived和haproxy 高可用方案"></a>5.2 keepalived和haproxy 高可用方案</h2><h3 id="5-2-1安装keepalived和haproxy服务"><a href="#5-2-1安装keepalived和haproxy服务" class="headerlink" title="5.2.1安装keepalived和haproxy服务"></a>5.2.1安装keepalived和haproxy服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">systemctl disable --now firewalld</span><br><span class="line">setenforce 0</span><br><span class="line">sed -i &#x27;s#SELINUX=enforcing#SELINUX=disabled#g&#x27; /etc/selinux/config</span><br><span class="line">yum -y install keepalived haproxy</span><br></pre></td></tr></table></figure>

<h3 id="5-2-2修改haproxy配置文件（配置文件一样）"><a href="#5-2-2修改haproxy配置文件（配置文件一样）" class="headerlink" title="5.2.2修改haproxy配置文件（配置文件一样）"></a>5.2.2修改haproxy配置文件（配置文件一样）</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cp</span> /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.bak</span></span><br><span class="line"></span><br><span class="line">cat &gt;/etc/haproxy/haproxy.cfg&lt;&lt;&quot;EOF&quot;</span><br><span class="line">global</span><br><span class="line"> maxconn 2000</span><br><span class="line"> ulimit-n 16384</span><br><span class="line"> log 127.0.0.1 local0 err</span><br><span class="line"> stats timeout 30s</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line"> log global</span><br><span class="line"> mode http</span><br><span class="line"> option httplog</span><br><span class="line"> timeout connect 5000</span><br><span class="line"> timeout client 50000</span><br><span class="line"> timeout server 50000</span><br><span class="line"> timeout http-request 15s</span><br><span class="line"> timeout http-keep-alive 15s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">frontend monitor-in</span><br><span class="line"> bind *:33305</span><br><span class="line"> mode http</span><br><span class="line"> option httplog</span><br><span class="line"> monitor-uri /monitor</span><br><span class="line"></span><br><span class="line">frontend k8s-master</span><br><span class="line"> bind 0.0.0.0:9443</span><br><span class="line"> bind 127.0.0.1:9443</span><br><span class="line"> mode tcp</span><br><span class="line"> option tcplog</span><br><span class="line"> tcp-request inspect-delay 5s</span><br><span class="line"> default_backend k8s-master</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">backend k8s-master</span><br><span class="line"> mode tcp</span><br><span class="line"> option tcplog</span><br><span class="line"> option tcp-check</span><br><span class="line"> balance roundrobin</span><br><span class="line"> default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100</span><br><span class="line"> server  k8s-master01  192.168.1.31:6443 check</span><br><span class="line"> server  k8s-master02  192.168.1.32:6443 check</span><br><span class="line"> server  k8s-master03  192.168.1.33:6443 check</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">这段配置代码是指定了一个HAProxy负载均衡器的配置。下面对各部分进行详细解释：</span><br><span class="line">1. global:</span><br><span class="line">   - maxconn 2000: 设置每个进程的最大连接数为2000。</span><br><span class="line">   - ulimit-n 16384: 设置每个进程的最大文件描述符数为16384。</span><br><span class="line">   - log 127.0.0.1 local0 err: 指定日志的输出地址为本地主机的127.0.0.1，并且只记录错误级别的日志。</span><br><span class="line">   - stats timeout 30s: 设置查看负载均衡器统计信息的超时时间为30秒。</span><br><span class="line"></span><br><span class="line">2. defaults:</span><br><span class="line">   - log global: 使默认日志与global部分相同。</span><br><span class="line">   - mode http: 设定负载均衡器的工作模式为HTTP模式。</span><br><span class="line">   - option httplog: 使负载均衡器记录HTTP协议的日志。</span><br><span class="line">   - timeout connect 5000: 设置与后端服务器建立连接的超时时间为5秒。</span><br><span class="line">   - timeout client 50000: 设置与客户端的连接超时时间为50秒。</span><br><span class="line">   - timeout server 50000: 设置与后端服务器连接的超时时间为50秒。</span><br><span class="line">   - timeout http-request 15s: 设置处理HTTP请求的超时时间为15秒。</span><br><span class="line">   - timeout http-keep-alive 15s: 设置保持HTTP连接的超时时间为15秒。</span><br><span class="line"></span><br><span class="line">3. frontend monitor-in:</span><br><span class="line">   - bind *:33305: 监听所有IP地址的33305端口。</span><br><span class="line">   - mode http: 设定frontend的工作模式为HTTP模式。</span><br><span class="line">   - option httplog: 记录HTTP协议的日志。</span><br><span class="line">   - monitor-uri /monitor: 设置监控URI为/monitor。</span><br><span class="line"></span><br><span class="line">4. frontend k8s-master:</span><br><span class="line">   - bind 0.0.0.0:9443: 监听所有IP地址的9443端口。</span><br><span class="line">   - bind 127.0.0.1:9443: 监听本地主机的9443端口。</span><br><span class="line">   - mode tcp: 设定frontend的工作模式为TCP模式。</span><br><span class="line">   - option tcplog: 记录TCP协议的日志。</span><br><span class="line">   - tcp-request inspect-delay 5s: 设置在接收到请求后延迟5秒进行检查。</span><br><span class="line">   - default_backend k8s-master: 设置默认的后端服务器组为k8s-master。</span><br><span class="line"></span><br><span class="line">5. backend k8s-master:</span><br><span class="line">   - mode tcp: 设定backend的工作模式为TCP模式。</span><br><span class="line">   - option tcplog: 记录TCP协议的日志。</span><br><span class="line">   - option tcp-check: 启用TCP检查功能。</span><br><span class="line">   - balance roundrobin: 使用轮询算法进行负载均衡。</span><br><span class="line">   - default-server inter 10s downinter 5s rise 2 fall 2 slowstart 60s maxconn 250 maxqueue 256 weight 100: 设置默认的服务器参数。</span><br><span class="line">   - server k8s-master01 192.168.1.31:6443 check: 增加一个名为k8s-master01的服务器，IP地址为192.168.1.31，端口号为6443，并对其进行健康检查。</span><br><span class="line">   - server k8s-master02 192.168.1.32:6443 check: 增加一个名为k8s-master02的服务器，IP地址为192.168.1.32，端口号为6443，并对其进行健康检查。</span><br><span class="line">   - server k8s-master03 192.168.1.33:6443 check: 增加一个名为k8s-master03的服务器，IP地址为192.168.1.33，端口号为6443，并对其进行健康检查。</span><br><span class="line"></span><br><span class="line">以上就是这段配置代码的详细解释。它主要定义了全局配置、默认配置、前端监听和后端服务器组的相关参数和设置。通过这些配置，可以实现负载均衡和监控功能。</span><br></pre></td></tr></table></figure>

<h3 id="5-2-3Master01配置keepalived-master节点"><a href="#5-2-3Master01配置keepalived-master节点" class="headerlink" title="5.2.3Master01配置keepalived master节点"></a>5.2.3Master01配置keepalived master节点</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash"><span class="built_in">cp</span> /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak</span></span><br><span class="line"></span><br><span class="line">cat &gt; /etc/keepalived/keepalived.conf &lt;&lt; EOF</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">    router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_apiserver &#123;</span><br><span class="line">    script &quot;/etc/keepalived/check_apiserver.sh&quot;</span><br><span class="line">    interval 5 </span><br><span class="line">    weight -5</span><br><span class="line">    fall 2</span><br><span class="line">    rise 1</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    # 注意网卡名</span><br><span class="line">    interface eth0 </span><br><span class="line">    mcast_src_ip 192.168.1.31</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    nopreempt</span><br><span class="line">    advert_int 2</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass K8SHA_KA_AUTH</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.1.36</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">      chk_apiserver </span><br><span class="line">&#125; &#125;</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="5-2-4Master02配置keepalived-backup节点"><a href="#5-2-4Master02配置keepalived-backup节点" class="headerlink" title="5.2.4Master02配置keepalived backup节点"></a>5.2.4Master02配置keepalived backup节点</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cp</span> /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak</span></span><br><span class="line"></span><br><span class="line">cat &gt; /etc/keepalived/keepalived.conf &lt;&lt; EOF</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">    router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_apiserver &#123;</span><br><span class="line">    script &quot;/etc/keepalived/check_apiserver.sh&quot;</span><br><span class="line">    interval 5 </span><br><span class="line">    weight -5</span><br><span class="line">    fall 2</span><br><span class="line">    rise 1</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    # 注意网卡名</span><br><span class="line">    interface eth0</span><br><span class="line">    mcast_src_ip 192.168.1.32</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 80</span><br><span class="line">    nopreempt</span><br><span class="line">    advert_int 2</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass K8SHA_KA_AUTH</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.1.36</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">      chk_apiserver </span><br><span class="line">&#125; &#125;</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="5-2-5Master03配置keepalived-backup节点"><a href="#5-2-5Master03配置keepalived-backup节点" class="headerlink" title="5.2.5Master03配置keepalived backup节点"></a>5.2.5Master03配置keepalived backup节点</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">cp</span> /etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf.bak</span></span><br><span class="line"></span><br><span class="line">cat &gt; /etc/keepalived/keepalived.conf &lt;&lt; EOF</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">    router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line">vrrp_script chk_apiserver &#123;</span><br><span class="line">    script &quot;/etc/keepalived/check_apiserver.sh&quot;</span><br><span class="line">    interval 5 </span><br><span class="line">    weight -5</span><br><span class="line">    fall 2</span><br><span class="line">    rise 1</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    # 注意网卡名</span><br><span class="line">    interface eth0</span><br><span class="line">    mcast_src_ip 192.168.1.33</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 50</span><br><span class="line">    nopreempt</span><br><span class="line">    advert_int 2</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass K8SHA_KA_AUTH</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.1.36</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">      chk_apiserver </span><br><span class="line">&#125; &#125;</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">这是一个用于配置keepalived的配置文件。下面是对每个部分的详细解释：</span><br><span class="line"></span><br><span class="line">- `global_defs`部分定义了全局参数。</span><br><span class="line">- `router_id`参数指定了当前路由器的标识，这里设置为&quot;LVS_DEVEL&quot;。</span><br><span class="line"></span><br><span class="line">- `vrrp_script`部分定义了一个VRRP脚本。`chk_apiserver`是脚本的名称，</span><br><span class="line">    - `script`参数指定了脚本的路径。该脚本每5秒执行一次，返回值为0表示服务正常，返回值为1表示服务异常。</span><br><span class="line">    - `weight`参数指定了根据脚本返回的值来调整优先级，这里设置为-5。</span><br><span class="line">    - `fall`参数指定了失败阈值，当连续2次脚本返回值为1时认为服务异常。</span><br><span class="line">    - `rise`参数指定了恢复阈值，当连续1次脚本返回值为0时认为服务恢复正常。</span><br><span class="line"></span><br><span class="line">- `vrrp_instance`部分定义了一个VRRP实例。`VI_1`是实例的名称。</span><br><span class="line">    - `state`参数指定了当前实例的状态，这里设置为MASTER表示当前实例是主节点。</span><br><span class="line">    - `interface`参数指定了要监听的网卡，这里设置为eth0。</span><br><span class="line">    - `mcast_src_ip`参数指定了VRRP报文的源IP地址，这里设置为192.168.1.31。</span><br><span class="line">    - `virtual_router_id`参数指定了虚拟路由器的ID，这里设置为51。</span><br><span class="line">    - `priority`参数指定了实例的优先级，优先级越高（数值越大）越有可能被选为主节点。</span><br><span class="line">    - `nopreempt`参数指定了当主节点失效后不要抢占身份，即不要自动切换为主节点。</span><br><span class="line">    - `advert_int`参数指定了发送广播的间隔时间，这里设置为2秒。</span><br><span class="line">    - `authentication`部分指定了认证参数</span><br><span class="line">    	- `auth_type`参数指定了认证类型，这里设置为PASS表示使用密码认证，</span><br><span class="line">    	- `auth_pass`参数指定了认证密码，这里设置为K8SHA_KA_AUTH。</span><br><span class="line">    - `virtual_ipaddress`部分指定了虚拟IP地址，这里设置为192.168.1.36。</span><br><span class="line">    - `track_script`部分指定了要跟踪的脚本，这里跟踪了chk_apiserver脚本。</span><br></pre></td></tr></table></figure>


<h3 id="5-2-6健康检查脚本配置（lb主机）"><a href="#5-2-6健康检查脚本配置（lb主机）" class="headerlink" title="5.2.6健康检查脚本配置（lb主机）"></a>5.2.6健康检查脚本配置（lb主机）</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;  /etc/keepalived/check_apiserver.sh &lt;&lt; EOF</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">err=0</span><br><span class="line">for k in \$(seq 1 3)</span><br><span class="line">do</span><br><span class="line">    check_code=\$(pgrep haproxy)</span><br><span class="line">    if [[ \$check_code == &quot;&quot; ]]; then</span><br><span class="line">        err=\$(expr \$err + 1)</span><br><span class="line">        sleep 1</span><br><span class="line">        continue</span><br><span class="line">    else</span><br><span class="line">        err=0</span><br><span class="line">        break</span><br><span class="line">    fi</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line">if [[ \$err != &quot;0&quot; ]]; then</span><br><span class="line">    echo &quot;systemctl stop keepalived&quot;</span><br><span class="line">    /usr/bin/systemctl stop keepalived</span><br><span class="line">    exit 1</span><br><span class="line">else</span><br><span class="line">    exit 0</span><br><span class="line">fi</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">给脚本授权</span></span><br><span class="line"></span><br><span class="line">chmod +x /etc/keepalived/check_apiserver.sh</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这段脚本是一个简单的bash脚本，主要用来检查是否有名为haproxy的进程正在运行。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 脚本的主要逻辑如下：</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">1. 首先设置一个变量err为0，用来记录错误次数。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2. 使用一个循环，在循环内部执行以下操作：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   a. 使用pgrep命令检查是否有名为haproxy的进程在运行。如果不存在该进程，将err加1，并暂停1秒钟，然后继续下一次循环。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   b. 如果存在haproxy进程，将err重置为0，并跳出循环。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">3. 检查err的值，如果不为0，表示检查失败，输出一条错误信息并执行“systemctl stop keepalived”命令停止keepalived进程，并退出脚本返回1。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">4. 如果err的值为0，表示检查成功，退出脚本返回0。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 该脚本的主要作用是检查是否存在运行中的haproxy进程，如果无法检测到haproxy进程，将停止keepalived进程并返回错误状态。如果haproxy进程存在，则返回成功状态。这个脚本可能是作为一个健康检查脚本的一部分，在确保haproxy服务可用的情况下，才继续运行其他操作。</span></span></span><br></pre></td></tr></table></figure>

<h3 id="5-2-7启动服务"><a href="#5-2-7启动服务" class="headerlink" title="5.2.7启动服务"></a>5.2.7启动服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">用于重新加载systemd管理的单位文件。当你新增或修改了某个单位文件（如.service文件、.socket文件等），需要运行该命令来刷新systemd对该文件的配置。</span></span><br><span class="line">systemctl enable --now haproxy.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启用并立即启动haproxy.service单元。haproxy.service是haproxy守护进程的systemd服务单元。</span></span><br><span class="line">systemctl enable --now keepalived.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启用并立即启动keepalived.service单元。keepalived.service是keepalived守护进程的systemd服务单元。</span></span><br><span class="line">systemctl status haproxy.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">haproxy.service单元的当前状态，包括运行状态、是否启用等信息。</span></span><br><span class="line">systemctl status keepalived.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">keepalived.service单元的当前状态，包括运行状态、是否启用等信息。</span></span><br></pre></td></tr></table></figure>

<h3 id="5-2-8测试高可用"><a href="#5-2-8测试高可用" class="headerlink" title="5.2.8测试高可用"></a>5.2.8测试高可用</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">能ping同</span></span><br><span class="line">[root@k8s-node02 ~]# ping 192.168.1.36</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">能telnet访问</span></span><br><span class="line">[root@k8s-node02 ~]# telnet 192.168.1.36 9443</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">关闭主节点，看vip是否漂移到备节点</span></span><br></pre></td></tr></table></figure>

<h1 id="6-k8s组件配置"><a href="#6-k8s组件配置" class="headerlink" title="6.k8s组件配置"></a>6.k8s组件配置</h1><p>所有k8s节点创建以下目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /etc/kubernetes/manifests/ /etc/systemd/system/kubelet.service.d /var/lib/kubelet /var/log/kubernetes</span><br></pre></td></tr></table></figure>

<h2 id="6-1-创建apiserver（所有master节点）"><a href="#6-1-创建apiserver（所有master节点）" class="headerlink" title="6.1.创建apiserver（所有master节点）"></a>6.1.创建apiserver（所有master节点）</h2><h3 id="6-1-1master01节点配置"><a href="#6-1-1master01节点配置" class="headerlink" title="6.1.1master01节点配置"></a>6.1.1master01节点配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kube-apiserver.service &lt;&lt; EOF</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kube-apiserver \\</span><br><span class="line">      --v=2  \\</span><br><span class="line">      --allow-privileged=true  \\</span><br><span class="line">      --bind-address=0.0.0.0  \\</span><br><span class="line">      --secure-port=6443  \\</span><br><span class="line">      --advertise-address=192.168.1.31 \\</span><br><span class="line">      --service-cluster-ip-range=10.96.0.0/12,fd00:1111::/112  \\</span><br><span class="line">      --service-node-port-range=30000-32767  \\</span><br><span class="line">      --etcd-servers=https://192.168.1.31:2379,https://192.168.1.32:2379,https://192.168.1.33:2379 \\</span><br><span class="line">      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  \\</span><br><span class="line">      --etcd-certfile=/etc/etcd/ssl/etcd.pem  \\</span><br><span class="line">      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  \\</span><br><span class="line">      --client-ca-file=/etc/kubernetes/pki/ca.pem  \\</span><br><span class="line">      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  \\</span><br><span class="line">      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  \\</span><br><span class="line">      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  \\</span><br><span class="line">      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  \\</span><br><span class="line">      --service-account-key-file=/etc/kubernetes/pki/sa.pub  \\</span><br><span class="line">      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key  \\</span><br><span class="line">      --service-account-issuer=https://kubernetes.default.svc.cluster.local \\</span><br><span class="line">      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  \\</span><br><span class="line">      --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  \</span><br><span class="line">      --authorization-mode=Node,RBAC  \\</span><br><span class="line">      --enable-bootstrap-token-auth=true  \\</span><br><span class="line">      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  \\</span><br><span class="line">      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  \\</span><br><span class="line">      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  \\</span><br><span class="line">      --requestheader-allowed-names=aggregator  \\</span><br><span class="line">      --requestheader-group-headers=X-Remote-Group  \\</span><br><span class="line">      --requestheader-extra-headers-prefix=X-Remote-Extra-  \\</span><br><span class="line">      --requestheader-username-headers=X-Remote-User \\</span><br><span class="line">      --enable-aggregator-routing=true</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=10s</span><br><span class="line">LimitNOFILE=65535</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="6-1-2master02节点配置"><a href="#6-1-2master02节点配置" class="headerlink" title="6.1.2master02节点配置"></a>6.1.2master02节点配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kube-apiserver.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kube-apiserver \\</span><br><span class="line">      --v=2  \\</span><br><span class="line">      --allow-privileged=true  \\</span><br><span class="line">      --bind-address=0.0.0.0  \\</span><br><span class="line">      --secure-port=6443  \\</span><br><span class="line">      --advertise-address=192.168.1.32 \\</span><br><span class="line">      --service-cluster-ip-range=10.96.0.0/12,fd00:1111::/112  \\</span><br><span class="line">      --service-node-port-range=30000-32767  \\</span><br><span class="line">      --etcd-servers=https://192.168.1.31:2379,https://192.168.1.32:2379,https://192.168.1.33:2379 \\</span><br><span class="line">      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  \\</span><br><span class="line">      --etcd-certfile=/etc/etcd/ssl/etcd.pem  \\</span><br><span class="line">      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  \\</span><br><span class="line">      --client-ca-file=/etc/kubernetes/pki/ca.pem  \\</span><br><span class="line">      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  \\</span><br><span class="line">      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  \\</span><br><span class="line">      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  \\</span><br><span class="line">      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  \\</span><br><span class="line">      --service-account-key-file=/etc/kubernetes/pki/sa.pub  \\</span><br><span class="line">      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key  \\</span><br><span class="line">      --service-account-issuer=https://kubernetes.default.svc.cluster.local \\</span><br><span class="line">      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  \\</span><br><span class="line">      --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  \\</span><br><span class="line">      --authorization-mode=Node,RBAC  \\</span><br><span class="line">      --enable-bootstrap-token-auth=true  \\</span><br><span class="line">      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  \\</span><br><span class="line">      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  \\</span><br><span class="line">      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  \\</span><br><span class="line">      --requestheader-allowed-names=aggregator  \\</span><br><span class="line">      --requestheader-group-headers=X-Remote-Group  \\</span><br><span class="line">      --requestheader-extra-headers-prefix=X-Remote-Extra-  \\</span><br><span class="line">      --requestheader-username-headers=X-Remote-User \\</span><br><span class="line">      --enable-aggregator-routing=true</span><br><span class="line"></span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=10s</span><br><span class="line">LimitNOFILE=65535</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="6-1-3master03节点配置"><a href="#6-1-3master03节点配置" class="headerlink" title="6.1.3master03节点配置"></a>6.1.3master03节点配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kube-apiserver.service  &lt;&lt; EOF</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kube-apiserver \\</span><br><span class="line">      --v=2  \\</span><br><span class="line">      --allow-privileged=true  \\</span><br><span class="line">      --bind-address=0.0.0.0  \\</span><br><span class="line">      --secure-port=6443  \\</span><br><span class="line">      --advertise-address=192.168.1.33 \\</span><br><span class="line">      --service-cluster-ip-range=10.96.0.0/12,fd00:1111::/112  \\</span><br><span class="line">      --service-node-port-range=30000-32767  \\</span><br><span class="line">      --etcd-servers=https://192.168.1.31:2379,https://192.168.1.32:2379,https://192.168.1.33:2379 \\</span><br><span class="line">      --etcd-cafile=/etc/etcd/ssl/etcd-ca.pem  \\</span><br><span class="line">      --etcd-certfile=/etc/etcd/ssl/etcd.pem  \\</span><br><span class="line">      --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem  \\</span><br><span class="line">      --client-ca-file=/etc/kubernetes/pki/ca.pem  \\</span><br><span class="line">      --tls-cert-file=/etc/kubernetes/pki/apiserver.pem  \\</span><br><span class="line">      --tls-private-key-file=/etc/kubernetes/pki/apiserver-key.pem  \\</span><br><span class="line">      --kubelet-client-certificate=/etc/kubernetes/pki/apiserver.pem  \\</span><br><span class="line">      --kubelet-client-key=/etc/kubernetes/pki/apiserver-key.pem  \\</span><br><span class="line">      --service-account-key-file=/etc/kubernetes/pki/sa.pub  \\</span><br><span class="line">      --service-account-signing-key-file=/etc/kubernetes/pki/sa.key  \\</span><br><span class="line">      --service-account-issuer=https://kubernetes.default.svc.cluster.local \\</span><br><span class="line">      --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname  \\</span><br><span class="line">      --enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,NodeRestriction,ResourceQuota  \\</span><br><span class="line">      --authorization-mode=Node,RBAC  \\</span><br><span class="line">      --enable-bootstrap-token-auth=true  \\</span><br><span class="line">      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem  \\</span><br><span class="line">      --proxy-client-cert-file=/etc/kubernetes/pki/front-proxy-client.pem  \\</span><br><span class="line">      --proxy-client-key-file=/etc/kubernetes/pki/front-proxy-client-key.pem  \\</span><br><span class="line">      --requestheader-allowed-names=aggregator  \\</span><br><span class="line">      --requestheader-group-headers=X-Remote-Group  \\</span><br><span class="line">      --requestheader-extra-headers-prefix=X-Remote-Extra-  \\</span><br><span class="line">      --requestheader-username-headers=X-Remote-User \\</span><br><span class="line">      --enable-aggregator-routing=true</span><br><span class="line"></span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=10s</span><br><span class="line">LimitNOFILE=65535</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">该配置文件是用于定义Kubernetes API Server的systemd服务的配置。systemd是一个用于启动和管理Linux系统服务的守护进程。</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">- Description: 服务的描述信息，用于显示在日志和系统管理工具中。</span><br><span class="line">- Documentation: 提供关于服务的文档链接。</span><br><span class="line">- After: 规定服务依赖于哪些其他服务或单元。在这个例子中，API Server服务在网络目标启动之后启动。</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">- ExecStart: 定义服务的命令行参数和命令。这里指定了API Server的启动命令，包括各种参数选项。</span><br><span class="line">- Restart: 指定当服务退出时应该如何重新启动。在这个例子中，服务在失败时将被重新启动。</span><br><span class="line">- RestartSec: 指定两次重新启动之间的等待时间。</span><br><span class="line">- LimitNOFILE: 指定进程可以打开的文件描述符的最大数量。</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">- WantedBy: 指定服务应该安装到哪个系统目标。在这个例子中，服务将被安装到multi-user.target目标，以便在多用户模式下启动。</span><br><span class="line"></span><br><span class="line">上述配置文件中定义的kube-apiserver服务将以指定的参数运行，这些参数包括：</span><br><span class="line"></span><br><span class="line">- `--v=2` 指定日志级别为2，打印详细的API Server日志。</span><br><span class="line">- `--allow-privileged=true` 允许特权容器运行。</span><br><span class="line">- `--bind-address=0.0.0.0` 绑定API Server监听的IP地址。</span><br><span class="line">- `--secure-port=6443` 指定API Server监听的安全端口。</span><br><span class="line">- `--advertise-address=192.168.1.31` 广告API Server的地址。</span><br><span class="line">- `--service-cluster-ip-range=10.96.0.0/12,fd00:1111::/112` 指定服务CIDR范围。</span><br><span class="line">- `--service-node-port-range=30000-32767` 指定NodePort的范围。</span><br><span class="line">- `--etcd-servers=https://192.168.1.31:2379,https://192.168.1.32:2379,https://192.168.1.33:2379` 指定etcd服务器的地址。</span><br><span class="line">- `--etcd-cafile` 指定etcd服务器的CA证书。</span><br><span class="line">- `--etcd-certfile` 指定etcd服务器的证书。</span><br><span class="line">- `--etcd-keyfile` 指定etcd服务器的私钥。</span><br><span class="line">- `--client-ca-file` 指定客户端CA证书。</span><br><span class="line">- `--tls-cert-file` 指定服务的证书。</span><br><span class="line">- `--tls-private-key-file` 指定服务的私钥。</span><br><span class="line">- `--kubelet-client-certificate` 和 `--kubelet-client-key` 指定与kubelet通信的客户端证书和私钥。</span><br><span class="line">- `--service-account-key-file` 指定服务账户公钥文件。</span><br><span class="line">- `--service-account-signing-key-file` 指定服务账户签名密钥文件。</span><br><span class="line">- `--service-account-issuer` 指定服务账户的发布者。</span><br><span class="line">- `--kubelet-preferred-address-types` 指定kubelet通信时的首选地址类型。</span><br><span class="line">- `--enable-admission-plugins` 启用一系列准入插件。</span><br><span class="line">- `--authorization-mode` 指定授权模式。</span><br><span class="line">- `--enable-bootstrap-token-auth` 启用引导令牌认证。</span><br><span class="line">- `--requestheader-client-ca-file` 指定请求头中的客户端CA证书。</span><br><span class="line">- `--proxy-client-cert-file` 和 `--proxy-client-key-file` 指定代理客户端的证书和私钥。</span><br><span class="line">- `--requestheader-allowed-names` 指定请求头中允许的名字。</span><br><span class="line">- `--requestheader-group-headers` 指定请求头中的组头。</span><br><span class="line">- `--requestheader-extra-headers-prefix` 指定请求头中的额外头前缀。</span><br><span class="line">- `--requestheader-username-headers` 指定请求头中的用户名头。</span><br><span class="line">- `--enable-aggregator-routing` 启用聚合路由。</span><br><span class="line"></span><br><span class="line">整个配置文件为Kubernetes API Server提供了必要的参数，以便正确地启动和运行。</span><br></pre></td></tr></table></figure>


<h3 id="6-1-4启动apiserver（所有master节点）"><a href="#6-1-4启动apiserver（所有master节点）" class="headerlink" title="6.1.4启动apiserver（所有master节点）"></a>6.1.4启动apiserver（所有master节点）</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">用于重新加载systemd管理的单位文件。当你新增或修改了某个单位文件（如.service文件、.socket文件等），需要运行该命令来刷新systemd对该文件的配置。</span></span><br><span class="line"></span><br><span class="line">systemctl enable --now kube-apiserver.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启用并立即启动kube-apiserver.service单元。kube-apiserver.service是kube-apiserver守护进程的systemd服务单元。</span></span><br><span class="line"></span><br><span class="line">systemctl restart kube-apiserver.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启kube-apiserver.service单元，即重新启动etcd守护进程。</span></span><br><span class="line"></span><br><span class="line">systemctl status kube-apiserver.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kube-apiserver.service单元的当前状态，包括运行状态、是否启用等信息。</span></span><br></pre></td></tr></table></figure>

<h2 id="6-2-配置kube-controller-manager-service"><a href="#6-2-配置kube-controller-manager-service" class="headerlink" title="6.2.配置kube-controller-manager service"></a>6.2.配置kube-controller-manager service</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">所有master节点配置，且配置相同</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">172.16.0.0/12为pod网段，按需求设置你自己的网段</span></span><br><span class="line"></span><br><span class="line">cat &gt; /usr/lib/systemd/system/kube-controller-manager.service &lt;&lt; EOF</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kube-controller-manager \\</span><br><span class="line">      --v=2 \\</span><br><span class="line">      --bind-address=0.0.0.0 \\</span><br><span class="line">      --root-ca-file=/etc/kubernetes/pki/ca.pem \\</span><br><span class="line">      --cluster-signing-cert-file=/etc/kubernetes/pki/ca.pem \\</span><br><span class="line">      --cluster-signing-key-file=/etc/kubernetes/pki/ca-key.pem \\</span><br><span class="line">      --service-account-private-key-file=/etc/kubernetes/pki/sa.key \\</span><br><span class="line">      --kubeconfig=/etc/kubernetes/controller-manager.kubeconfig \\</span><br><span class="line">      --leader-elect=true \\</span><br><span class="line">      --use-service-account-credentials=true \\</span><br><span class="line">      --node-monitor-grace-period=40s \\</span><br><span class="line">      --node-monitor-period=5s \\</span><br><span class="line">      --controllers=*,bootstrapsigner,tokencleaner \\</span><br><span class="line">      --allocate-node-cidrs=true \\</span><br><span class="line">      --service-cluster-ip-range=10.96.0.0/12,fd00:1111::/112 \\</span><br><span class="line">      --cluster-cidr=172.16.0.0/12,fc00:2222::/112 \\</span><br><span class="line">      --node-cidr-mask-size-ipv4=24 \\</span><br><span class="line">      --node-cidr-mask-size-ipv6=120 \\</span><br><span class="line">      --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem</span><br><span class="line"></span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=10s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">这是一个用于启动 Kubernetes 控制器管理器的 systemd 服务单元文件。下面是对每个部分的详细解释：</span><br><span class="line"></span><br><span class="line">[Unit]：单元的基本信息部分，用于描述和标识这个服务单元。</span><br><span class="line">Description：服务单元的描述信息，说明了该服务单元的作用，这里是 Kubernetes 控制器管理器。</span><br><span class="line">Documentation：可选项，提供了关于该服务单元的文档链接。</span><br><span class="line">After：定义了该服务单元在哪些其他单元之后启动，这里是 network.target，即在网络服务启动之后启动。</span><br><span class="line"></span><br><span class="line">[Service]：定义了服务的运行参数和行为。</span><br><span class="line">ExecStart：指定服务启动时执行的命令，这里是 /usr/local/bin/kube-controller-manager，并通过后续的行继续传递了一系列的参数设置。</span><br><span class="line">Restart：定义了服务在退出后的重新启动策略，这里设置为 always，表示总是重新启动服务。</span><br><span class="line">RestartSec：定义了重新启动服务的时间间隔，这里设置为 10 秒。</span><br><span class="line"></span><br><span class="line">[Install]：定义了如何安装和启用服务单元。</span><br><span class="line">WantedBy：指定了服务单元所属的 target，这里是 multi-user.target，表示启动多用户模式下的服务。</span><br><span class="line">在 ExecStart 中传递的参数说明如下：</span><br><span class="line"></span><br><span class="line">--v=2：设置日志的详细级别为 2。</span><br><span class="line">--bind-address=0.0.0.0：绑定的 IP 地址，用于监听 Kubernetes 控制平面的请求，这里设置为 0.0.0.0，表示监听所有网络接口上的请求。</span><br><span class="line">--root-ca-file：根证书文件的路径，用于验证其他组件的证书。</span><br><span class="line">--cluster-signing-cert-file：用于签名集群证书的证书文件路径。</span><br><span class="line">--cluster-signing-key-file：用于签名集群证书的私钥文件路径。</span><br><span class="line">--service-account-private-key-file：用于签名服务账户令牌的私钥文件路径。</span><br><span class="line">--kubeconfig：kubeconfig 文件的路径，包含了与 Kubernetes API 服务器通信所需的配置信息。</span><br><span class="line">--leader-elect=true：启用 Leader 选举机制，确保只有一个控制器管理器作为 leader 在运行。</span><br><span class="line">--use-service-account-credentials=true：使用服务账户的凭据进行认证和授权。</span><br><span class="line">--node-monitor-grace-period=40s：节点监控的优雅退出时间，节点长时间不响应时会触发节点驱逐。</span><br><span class="line">--node-monitor-period=5s：节点监控的检测周期，用于检测节点是否正常运行。</span><br><span class="line">--controllers：指定要运行的控制器类型，在这里使用了通配符 *，表示运行所有的控制器，同时还包括了 bootstrapsigner 和 tokencleaner 控制器。</span><br><span class="line">--allocate-node-cidrs=true：为节点分配 CIDR 子网，用于分配 Pod 网络地址。</span><br><span class="line">--service-cluster-ip-range：定义 Service 的 IP 范围，这里设置为 10.96.0.0/12 和 fd00::/108。</span><br><span class="line">--cluster-cidr：定义集群的 CIDR 范围，这里设置为 172.16.0.0/12 和 fc00::/48。</span><br><span class="line">--node-cidr-mask-size-ipv4：分配给每个节点的 IPv4 子网掩码大小，默认是 24。</span><br><span class="line">--node-cidr-mask-size-ipv6：分配给每个节点的 IPv6 子网掩码大小，默认是 120。</span><br><span class="line">--requestheader-client-ca-file：设置请求头中客户端 CA 的证书文件路径，用于认证请求头中的 CA 证书。</span><br><span class="line"></span><br><span class="line">这个服务单元文件描述了 Kubernetes 控制器管理器的启动参数和行为，并且定义了服务的依赖关系和重新启动策略。通过 systemd 启动该服务单元，即可启动 Kubernetes 控制器管理器组件。</span><br></pre></td></tr></table></figure>
<h3 id="6-2-1启动kube-controller-manager，并查看状态"><a href="#6-2-1启动kube-controller-manager，并查看状态" class="headerlink" title="6.2.1启动kube-controller-manager，并查看状态"></a>6.2.1启动kube-controller-manager，并查看状态</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">用于重新加载systemd管理的单位文件。当你新增或修改了某个单位文件（如.service文件、.socket文件等），需要运行该命令来刷新systemd对该文件的配置。</span></span><br><span class="line"></span><br><span class="line">systemctl enable --now kube-controller-manager.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启用并立即启动kube-controller-manager.service单元。kube-controller-manager.service是kube-controller-manager守护进程的systemd服务单元。</span></span><br><span class="line"></span><br><span class="line">systemctl restart kube-controller-manager.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启kube-controller-manager.service单元，即重新启动etcd守护进程。</span></span><br><span class="line"></span><br><span class="line">systemctl status kube-controller-manager.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kube-controller-manager.service单元的当前状态，包括运行状态、是否启用等信息。</span></span><br></pre></td></tr></table></figure>

<h2 id="6-3-配置kube-scheduler-service"><a href="#6-3-配置kube-scheduler-service" class="headerlink" title="6.3.配置kube-scheduler service"></a>6.3.配置kube-scheduler service</h2><h3 id="6-3-1所有master节点配置，且配置相同"><a href="#6-3-1所有master节点配置，且配置相同" class="headerlink" title="6.3.1所有master节点配置，且配置相同"></a>6.3.1所有master节点配置，且配置相同</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kube-scheduler.service &lt;&lt; EOF</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kube-scheduler \\</span><br><span class="line">      --v=2 \\</span><br><span class="line">      --bind-address=0.0.0.0 \\</span><br><span class="line">      --leader-elect=true \\</span><br><span class="line">      --kubeconfig=/etc/kubernetes/scheduler.kubeconfig</span><br><span class="line"></span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=10s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>
<p>参数</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">这是一个用于启动 Kubernetes 调度器的 systemd 服务单元文件。下面是对每个部分的详细解释：</span><br><span class="line"></span><br><span class="line">[Unit]：单元的基本信息部分，用于描述和标识这个服务单元。</span><br><span class="line">Description：服务单元的描述信息，说明了该服务单元的作用，这里是 Kubernetes 调度器。</span><br><span class="line">Documentation：可选项，提供了关于该服务单元的文档链接。</span><br><span class="line">After：定义了该服务单元在哪些其他单元之后启动，这里是 network.target，即在网络服务启动之后启动。</span><br><span class="line"></span><br><span class="line">[Service]：定义了服务的运行参数和行为。</span><br><span class="line">ExecStart：指定服务启动时执行的命令，这里是 /usr/local/bin/kube-scheduler，并通过后续的行继续传递了一系列的参数设置。</span><br><span class="line">Restart：定义了服务在退出后的重新启动策略，这里设置为 always，表示总是重新启动服务。</span><br><span class="line">RestartSec：定义了重新启动服务的时间间隔，这里设置为 10 秒。</span><br><span class="line"></span><br><span class="line">[Install]：定义了如何安装和启用服务单元。</span><br><span class="line">WantedBy：指定了服务单元所属的 target，这里是 multi-user.target，表示启动多用户模式下的服务。</span><br><span class="line"></span><br><span class="line">在 ExecStart 中传递的参数说明如下：</span><br><span class="line"></span><br><span class="line">--v=2：设置日志的详细级别为 2。</span><br><span class="line">--bind-address=0.0.0.0：绑定的 IP 地址，用于监听 Kubernetes 控制平面的请求，这里设置为 0.0.0.0，表示监听所有网络接口上的请求。</span><br><span class="line">--leader-elect=true：启用 Leader 选举机制，确保只有一个调度器作为 leader 在运行。</span><br><span class="line">--kubeconfig=/etc/kubernetes/scheduler.kubeconfig：kubeconfig 文件的路径，包含了与 Kubernetes API 服务器通信所需的配置信息。</span><br><span class="line"></span><br><span class="line">这个服务单元文件描述了 Kubernetes 调度器的启动参数和行为，并且定义了服务的依赖关系和重新启动策略。通过 systemd 启动该服务单元，即可启动 Kubernetes 调度器组件。</span><br></pre></td></tr></table></figure>
<h3 id="6-3-2启动并查看服务状态"><a href="#6-3-2启动并查看服务状态" class="headerlink" title="6.3.2启动并查看服务状态"></a>6.3.2启动并查看服务状态</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">用于重新加载systemd管理的单位文件。当你新增或修改了某个单位文件（如.service文件、.socket文件等），需要运行该命令来刷新systemd对该文件的配置。</span></span><br><span class="line"></span><br><span class="line">systemctl enable --now kube-scheduler.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启用并立即启动kube-scheduler.service单元。kube-scheduler.service是kube-scheduler守护进程的systemd服务单元。</span></span><br><span class="line"></span><br><span class="line">systemctl restart kube-scheduler.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启kube-scheduler.service单元，即重新启动etcd守护进程。</span></span><br><span class="line"></span><br><span class="line">systemctl status kube-scheduler.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kube-scheduler.service单元的当前状态，包括运行状态、是否启用等信息。</span></span><br></pre></td></tr></table></figure>

<h1 id="7-TLS-Bootstrapping配置"><a href="#7-TLS-Bootstrapping配置" class="headerlink" title="7.TLS Bootstrapping配置"></a>7.TLS Bootstrapping配置</h1><h2 id="7-1在master01上配置"><a href="#7-1在master01上配置" class="headerlink" title="7.1在master01上配置"></a>7.1在master01上配置</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">在《5.高可用配置》选择使用那种高可用方案</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">若使用 haproxy、keepalived 那么为 `--server=https://192.168.1.36:8443`</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">若使用 nginx方案，那么为 `--server=https://127.0.0.1:8443`</span></span><br><span class="line"></span><br><span class="line">cd bootstrap</span><br><span class="line"></span><br><span class="line">kubectl config set-cluster kubernetes     \</span><br><span class="line">--certificate-authority=/etc/kubernetes/pki/ca.pem     \</span><br><span class="line">--embed-certs=true     --server=https://127.0.0.1:8443     \</span><br><span class="line">--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这是一个使用 kubectl 命令设置 Kubernetes 集群配置的命令示例。下面是对每个选项的详细解释：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># config set-cluster kubernetes：指定要设置的集群名称为 &quot;kubernetes&quot;，表示要修改名为 &quot;kubernetes&quot; 的集群配置。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--certificate-authority=/etc/kubernetes/pki/ca.pem：指定证书颁发机构（CA）的证书文件路径，用于验证服务器证书的有效性。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--embed-certs=<span class="literal">true</span>：将证书文件嵌入到生成的 kubeconfig 文件中。这样可以避免在 kubeconfig 文件中引用外部证书文件。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--server=https://127.0.0.1:8443：指定 Kubernetes API 服务器的地址和端口，这里使用的是 https 协议和本地地址（127.0.0.1），端口号为 8443。你可以根据实际环境修改该参数。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig：指定 kubeconfig 文件的路径和名称，这里是 /etc/kubernetes/bootstrap-kubelet.kubeconfig。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过执行此命令，你可以设置名为 <span class="string">&quot;kubernetes&quot;</span> 的集群配置，并提供 CA 证书、API 服务器地址和端口，并将这些配置信息嵌入到 bootstrap-kubelet.kubeconfig 文件中。这个 kubeconfig 文件可以用于认证和授权 kubelet 组件与 Kubernetes API 服务器之间的通信。请确保路径和文件名与实际环境中的配置相匹配。</span></span><br><span class="line"></span><br><span class="line">kubectl config set-credentials tls-bootstrap-token-user     \</span><br><span class="line">--token=c8ad9c.2e4d610cf3e7426e \</span><br><span class="line">--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这是一个使用 kubectl 命令设置凭证信息的命令示例。下面是对每个选项的详细解释：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># config set-credentials tls-bootstrap-token-user：指定要设置的凭证名称为 &quot;tls-bootstrap-token-user&quot;，表示要修改名为 &quot;tls-bootstrap-token-user&quot; 的用户凭证配置。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--token=c8ad9c.2e4d610cf3e7426e：指定用户的身份验证令牌（token）。在这个示例中，令牌是 c8ad9c.2e4d610cf3e7426e。你可以根据实际情况修改该令牌。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig：指定 kubeconfig 文件的路径和名称，这里是 /etc/kubernetes/bootstrap-kubelet.kubeconfig。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过执行此命令，你可以设置名为 <span class="string">&quot;tls-bootstrap-token-user&quot;</span> 的用户凭证，并将令牌信息加入到 bootstrap-kubelet.kubeconfig 文件中。这个 kubeconfig 文件可以用于认证和授权 kubelet 组件与 Kubernetes API 服务器之间的通信。请确保路径和文件名与实际环境中的配置相匹配。</span></span><br><span class="line"></span><br><span class="line">kubectl config set-context tls-bootstrap-token-user@kubernetes     \</span><br><span class="line">--cluster=kubernetes     \</span><br><span class="line">--user=tls-bootstrap-token-user     \</span><br><span class="line">--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这是一个使用 kubectl 命令设置上下文信息的命令示例。下面是对每个选项的详细解释：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># config set-context tls-bootstrap-token-user@kubernetes：指定要设置的上下文名称为 &quot;tls-bootstrap-token-user@kubernetes&quot;，表示要修改名为 &quot;tls-bootstrap-token-user@kubernetes&quot; 的上下文配置。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--cluster=kubernetes：指定上下文关联的集群名称为 <span class="string">&quot;kubernetes&quot;</span>，表示使用名为 <span class="string">&quot;kubernetes&quot;</span> 的集群配置。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--user=tls-bootstrap-token-user：指定上下文关联的用户凭证名称为 <span class="string">&quot;tls-bootstrap-token-user&quot;</span>，表示使用名为 <span class="string">&quot;tls-bootstrap-token-user&quot;</span> 的用户凭证配置。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig：指定 kubeconfig 文件的路径和名称，这里是 /etc/kubernetes/bootstrap-kubelet.kubeconfig。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过执行此命令，你可以设置名为 <span class="string">&quot;tls-bootstrap-token-user@kubernetes&quot;</span> 的上下文，并将其关联到名为 <span class="string">&quot;kubernetes&quot;</span> 的集群配置和名为 <span class="string">&quot;tls-bootstrap-token-user&quot;</span> 的用户凭证配置。这样，bootstrap-kubelet.kubeconfig 文件就包含了完整的上下文信息，可以用于指定与 Kubernetes 集群建立连接时要使用的集群和凭证。请确保路径和文件名与实际环境中的配置相匹配。</span></span><br><span class="line"></span><br><span class="line">kubectl config use-context tls-bootstrap-token-user@kubernetes     \</span><br><span class="line">--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这是一个使用 kubectl 命令设置当前上下文的命令示例。下面是对每个选项的详细解释：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># config use-context tls-bootstrap-token-user@kubernetes：指定要使用的上下文名称为 &quot;tls-bootstrap-token-user@kubernetes&quot;，表示要将当前上下文切换为名为 &quot;tls-bootstrap-token-user@kubernetes&quot; 的上下文。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig：指定 kubeconfig 文件的路径和名称，这里是 /etc/kubernetes/bootstrap-kubelet.kubeconfig。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过执行此命令，你可以将当前上下文设置为名为 <span class="string">&quot;tls-bootstrap-token-user@kubernetes&quot;</span> 的上下文。这样，当你执行其他 kubectl 命令时，它们将使用该上下文与 Kubernetes 集群进行交互。请确保路径和文件名与实际环境中的配置相匹配。</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">token的位置在bootstrap.secret.yaml，如果修改的话到这个文件修改</span></span><br><span class="line">mkdir -p /root/.kube ; cp /etc/kubernetes/admin.kubeconfig /root/.kube/config</span><br></pre></td></tr></table></figure>

<h2 id="7-2查看集群状态，没问题的话继续后续操作"><a href="#7-2查看集群状态，没问题的话继续后续操作" class="headerlink" title="7.2查看集群状态，没问题的话继续后续操作"></a>7.2查看集群状态，没问题的话继续后续操作</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">1.28 版本只能查看到一个etcd 属于正常现象</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="built_in">export</span> ETCDCTL_API=3</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">etcdctl --endpoints=<span class="string">&quot;192.168.1.33:2379,192.168.1.32:2379,192.168.1.31:2379&quot;</span> --cacert=/etc/kubernetes/pki/etcd/etcd-ca.pem --cert=/etc/kubernetes/pki/etcd/etcd.pem --key=/etc/kubernetes/pki/etcd/etcd-key.pem  endpoint status --write-out=table</span></span><br><span class="line"></span><br><span class="line">kubectl get cs</span><br><span class="line">Warning: v1 ComponentStatus is deprecated in v1.19+</span><br><span class="line">NAME                 STATUS    MESSAGE   ERROR</span><br><span class="line">scheduler            Healthy   ok        </span><br><span class="line">controller-manager   Healthy   ok        </span><br><span class="line">etcd-0               Healthy   ok </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">切记执行，别忘记！！！</span></span><br><span class="line">kubectl create -f bootstrap.secret.yaml</span><br></pre></td></tr></table></figure>

<h1 id="8-node节点配置"><a href="#8-node节点配置" class="headerlink" title="8.node节点配置"></a>8.node节点配置</h1><h2 id="8-1-在master01上将证书复制到node节点"><a href="#8-1-在master01上将证书复制到node节点" class="headerlink" title="8.1.在master01上将证书复制到node节点"></a>8.1.在master01上将证书复制到node节点</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /etc/kubernetes/</span><br><span class="line"> </span><br><span class="line">for NODE in k8s-master02 k8s-master03 k8s-node01 k8s-node02; do ssh $NODE mkdir -p /etc/kubernetes/pki; for FILE in pki/ca.pem pki/ca-key.pem pki/front-proxy-ca.pem bootstrap-kubelet.kubeconfig kube-proxy.kubeconfig; do scp /etc/kubernetes/$FILE $NODE:/etc/kubernetes/$&#123;FILE&#125;; done; done</span><br></pre></td></tr></table></figure>

<h2 id="8-2-kubelet配置"><a href="#8-2-kubelet配置" class="headerlink" title="8.2.kubelet配置"></a>8.2.kubelet配置</h2><p><strong>注意 ： 8.2.1 和 8.2.2 需要和 上方 2.1 和 2.2 对应起来</strong></p>
<h3 id="8-2-1当使用docker作为Runtime"><a href="#8-2-1当使用docker作为Runtime" class="headerlink" title="8.2.1当使用docker作为Runtime"></a>8.2.1当使用docker作为Runtime</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /usr/lib/systemd/system/kubelet.service &lt;&lt; EOF</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network-online.target firewalld.service cri-docker.service docker.socket containerd.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line">Requires=docker.socket containerd.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kubelet \\</span><br><span class="line">    --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig  \\</span><br><span class="line">    --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \\</span><br><span class="line">    --config=/etc/kubernetes/kubelet-conf.yml \\</span><br><span class="line">    --container-runtime-endpoint=unix:///run/cri-dockerd.sock  \\</span><br><span class="line">    --node-labels=node.kubernetes.io/node= </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这是一个表示 Kubernetes Kubelet 服务的 systemd 单位文件示例。下面是对每个节（[Unit]、[Service]、[Install]）的详细解释：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># [Unit]</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Description=Kubernetes Kubelet：指定了此单位文件对应的服务描述信息为 &quot;Kubernetes Kubelet&quot;。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Documentation=...：指定了对该服务的文档链接。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- After: 说明该服务在哪些其他服务之后启动，这里是在网络在线、firewalld服务和containerd服务后启动。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- Wants: 说明该服务想要的其他服务，这里是网络在线服务。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- Requires: 说明该服务需要的其他服务，这里是docker.socket和containerd.service。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">[Service]</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># ExecStart=/usr/local/bin/kubelet ...：指定了启动 Kubelet 服务的命令和参数。这里使用的是 /usr/local/bin/kubelet 命令，并传递了一系列参数来配置 Kubelet 的运行。这些参数包括：</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig：指定了用于引导 kubelet 的 kubeconfig 文件的路径和名称。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--kubeconfig=/etc/kubernetes/kubelet.kubeconfig：指定了 kubelet 的 kubeconfig 文件的路径和名称。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--config=/etc/kubernetes/kubelet-conf.yml：指定了 kubelet 的配置文件的路径和名称。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--container-runtime-endpoint=unix:///run/cri-dockerd.sock：指定了容器运行时接口的端点地址，这里使用的是 Docker 运行时（cri-dockerd）的 UNIX 套接字。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--node-labels=node.kubernetes.io/node=：指定了节点的标签。这里的示例只给节点添加了一个简单的标签 node.kubernetes.io/node=。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">[Install]</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># WantedBy=multi-user.target：指定了在 multi-user.target 被启动时，该服务应该被启用。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过这个单位文件，你可以配置 Kubelet 服务的启动参数，指定相关的配置文件和凭证文件，以及定义节点的标签。请确认路径和文件名与你的实际环境中的配置相匹配。</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">IPv6示例</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">若不使用IPv6那么忽略此项即可</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下方 --node-ip 更换为每个节点的IP即可</span></span><br><span class="line">cat &gt; /usr/lib/systemd/system/kubelet.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network-online.target firewalld.service cri-docker.service docker.socket containerd.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line">Requires=docker.socket containerd.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kubelet \\</span><br><span class="line">    --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig  \\</span><br><span class="line">    --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \\</span><br><span class="line">    --config=/etc/kubernetes/kubelet-conf.yml \\</span><br><span class="line">    --container-runtime-endpoint=unix:///run/cri-dockerd.sock  \\</span><br><span class="line">    --node-labels=node.kubernetes.io/node=   \\</span><br><span class="line">    --node-ip=192.168.1.31,2408:822a:245:8c01::fab</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<h3 id="8-2-2当使用Containerd作为Runtime-（推荐）"><a href="#8-2-2当使用Containerd作为Runtime-（推荐）" class="headerlink" title="8.2.2当使用Containerd作为Runtime （推荐）"></a>8.2.2当使用Containerd作为Runtime （推荐）</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /var/lib/kubelet /var/log/kubernetes /etc/systemd/system/kubelet.service.d /etc/kubernetes/manifests/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">所有k8s节点配置kubelet service</span></span><br><span class="line">cat &gt; /usr/lib/systemd/system/kubelet.service &lt;&lt; EOF</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network-online.target firewalld.service containerd.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line">Requires=containerd.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kubelet \\</span><br><span class="line">    --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig  \\</span><br><span class="line">    --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \\</span><br><span class="line">    --config=/etc/kubernetes/kubelet-conf.yml \\</span><br><span class="line">    --container-runtime-endpoint=unix:///run/containerd/containerd.sock  \\</span><br><span class="line">    --node-labels=node.kubernetes.io/node=</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这是一个表示 Kubernetes Kubelet 服务的 systemd 单位文件示例。与之前相比，添加了 After 和 Requires 字段来指定依赖关系。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># [Unit]</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Description=Kubernetes Kubelet：指定了此单位文件对应的服务描述信息为 &quot;Kubernetes Kubelet&quot;。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Documentation=...：指定了对该服务的文档链接。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- After: 说明该服务在哪些其他服务之后启动，这里是在网络在线、firewalld服务和containerd服务后启动。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- Wants: 说明该服务想要的其他服务，这里是网络在线服务。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- Requires: 说明该服务需要的其他服务，这里是docker.socket和containerd.service。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">[Service]</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># ExecStart=/usr/local/bin/kubelet ...：指定了启动 Kubelet 服务的命令和参数，与之前的示例相同。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">--container-runtime-endpoint=unix:///run/containerd/containerd.sock：修改了容器运行时接口的端点地址，将其更改为使用 containerd 运行时（通过 UNIX 套接字）。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">[Install]</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># WantedBy=multi-user.target：指定了在 multi-user.target 被启动时，该服务应该被启用。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过这个单位文件，你可以配置 Kubelet 服务的启动参数，并指定了它依赖的 containerd 服务。确保路径和文件名与你实际环境中的配置相匹配。</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">IPv6示例</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">若不使用IPv6那么忽略此项即可</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下方 --node-ip 更换为每个节点的IP即可</span></span><br><span class="line">cat &gt; /usr/lib/systemd/system/kubelet.service &lt;&lt; EOF</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network-online.target firewalld.service containerd.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line">Requires=containerd.service</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kubelet \\</span><br><span class="line">    --bootstrap-kubeconfig=/etc/kubernetes/bootstrap-kubelet.kubeconfig  \\</span><br><span class="line">    --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \\</span><br><span class="line">    --config=/etc/kubernetes/kubelet-conf.yml \\</span><br><span class="line">    --container-runtime-endpoint=unix:///run/containerd/containerd.sock  \\</span><br><span class="line">    --node-labels=node.kubernetes.io/node=  \\</span><br><span class="line">    --node-ip=192.168.1.31,2408:822a:245:8c01::fab</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>


<h3 id="8-2-3所有k8s节点创建kubelet的配置文件"><a href="#8-2-3所有k8s节点创建kubelet的配置文件" class="headerlink" title="8.2.3所有k8s节点创建kubelet的配置文件"></a>8.2.3所有k8s节点创建kubelet的配置文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/kubernetes/kubelet-conf.yml &lt;&lt;EOF</span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">address: 0.0.0.0</span><br><span class="line">port: 10250</span><br><span class="line">readOnlyPort: 10255</span><br><span class="line">authentication:</span><br><span class="line">  anonymous:</span><br><span class="line">    enabled: false</span><br><span class="line">  webhook:</span><br><span class="line">    cacheTTL: 2m0s</span><br><span class="line">    enabled: true</span><br><span class="line">  x509:</span><br><span class="line">    clientCAFile: /etc/kubernetes/pki/ca.pem</span><br><span class="line">authorization:</span><br><span class="line">  mode: Webhook</span><br><span class="line">  webhook:</span><br><span class="line">    cacheAuthorizedTTL: 5m0s</span><br><span class="line">    cacheUnauthorizedTTL: 30s</span><br><span class="line">cgroupDriver: systemd</span><br><span class="line">cgroupsPerQOS: true</span><br><span class="line">clusterDNS:</span><br><span class="line">- 10.96.0.10</span><br><span class="line">clusterDomain: cluster.local</span><br><span class="line">containerLogMaxFiles: 5</span><br><span class="line">containerLogMaxSize: 10Mi</span><br><span class="line">contentType: application/vnd.kubernetes.protobuf</span><br><span class="line">cpuCFSQuota: true</span><br><span class="line">cpuManagerPolicy: none</span><br><span class="line">cpuManagerReconcilePeriod: 10s</span><br><span class="line">enableControllerAttachDetach: true</span><br><span class="line">enableDebuggingHandlers: true</span><br><span class="line">enforceNodeAllocatable:</span><br><span class="line">- pods</span><br><span class="line">eventBurst: 10</span><br><span class="line">eventRecordQPS: 5</span><br><span class="line">evictionHard:</span><br><span class="line">  imagefs.available: 15%</span><br><span class="line">  memory.available: 100Mi</span><br><span class="line">  nodefs.available: 10%</span><br><span class="line">  nodefs.inodesFree: 5%</span><br><span class="line">evictionPressureTransitionPeriod: 5m0s</span><br><span class="line">failSwapOn: true</span><br><span class="line">fileCheckFrequency: 20s</span><br><span class="line">hairpinMode: promiscuous-bridge</span><br><span class="line">healthzBindAddress: 127.0.0.1</span><br><span class="line">healthzPort: 10248</span><br><span class="line">httpCheckFrequency: 20s</span><br><span class="line">imageGCHighThresholdPercent: 85</span><br><span class="line">imageGCLowThresholdPercent: 80</span><br><span class="line">imageMinimumGCAge: 2m0s</span><br><span class="line">iptablesDropBit: 15</span><br><span class="line">iptablesMasqueradeBit: 14</span><br><span class="line">kubeAPIBurst: 10</span><br><span class="line">kubeAPIQPS: 5</span><br><span class="line">makeIPTablesUtilChains: true</span><br><span class="line">maxOpenFiles: 1000000</span><br><span class="line">maxPods: 110</span><br><span class="line">nodeStatusUpdateFrequency: 10s</span><br><span class="line">oomScoreAdj: -999</span><br><span class="line">podPidsLimit: -1</span><br><span class="line">registryBurst: 10</span><br><span class="line">registryPullQPS: 5</span><br><span class="line">resolvConf: /etc/resolv.conf</span><br><span class="line">rotateCertificates: true</span><br><span class="line">runtimeRequestTimeout: 2m0s</span><br><span class="line">serializeImagePulls: true</span><br><span class="line">staticPodPath: /etc/kubernetes/manifests</span><br><span class="line">streamingConnectionIdleTimeout: 4h0m0s</span><br><span class="line">syncFrequency: 1m0s</span><br><span class="line">volumeStatsAggPeriod: 1m0s</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这是一个Kubelet的配置文件，用于配置Kubelet的各项参数。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># - apiVersion: kubelet.config.k8s.io/v1beta1：指定了配置文件的API版本为kubelet.config.k8s.io/v1beta1。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- kind: KubeletConfiguration：指定了配置类别为KubeletConfiguration。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- address: 0.0.0.0：指定了Kubelet监听的地址为0.0.0.0。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- port: 10250：指定了Kubelet监听的端口为10250。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- readOnlyPort: 10255：指定了只读端口为10255，用于提供只读的状态信息。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- authentication：指定了认证相关的配置信息。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - anonymous.enabled: <span class="literal">false</span>：禁用了匿名认证。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - webhook.enabled: <span class="literal">true</span>：启用了Webhook认证。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - x509.clientCAFile: /etc/kubernetes/pki/ca.pem：指定了X509证书的客户端CA文件路径。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- authorization：指定了授权相关的配置信息。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - mode: Webhook：指定了授权模式为Webhook。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - webhook.cacheAuthorizedTTL: 5m0s：指定了授权缓存时间段为5分钟。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - webhook.cacheUnauthorizedTTL: 30s：指定了未授权缓存时间段为30秒。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- cgroupDriver: systemd：指定了Cgroup驱动为systemd。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- cgroupsPerQOS: <span class="literal">true</span>：启用了每个QoS类别一个Cgroup的设置。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- clusterDNS: 指定了集群的DNS服务器地址列表。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - 10.96.0.10：指定了DNS服务器地址为10.96.0.10。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- clusterDomain: cluster.local：指定了集群的域名后缀为cluster.local。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- containerLogMaxFiles: 5：指定了容器日志文件保留的最大数量为5个。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- containerLogMaxSize: 10Mi：指定了容器日志文件的最大大小为10Mi。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- contentType: application/vnd.kubernetes.protobuf：指定了内容类型为protobuf。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- cpuCFSQuota: <span class="literal">true</span>：启用了CPU CFS Quota。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- cpuManagerPolicy: none：禁用了CPU Manager。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- cpuManagerReconcilePeriod: 10s：指定了CPU管理器的调整周期为10秒。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- enableControllerAttachDetach: <span class="literal">true</span>：启用了控制器的挂载和拆卸。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- enableDebuggingHandlers: <span class="literal">true</span>：启用了调试处理程序。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- enforceNodeAllocatable: 指定了强制节点可分配资源的列表。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - pods：强制节点可分配pods资源。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- eventBurst: 10：指定了事件突发的最大数量为10。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- eventRecordQPS: 5：指定了事件记录的最大请求量为5。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- evictionHard: 指定了驱逐硬性限制参数的配置信息。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - imagefs.available: 15%：指定了镜像文件系统可用空间的限制为15%。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - memory.available: 100Mi：指定了可用内存的限制为100Mi。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - nodefs.available: 10%：指定了节点文件系统可用空间的限制为10%。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">  - nodefs.inodesFree: 5%：指定了节点文件系统可用inode的限制为5%。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- evictionPressureTransitionPeriod: 5m0s：指定了驱逐压力转换的时间段为5分钟。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- failSwapOn: <span class="literal">true</span>：指定了在发生OOM时禁用交换分区。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- fileCheckFrequency: 20s：指定了文件检查频率为20秒。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- hairpinMode: promiscuous-bridge：设置了Hairpin Mode为<span class="string">&quot;promiscuous-bridge&quot;</span>。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- healthzBindAddress: 127.0.0.1：指定了健康检查的绑定地址为127.0.0.1。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- healthzPort: 10248：指定了健康检查的端口为10248。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- httpCheckFrequency: 20s：指定了HTTP检查的频率为20秒。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- imageGCHighThresholdPercent: 85：指定了镜像垃圾回收的上阈值为85%。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- imageGCLowThresholdPercent: 80：指定了镜像垃圾回收的下阈值为80%。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- imageMinimumGCAge: 2m0s：指定了镜像垃圾回收的最小时间为2分钟。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- iptablesDropBit: 15：指定了iptables的Drop Bit为15。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- iptablesMasqueradeBit: 14：指定了iptables的Masquerade Bit为14。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- kubeAPIBurst: 10：指定了KubeAPI的突发请求数量为10个。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- kubeAPIQPS: 5：指定了KubeAPI的每秒请求频率为5个。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- makeIPTablesUtilChains: <span class="literal">true</span>：指定了是否使用iptables工具链。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- maxOpenFiles: 1000000：指定了最大打开文件数为1000000。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- maxPods: 110：指定了最大的Pod数量为110。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- nodeStatusUpdateFrequency: 10s：指定了节点状态更新的频率为10秒。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- oomScoreAdj: -999：指定了OOM Score Adjustment为-999。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- podPidsLimit: -1：指定了Pod的PID限制为-1，表示无限制。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- registryBurst: 10：指定了Registry的突发请求数量为10个。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- registryPullQPS: 5：指定了Registry的每秒拉取请求数量为5个。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- resolvConf: /etc/resolv.conf：指定了resolv.conf的文件路径。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- rotateCertificates: <span class="literal">true</span>：指定了是否轮转证书。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- runtimeRequestTimeout: 2m0s：指定了运行时请求的超时时间为2分钟。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- serializeImagePulls: <span class="literal">true</span>：指定了是否序列化镜像拉取。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- staticPodPath: /etc/kubernetes/manifests：指定了静态Pod的路径。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- streamingConnectionIdleTimeout: 4h0m0s：指定了流式连接的空闲超时时间为4小时。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- syncFrequency: 1m0s：指定了同步频率为1分钟。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">- volumeStatsAggPeriod: 1m0s：指定了卷统计聚合周期为1分钟。</span></span><br></pre></td></tr></table></figure>

<h3 id="8-2-4启动kubelet"><a href="#8-2-4启动kubelet" class="headerlink" title="8.2.4启动kubelet"></a>8.2.4启动kubelet</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">systemctl daemon-reload</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">用于重新加载systemd管理的单位文件。当你新增或修改了某个单位文件（如.service文件、.socket文件等），需要运行该命令来刷新systemd对该文件的配置。</span></span><br><span class="line"></span><br><span class="line">systemctl enable --now kubelet.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启用并立即启动kubelet.service单元。kubelet.service是kubelet守护进程的systemd服务单元。</span></span><br><span class="line"></span><br><span class="line">systemctl restart kubelet.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启kubelet.service单元，即重新启动kubelet守护进程。</span></span><br><span class="line"></span><br><span class="line">systemctl status kubelet.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubelet.service单元的当前状态，包括运行状态、是否启用等信息。</span></span><br></pre></td></tr></table></figure>

<h3 id="8-2-5查看集群"><a href="#8-2-5查看集群" class="headerlink" title="8.2.5查看集群"></a>8.2.5查看集群</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# kubectl  get node</span><br><span class="line">NAME           STATUS   ROLES    AGE   VERSION</span><br><span class="line">k8s-master01   Ready    &lt;none&gt;   16s   v1.29.2</span><br><span class="line">k8s-master02   Ready    &lt;none&gt;   13s   v1.29.2</span><br><span class="line">k8s-master03   Ready    &lt;none&gt;   12s   v1.29.2</span><br><span class="line">k8s-node01     Ready    &lt;none&gt;   10s   v1.29.2</span><br><span class="line">k8s-node02     Ready    &lt;none&gt;   9s    v1.29.2</span><br><span class="line">[root@k8s-master01 ~]#</span><br></pre></td></tr></table></figure>

<h3 id="8-2-6查看容器运行时"><a href="#8-2-6查看容器运行时" class="headerlink" title="8.2.6查看容器运行时"></a>8.2.6查看容器运行时</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# kubectl describe node | grep Runtime</span><br><span class="line">  Container Runtime Version:  containerd://1.7.13</span><br><span class="line">  Container Runtime Version:  containerd://1.7.13</span><br><span class="line">  Container Runtime Version:  containerd://1.7.13</span><br><span class="line">  Container Runtime Version:  containerd://1.7.13</span><br><span class="line">  Container Runtime Version:  containerd://1.7.13</span><br><span class="line">[root@k8s-master01 ~]# kubectl describe node | grep Runtime</span><br><span class="line">  Container Runtime Version:  docker://25.0.3</span><br><span class="line">  Container Runtime Version:  docker://25.0.3</span><br><span class="line">  Container Runtime Version:  docker://25.0.3</span><br><span class="line">  Container Runtime Version:  docker://25.0.3</span><br><span class="line">  Container Runtime Version:  docker://25.0.3</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="8-3-kube-proxy配置"><a href="#8-3-kube-proxy配置" class="headerlink" title="8.3.kube-proxy配置"></a>8.3.kube-proxy配置</h2><h3 id="8-3-1将kubeconfig发送至其他节点"><a href="#8-3-1将kubeconfig发送至其他节点" class="headerlink" title="8.3.1将kubeconfig发送至其他节点"></a>8.3.1将kubeconfig发送至其他节点</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">master-1执行</span></span><br><span class="line">for NODE in k8s-master02 k8s-master03 k8s-node01 k8s-node02; do scp /etc/kubernetes/kube-proxy.kubeconfig $NODE:/etc/kubernetes/kube-proxy.kubeconfig; done</span><br></pre></td></tr></table></figure>

<h3 id="8-3-2所有k8s节点添加kube-proxy的service文件"><a href="#8-3-2所有k8s节点添加kube-proxy的service文件" class="headerlink" title="8.3.2所有k8s节点添加kube-proxy的service文件"></a>8.3.2所有k8s节点添加kube-proxy的service文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">cat &gt;  /usr/lib/systemd/system/kube-proxy.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kube Proxy</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">ExecStart=/usr/local/bin/kube-proxy \\</span><br><span class="line">  --config=/etc/kubernetes/kube-proxy.yaml \\</span><br><span class="line">  --cluster-cidr=172.16.0.0/12,fc00:2222::/112 \\</span><br><span class="line">  --v=2</span><br><span class="line">Restart=always</span><br><span class="line">RestartSec=10s</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这是一个 systemd 服务单元文件的示例，用于配置 Kubernetes Kube Proxy 服务。下面是对其中一些字段的详细解释：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># [Unit]</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># Description: 描述了该服务单元的用途，这里是 Kubernetes Kube Proxy。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Documentation: 指定了该服务单元的文档地址，即 https://github.com/kubernetes/kubernetes。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">After: 指定该服务单元应在 network.target（网络目标）之后启动。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">[Service]</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># ExecStart: 指定了启动 Kube Proxy 服务的命令。通过 /usr/local/bin/kube-proxy 命令启动，并指定了配置文件的路径为 /etc/kubernetes/kube-proxy.yaml，同时指定了日志级别为 2。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Restart: 配置了服务在失败或退出后自动重启。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">RestartSec: 配置了重启间隔，这里是每次重启之间的等待时间为 10 秒。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">[Install]</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># WantedBy: 指定了该服务单元的安装目标为 multi-user.target（多用户目标），表示该服务将在多用户模式下启动。</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">通过配置这些字段，你可以启动和管理 Kubernetes Kube Proxy 服务。请注意，你需要根据实际情况修改 ExecStart 中的路径和文件名，确保与你的环境一致。另外，可以根据需求修改其他字段的值，以满足你的特定要求。</span></span><br></pre></td></tr></table></figure>

<h3 id="8-3-3所有k8s节点添加kube-proxy的配置"><a href="#8-3-3所有k8s节点添加kube-proxy的配置" class="headerlink" title="8.3.3所有k8s节点添加kube-proxy的配置"></a>8.3.3所有k8s节点添加kube-proxy的配置</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; /etc/kubernetes/kube-proxy.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">bindAddress: 0.0.0.0</span><br><span class="line">clientConnection:</span><br><span class="line">  acceptContentTypes: &quot;&quot;</span><br><span class="line">  burst: 10</span><br><span class="line">  contentType: application/vnd.kubernetes.protobuf</span><br><span class="line">  kubeconfig: /etc/kubernetes/kube-proxy.kubeconfig</span><br><span class="line">  qps: 5</span><br><span class="line">clusterCIDR: 172.16.0.0/12,fc00:2222::/112</span><br><span class="line">configSyncPeriod: 15m0s</span><br><span class="line">conntrack:</span><br><span class="line">  max: null</span><br><span class="line">  maxPerCore: 32768</span><br><span class="line">  min: 131072</span><br><span class="line">  tcpCloseWaitTimeout: 1h0m0s</span><br><span class="line">  tcpEstablishedTimeout: 24h0m0s</span><br><span class="line">enableProfiling: false</span><br><span class="line">healthzBindAddress: 0.0.0.0:10256</span><br><span class="line">hostnameOverride: &quot;&quot;</span><br><span class="line">iptables:</span><br><span class="line">  masqueradeAll: false</span><br><span class="line">  masqueradeBit: 14</span><br><span class="line">  minSyncPeriod: 0s</span><br><span class="line">  syncPeriod: 30s</span><br><span class="line">ipvs:</span><br><span class="line">  masqueradeAll: true</span><br><span class="line">  minSyncPeriod: 5s</span><br><span class="line">  scheduler: &quot;rr&quot;</span><br><span class="line">  syncPeriod: 30s</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">metricsBindAddress: 127.0.0.1:10249</span><br><span class="line">mode: &quot;ipvs&quot;</span><br><span class="line">nodePortAddresses: null</span><br><span class="line">oomScoreAdj: -999</span><br><span class="line">portRange: &quot;&quot;</span><br><span class="line">udpIdleTimeout: 250ms</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">这是一个Kubernetes的kube-proxy组件配置文件示例。以下是每个配置项的详细解释：</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 1. apiVersion: kubeproxy.config.k8s.io/v1alpha1</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   - 指定该配置文件的API版本。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 2. bindAddress: 0.0.0.0</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   - 指定kube-proxy使用的监听地址。0.0.0.0表示监听所有网络接口。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 3. clientConnection:</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   - 客户端连接配置项。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#    a. acceptContentTypes: &quot;&quot;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">      - 指定接受的内容类型。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#    b. burst: 10</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">      - 客户端请求超出qps设置时的最大突发请求数。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#    c. contentType: application/vnd.kubernetes.protobuf</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">      - 指定客户端请求的内容类型。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#    d. kubeconfig: /etc/kubernetes/kube-proxy.kubeconfig</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">      - kube-proxy使用的kubeconfig文件路径。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#    e. qps: 5</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">      - 每秒向API服务器发送的请求数量。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 4. clusterCIDR: 172.16.0.0/12,fc00:2222::/112</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   - 指定集群使用的CIDR范围，用于自动分配Pod IP。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 5. configSyncPeriod: 15m0s</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   - 指定kube-proxy配置同步到节点的频率。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 6. conntrack:</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   - 连接跟踪设置。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#    a. max: null</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">      - 指定连接跟踪的最大值。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#    b. maxPerCore: 32768</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">      - 指定每个核心的最大连接跟踪数。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#    c. min: 131072</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">      - 指定最小的连接跟踪数。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#    d. tcpCloseWaitTimeout: 1h0m0s</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">      - 指定处于CLOSE_WAIT状态的TCP连接的超时时间。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#    e. tcpEstablishedTimeout: 24h0m0s</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">      - 指定已建立的TCP连接的超时时间。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 7. enableProfiling: false</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   - 是否启用性能分析。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 8. healthzBindAddress: 0.0.0.0:10256</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   - 指定健康检查监听地址和端口。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 9. hostnameOverride: &quot;&quot;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">   - 指定覆盖默认主机名的值。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 10. iptables:</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    - iptables设置。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#     a. masqueradeAll: false</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">       - 是否对所有流量使用IP伪装。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#     b. masqueradeBit: 14</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">       - 指定伪装的Bit标记。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#     c. minSyncPeriod: 0s</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">       - 指定同步iptables规则的最小间隔。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#     d. syncPeriod: 30s</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">       - 指定同步iptables规则的时间间隔。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 11. ipvs:</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    - ipvs设置。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#     a. masqueradeAll: true</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">       - 是否对所有流量使用IP伪装。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#     b. minSyncPeriod: 5s</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">       - 指定同步ipvs规则的最小间隔。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#     c. scheduler: &quot;rr&quot;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">       - 指定ipvs默认使用的调度算法。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment">#     d. syncPeriod: 30s</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">       - 指定同步ipvs规则的时间间隔。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 12. kind: KubeProxyConfiguration</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    - 指定该配置文件的类型。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 13. metricsBindAddress: 127.0.0.1:10249</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    - 指定指标绑定的地址和端口。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 14. mode: &quot;ipvs&quot;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    - 指定kube-proxy的模式。这里指定为ipvs，使用IPVS代理模式。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 15. nodePortAddresses: null</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    - 指定可用于NodePort的网络地址。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 16. oomScoreAdj: -999</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    - 指定kube-proxy的OOM优先级。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 17. portRange: &quot;&quot;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    - 指定可用于服务端口范围。</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"></span></span><br><span class="line"><span class="language-bash"><span class="comment"># 18. udpIdleTimeout: 250ms</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">    - 指定UDP连接的空闲超时时间。</span></span><br></pre></td></tr></table></figure>

<h3 id="8-3-4启动kube-proxy"><a href="#8-3-4启动kube-proxy" class="headerlink" title="8.3.4启动kube-proxy"></a>8.3.4启动kube-proxy</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> systemctl daemon-reload</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">用于重新加载systemd管理的单位文件。当你新增或修改了某个单位文件（如.service文件、.socket文件等），需要运行该命令来刷新systemd对该文件的配置。</span></span><br><span class="line"></span><br><span class="line">systemctl enable --now kube-proxy.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启用并立即启动kube-proxy.service单元。kube-proxy.service是kube-proxy守护进程的systemd服务单元。</span></span><br><span class="line"></span><br><span class="line">systemctl restart kube-proxy.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启kube-proxy.service单元，即重新启动kube-proxy守护进程。</span></span><br><span class="line"></span><br><span class="line">systemctl status kube-proxy.service</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kube-proxy.service单元的当前状态，包括运行状态、是否启用等信息。</span></span><br></pre></td></tr></table></figure>

<h1 id="9-安装网络插件"><a href="#9-安装网络插件" class="headerlink" title="9.安装网络插件"></a>9.安装网络插件</h1><p><strong>注意 9.1 和 9.2 二选其一即可，建议在此处创建好快照后在进行操作，后续出问题可以回滚</strong></p>
<p>** centos7 要升级libseccomp 不然 无法安装网络插件**</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">https://github.com/opencontainers/runc/releases</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">升级runc</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">wget https://mirrors.chenby.cn/https://github.com/opencontainers/runc/releases/download/v1.1.12/runc.amd64</span></span><br><span class="line"></span><br><span class="line">install -m 755 runc.amd64 /usr/local/sbin/runc</span><br><span class="line">cp -p /usr/local/sbin/runc  /usr/local/bin/runc</span><br><span class="line">cp -p /usr/local/sbin/runc  /usr/bin/runc</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">下载高于2.4以上的包</span></span><br><span class="line">yum -y install http://rpmfind.net/linux/centos/8-stream/BaseOS/x86_64/os/Packages/libseccomp-2.5.1-1.el8.x86_64.rpm</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">清华源</span></span><br><span class="line">yum -y install https://mirrors.tuna.tsinghua.edu.cn/centos/8-stream/BaseOS/x86_64/os/Packages/libseccomp-2.5.1-1.el8.x86_64.rpm</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看当前版本</span></span><br><span class="line">[root@k8s-master-1 ~]# rpm -qa | grep libseccomp</span><br><span class="line">libseccomp-2.5.1-1.el8.x86_64</span><br></pre></td></tr></table></figure>

<h2 id="9-1安装Calico"><a href="#9-1安装Calico" class="headerlink" title="9.1安装Calico"></a>9.1安装Calico</h2><h3 id="9-1-1更改calico网段"><a href="#9-1-1更改calico网段" class="headerlink" title="9.1.1更改calico网段"></a>9.1.1更改calico网段</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">wget https://mirrors.chenby.cn/https://github.com/projectcalico/calico/blob/master/manifests/calico-typha.yaml</span><br><span class="line"></span><br><span class="line">cp calico-typha.yaml calico.yaml</span><br><span class="line">cp calico-typha.yaml calico-ipv6.yaml</span><br><span class="line"></span><br><span class="line">vim calico.yaml</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">calico-config ConfigMap处</span></span><br><span class="line">    &quot;ipam&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;calico-ipam&quot;,</span><br><span class="line">    &#125;,</span><br><span class="line">    - name: IP</span><br><span class="line">      value: &quot;autodetect&quot;</span><br><span class="line"></span><br><span class="line">    - name: CALICO_IPV4POOL_CIDR</span><br><span class="line">      value: &quot;172.16.0.0/12&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">vim calico-ipv6.yaml</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">calico-config ConfigMap处</span></span><br><span class="line">    &quot;ipam&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;calico-ipam&quot;,</span><br><span class="line">        &quot;assign_ipv4&quot;: &quot;true&quot;,</span><br><span class="line">        &quot;assign_ipv6&quot;: &quot;true&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    - name: IP</span><br><span class="line">      value: &quot;autodetect&quot;</span><br><span class="line"></span><br><span class="line">    - name: IP6</span><br><span class="line">      value: &quot;autodetect&quot;</span><br><span class="line"></span><br><span class="line">    - name: CALICO_IPV4POOL_CIDR</span><br><span class="line">      value: &quot;172.16.0.0/12&quot;</span><br><span class="line"></span><br><span class="line">    - name: CALICO_IPV6POOL_CIDR</span><br><span class="line">      value: &quot;fc00:2222::/112&quot;</span><br><span class="line"></span><br><span class="line">    - name: FELIX_IPV6SUPPORT</span><br><span class="line">      value: &quot;true&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">若docker镜像拉不下来，可以使用国内的仓库</span></span><br><span class="line">sed -i &quot;s#docker.io/calico/#m.daocloud.io/docker.io/calico/#g&quot; calico.yaml </span><br><span class="line">sed -i &quot;s#docker.io/calico/#m.daocloud.io/docker.io/calico/#g&quot; calico-ipv6.yaml</span><br><span class="line"></span><br><span class="line">sed -i &quot;s#m.daocloud.io/docker.io/calico/#docker.io/calico/#g&quot; calico.yaml </span><br><span class="line">sed -i &quot;s#m.daocloud.io/docker.io/calico/#docker.io/calico/#g&quot; calico-ipv6.yaml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">本地没有公网 IPv6 使用 calico.yaml</span></span><br><span class="line">kubectl apply -f calico.yaml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">本地有公网 IPv6 使用 calico-ipv6.yaml</span> </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl apply -f calico-ipv6.yaml</span> </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="9-1-2查看容器状态"><a href="#9-1-2查看容器状态" class="headerlink" title="9.1.2查看容器状态"></a>9.1.2查看容器状态</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">calico 初始化会很慢 需要耐心等待一下，大约十分钟左右</span></span><br><span class="line">[root@k8s-master01 ~]# kubectl  get pod -A</span><br><span class="line">NAMESPACE     NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">kube-system   calico-kube-controllers-6747f75cdc-fbvvc   1/1     Running   0          61s</span><br><span class="line">kube-system   calico-node-fs7hl                          1/1     Running   0          61s</span><br><span class="line">kube-system   calico-node-jqz58                          1/1     Running   0          61s</span><br><span class="line">kube-system   calico-node-khjlg                          1/1     Running   0          61s</span><br><span class="line">kube-system   calico-node-wmf8q                          1/1     Running   0          61s</span><br><span class="line">kube-system   calico-node-xc6gn                          1/1     Running   0          61s</span><br><span class="line">kube-system   calico-typha-6cdc4b4fbc-57snb              1/1     Running   0          61s</span><br></pre></td></tr></table></figure>

<h2 id="9-2-安装cilium"><a href="#9-2-安装cilium" class="headerlink" title="9.2 安装cilium"></a>9.2 安装cilium</h2><h3 id="9-2-1-安装helm"><a href="#9-2-1-安装helm" class="headerlink" title="9.2.1 安装helm"></a>9.2.1 安装helm</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">[root@k8s-master01 ~]# curl -fsSL -o get_helm.sh https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">[root@k8s-master01 ~]# <span class="built_in">chmod</span> 700 get_helm.sh</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">[root@k8s-master01 ~]# ./get_helm.sh</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">wget https://mirrors.huaweicloud.com/helm/v3.13.2/helm-v3.13.2-linux-amd64.tar.gz</span></span><br><span class="line">tar xvf helm-*-linux-amd64.tar.gz</span><br><span class="line">cp linux-amd64/helm /usr/local/bin/</span><br></pre></td></tr></table></figure>

<h3 id="9-2-2-安装cilium"><a href="#9-2-2-安装cilium" class="headerlink" title="9.2.2 安装cilium"></a>9.2.2 安装cilium</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加源</span></span><br><span class="line">helm repo add cilium https://helm.cilium.io</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改为国内源</span></span><br><span class="line">helm pull cilium/cilium</span><br><span class="line">tar xvf cilium-*.tgz</span><br><span class="line">cd cilium/</span><br><span class="line">sed -i &quot;s#quay.io/#m.daocloud.io/quay.io/#g&quot; values.yaml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">默认参数安装</span></span><br><span class="line">helm install  cilium ./cilium/ -n kube-system</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启用ipv6</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">helm install cilium cilium/cilium --namespace kube-system --<span class="built_in">set</span> ipv6.enabled=<span class="literal">true</span></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启用路由信息和监控插件</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">helm install cilium cilium/cilium --namespace kube-system --<span class="built_in">set</span> hubble.relay.enabled=<span class="literal">true</span> --<span class="built_in">set</span> hubble.ui.enabled=<span class="literal">true</span> --<span class="built_in">set</span> prometheus.enabled=<span class="literal">true</span> --<span class="built_in">set</span> operator.prometheus.enabled=<span class="literal">true</span> --<span class="built_in">set</span> hubble.enabled=<span class="literal">true</span> --<span class="built_in">set</span> hubble.metrics.enabled=<span class="string">&quot;&#123;dns,drop,tcp,flow,port-distribution,icmp,http&#125;&quot;</span></span> </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="9-2-3-查看"><a href="#9-2-3-查看" class="headerlink" title="9.2.3 查看"></a>9.2.3 查看</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 ~]# kubectl  get pod -A | grep cil</span><br><span class="line">kube-system   cilium-gmr6c                       1/1     Running       0             5m3s</span><br><span class="line">kube-system   cilium-kzgdj                       1/1     Running       0             5m3s</span><br><span class="line">kube-system   cilium-operator-69b677f97c-6pw4k   1/1     Running       0             5m3s</span><br><span class="line">kube-system   cilium-operator-69b677f97c-xzzdk   1/1     Running       0             5m3s</span><br><span class="line">kube-system   cilium-q2rnr                       1/1     Running       0             5m3s</span><br><span class="line">kube-system   cilium-smx5v                       1/1     Running       0             5m3s</span><br><span class="line">kube-system   cilium-tdjq4                       1/1     Running       0             5m3s</span><br><span class="line">[root@k8s-master01 ~]#</span><br></pre></td></tr></table></figure>

<h3 id="9-2-4-下载专属监控面板"><a href="#9-2-4-下载专属监控面板" class="headerlink" title="9.2.4 下载专属监控面板"></a>9.2.4 下载专属监控面板</h3><p>安装时候没有创建 监控可以忽略</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 yaml]# wget https://mirrors.chenby.cn/https://raw.githubusercontent.com/cilium/cilium/1.12.1/examples/kubernetes/addons/prometheus/monitoring-example.yaml</span><br><span class="line"></span><br><span class="line">[root@k8s-master01 yaml]# sed -i &quot;s#docker.io/#m.daocloud.io/docker.io/#g&quot; monitoring-example.yaml</span><br><span class="line"></span><br><span class="line">[root@k8s-master01 yaml]# kubectl  apply -f monitoring-example.yaml</span><br><span class="line">namespace/cilium-monitoring created</span><br><span class="line">serviceaccount/prometheus-k8s created</span><br><span class="line">configmap/grafana-config created</span><br><span class="line">configmap/grafana-cilium-dashboard created</span><br><span class="line">configmap/grafana-cilium-operator-dashboard created</span><br><span class="line">configmap/grafana-hubble-dashboard created</span><br><span class="line">configmap/prometheus created</span><br><span class="line">clusterrole.rbac.authorization.k8s.io/prometheus created</span><br><span class="line">clusterrolebinding.rbac.authorization.k8s.io/prometheus created</span><br><span class="line">service/grafana created</span><br><span class="line">service/prometheus created</span><br><span class="line">deployment.apps/grafana created</span><br><span class="line">deployment.apps/prometheus created</span><br><span class="line">[root@k8s-master01 yaml]#</span><br></pre></td></tr></table></figure>

<h3 id="9-2-5-下载部署测试用例"><a href="#9-2-5-下载部署测试用例" class="headerlink" title="9.2.5 下载部署测试用例"></a>9.2.5 下载部署测试用例</h3><p>说明 测试用例 需要在 安装CoreDNS 之后即可完成</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">wget https://mirrors.chenby.cn/https://raw.githubusercontent.com/cilium/cilium/master/examples/kubernetes/connectivity-check/connectivity-check.yaml</span><br><span class="line"></span><br><span class="line">sed -i &quot;s#google.com#baidu.cn#g&quot; connectivity-check.yaml</span><br><span class="line">sed -i &quot;s#quay.io/#m.daocloud.io/quay.io/#g&quot; connectivity-check.yaml</span><br><span class="line"></span><br><span class="line">kubectl  apply -f connectivity-check.yaml</span><br></pre></td></tr></table></figure>

<h3 id="9-2-6-查看pod"><a href="#9-2-6-查看pod" class="headerlink" title="9.2.6 查看pod"></a>9.2.6 查看pod</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 yaml]# kubectl  get pod -A</span><br><span class="line">NAMESPACE           NAME                                                     READY   STATUS    RESTARTS      AGE</span><br><span class="line">cilium-monitoring   grafana-59957b9549-6zzqh                                 1/1     Running   0             10m</span><br><span class="line">cilium-monitoring   prometheus-7c8c9684bb-4v9cl                              1/1     Running   0             10m</span><br><span class="line">default             chenby-75b5d7fbfb-7zjsr                                  1/1     Running   0             27h</span><br><span class="line">default             chenby-75b5d7fbfb-hbvr8                                  1/1     Running   0             27h</span><br><span class="line">default             chenby-75b5d7fbfb-ppbzg                                  1/1     Running   0             27h</span><br><span class="line">default             echo-a-6799dff547-pnx6w                                  1/1     Running   0             10m</span><br><span class="line">default             echo-b-fc47b659c-4bdg9                                   1/1     Running   0             10m</span><br><span class="line">default             echo-b-host-67fcfd59b7-28r9s                             1/1     Running   0             10m</span><br><span class="line">default             host-to-b-multi-node-clusterip-69c57975d6-z4j2z          1/1     Running   0             10m</span><br><span class="line">default             host-to-b-multi-node-headless-865899f7bb-frrmc           1/1     Running   0             10m</span><br><span class="line">default             pod-to-a-allowed-cnp-5f9d7d4b9d-hcd8x                    1/1     Running   0             10m</span><br><span class="line">default             pod-to-a-denied-cnp-65cc5ff97b-2rzb8                     1/1     Running   0             10m</span><br><span class="line">default             pod-to-a-dfc64f564-p7xcn                                 1/1     Running   0             10m</span><br><span class="line">default             pod-to-b-intra-node-nodeport-677868746b-trk2l            1/1     Running   0             10m</span><br><span class="line">default             pod-to-b-multi-node-clusterip-76bbbc677b-knfq2           1/1     Running   0             10m</span><br><span class="line">default             pod-to-b-multi-node-headless-698c6579fd-mmvd7            1/1     Running   0             10m</span><br><span class="line">default             pod-to-b-multi-node-nodeport-5dc4b8cfd6-8dxmz            1/1     Running   0             10m</span><br><span class="line">default             pod-to-external-1111-8459965778-pjt9b                    1/1     Running   0             10m</span><br><span class="line">default             pod-to-external-fqdn-allow-google-cnp-64df9fb89b-l9l4q   1/1     Running   0             10m</span><br><span class="line">kube-system         cilium-7rfj6                                             1/1     Running   0             56s</span><br><span class="line">kube-system         cilium-d4cch                                             1/1     Running   0             56s</span><br><span class="line">kube-system         cilium-h5x8r                                             1/1     Running   0             56s</span><br><span class="line">kube-system         cilium-operator-5dbddb6dbf-flpl5                         1/1     Running   0             56s</span><br><span class="line">kube-system         cilium-operator-5dbddb6dbf-gcznc                         1/1     Running   0             56s</span><br><span class="line">kube-system         cilium-t2xlz                                             1/1     Running   0             56s</span><br><span class="line">kube-system         cilium-z65z7                                             1/1     Running   0             56s</span><br><span class="line">kube-system         coredns-665475b9f8-jkqn8                                 1/1     Running   1 (36h ago)   36h</span><br><span class="line">kube-system         hubble-relay-59d8575-9pl9z                               1/1     Running   0             56s</span><br><span class="line">kube-system         hubble-ui-64d4995d57-nsv9j                               2/2     Running   0             56s</span><br><span class="line">kube-system         metrics-server-776f58c94b-c6zgs                          1/1     Running   1 (36h ago)   37h</span><br><span class="line">[root@k8s-master01 yaml]#</span><br></pre></td></tr></table></figure>

<h3 id="9-2-7-修改为NodePort"><a href="#9-2-7-修改为NodePort" class="headerlink" title="9.2.7 修改为NodePort"></a>9.2.7 修改为NodePort</h3><p>安装时候没有创建 监控可以忽略</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 yaml]# kubectl  edit svc  -n kube-system hubble-ui</span><br><span class="line">service/hubble-ui edited</span><br><span class="line">[root@k8s-master01 yaml]#</span><br><span class="line">[root@k8s-master01 yaml]# kubectl  edit svc  -n cilium-monitoring grafana</span><br><span class="line">service/grafana edited</span><br><span class="line">[root@k8s-master01 yaml]#</span><br><span class="line">[root@k8s-master01 yaml]# kubectl  edit svc  -n cilium-monitoring prometheus</span><br><span class="line">service/prometheus edited</span><br><span class="line">[root@k8s-master01 yaml]#</span><br><span class="line"></span><br><span class="line">type: NodePort</span><br></pre></td></tr></table></figure>

<h3 id="9-2-8-查看端口"><a href="#9-2-8-查看端口" class="headerlink" title="9.2.8 查看端口"></a>9.2.8 查看端口</h3><p>安装时候没有创建 监控可以忽略</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 yaml]# kubectl get svc -A | grep monit</span><br><span class="line">cilium-monitoring   grafana                NodePort    10.100.250.17    &lt;none&gt;        3000:30707/TCP           15m</span><br><span class="line">cilium-monitoring   prometheus             NodePort    10.100.131.243   &lt;none&gt;        9090:31155/TCP           15m</span><br><span class="line">[root@k8s-master01 yaml]#</span><br><span class="line">[root@k8s-master01 yaml]# kubectl get svc -A | grep hubble</span><br><span class="line">kube-system         hubble-metrics         ClusterIP   None             &lt;none&gt;        9965/TCP                 5m12s</span><br><span class="line">kube-system         hubble-peer            ClusterIP   10.100.150.29    &lt;none&gt;        443/TCP                  5m12s</span><br><span class="line">kube-system         hubble-relay           ClusterIP   10.109.251.34    &lt;none&gt;        80/TCP                   5m12s</span><br><span class="line">kube-system         hubble-ui              NodePort    10.102.253.59    &lt;none&gt;        80:31219/TCP             5m12s</span><br><span class="line">[root@k8s-master01 yaml]#</span><br></pre></td></tr></table></figure>

<h3 id="9-2-9-访问"><a href="#9-2-9-访问" class="headerlink" title="9.2.9 访问"></a>9.2.9 访问</h3><p>安装时候没有创建 监控可以忽略</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.1.31:30707</span><br><span class="line">http://192.168.1.31:31155</span><br><span class="line">http://192.168.1.31:31219</span><br></pre></td></tr></table></figure>

<h1 id="10-安装CoreDNS"><a href="#10-安装CoreDNS" class="headerlink" title="10.安装CoreDNS"></a>10.安装CoreDNS</h1><h2 id="10-1以下步骤只在master01操作"><a href="#10-1以下步骤只在master01操作" class="headerlink" title="10.1以下步骤只在master01操作"></a>10.1以下步骤只在master01操作</h2><h3 id="10-1-1修改文件"><a href="#10-1-1修改文件" class="headerlink" title="10.1.1修改文件"></a>10.1.1修改文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载tgz包</span></span><br><span class="line">helm repo add coredns https://coredns.github.io/helm</span><br><span class="line">helm pull coredns/coredns</span><br><span class="line">tar xvf coredns-*.tgz</span><br><span class="line">cd coredns/</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改IP地址</span></span><br><span class="line">vim values.yaml</span><br><span class="line">cat values.yaml | grep clusterIP:</span><br><span class="line">clusterIP: &quot;10.96.0.10&quot;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">示例</span></span><br><span class="line">---</span><br><span class="line">service:</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">clusterIP: <span class="string">&quot;&quot;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">clusterIPs: []</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">loadBalancerIP: <span class="string">&quot;&quot;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">externalIPs: []</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">externalTrafficPolicy: <span class="string">&quot;&quot;</span></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ipFamilyPolicy: <span class="string">&quot;&quot;</span></span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">The name of the Service</span></span><br><span class="line"><span class="meta prompt_">  # </span><span class="language-bash">If not <span class="built_in">set</span>, a name is generated using the fullname template</span></span><br><span class="line">  clusterIP: &quot;10.96.0.10&quot;</span><br><span class="line">  name: &quot;&quot;</span><br><span class="line">  annotations: &#123;&#125;</span><br><span class="line">---</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改为国内源 docker源可选</span></span><br><span class="line">sed -i &quot;s#coredns/#m.daocloud.io/docker.io/coredns/#g&quot; values.yaml</span><br><span class="line">sed -i &quot;s#registry.k8s.io/#m.daocloud.io/registry.k8s.io/#g&quot; values.yaml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">默认参数安装</span></span><br><span class="line">helm install  coredns ./coredns/ -n kube-system</span><br></pre></td></tr></table></figure>

<h1 id="11-安装Metrics-Server"><a href="#11-安装Metrics-Server" class="headerlink" title="11.安装Metrics Server"></a>11.安装Metrics Server</h1><h2 id="11-1以下步骤只在master01操作"><a href="#11-1以下步骤只在master01操作" class="headerlink" title="11.1以下步骤只在master01操作"></a>11.1以下步骤只在master01操作</h2><h3 id="11-1-1安装Metrics-server"><a href="#11-1-1安装Metrics-server" class="headerlink" title="11.1.1安装Metrics-server"></a>11.1.1安装Metrics-server</h3><p>在新版的Kubernetes中系统资源的采集均使用Metrics-server，可以通过Metrics采集节点和Pod的内存、磁盘、CPU和网络的使用率</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载</span> </span><br><span class="line">wget https://mirrors.chenby.cn/https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改配置</span></span><br><span class="line">vim components.yaml</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">1</span></span><br><span class="line">			- args:</span><br><span class="line">        - --cert-dir=/tmp</span><br><span class="line">        - --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname</span><br><span class="line">        - --kubelet-use-node-status-port</span><br><span class="line">        - --metric-resolution=15s</span><br><span class="line">        - --kubelet-insecure-tls</span><br><span class="line">        - --requestheader-client-ca-file=/etc/kubernetes/pki/front-proxy-ca.pem</span><br><span class="line">        - --requestheader-username-headers=X-Remote-User</span><br><span class="line">        - --requestheader-group-headers=X-Remote-Group</span><br><span class="line">        - --requestheader-extra-headers-prefix=X-Remote-Extra-</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">2</span></span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /tmp</span><br><span class="line">          name: tmp-dir</span><br><span class="line">        - name: ca-ssl</span><br><span class="line">          mountPath: /etc/kubernetes/pki</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">3</span></span><br><span class="line">      volumes:</span><br><span class="line">      - emptyDir: &#123;&#125;</span><br><span class="line">        name: tmp-dir</span><br><span class="line">      - name: ca-ssl</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /etc/kubernetes/pki</span><br><span class="line">---</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改为国内源 docker源可选</span></span><br><span class="line">sed -i &quot;s#registry.k8s.io/#m.daocloud.io/registry.k8s.io/#g&quot; *.yaml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">执行部署</span></span><br><span class="line">kubectl apply -f components.yaml</span><br></pre></td></tr></table></figure>

<h3 id="11-1-2稍等片刻查看状态"><a href="#11-1-2稍等片刻查看状态" class="headerlink" title="11.1.2稍等片刻查看状态"></a>11.1.2稍等片刻查看状态</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl  top node</span><br><span class="line">NAME           CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%   </span><br><span class="line">k8s-master01   268m         6%     2318Mi          60%       </span><br><span class="line">k8s-master02   147m         3%     1802Mi          47%       </span><br><span class="line">k8s-master03   147m         3%     1820Mi          47%       </span><br><span class="line">k8s-node01     62m          1%     1152Mi          30%       </span><br><span class="line">k8s-node02     63m          1%     1114Mi          29%  </span><br></pre></td></tr></table></figure>

<h1 id="12-集群验证"><a href="#12-集群验证" class="headerlink" title="12.集群验证"></a>12.集群验证</h1><h2 id="12-1部署pod资源"><a href="#12-1部署pod资源" class="headerlink" title="12.1部署pod资源"></a>12.1部署pod资源</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">cat&lt;&lt;EOF | kubectl apply -f -</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: busybox</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: busybox</span><br><span class="line">    image: docker.io/library/busybox:1.28</span><br><span class="line">    command:</span><br><span class="line">      - sleep</span><br><span class="line">      - &quot;3600&quot;</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">  restartPolicy: Always</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看</span></span><br><span class="line">kubectl  get pod</span><br><span class="line">NAME      READY   STATUS    RESTARTS   AGE</span><br><span class="line">busybox   1/1     Running   0          17s</span><br></pre></td></tr></table></figure>

<h2 id="12-2用pod解析默认命名空间中的kubernetes"><a href="#12-2用pod解析默认命名空间中的kubernetes" class="headerlink" title="12.2用pod解析默认命名空间中的kubernetes"></a>12.2用pod解析默认命名空间中的kubernetes</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看name</span></span><br><span class="line">kubectl get svc</span><br><span class="line">NAME         TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   17h</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进行解析</span></span><br><span class="line">kubectl exec  busybox -n default -- nslookup kubernetes</span><br><span class="line">3Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 kube-dns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      kubernetes</span><br><span class="line">Address 1: 10.96.0.1 kubernetes.default.svc.cluster.local</span><br></pre></td></tr></table></figure>

<h2 id="12-3测试跨命名空间是否可以解析"><a href="#12-3测试跨命名空间是否可以解析" class="headerlink" title="12.3测试跨命名空间是否可以解析"></a>12.3测试跨命名空间是否可以解析</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看有那些name</span></span><br><span class="line">kubectl  get svc -A</span><br><span class="line">NAMESPACE     NAME              TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">default       kubernetes        ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP         76m</span><br><span class="line">kube-system   calico-typha      ClusterIP   10.105.100.82   &lt;none&gt;        5473/TCP        35m</span><br><span class="line">kube-system   coredns-coredns   ClusterIP   10.96.0.10      &lt;none&gt;        53/UDP,53/TCP   8m14s</span><br><span class="line">kube-system   metrics-server    ClusterIP   10.105.60.31    &lt;none&gt;        443/TCP         109s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进行解析</span></span><br><span class="line">kubectl exec  busybox -n default -- nslookup coredns-coredns.kube-system</span><br><span class="line">Server:    10.96.0.10</span><br><span class="line">Address 1: 10.96.0.10 coredns-coredns.kube-system.svc.cluster.local</span><br><span class="line"></span><br><span class="line">Name:      coredns-coredns.kube-system</span><br><span class="line">Address 1: 10.96.0.10 coredns-coredns.kube-system.svc.cluster.local</span><br><span class="line">[root@k8s-master01 metrics-server]# </span><br></pre></td></tr></table></figure>

<h2 id="12-4每个节点都必须要能访问Kubernetes的kubernetes-svc-443和kube-dns的service-53"><a href="#12-4每个节点都必须要能访问Kubernetes的kubernetes-svc-443和kube-dns的service-53" class="headerlink" title="12.4每个节点都必须要能访问Kubernetes的kubernetes svc 443和kube-dns的service 53"></a>12.4每个节点都必须要能访问Kubernetes的kubernetes svc 443和kube-dns的service 53</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">telnet 10.96.0.1 443</span><br><span class="line">Trying 10.96.0.1...</span><br><span class="line">Connected to 10.96.0.1.</span><br><span class="line">Escape character is &#x27;^]&#x27;.</span><br><span class="line"></span><br><span class="line"> telnet 10.96.0.10 53</span><br><span class="line">Trying 10.96.0.10...</span><br><span class="line">Connected to 10.96.0.10.</span><br><span class="line">Escape character is &#x27;^]&#x27;.</span><br><span class="line"></span><br><span class="line">curl 10.96.0.10:53</span><br><span class="line">curl: (52) Empty reply from server</span><br></pre></td></tr></table></figure>

<h2 id="12-5Pod和Pod之前要能通"><a href="#12-5Pod和Pod之前要能通" class="headerlink" title="12.5Pod和Pod之前要能通"></a>12.5Pod和Pod之前要能通</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">kubectl get po -owide</span><br><span class="line">NAME      READY   STATUS    RESTARTS   AGE   IP              NODE         NOMINATED NODE   READINESS GATES</span><br><span class="line">busybox   1/1     Running   0          17m   172.27.14.193   k8s-node02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">kubectl get po -n kube-system -owide</span><br><span class="line">NAME                                       READY   STATUS    RESTARTS   AGE     IP               NODE           NOMINATED NODE   READINESS GATES</span><br><span class="line">calico-kube-controllers-76754ff848-pw4xg   1/1     Running   0          38m     172.25.244.193   k8s-master01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">calico-node-97m55                          1/1     Running   0          38m     192.168.1.34     k8s-node01     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">calico-node-hlz7j                          1/1     Running   0          38m     192.168.1.32     k8s-master02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">calico-node-jtlck                          1/1     Running   0          38m     192.168.1.33     k8s-master03   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">calico-node-lxfkf                          1/1     Running   0          38m     192.168.1.35     k8s-node02     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">calico-node-t667x                          1/1     Running   0          38m     192.168.1.31     k8s-master01   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">calico-typha-59d75c5dd4-gbhfp              1/1     Running   0          38m     192.168.1.35     k8s-node02     &lt;none&gt;           &lt;none&gt;</span><br><span class="line">coredns-coredns-c5c6d4d9b-bd829            1/1     Running   0          10m     172.25.92.65     k8s-master02   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">metrics-server-7c8b55c754-w7q8v            1/1     Running   0          3m56s   172.17.125.3     k8s-node01     &lt;none&gt;           &lt;none&gt;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">进入busybox ping其他节点上的pod</span></span><br><span class="line"></span><br><span class="line">kubectl exec -ti busybox -- sh</span><br><span class="line">/ # ping 192.168.1.34</span><br><span class="line">PING 192.168.1.34 (192.168.1.34): 56 data bytes</span><br><span class="line">64 bytes from 192.168.1.34: seq=0 ttl=63 time=0.358 ms</span><br><span class="line">64 bytes from 192.168.1.34: seq=1 ttl=63 time=0.668 ms</span><br><span class="line">64 bytes from 192.168.1.34: seq=2 ttl=63 time=0.637 ms</span><br><span class="line">64 bytes from 192.168.1.34: seq=3 ttl=63 time=0.624 ms</span><br><span class="line">64 bytes from 192.168.1.34: seq=4 ttl=63 time=0.907 ms</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">可以连通证明这个pod是可以跨命名空间和跨主机通信的</span></span><br></pre></td></tr></table></figure>

<h2 id="12-6创建三个副本，可以看到3个副本分布在不同的节点上（用完可以删了）"><a href="#12-6创建三个副本，可以看到3个副本分布在不同的节点上（用完可以删了）" class="headerlink" title="12.6创建三个副本，可以看到3个副本分布在不同的节点上（用完可以删了）"></a>12.6创建三个副本，可以看到3个副本分布在不同的节点上（用完可以删了）</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">cat&lt;&lt;EOF | kubectl apply -f -</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-deployment</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">spec:</span><br><span class="line">  replicas: 3</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: nginx</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">kubectl  get pod </span><br><span class="line">NAME                               READY   STATUS    RESTARTS   AGE</span><br><span class="line">busybox                            1/1     Running   0          6m25s</span><br><span class="line">nginx-deployment-9456bbbf9-4bmvk   1/1     Running   0          8s</span><br><span class="line">nginx-deployment-9456bbbf9-9rcdk   1/1     Running   0          8s</span><br><span class="line">nginx-deployment-9456bbbf9-dqv8s   1/1     Running   0          8s</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除nginx</span></span><br><span class="line">[root@k8s-master01 ~]# kubectl delete deployments nginx-deployment </span><br></pre></td></tr></table></figure>

<h1 id="13-安装dashboard"><a href="#13-安装dashboard" class="headerlink" title="13.安装dashboard"></a>13.安装dashboard</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">helm repo add kubernetes-dashboard https://kubernetes.github.io/dashboard/</span><br><span class="line">helm install kubernetes-dashboard kubernetes-dashboard/kubernetes-dashboard --namespace kube-system</span><br></pre></td></tr></table></figure>

<h2 id="13-1更改dashboard的svc为NodePort，如果已是请忽略"><a href="#13-1更改dashboard的svc为NodePort，如果已是请忽略" class="headerlink" title="13.1更改dashboard的svc为NodePort，如果已是请忽略"></a>13.1更改dashboard的svc为NodePort，如果已是请忽略</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl edit svc kubernetes-dashboard -n kube-system</span><br><span class="line">  type: NodePort</span><br></pre></td></tr></table></figure>

<h2 id="13-2查看端口号"><a href="#13-2查看端口号" class="headerlink" title="13.2查看端口号"></a>13.2查看端口号</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc kubernetes-dashboard -n kube-system</span><br><span class="line">NAME                   TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)         AGE</span><br><span class="line">kubernetes-dashboard   NodePort   10.108.120.110   &lt;none&gt;        443:30034/TCP   34s</span><br></pre></td></tr></table></figure>

<h2 id="13-3创建token"><a href="#13-3创建token" class="headerlink" title="13.3创建token"></a>13.3创建token</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; dashboard-user.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: admin-user</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: cluster-admin</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: admin-user</span><br><span class="line">  namespace: kube-system</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">kubectl  apply -f dashboard-user.yaml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建token</span></span><br><span class="line">kubectl -n kube-system create token admin-user</span><br><span class="line"></span><br><span class="line">eyJhbGciOiJSUzI1NiIsImtpZCI6Im5vZExpNi1tTERLb09ONVM2cEE0SWNCUnA4eTZieE81RnVGb1IwSk5QVFEifQ.eyJhdWQiOlsiaHR0cHM6Ly9rdWJlcm5ldGVzLmRlZmF1bHQuc3ZjLmNsdXN0ZXIubG9jYWwiXSwiZXhwIjoxNzA4MjQ4NjM4LCJpYXQiOjE3MDgyNDUwMzgsImlzcyI6Imh0dHBzOi8va3ViZXJuZXRlcy5kZWZhdWx0LnN2Yy5jbHVzdGVyLmxvY2FsIiwia3ViZXJuZXRlcy5pbyI6eyJuYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsInNlcnZpY2VhY2NvdW50Ijp7Im5hbWUiOiJhZG1pbi11c2VyIiwidWlkIjoiMTQ1YTdmZTktMTQ0YS00NDZmLWI1M2QtNDk4OGM3YjIyZjgyIn19LCJuYmYiOjE3MDgyNDUwMzgsInN1YiI6InN5c3RlbTpzZXJ2aWNlYWNjb3VudDprdWJlLXN5c3RlbTphZG1pbi11c2VyIn0.H2Oxxrb5BVLH1iDOA-Uo1I7aiAUZX1wK-xBiV9NJXQ32EDyQvss95yQbCNHtPMhQZ8jFE3NRhyjkgZMZmX7kR9J-89QXLqKhE8Qnihd1mq5HOEVQ8tjZ6ix8ymxs5QkfSvd_OUzILKBtfYAMb4Fer67Dyf14oBHWVKU9LQkCdtFaLxerK--N7gLWeGXzavqzOlEPZR5UZWUPwP5dJmAQtvSToPVMaKiA49LjaGJid0F5Pxnutr80oZRsLfKr0MpoEG6jrow1QeJ2PgVksDTcqMTpye-M6jmIbuxabsRSskTT_zEDT0J86BiLYIHnh79D-P7IUUq6GOp8DgG-wXhICQ</span><br></pre></td></tr></table></figure>

<h2 id="13-3登录dashboard"><a href="#13-3登录dashboard" class="headerlink" title="13.3登录dashboard"></a>13.3登录dashboard</h2><p><a target="_blank" rel="noopener" href="https://192.168.1.31:30034/">https://192.168.1.31:30034/</a></p>
<h1 id="14-ingress安装"><a href="#14-ingress安装" class="headerlink" title="14.ingress安装"></a>14.ingress安装</h1><h2 id="14-1执行部署"><a href="#14-1执行部署" class="headerlink" title="14.1执行部署"></a>14.1执行部署</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line">wget https://mirrors.chenby.cn/https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/cloud/deploy.yaml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改为国内源 docker源可选</span></span><br><span class="line">sed -i &quot;s#registry.k8s.io/#m.daocloud.io/registry.k8s.io/#g&quot; *.yaml</span><br><span class="line"></span><br><span class="line">cat &gt; backend.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: default-http-backend</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: default-http-backend</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app.kubernetes.io/name: default-http-backend</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app.kubernetes.io/name: default-http-backend</span><br><span class="line">    spec:</span><br><span class="line">      terminationGracePeriodSeconds: 60</span><br><span class="line">      containers:</span><br><span class="line">      - name: default-http-backend</span><br><span class="line">        image: registry.cn-hangzhou.aliyuncs.com/chenby/defaultbackend-amd64:1.5 </span><br><span class="line">        livenessProbe:</span><br><span class="line">          httpGet:</span><br><span class="line">            path: /healthz</span><br><span class="line">            port: 8080</span><br><span class="line">            scheme: HTTP</span><br><span class="line">          initialDelaySeconds: 30</span><br><span class="line">          timeoutSeconds: 5</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 10m</span><br><span class="line">            memory: 20Mi</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 10m</span><br><span class="line">            memory: 20Mi</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: default-http-backend</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    app.kubernetes.io/name: default-http-backend</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    targetPort: 8080</span><br><span class="line">  selector:</span><br><span class="line">    app.kubernetes.io/name: default-http-backend</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">kubectl  apply -f deploy.yaml </span><br><span class="line">kubectl  apply -f backend.yaml </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cat &gt; ingress-demo-app.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: hello-server</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: hello-server</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: hello-server</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: hello-server</span><br><span class="line">        image: registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images/hello-server</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 9000</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx-demo</span><br><span class="line">  name: nginx-demo</span><br><span class="line">spec:</span><br><span class="line">  replicas: 2</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx-demo</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx-demo</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - image: nginx</span><br><span class="line">        name: nginx</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx-demo</span><br><span class="line">  name: nginx-demo</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: nginx-demo</span><br><span class="line">  ports:</span><br><span class="line">  - port: 8000</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    app: hello-server</span><br><span class="line">  name: hello-server</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: hello-server</span><br><span class="line">  ports:</span><br><span class="line">  - port: 8000</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 9000</span><br><span class="line">---</span><br><span class="line">apiVersion: networking.k8s.io/v1</span><br><span class="line">kind: Ingress  </span><br><span class="line">metadata:</span><br><span class="line">  name: ingress-host-bar</span><br><span class="line">spec:</span><br><span class="line">  ingressClassName: nginx</span><br><span class="line">  rules:</span><br><span class="line">  - host: &quot;hello.chenby.cn&quot;</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - pathType: Prefix</span><br><span class="line">        path: &quot;/&quot;</span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: hello-server</span><br><span class="line">            port:</span><br><span class="line">              number: 8000</span><br><span class="line">  - host: &quot;demo.chenby.cn&quot;</span><br><span class="line">    http:</span><br><span class="line">      paths:</span><br><span class="line">      - pathType: Prefix</span><br><span class="line">        path: &quot;/nginx&quot;  </span><br><span class="line">        backend:</span><br><span class="line">          service:</span><br><span class="line">            name: nginx-demo</span><br><span class="line">            port:</span><br><span class="line">              number: 8000</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">等创建完成后在执行：</span></span><br><span class="line">kubectl  apply -f ingress-demo-app.yaml </span><br><span class="line"></span><br><span class="line">kubectl  get ingress</span><br><span class="line">NAME               CLASS   HOSTS                            ADDRESS     PORTS   AGE</span><br><span class="line">ingress-host-bar   nginx   hello.chenby.cn,demo.chenby.cn   192.168.1.32   80      7s</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="14-2过滤查看ingress端口"><a href="#14-2过滤查看ingress端口" class="headerlink" title="14.2过滤查看ingress端口"></a>14.2过滤查看ingress端口</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改为nodeport</span></span><br><span class="line">kubectl edit svc -n ingress-nginx   ingress-nginx-controller</span><br><span class="line">type: NodePort</span><br><span class="line"></span><br><span class="line">[root@hello ~/yaml]# kubectl  get svc -A | grep ingress</span><br><span class="line">ingress-nginx          ingress-nginx-controller             NodePort    10.104.231.36    &lt;none&gt;        80:32636/TCP,443:30579/TCP   104s</span><br><span class="line">ingress-nginx          ingress-nginx-controller-admission   ClusterIP   10.101.85.88     &lt;none&gt;        443/TCP                      105s</span><br><span class="line">[root@hello ~/yaml]#</span><br></pre></td></tr></table></figure>

<h1 id="15-IPv6测试"><a href="#15-IPv6测试" class="headerlink" title="15.IPv6测试"></a>15.IPv6测试</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">部署应用</span></span><br><span class="line"></span><br><span class="line">cat&lt;&lt;EOF | kubectl apply -f -</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: chenby</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: chenby</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: chenby</span><br><span class="line">    spec:</span><br><span class="line">      hostNetwork: true</span><br><span class="line">      containers:</span><br><span class="line">      - name: chenby</span><br><span class="line">        image: docker.io/library/nginx</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            memory: &quot;128Mi&quot;</span><br><span class="line">            cpu: &quot;500m&quot;</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 80</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: chenby</span><br><span class="line">spec:</span><br><span class="line">  ipFamilyPolicy: PreferDualStack</span><br><span class="line">  ipFamilies:</span><br><span class="line">  - IPv6</span><br><span class="line">  - IPv4</span><br><span class="line">  type: NodePort</span><br><span class="line">  selector:</span><br><span class="line">    app: chenby</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    targetPort: 80</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">查看端口</span></span><br><span class="line">[root@k8s-master01 ~]# kubectl  get svc</span><br><span class="line">NAME           TYPE        CLUSTER-IP            EXTERNAL-IP   PORT(S)        AGE</span><br><span class="line">chenby         NodePort    fd00:1111::bc86       &lt;none&gt;        80:31540/TCP   5s</span><br><span class="line">[root@k8s-master01 ~]# </span><br><span class="line"></span><br><span class="line">[root@localhost yaml]# curl -I http://192.168.1.31:31540</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.21.6</span><br><span class="line">Date: Thu, 05 May 2022 10:20:59 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 615</span><br><span class="line">Last-Modified: Tue, 25 Jan 2022 15:03:52 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: &quot;61f01158-267&quot;</span><br><span class="line">Accept-Ranges: bytes</span><br><span class="line"></span><br><span class="line">[root@localhost yaml]# </span><br><span class="line"></span><br><span class="line">[root@localhost yaml]# curl -I http://[2409:8a10:9e18:9020::10]:31540</span><br><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Server: nginx/1.21.6</span><br><span class="line">Date: Thu, 05 May 2022 10:20:54 GMT</span><br><span class="line">Content-Type: text/html</span><br><span class="line">Content-Length: 615</span><br><span class="line">Last-Modified: Tue, 25 Jan 2022 15:03:52 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line">ETag: &quot;61f01158-267&quot;</span><br><span class="line">Accept-Ranges: bytes</span><br></pre></td></tr></table></figure>

<h1 id="16-安装命令行自动补全功能"><a href="#16-安装命令行自动补全功能" class="headerlink" title="16.安装命令行自动补全功能"></a>16.安装命令行自动补全功能</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum install bash-completion -y</span><br><span class="line">source /usr/share/bash-completion/bash_completion</span><br><span class="line">source &lt;(kubectl completion bash)</span><br><span class="line">echo &quot;source &lt;(kubectl completion bash)&quot; &gt;&gt; ~/.bashrc</span><br></pre></td></tr></table></figure>

<h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">镜像加速器可以使用DaoCloud仓库，替换规则如下</span></span><br><span class="line">cr.l5d.io/  ===&gt; m.daocloud.io/cr.l5d.io/</span><br><span class="line">docker.elastic.co/  ===&gt; m.daocloud.io/docker.elastic.co/</span><br><span class="line">docker.io/  ===&gt; m.daocloud.io/docker.io/</span><br><span class="line">gcr.io/  ===&gt; m.daocloud.io/gcr.io/</span><br><span class="line">ghcr.io/  ===&gt; m.daocloud.io/ghcr.io/</span><br><span class="line">k8s.gcr.io/  ===&gt; m.daocloud.io/k8s.gcr.io/</span><br><span class="line">mcr.microsoft.com/  ===&gt; m.daocloud.io/mcr.microsoft.com/</span><br><span class="line">nvcr.io/  ===&gt; m.daocloud.io/nvcr.io/</span><br><span class="line">quay.io/  ===&gt; m.daocloud.io/quay.io/</span><br><span class="line">registry.jujucharms.com/  ===&gt; m.daocloud.io/registry.jujucharms.com/</span><br><span class="line">registry.k8s.io/  ===&gt; m.daocloud.io/registry.k8s.io/</span><br><span class="line">registry.opensource.zalan.do/  ===&gt; m.daocloud.io/registry.opensource.zalan.do/</span><br><span class="line">rocks.canonical.com/  ===&gt; m.daocloud.io/rocks.canonical.com/</span><br><span class="line"></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">镜像版本要自行查看，因为镜像版本是随时更新的，文档无法做到实时更新</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">docker pull 镜像</span></span><br><span class="line"></span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/chenby/cni:master </span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/chenby/node:master</span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/chenby/kube-controllers:master</span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/chenby/typha:master</span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/chenby/coredns:v1.10.0</span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/chenby/pause:3.6</span><br><span class="line">docker pull registry.cn-hangzhou.aliyuncs.com/chenby/metrics-server:v0.5.2</span><br><span class="line">docker pull kubernetesui/dashboard:v2.7.0</span><br><span class="line">docker pull kubernetesui/metrics-scraper:v1.0.8</span><br><span class="line">docker pull quay.io/cilium/cilium:v1.12.6</span><br><span class="line">docker pull quay.io/cilium/certgen:v0.1.8</span><br><span class="line">docker pull quay.io/cilium/hubble-relay:v1.12.6</span><br><span class="line">docker pull quay.io/cilium/hubble-ui-backend:v0.9.2</span><br><span class="line">docker pull quay.io/cilium/hubble-ui:v0.9.2</span><br><span class="line">docker pull quay.io/cilium/cilium-etcd-operator:v2.0.7</span><br><span class="line">docker pull quay.io/cilium/operator:v1.12.6</span><br><span class="line">docker pull quay.io/cilium/clustermesh-apiserver:v1.12.6</span><br><span class="line">docker pull quay.io/coreos/etcd:v3.5.4</span><br><span class="line">docker pull quay.io/cilium/startup-script:d69851597ea019af980891a4628fb36b7880ec26</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">docker 保存镜像</span></span><br><span class="line">docker save registry.cn-hangzhou.aliyuncs.com/chenby/cni:master -o cni.tar </span><br><span class="line">docker save registry.cn-hangzhou.aliyuncs.com/chenby/node:master -o node.tar </span><br><span class="line">docker save registry.cn-hangzhou.aliyuncs.com/chenby/typha:master -o typha.tar </span><br><span class="line">docker save registry.cn-hangzhou.aliyuncs.com/chenby/kube-controllers:master -o kube-controllers.tar </span><br><span class="line">docker save registry.cn-hangzhou.aliyuncs.com/chenby/coredns:v1.10.0 -o coredns.tar </span><br><span class="line">docker save registry.cn-hangzhou.aliyuncs.com/chenby/pause:3.6 -o pause.tar </span><br><span class="line">docker save registry.cn-hangzhou.aliyuncs.com/chenby/metrics-server:v0.5.2 -o metrics-server.tar </span><br><span class="line">docker save kubernetesui/dashboard:v2.7.0 -o dashboard.tar </span><br><span class="line">docker save kubernetesui/metrics-scraper:v1.0.8 -o metrics-scraper.tar </span><br><span class="line">docker save quay.io/cilium/cilium:v1.12.6 -o cilium.tar </span><br><span class="line">docker save quay.io/cilium/certgen:v0.1.8 -o certgen.tar </span><br><span class="line">docker save quay.io/cilium/hubble-relay:v1.12.6 -o hubble-relay.tar </span><br><span class="line">docker save quay.io/cilium/hubble-ui-backend:v0.9.2 -o hubble-ui-backend.tar </span><br><span class="line">docker save quay.io/cilium/hubble-ui:v0.9.2 -o hubble-ui.tar </span><br><span class="line">docker save quay.io/cilium/cilium-etcd-operator:v2.0.7 -o cilium-etcd-operator.tar </span><br><span class="line">docker save quay.io/cilium/operator:v1.12.6 -o operator.tar </span><br><span class="line">docker save quay.io/cilium/clustermesh-apiserver:v1.12.6 -o clustermesh-apiserver.tar </span><br><span class="line">docker save quay.io/coreos/etcd:v3.5.4 -o etcd.tar </span><br><span class="line">docker save quay.io/cilium/startup-script:d69851597ea019af980891a4628fb36b7880ec26 -o startup-script.tar </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">传输到各个节点</span></span><br><span class="line">for NODE in k8s-master01 k8s-master02 k8s-master03 k8s-node01 k8s-node02; do scp -r images/  $NODE:/root/ ; done</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建命名空间</span></span><br><span class="line">ctr ns create k8s.io</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">导入镜像</span></span><br><span class="line">ctr --namespace k8s.io image import images/cni.tar</span><br><span class="line">ctr --namespace k8s.io image import images/node.tar</span><br><span class="line">ctr --namespace k8s.io image import images/typha.tar</span><br><span class="line">ctr --namespace k8s.io image import images/kube-controllers.tar </span><br><span class="line">ctr --namespace k8s.io image import images/coredns.tar </span><br><span class="line">ctr --namespace k8s.io image import images/pause.tar </span><br><span class="line">ctr --namespace k8s.io image import images/metrics-server.tar </span><br><span class="line">ctr --namespace k8s.io image import images/dashboard.tar </span><br><span class="line">ctr --namespace k8s.io image import images/metrics-scraper.tar </span><br><span class="line">ctr --namespace k8s.io image import images/dashboard.tar </span><br><span class="line">ctr --namespace k8s.io image import images/metrics-scraper.tar </span><br><span class="line">ctr --namespace k8s.io image import images/cilium.tar </span><br><span class="line">ctr --namespace k8s.io image import images/certgen.tar </span><br><span class="line">ctr --namespace k8s.io image import images/hubble-relay.tar </span><br><span class="line">ctr --namespace k8s.io image import images/hubble-ui-backend.tar </span><br><span class="line">ctr --namespace k8s.io image import images/hubble-ui.tar </span><br><span class="line">ctr --namespace k8s.io image import images/cilium-etcd-operator.tar </span><br><span class="line">ctr --namespace k8s.io image import images/operator.tar </span><br><span class="line">ctr --namespace k8s.io image import images/clustermesh-apiserver.tar </span><br><span class="line">ctr --namespace k8s.io image import images/etcd.tar </span><br><span class="line">ctr --namespace k8s.io image import images/startup-script.tar </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">pull tar包 解压后</span></span><br><span class="line">helm pull cilium/cilium</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看镜像版本</span></span><br><span class="line">root@hello:~/cilium# cat values.yaml| grep tag: -C1</span><br><span class="line">  repository: &quot;quay.io/cilium/cilium&quot;</span><br><span class="line">  tag: &quot;v1.12.6&quot;</span><br><span class="line">  pullPolicy: &quot;IfNotPresent&quot;</span><br><span class="line">--</span><br><span class="line">    repository: &quot;quay.io/cilium/certgen&quot;</span><br><span class="line">    tag: &quot;v0.1.8@sha256:4a456552a5f192992a6edcec2febb1c54870d665173a33dc7d876129b199ddbd&quot;</span><br><span class="line">    pullPolicy: &quot;IfNotPresent&quot;</span><br><span class="line">--</span><br><span class="line">      repository: &quot;quay.io/cilium/hubble-relay&quot;</span><br><span class="line">      tag: &quot;v1.12.6&quot;</span><br><span class="line">       # hubble-relay-digest</span><br><span class="line">--</span><br><span class="line">        repository: &quot;quay.io/cilium/hubble-ui-backend&quot;</span><br><span class="line">        tag: &quot;v0.9.2@sha256:a3ac4d5b87889c9f7cc6323e86d3126b0d382933bd64f44382a92778b0cde5d7&quot;</span><br><span class="line">        pullPolicy: &quot;IfNotPresent&quot;</span><br><span class="line">--</span><br><span class="line">        repository: &quot;quay.io/cilium/hubble-ui&quot;</span><br><span class="line">        tag: &quot;v0.9.2@sha256:d3596efc94a41c6b772b9afe6fe47c17417658956e04c3e2a28d293f2670663e&quot;</span><br><span class="line">        pullPolicy: &quot;IfNotPresent&quot;</span><br><span class="line">--</span><br><span class="line">    repository: &quot;quay.io/cilium/cilium-etcd-operator&quot;</span><br><span class="line">    tag: &quot;v2.0.7@sha256:04b8327f7f992693c2cb483b999041ed8f92efc8e14f2a5f3ab95574a65ea2dc&quot;</span><br><span class="line">    pullPolicy: &quot;IfNotPresent&quot;</span><br><span class="line">--</span><br><span class="line">    repository: &quot;quay.io/cilium/operator&quot;</span><br><span class="line">    tag: &quot;v1.12.6&quot;</span><br><span class="line">    # operator-generic-digest</span><br><span class="line">--</span><br><span class="line">    repository: &quot;quay.io/cilium/startup-script&quot;</span><br><span class="line">    tag: &quot;d69851597ea019af980891a4628fb36b7880ec26&quot;</span><br><span class="line">    pullPolicy: &quot;IfNotPresent&quot;</span><br><span class="line">--</span><br><span class="line">    repository: &quot;quay.io/cilium/cilium&quot;</span><br><span class="line">    tag: &quot;v1.12.6&quot;</span><br><span class="line">    # cilium-digest</span><br><span class="line">--</span><br><span class="line">      repository: &quot;quay.io/cilium/clustermesh-apiserver&quot;</span><br><span class="line">      tag: &quot;v1.12.6&quot;</span><br><span class="line">      # clustermesh-apiserver-digest</span><br><span class="line">--</span><br><span class="line">        repository: &quot;quay.io/coreos/etcd&quot;</span><br><span class="line">        tag: &quot;v3.5.4@sha256:795d8660c48c439a7c3764c2330ed9222ab5db5bb524d8d0607cac76f7ba82a3&quot;</span><br><span class="line">        pullPolicy: &quot;IfNotPresent&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2024-03-16</span><i class="fa fa-tag"></i><a class="tag" href="/categories/云原生/" title="云原生">云原生 </a><a class="tag" href="/tags/kubernetes/" title="kubernetes">kubernetes </a><span class="leancloud_visitors"></span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://sreok.github.io/2024/03/16/【转载】二进制部署 Kubernetes v1.29.2 ipv4ipv6双栈/,Elijah,【转载】二进制部署 Kubernetes v1.29.2 ipv4/ipv6双栈,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2024/03/16/%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85Kubernetes%20v1.29.2/" title="【云原生】二进制安装Kubernetes v1.29.2">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2024/03/11/%E3%80%90%E4%BA%91%E5%8E%9F%E7%94%9F%E3%80%91%E4%BD%BF%E7%94%A8Cilium%E4%BD%9C%E4%B8%BAKubernetes%20CNI%E6%8F%92%E4%BB%B6/" title="【云原生】使用Cilium作为Kubernetes CNI插件">下一篇</a></li></ul></div><script src="/js/visitors.js"></script><a id="comments"></a><div id="vcomments" style="margin:0 30px;"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/gh/xcss/valine@latest/dist/Valine.min.js"></script><script>var valine = new Valine({
  el:'#vcomments',
  notify:true || false, 
  verify:false|| false, 
  app_id:'fI99ZhgQcLYvkEn59ArxksxC-gzGzoHsz',
  app_key:'t54nFvuZ0mPdSIYuMFD5eL39',
  placeholder:'念念不忘，必有回响...',
  path: window.location.pathname,
  serverURLs: '',
  visitor:true,
  recordIP:true,
  avatar:'hide'
})</script></div></div></div></div><script src="/js/search.js"></script><div class="hidden" id="search-popup"><div id="search-panel"><input type="text" id="local-search-input" name="q" results="0" placeholder="搜索..."><div id="local-search-results"></div></div></div><script>// 点击按钮显示弹窗
document.getElementById('search-button')?.addEventListener('click', function(event) {
    document.getElementById('search-popup').classList.remove('hidden');
    document.getElementById('local-search-input').focus();
    event.stopPropagation();
});

// 点击弹窗外关闭
document.addEventListener('click', function() {
    document.getElementById('search-popup').classList.add('hidden');
});

// 阻止弹窗内冒泡
document.getElementById('search-popup').addEventListener('click', function(event) {
    event.stopPropagation();
});

// 初始化搜索功能
document.addEventListener('DOMContentLoaded', function() {
    const path = "/search.json";
    if (typeof searchFunc === 'function') {
    searchFunc(path, 'local-search-input', 'local-search-results');
    } else {
    console.error('searchFunc is not defined');
    }
});</script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script src="/js/baidu-tongji.js"></script></body></html>