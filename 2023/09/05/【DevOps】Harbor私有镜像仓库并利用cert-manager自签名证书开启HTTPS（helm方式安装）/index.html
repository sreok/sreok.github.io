<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Elijah"><title>【DevOps】Harbor私有镜像仓库并利用cert-manager自签名证书开启HTTPS（helm方式安装） · Elijah</title><meta name="description" content="前提条件
cert-manager

ingress-nginx

Helm 2.8.0+

Kubernetes cluster 1.10+


12# 命名空间kubectl create ns devops

自签名证书1234567891011121314151617181920212223"><meta name="keywords" content="Elijah博客,Elijah Blog,博客,Elijah,Linux,Kubernetes,Docker,DevOps"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/links.css"><link rel="stylesheet" href="/css/search.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 7.3.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo.png" style="width:127px;"><h3 title=""><a href="/">Elijah</a></h3><div class="description"><p>Do one thing at a time, and do well</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/sreok"><i class="fa fa-github"></i></a></li><li><a href="mailto:admin@vsoul.cn"><i class="fa fa-envelope"></i></a></li><li><a href="/rss.xml"><i class="fa fa-rss"></i></a></li></ul><div class="footer"><div class="p"> <span>© 2020 - 2025 Elijah All Rights Reserved.</span></div><div class="by_farbox"><span>Technical support provided by </span><a href="https://github.com/sreok" target="_blank">Elijah  </a><span> & </span><a href="https://hexo.io/zh-cn/" target="_blank">Hexo </a></div><div class="beian"><img src="/images/gongan.png" style="height:10px;margin-right: 10px;position: relative;top: 1px;"><a href="https://beian.miit.gov.cn/" target="_blank">冀ICP备2022029112号</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/archives">归档</a></li><li><a href="/tags">标签</a></li><li><a href="/about">关于</a></li><li><a href="/links">友链</a></li><li><a href="/guestbook">留言</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="search_btn"><li><a id="search-button"><i class="fa fa-search"></i></a></li></div><div class="avatar"><img src="/images/favicon.png"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>【DevOps】Harbor私有镜像仓库并利用cert-manager自签名证书开启HTTPS（helm方式安装）</a></h3></div><div class="post-content"><h3 id="前提条件"><a href="#前提条件" class="headerlink" title="前提条件"></a><strong>前提条件</strong></h3><ul>
<li><p>cert-manager</p>
</li>
<li><p>ingress-nginx</p>
</li>
<li><p>Helm 2.8.0+</p>
</li>
<li><p>Kubernetes cluster 1.10+</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 命名空间</span><br><span class="line">kubectl create ns devops</span><br></pre></td></tr></table></figure>

<h3 id="自签名证书"><a href="#自签名证书" class="headerlink" title="自签名证书"></a><strong>自签名证书</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: cert-manager.io/v1</span><br><span class="line">kind: ClusterIssuer</span><br><span class="line">metadata:</span><br><span class="line">  name: selfsigned</span><br><span class="line">spec:</span><br><span class="line">  selfSigned: &#123;&#125;</span><br><span class="line">---</span><br><span class="line">apiVersion: cert-manager.io/v1</span><br><span class="line">kind: Certificate</span><br><span class="line">metadata:</span><br><span class="line">  name: devops-ca</span><br><span class="line">  namespace: cert-manager</span><br><span class="line">spec:</span><br><span class="line">  isCA: true</span><br><span class="line">  commonName: &quot;*.basepoint.net&quot;</span><br><span class="line">  secretName: devops-selfsigned-secret</span><br><span class="line">  duration: 876000h</span><br><span class="line">  renewBefore: 8760h</span><br><span class="line">  subject:</span><br><span class="line">    countries:</span><br><span class="line">    - China</span><br><span class="line">    localities:</span><br><span class="line">    - NanJing</span><br><span class="line">    organizations:</span><br><span class="line">    - basepoint</span><br><span class="line">    organizationalUnits:</span><br><span class="line">    - devops</span><br><span class="line">  privateKey:</span><br><span class="line">    algorithm: ECDSA</span><br><span class="line">    size: 256</span><br><span class="line">  issuerRef:</span><br><span class="line">    name: selfsigned</span><br><span class="line">    kind: ClusterIssuer</span><br><span class="line">    group: cert-manager.io</span><br><span class="line">---</span><br><span class="line">apiVersion: cert-manager.io/v1</span><br><span class="line">kind: ClusterIssuer</span><br><span class="line">metadata:</span><br><span class="line">  name: devops-issuer</span><br><span class="line">spec:</span><br><span class="line">  ca:</span><br><span class="line">    secretName: devops-selfsigned-secret</span><br><span class="line">---</span><br><span class="line">apiVersion: cert-manager.io/v1</span><br><span class="line">kind: Certificate</span><br><span class="line">metadata:</span><br><span class="line">  name: harbor-ca</span><br><span class="line">  namespace: devops</span><br><span class="line">  #namespace: cert-manager</span><br><span class="line">spec:</span><br><span class="line">  isCA: false</span><br><span class="line">  usages:</span><br><span class="line">    - server auth</span><br><span class="line">    - client auth</span><br><span class="line">  dnsNames:</span><br><span class="line">  - basepoint.net</span><br><span class="line">  - harbor.basepoint.net</span><br><span class="line">  commonName: &quot;harbor.basepoint.net&quot;</span><br><span class="line">  secretName: harbor-selfsigned-secret</span><br><span class="line">  duration: 876000h</span><br><span class="line">  renewBefore: 8760h</span><br><span class="line">  subject:</span><br><span class="line">    countries:</span><br><span class="line">    - China</span><br><span class="line">    localities:</span><br><span class="line">    - NanJing</span><br><span class="line">    organizations:</span><br><span class="line">    - basepoint</span><br><span class="line">    organizationalUnits:</span><br><span class="line">    - harbor</span><br><span class="line">  privateKey:</span><br><span class="line">    algorithm: ECDSA</span><br><span class="line">    size: 256</span><br><span class="line">  issuerRef:</span><br><span class="line">    name: devops-issuer</span><br><span class="line">    kind: ClusterIssuer</span><br><span class="line">    group: cert-manager.io</span><br></pre></td></tr></table></figure>

<blockquote>
<p>详解，原文链接：<a target="_blank" rel="noopener" href="https://sreok.cn/archives/c03ad0e3-f52e-4e3e-805a-95bcf2a9b37c">使用cert-manager 生成自签名证书 - Elijah Blog (</a><a target="_blank" rel="noopener" href="http://sreok.cn/">sreok.cn</a><a target="_blank" rel="noopener" href="https://sreok.cn/archives/c03ad0e3-f52e-4e3e-805a-95bcf2a9b37c">)</a></p>
</blockquote>
<h4 id="查看tls文件"><a href="#查看tls文件" class="headerlink" title="查看tls文件"></a><strong>查看tls文件</strong></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-master01 cert-manager]# kubectl get secrets -n devops harbor-selfsigned-secret</span><br><span class="line">NAME                       TYPE                DATA   AGE</span><br><span class="line">harbor-selfsigned-secret   kubernetes.io/tls   3      18s</span><br></pre></td></tr></table></figure>

<h3 id="安装Harbor"><a href="#安装Harbor" class="headerlink" title="安装Harbor"></a><strong>安装Harbor</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">helm repo add harbor https://helm.goharbor.io</span><br><span class="line">helm pull harbor/harbor --untar</span><br></pre></td></tr></table></figure>

<h4 id="修改values-yaml"><a href="#修改values-yaml" class="headerlink" title="修改values.yaml"></a><strong>修改values.yaml</strong></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ./harbor</span><br><span class="line">vim values.yaml</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br></pre></td><td class="code"><pre><span class="line">expose:</span><br><span class="line">  type: ingress</span><br><span class="line">  tls:</span><br><span class="line">    enabled: true</span><br><span class="line">    # 改成secret，使用刚才生成的自签名证书</span><br><span class="line">    certSource: secret</span><br><span class="line">    auto:</span><br><span class="line">      commonName: &quot;&quot;</span><br><span class="line">    secret:</span><br><span class="line">      # 改为自签名证书secret名</span><br><span class="line">      secretName: &quot;harbor-selfsigned-secret&quot;</span><br><span class="line">  ingress:</span><br><span class="line">    hosts:</span><br><span class="line">      # harbor域名</span><br><span class="line">      core: harbor.basepoint.net</span><br><span class="line">    controller: default</span><br><span class="line">    kubeVersionOverride: &quot;&quot;</span><br><span class="line">    className: &quot;nginx&quot;</span><br><span class="line">    annotations:nginx lines below</span><br><span class="line">      ingress.kubernetes.io/ssl-redirect: &quot;true&quot;</span><br><span class="line">      ingress.kubernetes.io/proxy-body-size: &quot;0&quot;</span><br><span class="line">      nginx.ingress.kubernetes.io/ssl-redirect: &quot;true&quot;</span><br><span class="line">      nginx.ingress.kubernetes.io/proxy-body-size: &quot;0&quot;</span><br><span class="line">    labels: &#123;&#125;</span><br><span class="line">  clusterIP:</span><br><span class="line">    name: harbor</span><br><span class="line">    staticClusterIP: &quot;&quot;</span><br><span class="line">    ports:</span><br><span class="line">      # The service port Harbor listens on when serving HTTP</span><br><span class="line">      httpPort: 80</span><br><span class="line">      # The service port Harbor listens on when serving HTTPS</span><br><span class="line">      httpsPort: 443</span><br><span class="line">    # Annotations on the ClusterIP service</span><br><span class="line">    annotations: &#123;&#125;</span><br><span class="line">    # ClusterIP-specific labels</span><br><span class="line">    labels: &#123;&#125;</span><br><span class="line">  nodePort:</span><br><span class="line">    # The name of NodePort service</span><br><span class="line">    name: harbor</span><br><span class="line">    ports:</span><br><span class="line">      http:</span><br><span class="line">        # The service port Harbor listens on when serving HTTP</span><br><span class="line">        port: 80</span><br><span class="line">        # The node port Harbor listens on when serving HTTP</span><br><span class="line">        nodePort: 30002</span><br><span class="line">      https:</span><br><span class="line">        # The service port Harbor listens on when serving HTTPS</span><br><span class="line">        port: 443</span><br><span class="line">        # The node port Harbor listens on when serving HTTPS</span><br><span class="line">        nodePort: 30003</span><br><span class="line">    # Annotations on the nodePort service</span><br><span class="line">    annotations: &#123;&#125;</span><br><span class="line">    # nodePort-specific labels</span><br><span class="line">    labels: &#123;&#125;</span><br><span class="line">  loadBalancer:</span><br><span class="line">    # The name of LoadBalancer service</span><br><span class="line">    name: harbor</span><br><span class="line">    # Set the IP if the LoadBalancer supports assigning IP</span><br><span class="line">    IP: &quot;&quot;</span><br><span class="line">    ports:</span><br><span class="line">      # The service port Harbor listens on when serving HTTP</span><br><span class="line">      httpPort: 80</span><br><span class="line">      # The service port Harbor listens on when serving HTTPS</span><br><span class="line">      httpsPort: 443</span><br><span class="line">    # Annotations on the loadBalancer service</span><br><span class="line">    annotations: &#123;&#125;</span><br><span class="line">    # loadBalancer-specific labels</span><br><span class="line">    labels: &#123;&#125;</span><br><span class="line">    sourceRanges: []</span><br><span class="line">​</span><br><span class="line"># The external URL for Harbor core service. It is used to</span><br><span class="line"># 1) populate the docker/helm commands showed on portal</span><br><span class="line"># 2) populate the token service URL returned to docker client</span><br><span class="line">#</span><br><span class="line"># Format: protocol://domain[:port]. Usually:</span><br><span class="line"># 1) if &quot;expose.type&quot; is &quot;ingress&quot;, the &quot;domain&quot; should be</span><br><span class="line"># the value of &quot;expose.ingress.hosts.core&quot;</span><br><span class="line"># 2) if &quot;expose.type&quot; is &quot;clusterIP&quot;, the &quot;domain&quot; should be</span><br><span class="line"># the value of &quot;expose.clusterIP.name&quot;</span><br><span class="line"># 3) if &quot;expose.type&quot; is &quot;nodePort&quot;, the &quot;domain&quot; should be</span><br><span class="line"># the IP address of k8s node</span><br><span class="line">#</span><br><span class="line"># If Harbor is deployed behind the proxy, set it as the URL of proxy</span><br><span class="line"># 改为</span><br><span class="line">externalURL: https://harbor.basepoint.net</span><br><span class="line">​</span><br><span class="line"># The persistence is enabled by default and a default StorageClass</span><br><span class="line"># is needed in the k8s cluster to provision volumes dynamically.</span><br><span class="line"># Specify another StorageClass in the &quot;storageClass&quot; or set &quot;existingClaim&quot;</span><br><span class="line"># if you already have existing persistent volumes to use</span><br><span class="line">#</span><br><span class="line"># For storing images and charts, you can also use &quot;azure&quot;, &quot;gcs&quot;, &quot;s3&quot;,</span><br><span class="line"># &quot;swift&quot; or &quot;oss&quot;. Set it in the &quot;imageChartStorage&quot; section</span><br><span class="line">persistence:</span><br><span class="line">  enabled: true</span><br><span class="line">  # Setting it to &quot;keep&quot; to avoid removing PVCs during a helm delete</span><br><span class="line">  # operation. Leaving it empty will delete PVCs after the chart deleted</span><br><span class="line">  # (this does not apply for PVCs that are created for internal database</span><br><span class="line">  # and redis components, i.e. they are never deleted automatically)</span><br><span class="line">  resourcePolicy: &quot;keep&quot;</span><br><span class="line">  persistentVolumeClaim:</span><br><span class="line">    registry:</span><br><span class="line">      existingClaim: &quot;&quot;</span><br><span class="line">      # storageClass根据实际更改，不设置代表使用默认的storageClass</span><br><span class="line">      storageClass: &quot;&quot;</span><br><span class="line">      subPath: &quot;&quot;</span><br><span class="line">      accessMode: ReadWriteOnce</span><br><span class="line">      # 大小根据需求更改</span><br><span class="line">      size: 5Gi</span><br><span class="line">      annotations: &#123;&#125;</span><br><span class="line">    jobservice:</span><br><span class="line">      jobLog:</span><br><span class="line">        existingClaim: &quot;&quot;</span><br><span class="line">        storageClass: &quot;&quot;</span><br><span class="line">        subPath: &quot;&quot;</span><br><span class="line">        accessMode: ReadWriteOnce</span><br><span class="line">        size: 1Gi</span><br><span class="line">        annotations: &#123;&#125;</span><br><span class="line">    # If external database is used, the following settings for database will</span><br><span class="line">    # be ignored</span><br><span class="line">    database:</span><br><span class="line">      existingClaim: &quot;&quot;</span><br><span class="line">      storageClass: &quot;&quot;</span><br><span class="line">      subPath: &quot;&quot;</span><br><span class="line">      accessMode: ReadWriteOnce</span><br><span class="line">      size: 1Gi</span><br><span class="line">      annotations: &#123;&#125;</span><br><span class="line">    # If external Redis is used, the following settings for Redis will</span><br><span class="line">    # be ignored</span><br><span class="line">    redis:</span><br><span class="line">      existingClaim: &quot;&quot;</span><br><span class="line">      storageClass: &quot;&quot;</span><br><span class="line">      subPath: &quot;&quot;</span><br><span class="line">      accessMode: ReadWriteOnce</span><br><span class="line">      size: 1Gi</span><br><span class="line">      annotations: &#123;&#125;</span><br><span class="line">    trivy:</span><br><span class="line">      existingClaim: &quot;&quot;</span><br><span class="line">      storageClass: &quot;&quot;</span><br><span class="line">      subPath: &quot;&quot;</span><br><span class="line">      accessMode: ReadWriteOnce</span><br><span class="line">      size: 5Gi</span><br><span class="line">      annotations: &#123;&#125;</span><br><span class="line">  imageChartStorage:</span><br><span class="line">    type: filesystem</span><br><span class="line">    filesystem:</span><br><span class="line">      rootdirectory: /storage</span><br><span class="line">      #maxthreads: 100</span><br><span class="line">    azure:</span><br><span class="line">      accountname: accountname</span><br><span class="line">      accountkey: base64encodedaccountkey</span><br><span class="line">      container: containername</span><br><span class="line">      #realm: core.windows.net</span><br><span class="line">      # To use existing secret, the key must be AZURE_STORAGE_ACCESS_KEY</span><br><span class="line">      existingSecret: &quot;&quot;</span><br><span class="line">    gcs:</span><br><span class="line">      bucket: bucketname</span><br><span class="line">      # The base64 encoded json file which contains the key</span><br><span class="line">      encodedkey: base64-encoded-json-key-file</span><br><span class="line">      #rootdirectory: /gcs/object/name/prefix</span><br><span class="line">      #chunksize: &quot;5242880&quot;</span><br><span class="line">      # To use existing secret, the key must be GCS_KEY_DATA</span><br><span class="line">      existingSecret: &quot;&quot;</span><br><span class="line">      useWorkloadIdentity: false</span><br><span class="line">    s3:</span><br><span class="line">      # Set an existing secret for S3 accesskey and secretkey</span><br><span class="line">      # keys in the secret should be REGISTRY_STORAGE_S3_ACCESSKEY and REGISTRY_STORAGE_S3_SECRETKEY for registry</span><br><span class="line">      #existingSecret: &quot;&quot;</span><br><span class="line">      region: us-west-1</span><br><span class="line">      bucket: bucketname</span><br><span class="line">      #accesskey: awsaccesskey</span><br><span class="line">      #secretkey: awssecretkey</span><br><span class="line">      #regionendpoint: http://myobjects.local</span><br><span class="line">      #encrypt: false</span><br><span class="line">      #keyid: mykeyid</span><br><span class="line">      #secure: true</span><br><span class="line">      #skipverify: false</span><br><span class="line">      #v4auth: true</span><br><span class="line">      #chunksize: &quot;5242880&quot;</span><br><span class="line">      #rootdirectory: /s3/object/name/prefix</span><br><span class="line">      #storageclass: STANDARD</span><br><span class="line">      #multipartcopychunksize: &quot;33554432&quot;</span><br><span class="line">      #multipartcopymaxconcurrency: 100</span><br><span class="line">      #multipartcopythresholdsize: &quot;33554432&quot;</span><br><span class="line">    swift:</span><br><span class="line">      authurl: https://storage.myprovider.com/v3/auth</span><br><span class="line">      username: username</span><br><span class="line">      password: password</span><br><span class="line">      container: containername</span><br><span class="line">      # keys in existing secret must be REGISTRY_STORAGE_SWIFT_PASSWORD, REGISTRY_STORAGE_SWIFT_SECRETKEY, REGISTRY_STORAGE_SWIFT_ACCESSKEY</span><br><span class="line">      existingSecret: &quot;&quot;</span><br><span class="line">      #region: fr</span><br><span class="line">      #tenant: tenantname</span><br><span class="line">      #tenantid: tenantid</span><br><span class="line">      #domain: domainname</span><br><span class="line">      #domainid: domainid</span><br><span class="line">      #trustid: trustid</span><br><span class="line">      #insecureskipverify: false</span><br><span class="line">      #chunksize: 5M</span><br><span class="line">      #prefix:</span><br><span class="line">      #secretkey: secretkey</span><br><span class="line">      #accesskey: accesskey</span><br><span class="line">      #authversion: 3</span><br><span class="line">      #endpointtype: public</span><br><span class="line">      #tempurlcontainerkey: false</span><br><span class="line">      #tempurlmethods:</span><br><span class="line">    oss:</span><br><span class="line">      accesskeyid: accesskeyid</span><br><span class="line">      accesskeysecret: accesskeysecret</span><br><span class="line">      region: regionname</span><br><span class="line">      bucket: bucketname</span><br><span class="line">      # key in existingSecret must be REGISTRY_STORAGE_OSS_ACCESSKEYSECRET</span><br><span class="line">      existingSecret: &quot;&quot;</span><br><span class="line">      #endpoint: endpoint</span><br><span class="line">      #internal: false</span><br><span class="line">      #encrypt: false</span><br><span class="line">      #secure: true</span><br><span class="line">      #chunksize: 10M</span><br><span class="line">      #rootdirectory: rootdirectory</span><br><span class="line">​</span><br><span class="line">​</span><br><span class="line">existingSecretAdminPasswordKey: HARBOR_ADMIN_PASSWORD</span><br><span class="line"># 默认密码，按需修改</span><br><span class="line">harborAdminPassword: &quot;Harbor12345&quot;</span><br><span class="line">​</span><br><span class="line">...</span><br><span class="line"># 下面的配置按需求修改，我这里没改动就不贴了，太长了。</span><br></pre></td></tr></table></figure>

<blockquote>
<p>中文注释都是改动的位置</p>
</blockquote>
<h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a><strong>安装</strong></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">helm upgrade --install harbor -n devops .</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-h3c-master01 ~]# kubectl get pod -n devops</span><br><span class="line">NAME                                READY   STATUS    RESTARTS        AGE</span><br><span class="line">harbor-core-659b9b95fc-7l69q        1/1     Running   0               21h</span><br><span class="line">harbor-database-0                   1/1     Running   0               3d17h</span><br><span class="line">harbor-jobservice-8b5f47bd5-lcdhw   1/1     Running   0               21h</span><br><span class="line">harbor-portal-67749b88d8-tcjqd      1/1     Running   0               3d17h</span><br><span class="line">harbor-redis-0                      1/1     Running   0               3d17h</span><br><span class="line">harbor-registry-687cc8d459-5w9l8    2/2     Running   0               21h</span><br><span class="line">harbor-trivy-0                      1/1     Running   0               3d17h</span><br></pre></td></tr></table></figure>

<h4 id="查看ingress"><a href="#查看ingress" class="headerlink" title="查看ingress"></a><strong>查看ingress</strong></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-h3c-master01 ~]# kubectl get ingress -n devops</span><br><span class="line">NAME             CLASS   HOSTS                  ADDRESS        PORTS     AGE</span><br><span class="line">harbor-ingress   nginx   harbor.basepoint.net   172.25.2.204   80, 443</span><br></pre></td></tr></table></figure>

<h4 id="添加hosts"><a href="#添加hosts" class="headerlink" title="添加hosts"></a><strong>添加hosts</strong></h4><p><code>系统添加，略过。</code></p>
<h4 id="查看证书"><a href="#查看证书" class="headerlink" title="查看证书"></a><strong>查看证书</strong></h4><p><img src="/images/image-zmhl.png"></p>
<h3 id="系统颁发证书"><a href="#系统颁发证书" class="headerlink" title="系统颁发证书"></a><strong>系统颁发证书</strong></h3><p><img src="https://sreok.cn/images/image-iydt.png" alt="img"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># basse64解码并保存到电脑</span><br><span class="line">echo &quot;connect in ca.crt&quot; | base64 -d</span><br></pre></td></tr></table></figure>

<p><img src="https://sreok.cn/images/image-fhla.png" alt="img"></p>
<h4 id="MacOS-导入证书"><a href="#MacOS-导入证书" class="headerlink" title="MacOS 导入证书"></a><strong>MacOS 导入证书</strong></h4><p><img src="https://sreok.cn/images/image-mwml.png" alt="img"></p>
<p><img src="https://sreok.cn/images/image-aqcb.png" alt="img"></p>
<p><img src="https://sreok.cn/images/image-ybtx.png" alt="img"></p>
<h4 id="Linux-导入证书（全部k8s节点操作）"><a href="#Linux-导入证书（全部k8s节点操作）" class="headerlink" title="Linux 导入证书（全部k8s节点操作）"></a><strong>Linux 导入证书（全部k8s节点操作）</strong></h4><p>安装ca-certificates，一般系统是自带的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install ca-certificates</span><br></pre></td></tr></table></figure>

<p>将证书放置以下目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/etc/pki/ca-trust/source/anchors/</span><br></pre></td></tr></table></figure>

<p>执行信任此证书</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update-ca-trust</span><br></pre></td></tr></table></figure>

<blockquote>
<p>此操作会更新以下文件，而不是只是tls-ca-bundle.pem</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/etc/pki/ca-trust/extracted/openssl/ca-bundle.trust.crt</span><br><span class="line">/etc/pki/ca-trust/extracted/pem/tls-ca-bundle.pem</span><br><span class="line">/etc/pki/ca-trust/extracted/pem/email-ca-bundle.pem</span><br><span class="line">/etc/pki/ca-trust/extracted/pem/objsign-ca-bundle.pem  </span><br></pre></td></tr></table></figure>

<p>删除时在<code>/etc/pki/ca-trust/source/anchors/</code>文件中删掉对应的ca证书，重新执行<code>update-ca-trust</code>即可。</p>
</blockquote>
<h3 id="创建imagePullSecrets"><a href="#创建imagePullSecrets" class="headerlink" title="创建imagePullSecrets"></a><strong>创建imagePullSecrets</strong></h3><h4 id="方式一：在命令行上提供凭据来创建-Secret"><a href="#方式一：在命令行上提供凭据来创建-Secret" class="headerlink" title="方式一：在命令行上提供凭据来创建 Secret"></a><strong>方式一：在命令行上提供凭据来创建 Secret</strong></h4><p>官方文档：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/pull-image-private-registry/#create-a-secret-by-providing-credentials-on-the-command-line">从私有仓库拉取镜像 | Kubernetes</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret docker-registry regcred \</span><br><span class="line">--docker-server=harbor.basepoint.net \</span><br><span class="line">--docker-username=admin \</span><br><span class="line">--docker-password=Harbor12345 \</span><br><span class="line">--docker-email=admin@basepoint.net</span><br><span class="line"># -n 命名空间 </span><br></pre></td></tr></table></figure>

<h4 id="方式二：创建一个基于现有凭据的-Secret"><a href="#方式二：创建一个基于现有凭据的-Secret" class="headerlink" title="方式二：创建一个基于现有凭据的 Secret"></a><strong>方式二：创建一个基于现有凭据的 Secret</strong></h4><p>官方文档：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh-cn/docs/tasks/configure-pod-container/pull-image-private-registry/#registry-secret-existing-credentials">从私有仓库拉取镜像 | Kubernetes</a></p>
<p>选择其中一个节点安装docker</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install docker-ce</span><br></pre></td></tr></table></figure>

<p>登录docker</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker login harbor.basepoint.net -u admin -p Harbor12345</span><br></pre></td></tr></table></figure>

<p>登录成功后会创建一个文件：<code>~/.docker/config.json</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret generic harbor-admin \</span><br><span class="line">--from-file=.dockerconfigjson=~/.docker/config.json \</span><br><span class="line">--type=kubernetes.io/dockerconfigjson</span><br><span class="line"># -n 命名空间 </span><br></pre></td></tr></table></figure>

<h3 id="测试拉取镜像"><a href="#测试拉取镜像" class="headerlink" title="测试拉取镜像"></a><strong>测试拉取镜像</strong></h3><p>将library设置为私有仓库</p>
<p><img src="/images/image-oiwb.png"></p>
<h4 id="拉取私有仓库镜像"><a href="#拉取私有仓库镜像" class="headerlink" title="拉取私有仓库镜像"></a><strong>拉取私有仓库镜像</strong></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">cat &gt; nginx.yaml &lt;&lt; EOF</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx</span><br><span class="line">  labels:</span><br><span class="line">    app: nginx</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: nginx</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: nginx</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: nginx</span><br><span class="line">        image: harbor.basepoint.net/library/nginx:1.25.0</span><br><span class="line">        # 每次启动都拉取</span><br><span class="line">        imagePullPolicy: Always</span><br><span class="line">      # 注意命名空间，如果要安装在其他命名空间，就不存在这个seccret，则需要重新创建</span><br><span class="line">      imagePullSecrets:</span><br><span class="line">      - name: harbor-admin</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f nginx.yaml</span><br></pre></td></tr></table></figure>

<h4 id="成功即可"><a href="#成功即可" class="headerlink" title="成功即可"></a><strong>成功即可</strong></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@k8s-h3c-master01 ~]# kubectl get pod</span><br><span class="line">NAME                         READY   STATUS    RESTARTS   AGE</span><br><span class="line">nginx-67d8d49fb6-4vwk9       1/1     Running   0          59m</span><br></pre></td></tr></table></figure>

<p><img src="/images/image-uuoq.png"></p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2023-09-05</span><i class="fa fa-tag"></i><a class="tag" href="/categories/云原生/" title="云原生">云原生 </a><a class="tag" href="/tags/Harbor/" title="Harbor">Harbor </a><a class="tag" href="/tags/DevOps/" title="DevOps">DevOps </a><span class="leancloud_visitors"></span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://sreok.github.io/2023/09/05/【DevOps】Harbor私有镜像仓库并利用cert-manager自签名证书开启HTTPS（helm方式安装）/,Elijah,【DevOps】Harbor私有镜像仓库并利用cert-manager自签名证书开启HTTPS（helm方式安装）,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2023/09/06/%E3%80%90DevOps%E3%80%91Jenkins%E5%9F%BA%E4%BA%8EKubernetes%E5%88%9B%E5%BB%BA%E9%9D%99%E6%80%81%E6%9E%84%E5%BB%BA%E6%B1%A0/" title="【DevOps】Jenkins基于Kubernetes创建静态构建池">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2023/07/10/%E3%80%90%E6%95%85%E9%9A%9C%E6%8E%92%E6%9F%A5%E3%80%91kube-vip%20%E4%B8%8E%20MetalLB%20LoadBalancer%20Layer2%20ARP%E5%86%B2%E7%AA%81/" title="【故障排查】kube-vip 与 MetalLB LoadBalancer Layer2 ARP冲突">下一篇</a></li></ul></div><script src="/js/visitors.js"></script><a id="comments"></a><div id="vcomments" style="margin:0 30px;"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/gh/xcss/valine@latest/dist/Valine.min.js"></script><script>var valine = new Valine({
  el:'#vcomments',
  notify:true || false, 
  verify:false|| false, 
  app_id:'fI99ZhgQcLYvkEn59ArxksxC-gzGzoHsz',
  app_key:'t54nFvuZ0mPdSIYuMFD5eL39',
  placeholder:'念念不忘，必有回响...',
  path: window.location.pathname,
  serverURLs: '',
  visitor:true,
  recordIP:true,
  avatar:'hide'
})</script></div></div></div></div><script src="/js/search.js"></script><div class="hidden" id="search-popup"><div id="search-panel"><input type="text" id="local-search-input" name="q" results="0" placeholder="搜索..."><div id="local-search-results"></div></div></div><script>// 点击按钮显示弹窗
document.getElementById('search-button')?.addEventListener('click', function(event) {
    document.getElementById('search-popup').classList.remove('hidden');
    document.getElementById('local-search-input').focus();
    event.stopPropagation();
});

// 点击弹窗外关闭
document.addEventListener('click', function() {
    document.getElementById('search-popup').classList.add('hidden');
});

// 阻止弹窗内冒泡
document.getElementById('search-popup').addEventListener('click', function(event) {
    event.stopPropagation();
});

// 初始化搜索功能
document.addEventListener('DOMContentLoaded', function() {
    const path = "/search.json";
    if (typeof searchFunc === 'function') {
    searchFunc(path, 'local-search-input', 'local-search-results');
    } else {
    console.error('searchFunc is not defined');
    }
});</script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script src="/js/baidu-tongji.js"></script></body></html>