<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Elijah"><title>【DevOps】Jenkins基于Kubernetes创建动态构建池 · Elijah</title><meta name="description" content="安装插件
Kubernetes

GitLab


添加GitLab密钥1. GitLab &amp;#x3D;&amp;#x3D;&amp;gt; 创建jenkins用户
2. 进入jenkins个人中心 &amp;#x3D;&amp;#x3D;&amp;gt; 创建token

3. jenkins &amp;#x3D;&amp;#x3D;&amp;gt; 凭证管理"><meta name="keywords" content="Elijah博客,Elijah Blog,博客,Elijah,Linux,Kubernetes,Docker,DevOps"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/search.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><script src="/js/jquery.js"></script><meta name="generator" content="Hexo 7.3.0"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo.png" style="width:127px;"><h3 title=""><a href="/">Elijah</a></h3><div class="description"><p>Do one thing at a time, and do well</p></div></div></div><ul class="social-links"><li><a target="_blank" rel="noopener" href="https://github.com/sreok"><i class="fa fa-github"></i></a></li><li><a href="mailto:admin@vsoul.cn"><i class="fa fa-envelope"></i></a></li><li><a href="/rss.xml"><i class="fa fa-rss"></i></a></li></ul><div class="footer"><div class="p"> <span>© 2020 - 2025 Elijah All Rights Reserved.</span></div><div class="by_farbox"><span>Technical support provided by </span><a href="https://github.com/sreok" target="_blank">Elijah  </a><span> & </span><a href="https://hexo.io/zh-cn/" target="_blank">Hexo </a></div><div class="beian"><img src="/images/gongan.png" style="height:10px;margin-right: 10px;position: relative;top: 1px;"><a href="https://beian.miit.gov.cn/" target="_blank">冀ICP备2022029112号</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/archives">归档</a></li><li><a href="/tags">标签</a></li><li><a href="/about">关于</a></li><li><a href="/links">友链</a></li><li><a href="/guestbook">留言</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="/images/favicon.png"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>【DevOps】Jenkins基于Kubernetes创建动态构建池</a></h3></div><div class="post-content"><h3 id="安装插件"><a href="#安装插件" class="headerlink" title="安装插件"></a>安装插件</h3><ul>
<li><p>Kubernetes</p>
</li>
<li><p>GitLab</p>
</li>
</ul>
<h3 id="添加GitLab密钥"><a href="#添加GitLab密钥" class="headerlink" title="添加GitLab密钥"></a>添加GitLab密钥</h3><p>1. GitLab &#x3D;&#x3D;&gt; 创建jenkins用户</p>
<p>2. 进入jenkins个人中心 &#x3D;&#x3D;&gt; 创建token</p>
<p><img src="/images/image-gujn.png"></p>
<p>3. jenkins &#x3D;&#x3D;&gt; 凭证管理 &#x3D;&#x3D;&gt; 系统 &#x3D;&#x3D;&gt; 全局凭证 &#x3D;&#x3D;&gt; 添加凭证 &#x3D;&#x3D;&gt; 类型（GitLab API token）</p>
<p><img src="/images/image-sgvg.png"></p>
<ol start="4">
<li>创建kubernetes凭证（部署用）</li>
</ol>
<p><img src="/images/image-tpuc.png"></p>
<h3 id="自定义构建镜像"><a href="#自定义构建镜像" class="headerlink" title="自定义构建镜像"></a>自定义构建镜像</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">FROM rockylinux:9.3</span><br><span class="line"></span><br><span class="line"># ca.crt是https的ca证书，用于获取gitlab代码和harbor镜像</span><br><span class="line">COPY ca.crt /etc/pki/ca-trust/source/anchors/</span><br><span class="line"># 部署到kubernetes时使用</span><br><span class="line">COPY kubectl /usr/local/bin</span><br><span class="line"># 部署helm使用</span><br><span class="line">COPY helm /usr/local/bin</span><br><span class="line"># 启动时使用</span><br><span class="line">COPY jenkins-agent /usr/local/bin</span><br><span class="line"># go环境</span><br><span class="line">COPY build/go1.22.5.linux-amd64.tar.gz /tmp</span><br><span class="line"># java环境</span><br><span class="line">COPY build/openjdk-22.0.2_linux-x64_bin.tar.gz /tmp</span><br><span class="line"># workdir时会创建这个目录</span><br><span class="line">WORKDIR /usr/share/jenkins</span><br><span class="line">COPY agent.jar /usr/share/jenkins</span><br><span class="line"></span><br><span class="line"># 安装基础包、解压环境、信任证书</span><br><span class="line">RUN yum -y install yum-utils git wget vim &amp;&amp; \</span><br><span class="line">    tar -C /usr/local -xzf /tmp/go1.22.5.linux-amd64.tar.gz &amp;&amp; \</span><br><span class="line">    tar -C /usr/local -xzf /tmp/openjdk-22.0.2_linux-x64_bin.tar.gz &amp;&amp; \</span><br><span class="line">    update-ca-trust</span><br><span class="line"></span><br><span class="line"># 设置环境变量</span><br><span class="line">ENV JAVA_HOME=/usr/local/jdk-22.0.2</span><br><span class="line">ENV PATH=$PATH:/usr/local/go/bin:/usr/local/jdk-22.0.2/bin</span><br><span class="line">ENV GOPATH=/usr/share/go</span><br><span class="line">ENV GO111MODULE=on</span><br><span class="line">ENV GOPRIVATE=gitee.cn</span><br><span class="line">ENV GOPROXY=https://goproxy.cn,direct</span><br><span class="line"></span><br><span class="line"># 进入镜像时的目录，这里与一会agent要设置的workspaces一致，是为了排查时方便，这个无所谓。</span><br><span class="line">WORKDIR /home/jenkins/agent</span><br><span class="line">ENTRYPOINT [&quot;/usr/local/bin/jenkins-agent&quot;]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>jenkins-agent最后一行改为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec $JAVA_BIN $JAVA_OPTIONS -jar /usr/share/jenkins/agent.jar $SECRET $AGENT_NAME $TUNNEL $URL $WORKDIR $WEB_SOCKET $DIRECT $PROTOCOLS $INSTANCE_IDENTITY &quot;$@&quot;</span><br></pre></td></tr></table></figure>

<p>去掉$REMOTING_OPTS，因为启动时jenkins传的参数无效，且用不上。</p>
<p>完整的jenkins-agent脚本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line">#!/usr/bin/env sh</span><br><span class="line"></span><br><span class="line"># The MIT License</span><br><span class="line">#</span><br><span class="line">#  Copyright (c) 2015-2020, CloudBees, Inc.</span><br><span class="line">#</span><br><span class="line">#  Permission is hereby granted, free of charge, to any person obtaining a copy</span><br><span class="line">#  of this software and associated documentation files (the &quot;Software&quot;), to deal</span><br><span class="line">#  in the Software without restriction, including without limitation the rights</span><br><span class="line">#  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell</span><br><span class="line">#  copies of the Software, and to permit persons to whom the Software is</span><br><span class="line">#  furnished to do so, subject to the following conditions:</span><br><span class="line">#</span><br><span class="line">#  The above copyright notice and this permission notice shall be included in</span><br><span class="line">#  all copies or substantial portions of the Software.</span><br><span class="line">#</span><br><span class="line">#  THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR</span><br><span class="line">#  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,</span><br><span class="line">#  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE</span><br><span class="line">#  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER</span><br><span class="line">#  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,</span><br><span class="line">#  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN</span><br><span class="line">#  THE SOFTWARE.</span><br><span class="line"></span><br><span class="line"># Usage jenkins-agent.sh [options] -url http://jenkins -secret [SECRET] -name [AGENT_NAME]</span><br><span class="line"># Optional environment variables :</span><br><span class="line"># * JENKINS_JAVA_BIN : Java executable to use instead of the default in PATH or obtained from JAVA_HOME</span><br><span class="line"># * JENKINS_JAVA_OPTS : Java Options to use for the remoting process, otherwise obtained from JAVA_OPTS</span><br><span class="line"># * REMOTING_OPTS : Generic way to pass additional CLI options to agent.jar (see -help)</span><br><span class="line">#</span><br><span class="line"># Deprecated environment variables (prefer setting REMOTING_OPTS)</span><br><span class="line"># * JENKINS_TUNNEL : HOST:PORT for a tunnel to route TCP traffic to jenkins host, when jenkins can&#x27;t be directly accessed over network</span><br><span class="line"># * JENKINS_URL : alternate jenkins URL</span><br><span class="line"># * JENKINS_SECRET : agent secret, if not set as an argument</span><br><span class="line"># * JENKINS_AGENT_NAME : agent name, if not set as an argument</span><br><span class="line"># * JENKINS_AGENT_WORKDIR : agent work directory, if not set by optional parameter -workDir</span><br><span class="line"># * JENKINS_WEB_SOCKET: true if the connection should be made via WebSocket rather than TCP</span><br><span class="line"># * JENKINS_DIRECT_CONNECTION: Connect directly to this TCP agent port, skipping the HTTP(S) connection parameter download.</span><br><span class="line">#                              Value: &quot;&lt;HOST&gt;:&lt;PORT&gt;&quot;</span><br><span class="line"># * JENKINS_INSTANCE_IDENTITY: The base64 encoded InstanceIdentity byte array of the Jenkins controller. When this is set,</span><br><span class="line">#                              the agent skips connecting to an HTTP(S) port for connection info.</span><br><span class="line"># * JENKINS_PROTOCOLS:         Specify the remoting protocols to attempt when instanceIdentity is provided.</span><br><span class="line"></span><br><span class="line">if [ $# -eq 1 ] &amp;&amp; [ &quot;$&#123;1#-&#125;&quot; = &quot;$1&quot; ] ; then</span><br><span class="line"></span><br><span class="line">	# if `docker run` only has one arguments and it is not an option as `-help`, we assume user is running alternate command like `bash` to inspect the image</span><br><span class="line">	exec &quot;$@&quot;</span><br><span class="line"></span><br><span class="line">else</span><br><span class="line"></span><br><span class="line">	# if -tunnel is not provided, try env vars</span><br><span class="line">	case &quot;$@&quot; in</span><br><span class="line">		*&quot;-tunnel &quot;*) ;;</span><br><span class="line">		*)</span><br><span class="line">		if [ ! -z &quot;$JENKINS_TUNNEL&quot; ]; then</span><br><span class="line">			TUNNEL=&quot;-tunnel $JENKINS_TUNNEL&quot;</span><br><span class="line">		fi ;;</span><br><span class="line">	esac</span><br><span class="line"></span><br><span class="line">	# if -workDir is not provided, try env vars</span><br><span class="line">	if [ ! -z &quot;$JENKINS_AGENT_WORKDIR&quot; ]; then</span><br><span class="line">		case &quot;$@&quot; in</span><br><span class="line">			*&quot;-workDir&quot;*) echo &quot;Warning: Work directory is defined twice in command-line arguments and the environment variable&quot; ;;</span><br><span class="line">			*)</span><br><span class="line">			WORKDIR=&quot;-workDir $JENKINS_AGENT_WORKDIR&quot; ;;</span><br><span class="line">		esac</span><br><span class="line">	fi</span><br><span class="line"></span><br><span class="line">	if [ -n &quot;$JENKINS_URL&quot; ]; then</span><br><span class="line">		URL=&quot;-url $JENKINS_URL&quot;</span><br><span class="line">	fi</span><br><span class="line"></span><br><span class="line">	if [ -n &quot;$JENKINS_NAME&quot; ]; then</span><br><span class="line">		JENKINS_AGENT_NAME=&quot;$JENKINS_NAME&quot;</span><br><span class="line">	fi</span><br><span class="line"></span><br><span class="line">	if [ &quot;$JENKINS_WEB_SOCKET&quot; = true ]; then</span><br><span class="line">		WEB_SOCKET=-webSocket</span><br><span class="line">	fi</span><br><span class="line"></span><br><span class="line">	if [ -n &quot;$JENKINS_PROTOCOLS&quot; ]; then</span><br><span class="line">		PROTOCOLS=&quot;-protocols $JENKINS_PROTOCOLS&quot;</span><br><span class="line">	fi</span><br><span class="line"></span><br><span class="line">	if [ -n &quot;$JENKINS_DIRECT_CONNECTION&quot; ]; then</span><br><span class="line">		DIRECT=&quot;-direct $JENKINS_DIRECT_CONNECTION&quot;</span><br><span class="line">	fi</span><br><span class="line"></span><br><span class="line">	if [ -n &quot;$JENKINS_INSTANCE_IDENTITY&quot; ]; then</span><br><span class="line">		INSTANCE_IDENTITY=&quot;-instanceIdentity $JENKINS_INSTANCE_IDENTITY&quot;</span><br><span class="line">	fi</span><br><span class="line"></span><br><span class="line">	if [ &quot;$JENKINS_JAVA_BIN&quot; ]; then</span><br><span class="line">		JAVA_BIN=&quot;$JENKINS_JAVA_BIN&quot;</span><br><span class="line">	else</span><br><span class="line">		# if java home is defined, use it</span><br><span class="line">		JAVA_BIN=&quot;java&quot;</span><br><span class="line">		if [ &quot;$JAVA_HOME&quot; ]; then</span><br><span class="line">			JAVA_BIN=&quot;$JAVA_HOME/bin/java&quot;</span><br><span class="line">		fi</span><br><span class="line">	fi</span><br><span class="line"></span><br><span class="line">	if [ &quot;$JENKINS_JAVA_OPTS&quot; ]; then</span><br><span class="line">		JAVA_OPTIONS=&quot;$JENKINS_JAVA_OPTS&quot;</span><br><span class="line">	else</span><br><span class="line">		# if JAVA_OPTS is defined, use it</span><br><span class="line">		if [ &quot;$JAVA_OPTS&quot; ]; then</span><br><span class="line">			JAVA_OPTIONS=&quot;$JAVA_OPTS&quot;</span><br><span class="line">		fi</span><br><span class="line">	fi</span><br><span class="line"></span><br><span class="line">	# if both required options are defined, do not pass the parameters</span><br><span class="line">	if [ -n &quot;$JENKINS_SECRET&quot; ]; then</span><br><span class="line">		case &quot;$@&quot; in</span><br><span class="line">			*&quot;$&#123;JENKINS_SECRET&#125;&quot;*) echo &quot;Warning: SECRET is defined twice in command-line arguments and the environment variable&quot; ;;</span><br><span class="line">			*)</span><br><span class="line">			SECRET=&quot;-secret $&#123;JENKINS_SECRET&#125;&quot; ;;</span><br><span class="line">		esac</span><br><span class="line">	fi</span><br><span class="line"></span><br><span class="line">	if [ -n &quot;$JENKINS_AGENT_NAME&quot; ]; then</span><br><span class="line">		case &quot;$@&quot; in</span><br><span class="line">			*&quot;$&#123;JENKINS_AGENT_NAME&#125;&quot;*) echo &quot;Warning: AGENT_NAME is defined twice in command-line arguments and the environment variable&quot; ;;</span><br><span class="line">			*)</span><br><span class="line">			AGENT_NAME=&quot;-name $&#123;JENKINS_AGENT_NAME&#125;&quot; ;;</span><br><span class="line">		esac</span><br><span class="line">	fi</span><br><span class="line"></span><br><span class="line">	#TODO: Handle the case when the command-line and Environment variable contain different values.</span><br><span class="line">	#It is fine it blows up for now since it should lead to an error anyway.</span><br><span class="line"></span><br><span class="line">        #exec $JAVA_BIN $JAVA_OPTIONS -jar /usr/share/jenkins/agent.jar $SECRET $AGENT_NAME $TUNNEL $URL $WORKDIR $WEB_SOCKET $DIRECT $PROTOCOLS $INSTANCE_IDENTITY $REMOTING_OPTS &quot;$@&quot;</span><br><span class="line">        exec $JAVA_BIN $JAVA_OPTIONS -jar /usr/share/jenkins/agent.jar $SECRET $AGENT_NAME $TUNNEL $URL $WORKDIR $WEB_SOCKET $DIRECT $PROTOCOLS $INSTANCE_IDENTITY &quot;$@&quot;</span><br><span class="line"></span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 构建镜像</span><br><span class="line">docker build -t harbor.basepoint.net/library/rocky_build:jdk22-go1.22.5 .</span><br><span class="line"># 上传私有仓库</span><br><span class="line">docker push harbor.basepoint.net/library/rocky_build:jdk22-go1.22.5</span><br></pre></td></tr></table></figure>

<h4 id="（可选）docker-dind镜像上传到私有仓库，加速构建时下载镜像"><a href="#（可选）docker-dind镜像上传到私有仓库，加速构建时下载镜像" class="headerlink" title="（可选）docker dind镜像上传到私有仓库，加速构建时下载镜像"></a>（可选）docker dind镜像上传到私有仓库，加速构建时下载镜像</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker pull docker:dind</span><br><span class="line">docker tag docker:dind harbor.basepoint.net/library/docker:dind</span><br><span class="line">docker push harbor.basepoint.net/library/docker:dind</span><br></pre></td></tr></table></figure>

<h3 id="创建云节点"><a href="#创建云节点" class="headerlink" title="创建云节点"></a>创建云节点</h3><p>Jenkins &#x3D;&#x3D;&gt; 系统管理 &#x3D;&#x3D;&gt; CLouds &#x3D;&#x3D;&gt; New cloud</p>
<p><img src="/images/image-qthn.png"></p>
<p><img src="/images/image-qucu.png"></p>
<h3 id="创建Pod模版"><a href="#创建Pod模版" class="headerlink" title="创建Pod模版"></a>创建Pod模版</h3><p><img src="/images/image-capf.png"></p>
<blockquote>
<p>名称不设置默认也是jenkins-agent，</p>
<p>命名空间写构建时运行的命名空间，我这里是jenkins在同一个命名空间下（前提RBAC权限要赋予到位）</p>
<p>标签列表，pipline选择节点标签一致时才会触发这个pod模版</p>
</blockquote>
<p><img src="/images/image-ccsk.png"></p>
<blockquote>
<p>这里使用构建的镜像，jnlp名称是固定的，否则覆盖不了默认的jnlp容器，</p>
<p>运行的命令和参数不要写，否则会替换镜像中的CMD或者ENPTYPOINT参数</p>
</blockquote>
<p><img src="/images/image-kekn.png"></p>
<blockquote>
<p>（可选）使用Docker in Docker 构建docker镜像，必须使用最高权限运行，</p>
<p>运行的命令和参数不要写，否则会替换镜像中的CMD或者ENPTYPOINT参数</p>
</blockquote>
<p><img src="/images/image-qfoy.png"></p>
<blockquote>
<p>docker容器登录harbor时使用，harbor-ca是使用trust分发的ca.crt</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: trust.cert-manager.io/v1alpha1</span><br><span class="line">kind: Bundle</span><br><span class="line">metadata:</span><br><span class="line">  name: harbor-ca</span><br><span class="line">spec:</span><br><span class="line">  sources:</span><br><span class="line">  - secret:</span><br><span class="line">      # devops-tls是源secret（使用cert-manager创建的自签名证书），包含ca.crt</span><br><span class="line">      name: &quot;devops-tls&quot;</span><br><span class="line">      key: &quot;ca.crt&quot;</span><br><span class="line">  target:</span><br><span class="line">    secret:</span><br><span class="line">      key: &quot;ca.crt&quot;</span><br></pre></td></tr></table></figure>

<p>cert-manager和trust参考请转移以下文章</p>
<p>原文地址：<a target="_blank" rel="noopener" href="https://sreok.cn/archives/c03ad0e3-f52e-4e3e-805a-95bcf2a9b37c">使用cert-manager 生成自签名证书 - Elijah Blog (</a><a target="_blank" rel="noopener" href="http://sreok.cn/">sreok.cn</a><a target="_blank" rel="noopener" href="https://sreok.cn/archives/c03ad0e3-f52e-4e3e-805a-95bcf2a9b37c">)</a></p>
<p>原文地址：<a target="_blank" rel="noopener" href="https://sreok.cn/archives/ed87d9b2-89b3-46df-aa33-7a647bbd6395">使用trust-manager将TLS证书同步到其他命名空间 - Elijah Blog (</a><a target="_blank" rel="noopener" href="http://sreok.cn/">sreok.cn</a><a target="_blank" rel="noopener" href="https://sreok.cn/archives/ed87d9b2-89b3-46df-aa33-7a647bbd6395">)</a></p>
</blockquote>
<p><img src="/images/image-ztow.png"></p>
<blockquote>
<p>（可选）pod模版中获取镜像如果是私有镜像需要用到，创建如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret docker-registry regcred \</span><br><span class="line">--docker-server=harbor.basepoint.net \</span><br><span class="line">--docker-username=admin \</span><br><span class="line">--docker-password=Harbor12345 \</span><br><span class="line">--docker-email=admin@basepoint.net</span><br><span class="line">-n devops </span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="创建pipeline项目（golang后端）"><a href="#创建pipeline项目（golang后端）" class="headerlink" title="创建pipeline项目（golang后端）"></a>创建pipeline项目（golang后端）</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">pipeline &#123;</span><br><span class="line">    agent &#123;</span><br><span class="line">        // 与pod模版设置的标签一致</span><br><span class="line">        label &#x27;slave&#x27;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(&#x27;Git Clone&#x27;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                container(&quot;jnlp&quot;)&#123;</span><br><span class="line">                    //git  branch: &quot;main&quot;, credentialsId: &quot;gitlab-root&quot;, url: &quot;http://gitlab-webservice-default.devops.svc:8181/kube-go/kube-go.git&quot;</span><br><span class="line">                    git  branch: &quot;main&quot;, credentialsId: &quot;gitlab-root&quot;, url: &quot;https://gitlab.basepoint.net/kube-go/kube-go.git&quot;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&#x27;GO Build&#x27;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                container(&quot;jnlp&quot;)&#123;</span><br><span class="line">                    echo &#x27;go编译&#x27;</span><br><span class="line">                    sh &#x27;go version&#x27;</span><br><span class="line">                    sh &#x27;go mod tidy&#x27;</span><br><span class="line">                    sh &#x27;go build -o ./build/ ./main/main.go&#x27;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&#x27;Docker Build&#x27;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                container(&quot;docker&quot;)&#123;</span><br><span class="line">                    echo &#x27;构建docker镜像&#x27;</span><br><span class="line">                    sh &#x27;docker -v&#x27;</span><br><span class="line">                    // 登录harbor私有仓库</span><br><span class="line">                    sh &#x27;docker login harbor.basepoint.net -u admin -p Harbor12345&#x27;</span><br><span class="line">                    // FROM镜像不使用/etc/docker/certs/下的证书，提前拉取Dockerfile中的FROM镜像</span><br><span class="line">                    sh &#x27;docker pull harbor.basepoint.net/library/golang:1.22.5&#x27;</span><br><span class="line">                    sh &#x27;docker build -t harbor.basepoint.net/kube-go/kube-go:v1 .&#x27;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(&#x27;Docker Push&#x27;) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                container(&quot;docker&quot;)&#123;</span><br><span class="line">                    echo &#x27;推送docker镜像&#x27;</span><br><span class="line">                    sh &#x27;docker push harbor.basepoint.net/kube-go/kube-go:v1&#x27;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    post &#123;</span><br><span class="line">        always&#123;</span><br><span class="line">            script&#123;</span><br><span class="line">                println(&quot;流水线结束后，经常做的事情&quot;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">            </span><br><span class="line">        success&#123;</span><br><span class="line">            script&#123;</span><br><span class="line">                println(&quot;流水线成功后，要做的事情&quot;)</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">        failure&#123;</span><br><span class="line">            script&#123;</span><br><span class="line">                println(&quot;流水线失败后，要做的事情&quot;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">            </span><br><span class="line">        aborted&#123;</span><br><span class="line">            script&#123;</span><br><span class="line">                println(&quot;流水线取消后，要做的事情&quot;)</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="测试构建"><a href="#测试构建" class="headerlink" title="测试构建"></a>测试构建</h3><p><img src="/images/image-rbsq.png"></p>
<h4 id="查看构建之后的镜像"><a href="#查看构建之后的镜像" class="headerlink" title="查看构建之后的镜像"></a>查看构建之后的镜像</h4><p><img src="/images/image-ynye.png"></p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2023-09-07</span><i class="fa fa-tag"></i><a class="tag" href="/categories/云原生/" title="云原生">云原生 </a><a class="tag" href="/tags/DevOps/" title="DevOps">DevOps </a><a class="tag" href="/tags/Jenkins/" title="Jenkins">Jenkins </a><span class="leancloud_visitors"></span></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="" onclick="javascript:join_favorite()" ref="sidebar"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" target="_blank" rel="noopener" href="http://twitter.com/home?status=,https://sreok.github.io/2023/09/07/【DevOps】Jenkins基于Kubernetes创建动态构建池/,Elijah,【DevOps】Jenkins基于Kubernetes创建动态构建池,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2023/09/10/%E3%80%90DevOps%E3%80%91Kubernetes%E9%83%A8%E7%BD%B2%E7%A7%81%E6%9C%89%E4%BB%A3%E7%A0%81%E4%BB%93%E5%BA%93GitLab%20v17.2.0%EF%BC%88Helm%E6%96%B9%E5%BC%8F%E5%AE%89%E8%A3%85%EF%BC%89/" title="【DevOps】Kubernetes部署私有代码仓库GitLab v17.2.0（Helm方式安装）">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2023/09/06/%E3%80%90DevOps%E3%80%91Jenkins%E5%9F%BA%E4%BA%8EKubernetes%E5%88%9B%E5%BB%BA%E9%9D%99%E6%80%81%E6%9E%84%E5%BB%BA%E6%B1%A0/" title="【DevOps】Jenkins基于Kubernetes创建静态构建池">下一篇</a></li></ul></div><script src="/js/visitors.js"></script><a id="comments"></a><div id="vcomments" style="margin:0 30px;"></div><script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script><script src="//cdn.jsdelivr.net/gh/xcss/valine@latest/dist/Valine.min.js"></script><script>var valine = new Valine({
  el:'#vcomments',
  notify:true || false, 
  verify:false|| false, 
  app_id:'fI99ZhgQcLYvkEn59ArxksxC-gzGzoHsz',
  app_key:'t54nFvuZ0mPdSIYuMFD5eL39',
  placeholder:'念念不忘，必有回响...',
  path: window.location.pathname,
  serverURLs: '',
  visitor:true,
  recordIP:true,
  avatar:'hide'
})</script></div></div></div></div><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/add-bookmark.js"></script><script src="/js/baidu-tongji.js"></script></body></html>